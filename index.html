<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofuje - Multiplayer CBT</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}
        :root{--bg:#667eea;--bg2:#764ba2;--glass:rgba(255,255,255,0.15);--glass-border:rgba(255,255,255,0.2);--text:#fff;--shadow:0 8px 32px rgba(31,38,135,0.37)}
        .dark{--bg:#1a1a2e;--bg2:#16213e;--glass:rgba(0,0,0,0.3);--glass-border:rgba(255,255,255,0.1);--text:#fff}
        body{min-height:100vh;background:linear-gradient(135deg,var(--bg),var(--bg2));display:flex;justify-content:center;align-items:center;padding:20px;transition:0.3s}
        .glass{background:var(--glass);backdrop-filter:blur(20px);border-radius:20px;border:1px solid var(--glass-border);box-shadow:var(--shadow)}
        .container{width:100%;max-width:1200px;min-height:90vh;padding:30px;color:var(--text)}
        .hidden{display:none!important}
        .btn{padding:12px 30px;border:none;border-radius:12px;cursor:pointer;font-weight:600;transition:0.3s;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
        .btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(102,126,234,0.4)}
        .btn-secondary{background:var(--glass);border:1px solid var(--glass-border)}
        input,select{width:100%;padding:15px;border:1px solid var(--glass-border);border-radius:12px;background:var(--glass);color:var(--text);font-size:16px;margin-bottom:15px}
        input::placeholder{color:rgba(255,255,255,0.6)}
        .auth-container{max-width:450px;margin:0 auto;text-align:center}
        .logo{font-size:3rem;font-weight:700;margin-bottom:10px;background:linear-gradient(135deg,#fff,#a8edea);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .tabs{display:flex;gap:10px;margin-bottom:30px}
        .tab{flex:1;padding:12px;border-radius:12px;cursor:pointer;background:transparent;border:1px solid var(--glass-border);color:var(--text)}
        .tab.active{background:linear-gradient(135deg,#667eea,#764ba2)}
        .dashboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}
        .user-info{display:flex;align-items:center;gap:15px}
        .avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:600}
        .header-actions{display:flex;gap:10px;align-items:center}
        .dark-toggle{width:50px;height:26px;border-radius:13px;background:var(--glass);border:1px solid var(--glass-border);cursor:pointer;position:relative}
        .dark-toggle::after{content:'';position:absolute;width:20px;height:20px;border-radius:50%;background:#fff;top:2px;left:3px;transition:0.3s}
        .dark .dark-toggle::after{left:26px;background:#667eea}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{padding:25px;text-align:center}
        .stat-card i{font-size:2rem;margin-bottom:10px;color:#a8edea}
        .stat-value{font-size:2rem;font-weight:700}
        .stat-label{opacity:0.8;font-size:0.9rem}
        .section-title{font-size:1.5rem;margin-bottom:20px;display:flex;align-items:center;gap:10px}
        .tests-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
        .test-card{padding:25px;cursor:pointer;transition:0.3s}
        .test-card:hover{transform:translateY(-5px)}
        .test-card h3{margin-bottom:10px}
        .test-card p{opacity:0.8;font-size:0.9rem;margin-bottom:15px}
        .leaderboard{max-height:400px;overflow-y:auto}
        .leaderboard-item{display:flex;align-items:center;padding:15px;margin-bottom:10px;border-radius:12px;background:var(--glass)}
        .leaderboard-item.gold{background:linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,193,7,0.2))}
        .leaderboard-item.silver{background:linear-gradient(135deg,rgba(192,192,192,0.3),rgba(158,158,158,0.2))}
        .leaderboard-item.bronze{background:linear-gradient(135deg,rgba(205,127,50,0.3),rgba(121,85,72,0.2))}
        .rank{width:30px;font-weight:700;font-size:1.2rem}
        .lb-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;margin-right:15px}
        .lb-info{flex:1}
        .lb-name{font-weight:600}
        .lb-code{font-size:0.8rem;opacity:0.7}
        .lb-points{font-weight:700;color:#a8edea}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;padding:20px}
        .modal-content{max-width:500px;width:100%;padding:30px;text-align:center}
        .waiting-room h2{margin-bottom:20px}
        .waiting-spinner{width:60px;height:60px;border:4px solid var(--glass-border);border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite;margin:30px auto}
        @keyframes spin{to{transform:rotate(360deg)}}
        .quiz-container{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        @media(max-width:900px){.quiz-container{grid-template-columns:1fr}}
        .quiz-panel{padding:25px}
        .quiz-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
        .timer{font-size:1.5rem;font-weight:700;color:#ff6b6b}
        .player-status{display:flex;align-items:center;gap:10px;padding:10px;background:var(--glass);border-radius:10px;margin-bottom:15px}
        .question-box{margin-bottom:20px}
        .question-number{font-size:0.9rem;opacity:0.8;margin-bottom:10px}
        .question-text{font-size:1.1rem;font-weight:500;margin-bottom:20px}
        .options{display:flex;flex-direction:column;gap:10px}
        .option{padding:15px;border-radius:12px;cursor:pointer;transition:0.3s;border:2px solid transparent;background:var(--glass)}
        .option:hover{border-color:#667eea}
        .option.selected{background:linear-gradient(135deg,#667eea,#764ba2);border-color:transparent}
        .quiz-nav{display:flex;gap:10px;justify-content:space-between;margin-top:20px}
        .question-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:5px;margin-top:20px}
        .q-dot{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;cursor:pointer;background:var(--glass);border:1px solid var(--glass-border)}
        .q-dot.answered{background:linear-gradient(135deg,#667eea,#764ba2)}
        .q-dot.current{border:2px solid #fff}
        .voice-controls{display:flex;gap:10px;margin-top:20px}
        .voice-btn{width:50px;height:50px;border-radius:50%;border:none;cursor:pointer;font-size:1.2rem;transition:0.3s}
        .voice-btn.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
        .voice-btn.muted{background:#ff6b6b;color:#fff}
        .results-container{text-align:center;padding:40px}
        .result-icon{font-size:5rem;margin-bottom:20px}
        .result-icon.win{color:#4ecdc4}
        .result-icon.lose{color:#ff6b6b}
        .result-icon.draw{color:#ffd93d}
        .result-cards{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:30px 0}
        .result-card{padding:25px}
        .result-card h3{margin-bottom:15px}
        .result-score{font-size:2.5rem;font-weight:700}
        .point-change{font-size:1.2rem;margin-top:10px}
        .point-change.positive{color:#4ecdc4}
        .point-change.negative{color:#ff6b6b}
        .records-container{margin-top:30px}
        .record-item{display:flex;justify-content:space-between;padding:15px;margin-bottom:10px;border-radius:12px;background:var(--glass)}
        .nav-tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
        .nav-tab{padding:10px 20px;border-radius:10px;cursor:pointer;background:var(--glass);border:1px solid var(--glass-border)}
        .nav-tab.active{background:linear-gradient(135deg,#667eea,#764ba2)}
        ::-webkit-scrollbar{width:8px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:var(--glass-border);border-radius:4px}
    </style>
</head>
<body>
    <div class="container glass" id="app">
        <!-- Auth Section -->
        <div id="authSection" class="auth-container">
            <div class="logo">Ofuje</div>
            <p style="margin-bottom:30px;opacity:0.8">Multiplayer CBT Platform</p>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('login')">Login</div>
                <div class="tab" onclick="switchTab('register')">Register</div>
            </div>
            <div id="loginForm">
                <input type="text" id="loginCode" placeholder="Enter Access Code">
                <button class="btn" style="width:100%" onclick="login()">Login</button>
            </div>
            <div id="registerForm" class="hidden">
                <input type="text" id="regName" placeholder="Your Full Name">
                <input type="text" id="regCode" placeholder="Choose Access Code">
                <button class="btn" style="width:100%" onclick="register()">Register</button>
            </div>
            <p id="authError" style="color:#ff6b6b;margin-top:15px"></p>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="hidden">
            <div class="dashboard-header">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">O</div>
                    <div>
                        <h2 id="userName">User</h2>
                        <small id="userCode" style="opacity:0.7"></small>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="dark-toggle" onclick="toggleDark()"></div>
                    <button class="btn btn-secondary" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showDashTab('home')">Home</div>
                <div class="nav-tab" onclick="showDashTab('leaderboard')">Leaderboard</div>
                <div class="nav-tab" onclick="showDashTab('records')">Records</div>
                <div class="nav-tab" onclick="showDashTab('users')">Users</div>
            </div>

            <div id="homeTab">
                <div class="stats-grid">
                    <div class="stat-card glass">
                        <i class="fas fa-trophy"></i>
                        <div class="stat-value" id="statPoints">0</div>
                        <div class="stat-label">Points</div>
                    </div>
                    <div class="stat-card glass">
                        <i class="fas fa-check-circle"></i>
                        <div class="stat-value" id="statWins">0</div>
                        <div class="stat-label">Wins</div>
                    </div>
                    <div class="stat-card glass">
                        <i class="fas fa-times-circle"></i>
                        <div class="stat-value" id="statLosses">0</div>
                        <div class="stat-label">Losses</div>
                    </div>
                    <div class="stat-card glass">
                        <i class="fas fa-gamepad"></i>
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">Total Games</div>
                    </div>
                </div>
                <h3 class="section-title"><i class="fas fa-book"></i> Available Tests</h3>
                <div class="tests-grid" id="testsGrid"></div>
            </div>

            <div id="leaderboardTab" class="hidden">
                <h3 class="section-title"><i class="fas fa-trophy"></i> Leaderboard</h3>
                <div class="leaderboard" id="leaderboardList"></div>
            </div>

            <div id="recordsTab" class="hidden">
                <h3 class="section-title"><i class="fas fa-history"></i> Your Records</h3>
                <div id="recordsList"></div>
            </div>

            <div id="usersTab" class="hidden">
                <h3 class="section-title"><i class="fas fa-users"></i> All Users</h3>
                <div id="usersList"></div>
            </div>
        </div>

        <!-- Quiz Section -->
        <div id="quizSection" class="hidden">
            <div class="quiz-header">
                <h2 id="quizTitle">Quiz</h2>
                <div class="timer"><i class="fas fa-clock"></i> <span id="timerDisplay">60:00</span></div>
            </div>
            <div class="quiz-container">
                <div class="quiz-panel glass">
                    <div class="player-status">
                        <div class="avatar" style="width:35px;height:35px;font-size:1rem" id="myAvatar">M</div>
                        <div style="flex:1">
                            <div id="myName">You</div>
                            <small>Score: <span id="myScore">0</span>/40</small>
                        </div>
                        <span>Q<span id="myQuestion">1</span></span>
                    </div>
                    <div class="question-box">
                        <div class="question-number">Question <span id="currentQ">1</span> of 40</div>
                        <div class="question-text" id="questionText"></div>
                    </div>
                    <div class="options" id="optionsContainer"></div>
                    <div class="quiz-nav">
                        <button class="btn btn-secondary" onclick="prevQuestion()"><i class="fas fa-arrow-left"></i> Prev</button>
                        <button class="btn btn-secondary" onclick="nextQuestion()">Next <i class="fas fa-arrow-right"></i></button>
                        <button class="btn" onclick="submitQuiz()">Submit</button>
                    </div>
                    <div class="question-grid" id="questionGrid"></div>
                </div>
                <div class="quiz-panel glass">
                    <div class="player-status">
                        <div class="avatar" style="width:35px;height:35px;font-size:1rem;background:linear-gradient(135deg,#f093fb,#f5576c)" id="oppAvatar">O</div>
                        <div style="flex:1">
                            <div id="oppName">Opponent</div>
                            <small>Score: <span id="oppScore">0</span>/40</small>
                        </div>
                        <span>Q<span id="oppQuestion">1</span></span>
                    </div>
                    <div style="text-align:center;padding:50px 0">
                        <i class="fas fa-user-shield" style="font-size:4rem;opacity:0.5"></i>
                        <p style="margin-top:20px;opacity:0.7">Opponent's answers are hidden</p>
                    </div>
                    <div class="voice-controls" style="justify-content:center">
                        <button class="voice-btn active" id="micBtn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                        <button class="voice-btn active" id="speakerBtn" onclick="toggleSpeaker()"><i class="fas fa-volume-up"></i></button>
                    </div>
                    <audio id="remoteAudio" autoplay></audio>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <div class="results-container">
                <div class="result-icon" id="resultIcon"><i class="fas fa-trophy"></i></div>
                <h1 id="resultTitle">Victory!</h1>
                <p id="resultSubtitle" style="opacity:0.8"></p>
                <div class="result-cards">
                    <div class="result-card glass">
                        <h3>You</h3>
                        <div class="result-score" id="myFinalScore">0/40</div>
                        <div class="point-change" id="myPointChange">+10</div>
                        <div style="margin-top:10px;opacity:0.7">Total: <span id="myTotalPoints">0</span></div>
                    </div>
                    <div class="result-card glass">
                        <h3 id="oppFinalName">Opponent</h3>
                        <div class="result-score" id="oppFinalScore">0/40</div>
                        <div class="point-change" id="oppPointChange">-5</div>
                        <div style="margin-top:10px;opacity:0.7">Total: <span id="oppTotalPoints">0</span></div>
                    </div>
                </div>
                <button class="btn" onclick="backToDashboard()">Back to Dashboard</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal hidden" id="codeModal">
        <div class="modal-content glass">
            <h2 style="margin-bottom:20px">Enter Test Code</h2>
            <input type="text" id="testCode" placeholder="Enter code to proceed">
            <p id="codeError" style="color:#ff6b6b;margin-bottom:15px"></p>
            <div style="display:flex;gap:10px">
                <button class="btn btn-secondary" onclick="closeModal('codeModal')">Cancel</button>
                <button class="btn" onclick="verifyTestCode()">Proceed</button>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="waitingModal">
        <div class="modal-content glass waiting-room">
            <h2>Waiting for Opponent</h2>
            <div class="waiting-spinner"></div>
            <p id="waitingText">Looking for a player...</p>
            <button class="btn btn-secondary" style="margin-top:20px" onclick="cancelWaiting()">Cancel</button>
        </div>
    </div>

    <script type="module">
        import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import{getDatabase,ref,set,get,push,onValue,update,remove,onDisconnect}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig={apiKey: "AIzaSyBqJ6HGEG6lr_xASqfNj8qufTcsgD9x-XM",
  authDomain: "real-72aca.firebaseapp.com",
  projectId: "real-72aca",
  storageBucket: "real-72aca.firebasestorage.app",
  messagingSenderId: "546290119112",
  appId: "1:546290119112:web:9dc7c0cb649f327f0e90fd",
  measurementId: "G-7NLB3398FM"};

        // IMPORTANT: Replace with your Firebase config
        const app=initializeApp(firebaseConfig);
        const db=getDatabase(app);

        // State
        let currentUser=null,currentTest=null,currentRoom=null,roomRef=null,answers=[],timerInterval=null,localStream=null,peerConnection=null,isMicOn=true,isSpeakerOn=true;

        // Default Tests
        const tests=[
            {id:'math101',name:'Mathematics Quiz',desc:'Test your math skills with 40 questions',questions:generateQuestions('math')},
            {id:'science101',name:'Science Quiz',desc:'General science knowledge test',questions:generateQuestions('science')}
        ];

        function generateQuestions(type){
            const q=[];
            const mathQs=[
                {q:'What is 15 × 12?',o:['180','175','190','170'],a:0},
                {q:'Solve: 144 ÷ 12',o:['11','12','13','14'],a:1},
                {q:'What is 25²?',o:['525','625','725','425'],a:1},
                {q:'√256 = ?',o:['14','15','16','17'],a:2},
                {q:'What is 3⁴?',o:['81','64','27','9'],a:0},
            ];
            const sciQs=[
                {q:'What is H₂O?',o:['Hydrogen','Oxygen','Water','Helium'],a:2},
                {q:'Speed of light?',o:['300,000 km/s','150,000 km/s','200,000 km/s','250,000 km/s'],a:0},
                {q:'Largest planet?',o:['Saturn','Jupiter','Neptune','Uranus'],a:1},
                {q:'What is photosynthesis?',o:['Breathing','Food making','Movement','Growth'],a:1},
                {q:'DNA stands for?',o:['Deoxyribonucleic Acid','Dinitrogen Acid','Dynamic Nuclear Acid','None'],a:0},
            ];
            const base=type==='math'?mathQs:sciQs;
            for(let i=0;i<40;i++)q.push({...base[i%5],q:`Q${i+1}: ${base[i%5].q}`});
            return q;
        }

        // UI Functions
        window.switchTab=(tab)=>{
            document.querySelectorAll('.tabs .tab').forEach((t,i)=>t.classList.toggle('active',i===(tab==='login'?0:1)));
            document.getElementById('loginForm').classList.toggle('hidden',tab!=='login');
            document.getElementById('registerForm').classList.toggle('hidden',tab==='login');
            document.getElementById('authError').textContent='';
        };

        window.showDashTab=(tab)=>{
            document.querySelectorAll('.nav-tab').forEach((t,i)=>t.classList.toggle('active',['home','leaderboard','records','users'][i]===tab));
            ['homeTab','leaderboardTab','recordsTab','usersTab'].forEach(t=>document.getElementById(t).classList.add('hidden'));
            document.getElementById(tab+'Tab').classList.remove('hidden');
            if(tab==='leaderboard')loadLeaderboard();
            if(tab==='records')loadRecords();
            if(tab==='users')loadUsers();
        };

        window.toggleDark=()=>document.body.classList.toggle('dark');

        // Auth Functions
        window.register=async()=>{
            const name=document.getElementById('regName').value.trim();
            const code=document.getElementById('regCode').value.trim();
            if(!name||!code)return showError('Please fill all fields');
            const snapshot=await get(ref(db,'users/'+code));
            if(snapshot.exists())return showError('Access code already taken');
            await set(ref(db,'users/'+code),{name,code,points:0,wins:0,losses:0,createdAt:Date.now()});
            showError('Registration successful! Please login','green');
            switchTab('login');
        };

        window.login=async()=>{
            const code=document.getElementById('loginCode').value.trim();
            if(!code)return showError('Please enter access code');
            const snapshot=await get(ref(db,'users/'+code));
            if(!snapshot.exists())return showError('Invalid access code');
            currentUser={...snapshot.val(),code};
            localStorage.setItem('ofujeUser',code);
            showDashboard();
        };

        window.logout=()=>{
            currentUser=null;
            localStorage.removeItem('ofujeUser');
            showSection('authSection');
        };

        function showError(msg,color='#ff6b6b'){
            const e=document.getElementById('authError');
            e.textContent=msg;
            e.style.color=color;
        }

        // Dashboard
        function showDashboard(){
            document.getElementById('userName').textContent=currentUser.name;
            document.getElementById('userCode').textContent=currentUser.code;
            document.getElementById('userAvatar').textContent=currentUser.name[0].toUpperCase();
            document.getElementById('statPoints').textContent=currentUser.points||0;
            document.getElementById('statWins').textContent=currentUser.wins||0;
            document.getElementById('statLosses').textContent=currentUser.losses||0;
            document.getElementById('statTotal').textContent=(currentUser.wins||0)+(currentUser.losses||0);
            renderTests();
            showSection('dashboardSection');
        }

        function renderTests(){
            document.getElementById('testsGrid').innerHTML=tests.map(t=>`
                <div class="test-card glass" onclick="selectTest('${t.id}')">
                    <h3><i class="fas fa-book-open"></i> ${t.name}</h3>
                    <p>${t.desc}</p>
                    <span class="btn btn-secondary">Start Test</span>
                </div>
            `).join('');
        }

        window.selectTest=(id)=>{
            currentTest=tests.find(t=>t.id===id);
            document.getElementById('codeModal').classList.remove('hidden');
        };

        window.verifyTestCode=()=>{
            if(document.getElementById('testCode').value!=='OFUJE2024'){
                document.getElementById('codeError').textContent='Invalid code';
                return;
            }
            closeModal('codeModal');
            findMatch();
        };

        window.closeModal=(id)=>document.getElementById(id).classList.add('hidden');

        // Matchmaking
        async function findMatch(){
            document.getElementById('waitingModal').classList.remove('hidden');
            const waitingRef=ref(db,'waiting/'+currentTest.id);
            const snapshot=await get(waitingRef);
            
            if(snapshot.exists()&&snapshot.val().player!==currentUser.code){
                const opponent=snapshot.val();
                const roomId=push(ref(db,'rooms')).key;
                await remove(waitingRef);
                await set(ref(db,'rooms/'+roomId),{
                    testId:currentTest.id,
                    player1:{code:opponent.player,name:opponent.name,score:0,currentQ:1,answers:[],submitted:false},
                    player2:{code:currentUser.code,name:currentUser.name,score:0,currentQ:1,answers:[],submitted:false},
                    startTime:Date.now(),
                    status:'active'
                });
                currentRoom=roomId;
                startQuiz();
            }else{
                await set(waitingRef,{player:currentUser.code,name:currentUser.name,timestamp:Date.now()});
                onValue(ref(db,'rooms'),async(snap)=>{
                    if(!snap.exists())return;
                    const rooms=snap.val();
                    for(let id in rooms){
                        if(rooms[id].player1?.code===currentUser.code||rooms[id].player2?.code===currentUser.code){
                            if(rooms[id].status==='active'){
                                currentRoom=id;
                                startQuiz();
                                return;
                            }
                        }
                    }
                },{onlyOnce:true});
            }
        }

        window.cancelWaiting=async()=>{
            await remove(ref(db,'waiting/'+currentTest.id));
            closeModal('waitingModal');
        };

        // Quiz
        let currentQuestion=0;

        function startQuiz(){
            closeModal('waitingModal');
            showSection('quizSection');
            document.getElementById('quizTitle').textContent=currentTest.name;
            answers=Array(40).fill(null);
            currentQuestion=0;
            renderQuestion();
            renderQuestionGrid();
            startTimer(3600);
            listenRoom();
            initVoice();
        }

        function renderQuestion(){
            const q=currentTest.questions[currentQuestion];
            document.getElementById('currentQ').textContent=currentQuestion+1;
            document.getElementById('myQuestion').textContent=currentQuestion+1;
            document.getElementById('questionText').textContent=q.q;
            document.getElementById('optionsContainer').innerHTML=q.o.map((o,i)=>`
                <div class="option ${answers[currentQuestion]===i?'selected':''}" onclick="selectOption(${i})">${String.fromCharCode(65+i)}. ${o}</div>
            `).join('');
        }

        function renderQuestionGrid(){
            document.getElementById('questionGrid').innerHTML=Array(40).fill(0).map((_,i)=>`
                <div class="q-dot ${answers[i]!==null?'answered':''} ${i===currentQuestion?'current':''}" onclick="goToQuestion(${i})">${i+1}</div>
            `).join('');
        }

        window.selectOption=(i)=>{
            answers[currentQuestion]=i;
            renderQuestion();
            renderQuestionGrid();
            updateProgress();
        };

        window.prevQuestion=()=>{if(currentQuestion>0){currentQuestion--;renderQuestion();renderQuestionGrid();}};
        window.nextQuestion=()=>{if(currentQuestion<39){currentQuestion++;renderQuestion();renderQuestionGrid();}};
        window.goToQuestion=(i)=>{currentQuestion=i;renderQuestion();renderQuestionGrid();};

        async function updateProgress(){
            const score=answers.filter((a,i)=>a===currentTest.questions[i].a).length;
            const playerKey=await getPlayerKey();
            await update(ref(db,'rooms/'+currentRoom+'/'+playerKey),{score,currentQ:currentQuestion+1,answers});
            document.getElementById('myScore').textContent=score;
        }

        async function getPlayerKey(){
            const snap=await get(ref(db,'rooms/'+currentRoom));
            const room=snap.val();
            return room.player1.code===currentUser.code?'player1':'player2';
        }

        function listenRoom(){
            roomRef=onValue(ref(db,'rooms/'+currentRoom),(snap)=>{
                if(!snap.exists())return;
                const room=snap.val();
                const isP1=room.player1.code===currentUser.code;
                const opp=isP1?room.player2:room.player1;
                const me=isP1?room.player1:room.player2;
                
                document.getElementById('oppName').textContent=opp.name;
                document.getElementById('oppAvatar').textContent=opp.name[0];
                document.getElementById('oppScore').textContent=opp.score;
                document.getElementById('oppQuestion').textContent=opp.currentQ;
                document.getElementById('myName').textContent=me.name;
                document.getElementById('myAvatar').textContent=me.name[0];

                if(opp.submitted&&!room.finished){
                    finishQuiz();
                }
            });
        }

        function startTimer(seconds){
            let time=seconds;
            timerInterval=setInterval(()=>{
                time--;
                const m=Math.floor(time/60);
                const s=time%60;
                document.getElementById('timerDisplay').textContent=`${m}:${s.toString().padStart(2,'0')}`;
                if(time<=0){clearInterval(timerInterval);finishQuiz();}
            },1000);
        }

        window.submitQuiz=()=>finishQuiz();

        async function finishQuiz(){
            clearInterval(timerInterval);
            const playerKey=await getPlayerKey();
            const score=answers.filter((a,i)=>a===currentTest.questions[i].a).length;
            await update(ref(db,'rooms/'+currentRoom+'/'+playerKey),{score,submitted:true,answers});
            await update(ref(db,'rooms/'+currentRoom),{finished:true});
            
            setTimeout(async()=>{
                const snap=await get(ref(db,'rooms/'+currentRoom));
                const room=snap.val();
                showResults(room);
            },1000);
        }

        async function showResults(room){
            if(peerConnection)peerConnection.close();
            if(localStream)localStream.getTracks().forEach(t=>t.stop());
            
            const isP1=room.player1.code===currentUser.code;
            const me=isP1?room.player1:room.player2;
            const opp=isP1?room.player2:room.player1;
            
            const won=me.score>opp.score;
            const draw=me.score===opp.score;
            const myChange=draw?0:(won?10:-5);
            const oppChange=draw?0:(won?-5:10);
            
            const newPoints=(currentUser.points||0)+myChange;
            const newWins=(currentUser.wins||0)+(won?1:0);
            const newLosses=(currentUser.losses||0)+(won?0:(draw?0:1));
            
            await update(ref(db,'users/'+currentUser.code),{points:newPoints,wins:newWins,losses:newLosses});
            await push(ref(db,'records/'+currentUser.code),{
                testId:currentTest.id,testName:currentTest.name,
                opponent:opp.name,myScore:me.score,oppScore:opp.score,
                result:draw?'draw':(won?'win':'loss'),pointChange:myChange,timestamp:Date.now()
            });
            
            currentUser.points=newPoints;
            currentUser.wins=newWins;
            currentUser.losses=newLosses;

            const icon=document.getElementById('resultIcon');
            icon.innerHTML=draw?'<i class="fas fa-handshake"></i>':(won?'<i class="fas fa-trophy"></i>':'<i class="fas fa-heart-broken"></i>');
            icon.className='result-icon '+(draw?'draw':(won?'win':'lose'));
            document.getElementById('resultTitle').textContent=draw?'Draw!':won?'Victory!':'Defeat';
            document.getElementById('resultSubtitle').textContent=draw?'You tied!':(won?'Congratulations!':'Better luck next time');
            document.getElementById('myFinalScore').textContent=me.score+'/40';
            document.getElementById('oppFinalScore').textContent=opp.score+'/40';
            document.getElementById('oppFinalName').textContent=opp.name;
            document.getElementById('myPointChange').textContent=(myChange>=0?'+':'')+myChange;
            document.getElementById('myPointChange').className='point-change '+(myChange>=0?'positive':'negative');
            document.getElementById('oppPointChange').textContent=(oppChange>=0?'+':'')+oppChange;
            document.getElementById('oppPointChange').className='point-change '+(oppChange>=0?'positive':'negative');
            document.getElementById('myTotalPoints').textContent=newPoints;
            
            showSection('resultsSection');
        }

        window.backToDashboard=()=>{
            currentRoom=null;
            showDashboard();
        };

        // Leaderboard & Records
        async function loadLeaderboard(){
            const snap=await get(ref(db,'users'));
            if(!snap.exists())return;
            const users=Object.values(snap.val()).sort((a,b)=>b.points-a.points);
            document.getElementById('leaderboardList').innerHTML=users.map((u,i)=>`
                <div class="leaderboard-item ${i===0?'gold':i===1?'silver':i===2?'bronze':''}">
                    <span class="rank">${i+1}</span>
                    <div class="lb-avatar">${u.name[0]}</div>
                    <div class="lb-info"><div class="lb-name">${u.name}</div><div class="lb-code">${u.code}</div></div>
                    <div class="lb-points">${u.points||0} pts</div>
                </div>
            `).join('');
        }

        async function loadRecords(){
            const snap=await get(ref(db,'records/'+currentUser.code));
            if(!snap.exists())return document.getElementById('recordsList').innerHTML='<p style="opacity:0.7">No records yet</p>';
            const records=Object.values(snap.val()).reverse();
            document.getElementById('recordsList').innerHTML=records.map(r=>`
                <div class="record-item glass">
                    <div><strong>${r.testName}</strong><br><small>vs ${r.opponent}</small></div>
                    <div style="text-align:right">
                        <span style="color:${r.result==='win'?'#4ecdc4':r.result==='loss'?'#ff6b6b':'#ffd93d'}">${r.result.toUpperCase()}</span><br>
                        <small>${r.myScore} - ${r.oppScore}</small>
                    </div>
                </div>
            `).join('');
        }

        async function loadUsers(){
            const snap=await get(ref(db,'users'));
            if(!snap.exists())return;
            const users=Object.values(snap.val());
            document.getElementById('usersList').innerHTML=users.map(u=>`
                <div class="leaderboard-item">
                    <div class="lb-avatar">${u.name[0]}</div>
                    <div class="lb-info"><div class="lb-name">${u.name}</div><div class="lb-code">${u.code}</div></div>
                    <div style="text-align:right"><div>${u.points||0} pts</div><small>${u.wins||0}W/${u.losses||0}L</small></div>
                </div>
            `).join('');
        }

        // Voice Chat
        async function initVoice(){
            try{
                localStream=await navigator.mediaDevices.getUserMedia({audio:true});
                const config={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
                peerConnection=new RTCPeerConnection(config);
                localStream.getTracks().forEach(t=>peerConnection.addTrack(t,localStream));
                peerConnection.ontrack=e=>document.getElementById('remoteAudio').srcObject=e.streams[0];
                peerConnection.onicecandidate=e=>{if(e.candidate)set(ref(db,'rooms/'+currentRoom+'/ice/'+currentUser.code+'/'+Date.now()),e.candidate.toJSON());};
                
                const playerKey=await getPlayerKey();
                if(playerKey==='player1'){
                    const offer=await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    await set(ref(db,'rooms/'+currentRoom+'/offer'),{type:offer.type,sdp:offer.sdp});
                    onValue(ref(db,'rooms/'+currentRoom+'/answer'),async(snap)=>{
                        if(snap.exists()&&peerConnection.signalingState!=='closed'){
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                        }
                    });
                }else{
                    onValue(ref(db,'rooms/'+currentRoom+'/offer'),async(snap)=>{
                        if(snap.exists()&&peerConnection.signalingState!=='closed'){
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                            const answer=await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);
                            await set(ref(db,'rooms/'+currentRoom+'/answer'),{type:answer.type,sdp:answer.sdp});
                        }
                    });
                }
                
                const oppCode=(await getPlayerKey())==='player1'?'player2':'player1';
                const oppUserRef=ref(db,'rooms/'+currentRoom);
                onValue(ref(db,'rooms/'+currentRoom+'/ice'),async(snap)=>{
                    if(!snap.exists())return;
                    const ices=snap.val();
                    const oppIces=Object.values(ices).filter((_,k)=>Object.keys(ices)[k]!==currentUser.code);
                    oppIces.forEach(async(ice)=>{
                        Object.values(ice).forEach(async(c)=>{
                            try{await peerConnection.addIceCandidate(new RTCIceCandidate(c));}catch(e){}
                        });
                    });
                });
            }catch(e){console.log('Voice init error:',e);}
        }

        window.toggleMic=()=>{
            isMicOn=!isMicOn;
            localStream?.getAudioTracks().forEach(t=>t.enabled=isMicOn);
            const btn=document.getElementById('micBtn');
            btn.className='voice-btn '+(isMicOn?'active':'muted');
            btn.innerHTML=`<i class="fas fa-microphone${isMicOn?'':'-slash'}"></i>`;
        };

        window.toggleSpeaker=()=>{
            isSpeakerOn=!isSpeakerOn;
            document.getElementById('remoteAudio').muted=!isSpeakerOn;
            const btn=document.getElementById('speakerBtn');
            btn.className='voice-btn '+(isSpeakerOn?'active':'muted');
            btn.innerHTML=`<i class="fas fa-volume-${isSpeakerOn?'up':'mute'}"></i>`;
        };

        // Utils
        function showSection(id){
            ['authSection','dashboardSection','quizSection','resultsSection'].forEach(s=>document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // Init
        (async()=>{
            const savedCode=localStorage.getItem('ofujeUser');
            if(savedCode){
                const snap=await get(ref(db,'users/'+savedCode));
                if(snap.exists()){
                    currentUser={...snap.val(),code:savedCode};
                    showDashboard();
                    return;
                }
            }
            showSection('authSection');
        })();
    </script>
</body>
</html>