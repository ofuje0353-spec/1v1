<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ofuje - Multiplayer CBT</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root{--bg:#f0f4f8;--card:#fff;--text:#1a202c;--primary:#6366f1;--secondary:#8b5cf6;--accent:#06b6d4;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--border:#e2e8f0;--shadow:0 4px 20px rgba(0,0,0,0.08)}
[data-theme="dark"]{--bg:#0f172a;--card:#1e293b;--text:#f1f5f9;--border:#334155;--shadow:0 4px 20px rgba(0,0,0,0.3)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:all .3s}
.hidden{display:none!important}
.container{max-width:1200px;margin:0 auto;padding:20px}
.card{background:var(--card);border-radius:16px;padding:24px;box-shadow:var(--shadow);border:1px solid var(--border)}
.btn{padding:12px 24px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s;display:inline-flex;align-items:center;gap:8px}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 25px rgba(99,102,241,0.4)}
.btn-danger{background:var(--danger);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-warning{background:var(--warning);color:#fff}
.btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
input,select,textarea{width:100%;padding:14px;border:2px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);font-size:16px;transition:all .3s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,0.1)}
.logo{font-size:2.5rem;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.auth-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.auth-card{width:100%;max-width:420px}
.auth-card h2{text-align:center;margin-bottom:24px}
.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:8px;font-weight:500}
.tabs{display:flex;gap:8px;margin-bottom:24px}
.tab{flex:1;padding:12px;text-align:center;border-radius:10px;cursor:pointer;background:var(--border);transition:all .3s}
.tab.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
.dashboard{display:grid;gap:20px}
.header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px}
.user-info{display:flex;align-items:center;gap:12px}
.avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.2rem}
.nav-btns{display:flex;gap:8px;flex-wrap:wrap}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px}
.stat-card{text-align:center;padding:20px}
.stat-card i{font-size:2rem;margin-bottom:12px;color:var(--primary)}
.stat-card h3{font-size:2rem;margin-bottom:4px}
.stat-card p{color:#64748b;font-size:.9rem}
.test-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
.test-card{position:relative;overflow:hidden}
.test-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--accent))}
.test-card h3{margin-bottom:8px}
.test-card p{color:#64748b;margin-bottom:16px}
.active-battles{font-size:.8rem;color:var(--success);margin-bottom:8px}
.leaderboard-list{max-height:400px;overflow-y:auto}
.leaderboard-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;margin-bottom:8px;background:var(--bg);transition:all .3s}
.leaderboard-item:hover{transform:translateX(4px)}
.leaderboard-item.gold{background:linear-gradient(135deg,#fef3c7,#fcd34d20);border:1px solid #fcd34d}
.leaderboard-item.silver{background:linear-gradient(135deg,#f1f5f9,#94a3b820);border:1px solid #94a3b8}
.leaderboard-item.bronze{background:linear-gradient(135deg,#fed7aa,#fb923c20);border:1px solid #fb923c}
.leaderboard-item.current-user{box-shadow:0 0 0 2px var(--primary)}
.rank{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;background:var(--card)}
.quiz-arena{min-height:100vh;padding:20px}
.quiz-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:24px}
.timer{font-size:1.5rem;font-weight:700;color:var(--danger);display:flex;align-items:center;gap:8px}
.timer.warning{animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.players-status{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.player-card{padding:16px;text-align:center;position:relative}
.player-card.current{border:2px solid var(--primary)}
.player-card .status-dot{width:10px;height:10px;border-radius:50%;background:var(--success);position:absolute;top:12px;right:12px;animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.question-card{margin-bottom:24px}
.question-card h3{margin-bottom:16px;font-size:1.2rem;line-height:1.6}
.question-number{display:inline-block;background:var(--primary);color:#fff;padding:4px 12px;border-radius:20px;font-size:.85rem;margin-bottom:12px}
.options{display:grid;gap:12px}
.option{padding:16px;border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:12px}
.option:hover{border-color:var(--primary);background:rgba(99,102,241,0.05)}
.option.selected{border-color:var(--primary);background:rgba(99,102,241,0.1)}
.option-letter{width:36px;height:36px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-weight:600;flex-shrink:0}
.option.selected .option-letter{background:var(--primary);color:#fff}
.quiz-nav{display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap}
.question-dots{display:flex;flex-wrap:wrap;gap:8px;margin-top:16px;justify-content:center}
.question-dot{width:32px;height:32px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.8rem;transition:all .2s}
.question-dot.answered{background:var(--success);color:#fff;border-color:var(--success)}
.question-dot.current{border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,0.3)}
.comm-panel{position:fixed;bottom:20px;right:20px;z-index:100}
.comm-toggle{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));border:none;color:#fff;font-size:1.5rem;cursor:pointer;box-shadow:var(--shadow);position:relative}
.comm-toggle .badge{position:absolute;top:-5px;right:-5px;background:var(--danger);color:#fff;width:20px;height:20px;border-radius:50%;font-size:.7rem;display:flex;align-items:center;justify-content:center}
.comm-box{position:absolute;bottom:70px;right:0;width:340px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;display:none}
.comm-box.active{display:block;animation:slideUp .3s}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.comm-header{padding:16px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;display:flex;justify-content:space-between;align-items:center}
.voice-controls{display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--border)}
.voice-controls button{flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;background:var(--bg);display:flex;align-items:center;justify-content:center;gap:6px;transition:all .2s}
.voice-controls button.active{background:var(--success);color:#fff}
.voice-controls button.muted{background:var(--danger);color:#fff}
.messages{height:220px;overflow-y:auto;padding:12px}
.message{margin-bottom:12px;padding:10px 14px;border-radius:12px;max-width:85%;word-wrap:break-word}
.message.sent{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;margin-left:auto;border-bottom-right-radius:4px}
.message.received{background:var(--bg);border-bottom-left-radius:4px}
.message .time{font-size:.7rem;opacity:0.7;margin-top:4px}
.chat-input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
.chat-input input{flex:1;padding:10px}
.emoji-picker{position:relative}
.emoji-list{position:absolute;bottom:100%;right:0;background:var(--card);border-radius:10px;padding:8px;box-shadow:var(--shadow);display:none;flex-wrap:wrap;width:220px;max-height:150px;overflow-y:auto}
.emoji-list.active{display:flex}
.emoji-list span{padding:6px;cursor:pointer;font-size:1.3rem;border-radius:4px;transition:background .2s}
.emoji-list span:hover{background:var(--bg)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;backdrop-filter:blur(4px)}
.modal-content{background:var(--card);border-radius:16px;padding:24px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;animation:modalIn .3s}
@keyframes modalIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
.modal-content h2{margin-bottom:16px;display:flex;align-items:center;gap:10px}
.toast-container{position:fixed;top:20px;right:20px;z-index:2000}
.toast{padding:16px 24px;border-radius:12px;margin-bottom:8px;color:#fff;display:flex;align-items:center;gap:12px;animation:slideIn .3s;box-shadow:0 4px 15px rgba(0,0,0,0.2)}
@keyframes slideIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
.toast.success{background:linear-gradient(135deg,#10b981,#059669)}
.toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
.toast.info{background:linear-gradient(135deg,var(--primary),var(--secondary))}
.toast.warning{background:linear-gradient(135deg,#f59e0b,#d97706)}
.results-card{text-align:center;padding:32px}
.results-card h2{font-size:2rem;margin-bottom:24px;justify-content:center}
.result-badge{font-size:4rem;margin-bottom:16px}
.score-display{font-size:3.5rem;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.results-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px;text-align:left}
.result-item{background:var(--bg);padding:16px;border-radius:12px}
.result-item h4{color:#64748b;font-size:.85rem;margin-bottom:4px}
.result-item p{font-size:1.4rem;font-weight:600}
.admin-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.admin-tab{padding:10px 20px;border-radius:8px;cursor:pointer;background:var(--bg);transition:all .3s}
.admin-tab.active{background:var(--primary);color:#fff}
.admin-table{width:100%;border-collapse:collapse}
.admin-table th,.admin-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
.admin-table th{background:var(--bg);font-weight:600;position:sticky;top:0}
.admin-table tr:hover td{background:var(--bg)}
.admin-table-wrapper{max-height:400px;overflow-y:auto;border-radius:10px;border:1px solid var(--border)}
.waiting-room{text-align:center;padding:60px 40px}
.waiting-room .spinner{width:80px;height:80px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 24px}
@keyframes spin{to{transform:rotate(360deg)}}
.waiting-room h2{margin-bottom:12px}
.waiting-info{display:flex;justify-content:center;gap:24px;margin-top:24px;flex-wrap:wrap}
.waiting-info-item{text-align:center}
.waiting-info-item span{display:block;font-size:1.5rem;font-weight:700;color:var(--primary)}
.progress-bar{height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-top:20px}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));transition:width .3s}
.records-list{max-height:300px;overflow-y:auto}
.record-item{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid var(--border);transition:background .2s}
.record-item:hover{background:var(--bg)}
.record-item:last-child{border-bottom:none}
.record-result{padding:4px 10px;border-radius:20px;font-size:.8rem;font-weight:600}
.record-result.win{background:rgba(16,185,129,0.1);color:var(--success)}
.record-result.loss{background:rgba(239,68,68,0.1);color:var(--danger)}
.record-result.tie{background:rgba(245,158,11,0.1);color:var(--warning)}
@media(max-width:768px){.header{flex-direction:column;text-align:center}.nav-btns{justify-content:center}.players-status{grid-template-columns:1fr}.comm-box{width:300px;right:-10px}.results-grid{grid-template-columns:1fr}.quiz-nav{flex-direction:column}.quiz-nav .btn{width:100%;justify-content:center}}
</style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>

<!-- Auth Section -->
<div id="authSection" class="auth-container">
<div class="card auth-card">
<div class="logo" style="text-align:center;margin-bottom:24px">Ofuje</div>
<div class="tabs">
<div class="tab active" onclick="switchTab('login')">Login</div>
<div class="tab" onclick="switchTab('register')">Register</div>
</div>
<div id="loginForm">
<div class="form-group"><label>Access Code</label><input type="text" id="loginCode" placeholder="Enter your access code"></div>
<button class="btn btn-primary" style="width:100%" onclick="login()"><i class="fas fa-sign-in-alt"></i>Login</button>
<p style="text-align:center;margin-top:16px;color:#64748b"><small>Admin? <a href="#" onclick="showAdminLogin()" style="color:var(--primary)">Login here</a></small></p>
</div>
<div id="registerForm" class="hidden">
<div class="form-group"><label>Full Name</label><input type="text" id="regName" placeholder="Enter your full name"></div>
<div class="form-group"><label>School</label><input type="text" id="regSchool" placeholder="Enter your school name"></div>
<div class="form-group"><label>Preferred Access Code</label><input type="text" id="regCode" placeholder="Create a unique code"></div>
<button class="btn btn-primary" style="width:100%" onclick="register()"><i class="fas fa-user-plus"></i>Register</button>
</div>
</div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden container dashboard">
<div class="card header">
<div class="user-info">
<div class="avatar" id="userAvatar">U</div>
<div><h3 id="userName">User</h3><p style="color:#64748b" id="userSchool">School</p></div>
</div>
<div class="nav-btns">
<button class="btn btn-outline" onclick="toggleTheme()" title="Toggle Theme"><i class="fas fa-moon" id="themeIcon"></i></button>
<button class="btn btn-outline" onclick="showSettings()" title="Settings"><i class="fas fa-cog"></i></button>
<button class="btn btn-danger" onclick="logout()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
</div>
</div>
<div class="stats-grid">
<div class="card stat-card"><i class="fas fa-trophy"></i><h3 id="userPoints">0</h3><p>Total Points</p></div>
<div class="card stat-card"><i class="fas fa-chart-line"></i><h3 id="userRank">#1</h3><p>Current Rank</p></div>
<div class="card stat-card"><i class="fas fa-gamepad"></i><h3 id="userGames">0</h3><p>Games Played</p></div>
<div class="card stat-card"><i class="fas fa-percent"></i><h3 id="userWinRate">0%</h3><p>Win Rate</p></div>
</div>
<div class="card"><h2 style="margin-bottom:16px"><i class="fas fa-book" style="color:var(--primary)"></i> Available Tests</h2>
<div class="test-grid" id="testGrid"></div>
</div>
<div class="card"><h2 style="margin-bottom:16px"><i class="fas fa-medal" style="color:var(--warning)"></i> Leaderboard</h2>
<div class="leaderboard-list" id="leaderboard"></div>
</div>
<div class="card"><h2 style="margin-bottom:16px"><i class="fas fa-history" style="color:var(--secondary)"></i> Past Records</h2>
<div class="records-list" id="pastRecords"><p style="color:#64748b;text-align:center;padding:20px">No records yet</p></div>
</div>
</div>

<!-- Quiz Arena -->
<div id="quizArena" class="hidden quiz-arena container">
<div class="card quiz-header">
<div><h2 id="quizTitle">Test</h2><p style="color:#64748b">Question <span id="currentQ">1</span> of <span id="totalQ">2</span></p></div>
<div class="timer" id="timerContainer"><i class="fas fa-clock"></i> <span id="timer">60:00</span></div>
</div>
<div class="players-status">
<div class="card player-card current"><div class="status-dot"></div><div class="avatar" style="margin:0 auto 8px" id="p1Avatar">Y</div><h4 id="p1Name">You</h4><p style="color:#64748b">Question <span id="p1Q">1</span></p></div>
<div class="card player-card"><div class="status-dot"></div><div class="avatar" style="margin:0 auto 8px;background:linear-gradient(135deg,var(--accent),var(--success))" id="p2Avatar">O</div><h4 id="p2Name">Opponent</h4><p style="color:#64748b">Question <span id="p2Q">1</span></p></div>
</div>
<div class="card question-card">
<span class="question-number">Question <span id="qNum">1</span></span>
<h3 id="questionText">Loading question...</h3>
<div class="options" id="optionsContainer"></div>
<div class="question-dots" id="questionDots"></div>
</div>
<div class="quiz-nav">
<button class="btn btn-outline" id="prevBtn" onclick="prevQuestion()"><i class="fas fa-arrow-left"></i> Previous</button>
<button class="btn btn-outline" id="nextBtn" onclick="nextQuestion()">Next <i class="fas fa-arrow-right"></i></button>
<button class="btn btn-success" onclick="confirmSubmit()"><i class="fas fa-paper-plane"></i> Submit Quiz</button>
</div>
<div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
</div>

<!-- Waiting Room -->
<div id="waitingRoom" class="hidden container">
<div class="card waiting-room">
<div class="spinner"></div>
<h2>üéÆ Waiting for Opponent</h2>
<p style="color:#64748b">Looking for another player to challenge...</p>
<div class="waiting-info">
<div class="waiting-info-item"><span id="waitingTest">Test</span><small style="color:#64748b">Test Name</small></div>
<div class="waiting-info-item"><span id="waitingTime">0:00</span><small style="color:#64748b">Wait Time</small></div>
</div>
<button class="btn btn-danger" style="margin-top:32px" onclick="cancelWaiting()"><i class="fas fa-times"></i> Cancel</button>
</div>
</div>

<!-- Results Modal -->
<div id="resultsModal" class="modal hidden">
<div class="card modal-content results-card">
<div class="result-badge" id="resultEmoji">üéâ</div>
<h2 id="resultTitle">Quiz Complete!</h2>
<div class="score-display" id="finalScore">0/2</div>
<div class="results-grid">
<div class="result-item"><h4>Your Score</h4><p id="yourScore">0</p></div>
<div class="result-item"><h4>Opponent Score</h4><p id="oppScore">0</p></div>
<div class="result-item"><h4>Point Change</h4><p id="pointChange">+0</p></div>
<div class="result-item"><h4>New Total</h4><p id="newTotal">0</p></div>
</div>
<button class="btn btn-primary" style="margin-top:24px;width:100%" onclick="closeResults()"><i class="fas fa-home"></i> Back to Dashboard</button>
</div>
</div>

<!-- Test Code Modal -->
<div id="testCodeModal" class="modal hidden">
<div class="card modal-content">
<h2><i class="fas fa-key" style="color:var(--warning)"></i> Enter Test Code</h2>
<p style="color:#64748b;margin-bottom:16px">Enter the 6-character alphanumeric code to access this test</p>
<div class="form-group"><input type="text" id="testCodeInput" maxlength="6" placeholder="e.g., ABC123" style="text-transform:uppercase;text-align:center;font-size:1.5rem;letter-spacing:4px"></div>
<div style="display:flex;gap:12px">
<button class="btn btn-outline" style="flex:1" onclick="closeTestCode()">Cancel</button>
<button class="btn btn-primary" style="flex:1" onclick="verifyTestCode()"><i class="fas fa-play"></i> Start</button>
</div>
</div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal hidden">
<div class="card modal-content">
<h2><i class="fas fa-cog" style="color:var(--primary)"></i> Settings</h2>
<div class="form-group"><label>Display Name</label><input type="text" id="settingsName"></div>
<div class="form-group"><label>Access Code</label><input type="text" id="settingsCode"></div>
<div style="display:flex;gap:12px;flex-wrap:wrap">
<button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save"></i> Save</button>
<button class="btn btn-danger" onclick="deleteAccount()"><i class="fas fa-trash"></i> Delete Account</button>
<button class="btn btn-outline" onclick="closeSettings()">Cancel</button>
</div>
</div>
</div>

<!-- Confirm Submit Modal -->
<div id="confirmModal" class="modal hidden">
<div class="card modal-content" style="text-align:center">
<h2><i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> Submit Quiz?</h2>
<p style="color:#64748b;margin:16px 0">This will end the quiz for both you and your opponent. Are you sure?</p>
<p id="unansweredWarning" style="color:var(--danger);margin-bottom:16px"></p>
<div style="display:flex;gap:12px">
<button class="btn btn-outline" style="flex:1" onclick="closeConfirm()">Continue Quiz</button>
<button class="btn btn-success" style="flex:1" onclick="submitQuiz()"><i class="fas fa-check"></i> Submit</button>
</div>
</div>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="hidden container dashboard">
<div class="card header">
<div><h2 class="logo">Ofuje Admin</h2></div>
<div class="nav-btns">
<button class="btn btn-outline" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
<button class="btn btn-danger" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
</div>
</div>
<div class="admin-tabs">
<div class="admin-tab active" onclick="switchAdminTab('users')"><i class="fas fa-users"></i> Users</div>
<div class="admin-tab" onclick="switchAdminTab('tests')"><i class="fas fa-book"></i> Tests</div>
<div class="admin-tab" onclick="switchAdminTab('questions')"><i class="fas fa-question-circle"></i> Questions</div>
<div class="admin-tab" onclick="switchAdminTab('rooms')"><i class="fas fa-gamepad"></i> Active Games</div>
</div>
<div class="card" id="adminContent"></div>
</div>

<!-- Admin Login Modal -->
<div id="adminLoginModal" class="modal hidden">
<div class="card modal-content">
<h2><i class="fas fa-shield-alt" style="color:var(--danger)"></i> Admin Login</h2>
<div class="form-group"><label>Admin Password</label><input type="password" id="adminPass" placeholder="Enter admin password"></div>
<div style="display:flex;gap:12px">
<button class="btn btn-outline" style="flex:1" onclick="closeAdminLogin()">Cancel</button>
<button class="btn btn-primary" style="flex:1" onclick="adminLogin()"><i class="fas fa-sign-in-alt"></i> Login</button>
</div>
</div>
</div>

<!-- Communication Panel -->
<div class="comm-panel hidden" id="commPanel">
<div class="comm-box" id="commBox">
<div class="comm-header"><span><i class="fas fa-comments"></i> Chat with Opponent</span><button onclick="toggleComm()" style="background:none;border:none;color:#fff;cursor:pointer;font-size:1.2rem"><i class="fas fa-times"></i></button></div>
<div class="voice-controls">
<button id="micBtn" onclick="toggleMic()"><i class="fas fa-microphone"></i> Mic</button>
<button id="speakerBtn" class="active" onclick="toggleSpeaker()"><i class="fas fa-volume-up"></i> Speaker</button>
</div>
<div class="messages" id="messages"></div>
<div class="chat-input">
<input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMessage()">
<div class="emoji-picker">
<button class="btn btn-outline" style="padding:10px 12px" onclick="toggleEmoji()">üòä</button>
<div class="emoji-list" id="emojiList"></div>
</div>
<button class="btn btn-primary" style="padding:10px 14px" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
</div>
</div>
<button class="comm-toggle" onclick="toggleComm()"><i class="fas fa-comments"></i><span class="badge hidden" id="msgBadge">0</span></button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
// Firebase Configuration - Replace with your own config
const firebaseConfig={apiKey: "AIzaSyDofEQ2jiMIXji7y-fGopDQcLY8dhixGk4",
  authDomain: "danz-66ffa.firebaseapp.com",
  projectId: "danz-66ffa",
  storageBucket: "danz-66ffa.firebasestorage.app",
  messagingSenderId: "570041531960",
  appId: "1:570041531960:web:24b77baa80aba9636c30cd"};

firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// State
let currentUser=null,currentTest=null,currentRoom=null,currentTestData=null,timerInterval=null,waitingInterval=null,answers={},currentQ=0,micEnabled=false,speakerEnabled=true,unreadMsgs=0;

// Emojis
const emojis=['üòä','üòÇ','üéâ','üëç','üëé','‚ù§Ô∏è','üî•','üòé','ü§î','üòÖ','üëè','üí™','üôå','üò≠','ü•≥','‚ú®','üò±','ü§£','üòç','üôè','üíØ','üéØ','‚ö°','üåü','üò§'];

// Default Tests - Can be added manually via code
const defaultTests=[
{id:'testA',name:'Mathematics Quiz',code:'MATH01',questions:[
{q:'What is 15 + 27?',opts:['42','40','45','38'],ans:0},
{q:'What is 12 √ó 8?',opts:['86','96','106','88'],ans:1}
]},
{id:'testB',name:'Science Quiz',code:'SCI001',questions:[
{q:'What planet is known as the Red Planet?',opts:['Venus','Mars','Jupiter','Saturn'],ans:1},
{q:'What is H2O commonly known as?',opts:['Oxygen','Hydrogen','Water','Carbon Dioxide'],ans:2}
]}
];

// Toast Notification
function toast(msg,type='info'){
const t=document.createElement('div');
t.className=`toast ${type}`;
const icons={success:'check-circle',error:'exclamation-circle',info:'info-circle',warning:'exclamation-triangle'};
t.innerHTML=`<i class="fas fa-${icons[type]}"></i><span>${msg}</span>`;
document.getElementById('toastContainer').appendChild(t);
setTimeout(()=>{t.style.animation='slideIn .3s reverse';setTimeout(()=>t.remove(),300)},3000);
}

// Auth Functions
function switchTab(tab){
document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===(tab==='login'?0:1)));
document.getElementById('loginForm').classList.toggle('hidden',tab!=='login');
document.getElementById('registerForm').classList.toggle('hidden',tab==='login');
}

function initDB(){
db.ref('tests').once('value',s=>{
if(!s.exists()){
defaultTests.forEach(t=>db.ref('tests/'+t.id).set(t));
toast('Default tests initialized','info');
}
});
}

async function register(){
const name=document.getElementById('regName').value.trim();
const school=document.getElementById('regSchool').value.trim();
const code=document.getElementById('regCode').value.trim().toUpperCase();
if(!name||!school||!code)return toast('Please fill all fields','error');
if(code.length<3)return toast('Access code must be at least 3 characters','error');
const snap=await db.ref('users/'+code).once('value');
if(snap.exists())return toast('Access code already taken','error');
const user={name,school,code,points:0,wins:0,losses:0,ties:0,games:0,createdAt:Date.now()};
await db.ref('users/'+code).set(user);
toast('Registration successful! Please login.','success');
switchTab('login');
document.getElementById('loginCode').value=code;
}

async function login(){
const code=document.getElementById('loginCode').value.trim().toUpperCase();
if(!code)return toast('Please enter access code','error');
const snap=await db.ref('users/'+code).once('value');
if(!snap.exists())return toast('Invalid access code','error');
const userData=snap.val();
if(userData.restricted)return toast('Your account has been restricted','error');
currentUser={...userData,code};
localStorage.setItem('ofujeUser',code);
toast(`Welcome back, ${currentUser.name}!`,'success');
showDashboard();
}

function logout(){
currentUser=null;
localStorage.removeItem('ofujeUser');
document.getElementById('dashboard').classList.add('hidden');
document.getElementById('authSection').classList.remove('hidden');
document.getElementById('loginCode').value='';
}

// Dashboard
function showDashboard(){
document.getElementById('authSection').classList.add('hidden');
document.getElementById('dashboard').classList.remove('hidden');
updateDashboard();
loadTests();
loadLeaderboard();
loadRecords();
}

function updateDashboard(){
document.getElementById('userName').textContent=currentUser.name;
document.getElementById('userSchool').textContent=currentUser.school;
document.getElementById('userAvatar').textContent=currentUser.name.charAt(0).toUpperCase();
document.getElementById('userPoints').textContent=currentUser.points||0;
document.getElementById('userGames').textContent=currentUser.games||0;
const winRate=currentUser.games>0?Math.round((currentUser.wins/currentUser.games)*100):0;
document.getElementById('userWinRate').textContent=winRate+'%';
updateRank();
}

function updateRank(){
db.ref('users').orderByChild('points').once('value',s=>{
const users=[];
s.forEach(c=>{if(!c.val().restricted)users.unshift(c.val())});
const rank=users.findIndex(u=>u.code===currentUser.code)+1;
document.getElementById('userRank').textContent='#'+rank;
});
}

// Tests
function loadTests(){
db.ref('tests').on('value',s=>{
const tests=s.val()||{};
let html='';
Object.values(tests).forEach(t=>{
// Count active games for this test
db.ref('rooms').orderByChild('testId').equalTo(t.id).once('value',rs=>{
let activeCount=0;
rs.forEach(r=>{if(r.val().status==='playing')activeCount++});
const activeHtml=activeCount>0?`<p class="active-battles"><i class="fas fa-gamepad"></i> ${activeCount} active battle${activeCount>1?'s':''}</p>`:'';
document.getElementById('test_'+t.id)&&(document.getElementById('test_'+t.id).innerHTML=activeHtml);
});
html+=`<div class="card test-card">
<h3>${t.name}</h3>
<p><i class="fas fa-question-circle"></i> ${t.questions?.length||0} Questions</p>
<div id="test_${t.id}"></div>
<button class="btn btn-primary" onclick="selectTest('${t.id}')"><i class="fas fa-play"></i> Start Battle</button>
</div>`;
});
document.getElementById('testGrid').innerHTML=html||'<p style="color:#64748b">No tests available</p>';
});
}

// Leaderboard
function loadLeaderboard(){
db.ref('users').orderByChild('points').on('value',s=>{
const users=[];
s.forEach(c=>{if(!c.val().restricted)users.unshift(c.val())});
let html='';
users.slice(0,20).forEach((u,i)=>{
const cls=i===0?'gold':i===1?'silver':i===2?'bronze':'';
const isCurrent=currentUser&&u.code===currentUser.code;
const medals=['ü•á','ü•à','ü•â'];
html+=`<div class="leaderboard-item ${cls} ${isCurrent?'current-user':''}">
<div class="rank">${i<3?medals[i]:i+1}</div>
<div class="avatar" style="width:36px;height:36px;font-size:.9rem">${u.name.charAt(0)}</div>
<div style="flex:1">
<strong>${u.name}${isCurrent?' (You)':''}</strong>
<p style="color:#64748b;font-size:.8rem">${u.school} ‚Ä¢ ${u.wins}W/${u.losses}L</p>
</div>
<div style="font-weight:700;color:var(--primary)">${u.points||0}</div>
</div>`;
});
document.getElementById('leaderboard').innerHTML=html||'<p style="color:#64748b;text-align:center">No users yet</p>';
});
}

// Records
function loadRecords(){
db.ref('records/'+currentUser.code).orderByChild('date').limitToLast(15).on('value',s=>{
const records=[];
s.forEach(c=>records.unshift(c.val()));
let html='';
records.forEach(r=>{
const resultClass=r.result==='win'?'win':r.result==='tie'?'tie':'loss';
const resultText=r.result==='win'?'Victory':r.result==='tie'?'Tie':'Defeat';
html+=`<div class="record-item">
<div>
<strong>${r.testName}</strong>
<p style="color:#64748b;font-size:.8rem">${new Date(r.date).toLocaleDateString()} vs ${r.opponent||'Unknown'}</p>
</div>
<div style="text-align:right">
<span class="record-result ${resultClass}">${resultText}</span>
<p style="font-size:.9rem;margin-top:4px">${r.score}/${r.total} ‚Ä¢ <span style="color:${r.pointChange>=0?'var(--success)':'var(--danger)'}">${r.pointChange>=0?'+':''}${r.pointChange}</span></p>
</div>
</div>`;
});
document.getElementById('pastRecords').innerHTML=html||'<p style="color:#64748b;text-align:center;padding:20px">No records yet. Start a battle!</p>';
});
}

// Test Selection
function selectTest(id){
currentTest=id;
document.getElementById('testCodeInput').value='';
document.getElementById('testCodeModal').classList.remove('hidden');
}

function closeTestCode(){
document.getElementById('testCodeModal').classList.add('hidden');
}

async function verifyTestCode(){
const code=document.getElementById('testCodeInput').value.trim().toUpperCase();
if(!code||code.length!==6)return toast('Please enter a valid 6-character code','error');
const snap=await db.ref('tests/'+currentTest).once('value');
const test=snap.val();
if(!test)return toast('Test not found','error');
if(test.code!==code)return toast('Invalid test code','error');
if(!test.questions||test.questions.length===0)return toast('This test has no questions','error');
currentTestData=test;
closeTestCode();
joinWaitingRoom(test);
}

// Matchmaking - Supports Multiple Concurrent Battles
async function joinWaitingRoom(test){
document.getElementById('dashboard').classList.add('hidden');
document.getElementById('waitingRoom').classList.remove('hidden');
document.getElementById('waitingTest').textContent=test.name;

let waitTime=0;
waitingInterval=setInterval(()=>{
waitTime++;
const m=Math.floor(waitTime/60);
const s=waitTime%60;
document.getElementById('waitingTime').textContent=`${m}:${s.toString().padStart(2,'0')}`;
},1000);

// Try to find an available waiting room
const roomsSnap=await db.ref('rooms').orderByChild('testId').equalTo(test.id).once('value');
let foundRoom=null;

roomsSnap.forEach(r=>{
const room=r.val();
// Find a waiting room where we're not player1 and hasn't been claimed
if(room.status==='waiting'&&room.player1!==currentUser.code&&!room.player2){
foundRoom={id:r.key,...room};
}
});

if(foundRoom){
// Try to join with a transaction to prevent race conditions
const roomRef=db.ref('rooms/'+foundRoom.id);
roomRef.transaction(room=>{
if(room&&room.status==='waiting'&&!room.player2){
room.player2=currentUser.code;
room.player2Name=currentUser.name;
room.status='playing';
room.startTime=Date.now();
return room;
}
return;// Abort if already taken
},(error,committed)=>{
if(committed){
currentRoom=foundRoom.id;
clearInterval(waitingInterval);
startQuiz(test);
}else{
// Room was taken, create new one
createWaitingRoom(test);
}
});
}else{
createWaitingRoom(test);
}
}

function createWaitingRoom(test){
currentRoom=db.ref('rooms').push().key;
db.ref('rooms/'+currentRoom).set({
testId:test.id,
testName:test.name,
player1:currentUser.code,
player1Name:currentUser.name,
player1Q:1,
player2Q:1,
status:'waiting',
createdAt:Date.now()
});

// Listen for opponent joining
db.ref('rooms/'+currentRoom).on('value',s=>{
const room=s.val();
if(room&&room.status==='playing'){
clearInterval(waitingInterval);
startQuiz(test);
}
});
}

function cancelWaiting(){
clearInterval(waitingInterval);
if(currentRoom){
db.ref('rooms/'+currentRoom).remove();
db.ref('rooms/'+currentRoom).off();
}
currentRoom=null;
document.getElementById('waitingRoom').classList.add('hidden');
document.getElementById('dashboard').classList.remove('hidden');
toast('Matchmaking cancelled','info');
}

// Quiz
function startQuiz(test){
document.getElementById('waitingRoom').classList.add('hidden');
document.getElementById('quizArena').classList.remove('hidden');
document.getElementById('commPanel').classList.remove('hidden');
document.getElementById('quizTitle').textContent=test.name;
document.getElementById('totalQ').textContent=test.questions.length;

answers={};
currentQ=0;
unreadMsgs=0;

// Generate question dots
let dotsHtml='';
test.questions.forEach((_,i)=>{
dotsHtml+=`<div class="question-dot ${i===0?'current':''}" onclick="goToQuestion(${i})">${i+1}</div>`;
});
document.getElementById('questionDots').innerHTML=dotsHtml;

displayQuestion(test.questions);
startTimer(3600);// 1 hour
listenRoom(test);
listenMessages();
}

function displayQuestion(questions){
const q=questions[currentQ];
document.getElementById('currentQ').textContent=currentQ+1;
document.getElementById('qNum').textContent=currentQ+1;
document.getElementById('questionText').textContent=q.q;

let html='';
const letters=['A','B','C','D'];
q.opts.forEach((o,i)=>{
html+=`<div class="option ${answers[currentQ]===i?'selected':''}" onclick="selectOption(${i})">
<div class="option-letter">${letters[i]}</div>
<span>${o}</span>
</div>`;
});
document.getElementById('optionsContainer').innerHTML=html;

// Update navigation
document.getElementById('prevBtn').disabled=currentQ===0;
document.getElementById('nextBtn').disabled=currentQ===questions.length-1;

// Update progress
document.getElementById('progressFill').style.width=((currentQ+1)/questions.length*100)+'%';

// Update question dots
document.querySelectorAll('.question-dot').forEach((dot,i)=>{
dot.classList.toggle('current',i===currentQ);
dot.classList.toggle('answered',answers[i]!==undefined);
});

// Update position in room
updateMyPosition();
}

function selectOption(i){
answers[currentQ]=i;
document.querySelectorAll('.option').forEach((o,idx)=>{
o.classList.toggle('selected',idx===i);
});
document.querySelectorAll('.question-dot')[currentQ].classList.add('answered');
}

function nextQuestion(){
if(currentQ<currentTestData.questions.length-1){
currentQ++;
displayQuestion(currentTestData.questions);
}
}

function prevQuestion(){
if(currentQ>0){
currentQ--;
displayQuestion(currentTestData.questions);
}
}

function goToQuestion(idx){
currentQ=idx;
displayQuestion(currentTestData.questions);
}

function updateMyPosition(){
if(!currentRoom)return;
db.ref('rooms/'+currentRoom).once('value',s=>{
const room=s.val();
if(!room)return;
const isP1=room.player1===currentUser.code;
db.ref('rooms/'+currentRoom+'/'+(isP1?'player1Q':'player2Q')).set(currentQ+1);
});
}

function listenRoom(test){
db.ref('rooms/'+currentRoom).on('value',s=>{
const room=s.val();
if(!room)return;

const isP1=room.player1===currentUser.code;
document.getElementById('p1Name').textContent=isP1?'You':room.player1Name;
document.getElementById('p2Name').textContent=isP1?(room.player2Name||'Waiting...'):'You';
document.getElementById('p1Avatar').textContent=(isP1?currentUser.name:room.player1Name||'?').charAt(0).toUpperCase();
document.getElementById('p2Avatar').textContent=(isP1?(room.player2Name||'?'):currentUser.name).charAt(0).toUpperCase();
document.getElementById('p1Q').textContent=room.player1Q||1;
document.getElementById('p2Q').textContent=room.player2Q||1;

// Check if quiz ended
if(room.status==='finished'){
const myViewed=isP1?room.p1Viewed:room.p2Viewed;
if(!myViewed){
showResults(room,test,isP1);
}
}
});
}

function startTimer(secs){
let rem=secs;
const timerEl=document.getElementById('timer');
const timerContainer=document.getElementById('timerContainer');

timerInterval=setInterval(()=>{
rem--;
const m=Math.floor(rem/60);
const s=rem%60;
timerEl.textContent=`${m}:${s.toString().padStart(2,'0')}`;

if(rem<=300)timerContainer.classList.add('warning');
if(rem<=0){
clearInterval(timerInterval);
submitQuiz();
}
},1000);
}

function confirmSubmit(){
const total=currentTestData.questions.length;
const answered=Object.keys(answers).length;
const unanswered=total-answered;

document.getElementById('unansweredWarning').textContent=unanswered>0?
`‚ö†Ô∏è You have ${unanswered} unanswered question${unanswered>1?'s':''}!`:'';
document.getElementById('confirmModal').classList.remove('hidden');
}

function closeConfirm(){
document.getElementById('confirmModal').classList.add('hidden');
}

async function submitQuiz(){
closeConfirm();
clearInterval(timerInterval);

const test=currentTestData;
let score=0;
test.questions.forEach((q,i)=>{
if(answers[i]===q.ans)score++;
});

const roomSnap=await db.ref('rooms/'+currentRoom).once('value');
const room=roomSnap.val();
const isP1=room.player1===currentUser.code;

await db.ref('rooms/'+currentRoom).update({
[isP1?'p1Score':'p2Score']:score,
[isP1?'p1Answers':'p2Answers']:answers,
status:'finished'
});

toast('Quiz submitted! Waiting for results...','info');
}

async function showResults(room,test,isP1){
clearInterval(timerInterval);

const myScore=isP1?room.p1Score:room.p2Score;
const oppScore=isP1?room.p2Score:room.p1Score;
const oppName=isP1?room.player2Name:room.player1Name;

if(myScore===undefined||oppScore===undefined)return;

const won=myScore>oppScore;
const tied=myScore===oppScore;
let pointChange=won?10:tied?0:(currentUser.points>=5?-5:currentUser.points>0?-currentUser.points:0);
const newPoints=Math.max(0,(currentUser.points||0)+pointChange);

// Update user stats
const updates={
points:newPoints,
games:(currentUser.games||0)+1
};
if(won)updates.wins=(currentUser.wins||0)+1;
else if(tied)updates.ties=(currentUser.ties||0)+1;
else updates.losses=(currentUser.losses||0)+1;

await db.ref('users/'+currentUser.code).update(updates);

// Save record
await db.ref('records/'+currentUser.code).push({
testName:test.name,
score:myScore,
total:test.questions.length,
result:won?'win':tied?'tie':'loss',
opponent:oppName,
oppScore:oppScore,
pointChange:pointChange,
date:Date.now()
});

// Mark as viewed
await db.ref('rooms/'+currentRoom+'/'+(isP1?'p1Viewed':'p2Viewed')).set(true);

// Update local state
currentUser.points=newPoints;
currentUser.games=updates.games;
if(won)currentUser.wins=updates.wins;
else if(tied)currentUser.ties=updates.ties;
else currentUser.losses=updates.losses;

// Show results
document.getElementById('resultEmoji').textContent=won?'üèÜ':tied?'ü§ù':'üò¢';
document.getElementById('resultTitle').textContent=won?'Victory!':tied?'It\'s a Tie!':'Defeat';
document.getElementById('finalScore').textContent=`${myScore}/${test.questions.length}`;
document.getElementById('yourScore').textContent=myScore;
document.getElementById('oppScore').textContent=oppScore;
document.getElementById('pointChange').textContent=(pointChange>=0?'+':'')+pointChange;
document.getElementById('pointChange').style.color=pointChange>=0?'var(--success)':'var(--danger)';
document.getElementById('newTotal').textContent=newPoints;
document.getElementById('resultsModal').classList.remove('hidden');
}

function closeResults(){
document.getElementById('resultsModal').classList.add('hidden');
document.getElementById('quizArena').classList.add('hidden');
document.getElementById('commPanel').classList.add('hidden');
db.ref('rooms/'+currentRoom).off();
db.ref('rooms/'+currentRoom+'/messages').off();
currentRoom=null;
currentTestData=null;
showDashboard();
}

// Theme
function toggleTheme(){
const isDark=document.body.getAttribute('data-theme')==='dark';
document.body.setAttribute('data-theme',isDark?'light':'dark');
document.getElementById('themeIcon').className=isDark?'fas fa-moon':'fas fa-sun';
localStorage.setItem('theme',isDark?'light':'dark');
}

// Settings
function showSettings(){
document.getElementById('settingsName').value=currentUser.name;
document.getElementById('settingsCode').value=currentUser.code;
document.getElementById('settingsModal').classList.remove('hidden');
}

function closeSettings(){
document.getElementById('settingsModal').classList.add('hidden');
}

async function saveSettings(){
const newName=document.getElementById('settingsName').value.trim();
const newCode=document.getElementById('settingsCode').value.trim().toUpperCase();
if(!newName||!newCode)return toast('Please fill all fields','error');

if(newCode!==currentUser.code){
const snap=await db.ref('users/'+newCode).once('value');
if(snap.exists())return toast('Access code already taken','error');

// Migrate user data
const userData={...currentUser,name:newName,code:newCode};
delete userData.code;
await db.ref('users/'+newCode).set({...userData,code:newCode});
await db.ref('users/'+currentUser.code).remove();

// Migrate records
const recordsSnap=await db.ref('records/'+currentUser.code).once('value');
if(recordsSnap.exists()){
await db.ref('records/'+newCode).set(recordsSnap.val());
await db.ref('records/'+currentUser.code).remove();
}

currentUser.code=newCode;
localStorage.setItem('ofujeUser',newCode);
}else{
await db.ref('users/'+currentUser.code+'/name').set(newName);
}

currentUser.name=newName;
toast('Settings saved successfully!','success');
closeSettings();
updateDashboard();
}

async function deleteAccount(){
if(!confirm('Are you sure you want to delete your account? This cannot be undone!'))return;
await db.ref('users/'+currentUser.code).remove();
await db.ref('records/'+currentUser.code).remove();
toast('Account deleted','success');
logout();
}

// Communication
function toggleComm(){
const box=document.getElementById('commBox');
box.classList.toggle('active');
if(box.classList.contains('active')){
unreadMsgs=0;
updateMsgBadge();
}
}

function toggleMic(){
micEnabled=!micEnabled;
const btn=document.getElementById('micBtn');
btn.classList.toggle('active',micEnabled);
btn.classList.toggle('muted',!micEnabled);
toast(micEnabled?'Microphone enabled':'Microphone disabled','info');
}

function toggleSpeaker(){
speakerEnabled=!speakerEnabled;
const btn=document.getElementById('speakerBtn');
btn.classList.toggle('active',speakerEnabled);
btn.classList.toggle('muted',!speakerEnabled);
toast(speakerEnabled?'Speaker enabled':'Speaker muted','info');
}

function sendMessage(){
const input=document.getElementById('chatInput');
const msg=input.value.trim();
if(!msg||!currentRoom)return;
db.ref('rooms/'+currentRoom+'/messages').push({
from:currentUser.code,
name:currentUser.name,
text:msg,
time:Date.now()
});
input.value='';
}

function listenMessages(){
if(!currentRoom)return;
document.getElementById('messages').innerHTML='';
db.ref('rooms/'+currentRoom+'/messages').on('child_added',s=>{
const m=s.val();
const isMine=m.from===currentUser.code;
const div=document.createElement('div');
div.className=`message ${isMine?'sent':'received'}`;
const time=new Date(m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
div.innerHTML=`${m.text}<div class="time">${time}</div>`;
document.getElementById('messages').appendChild(div);
document.getElementById('messages').scrollTop=999999;

if(!isMine&&!document.getElementById('commBox').classList.contains('active')){
unreadMsgs++;
updateMsgBadge();
}
});
}

function updateMsgBadge(){
const badge=document.getElementById('msgBadge');
badge.textContent=unreadMsgs;
badge.classList.toggle('hidden',unreadMsgs===0);
}

function toggleEmoji(){
document.getElementById('emojiList').classList.toggle('active');
}

function initEmojis(){
const list=document.getElementById('emojiList');
emojis.forEach(e=>{
const span=document.createElement('span');
span.textContent=e;
span.onclick=()=>{
document.getElementById('chatInput').value+=e;
document.getElementById('chatInput').focus();
toggleEmoji();
};
list.appendChild(span);
});
}

// Admin
function showAdminLogin(){
document.getElementById('adminLoginModal').classList.remove('hidden');
}

function closeAdminLogin(){
document.getElementById('adminLoginModal').classList.add('hidden');
document.getElementById('adminPass').value='';
}

function adminLogin(){
const pass=document.getElementById('adminPass').value;
if(pass!=='admin123')return toast('Invalid admin password','error');
closeAdminLogin();
document.getElementById('authSection').classList.add('hidden');
document.getElementById('adminPanel').classList.remove('hidden');
loadAdminUsers();
toast('Welcome, Admin!','success');
}

function adminLogout(){
document.getElementById('adminPanel').classList.add('hidden');
document.getElementById('authSection').classList.remove('hidden');
}

function switchAdminTab(tab){
document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
event.target.classList.add('active');
if(tab==='users')loadAdminUsers();
else if(tab==='tests')loadAdminTests();
else if(tab==='questions')loadAdminQuestions();
else loadAdminRooms();
}

function loadAdminUsers(){
db.ref('users').on('value',s=>{
const users=s.val()||{};
let html=`<div class="admin-table-wrapper"><table class="admin-table">
<tr><th>Name</th><th>School</th><th>Code</th><th>Points</th><th>Status</th><th>Actions</th></tr>`;
Object.entries(users).forEach(([k,u])=>{
html+=`<tr>
<td>${u.name}</td>
<td>${u.school}</td>
<td><code>${u.code}</code></td>
<td><input type="number" value="${u.points||0}" style="width:70px;padding:6px" onchange="updatePoints('${k}',this.value)"></td>
<td><span style="color:${u.restricted?'var(--danger)':'var(--success)'}">${u.restricted?'Restricted':'Active'}</span></td>
<td>
<button class="btn btn-${u.restricted?'success':'warning'}" style="padding:6px 10px;font-size:.8rem" onclick="toggleRestrict('${k}',${!u.restricted})">${u.restricted?'Activate':'Restrict'}</button>
<button class="btn btn-danger" style="padding:6px 10px;font-size:.8rem;margin-left:4px" onclick="adminDeleteUser('${k}')"><i class="fas fa-trash"></i></button>
</td>
</tr>`;
});
html+='</table></div>';
document.getElementById('adminContent').innerHTML=html;
});
}

function updatePoints(code,pts){
db.ref('users/'+code+'/points').set(parseInt(pts)||0);
toast('Points updated','success');
}

function adminDeleteUser(code){
if(!confirm('Delete this user permanently?'))return;
db.ref('users/'+code).remove();
db.ref('records/'+code).remove();
toast('User deleted','success');
}

function toggleRestrict(code,val){
db.ref('users/'+code+'/restricted').set(val);
toast(val?'User restricted':'User activated','success');
}

function loadAdminTests(){
db.ref('tests').on('value',s=>{
const tests=s.val()||{};
let html=`<button class="btn btn-primary" style="margin-bottom:16px" onclick="showAddTest()"><i class="fas fa-plus"></i> Add New Test</button>
<div class="admin-table-wrapper"><table class="admin-table">
<tr><th>Name</th><th>Code</th><th>Questions</th><th>Actions</th></tr>`;
Object.entries(tests).forEach(([k,t])=>{
html+=`<tr>
<td>${t.name}</td>
<td><code>${t.code}</code></td>
<td>${t.questions?.length||0}</td>
<td>
<button class="btn btn-danger" style="padding:6px 10px;font-size:.8rem" onclick="deleteTest('${k}')"><i class="fas fa-trash"></i> Delete</button>
</td>
</tr>`;
});
html+='</table></div>';
document.getElementById('adminContent').innerHTML=html;
});
}

function showAddTest(){
const name=prompt('Enter test name:');
if(!name)return;
const code=prompt('Enter 6-character test code:');
if(!code||code.length!==6)return toast('Code must be 6 characters','error');
const id='test_'+Date.now();
db.ref('tests/'+id).set({id,name,code:code.toUpperCase(),questions:[]});
toast('Test created! Add questions from Questions tab.','success');
}

function deleteTest(id){
if(!confirm('Delete this test and all its questions?'))return;
db.ref('tests/'+id).remove();
toast('Test deleted','success');
}

function loadAdminQuestions(){
db.ref('tests').once('value',s=>{
const tests=s.val()||{};
const testIds=Object.keys(tests);
if(testIds.length===0){
document.getElementById('adminContent').innerHTML='<p>No tests available. Create a test first.</p>';
return;
}
let selectHtml='<select id="adminTestSelect" onchange="loadTestQuestions(this.value)" style="margin-bottom:16px">';
testIds.forEach(k=>selectHtml+=`<option value="${k}">${tests[k].name}</option>`);
selectHtml+='</select><div id="questionsContent"></div>';
document.getElementById('adminContent').innerHTML=selectHtml;
loadTestQuestions(testIds[0]);
});
}

function loadTestQuestions(testId){
db.ref('tests/'+testId+'/questions').on('value',s=>{
const qs=s.val()||[];
let html=`<button class="btn btn-primary" style="margin-bottom:16px" onclick="addQuestion('${testId}')"><i class="fas fa-plus"></i> Add Question</button>`;
if(qs.length===0){
html+='<p style="color:#64748b">No questions in this test</p>';
}else{
qs.forEach((q,i)=>{
html+=`<div class="card" style="margin-bottom:12px;padding:16px">
<div style="display:flex;justify-content:space-between;align-items:start;gap:12px">
<div style="flex:1">
<strong>Q${i+1}:</strong> ${q.q}
<div style="margin-top:8px;color:#64748b;font-size:.9rem">
Options: ${q.opts.map((o,idx)=>`<span style="color:${idx===q.ans?'var(--success)':''}">${String.fromCharCode(65+idx)}) ${o}</span>`).join(' | ')}
</div>
</div>
<div>
<button class="btn btn-outline" style="padding:6px 10px" onclick="editQuestion('${testId}',${i})"><i class="fas fa-edit"></i></button>
<button class="btn btn-danger" style="padding:6px 10px" onclick="deleteQuestion('${testId}',${i})"><i class="fas fa-trash"></i></button>
</div>
</div>
</div>`;
});
}
document.getElementById('questionsContent').innerHTML=html;
});
}

function addQuestion(testId){
const q=prompt('Enter question:');
if(!q)return;
const opts=prompt('Enter 4 options separated by comma:');
if(!opts)return;
const optsArr=opts.split(',').map(o=>o.trim());
if(optsArr.length!==4)return toast('Please provide exactly 4 options','error');
const ans=parseInt(prompt('Enter correct answer index (0-3):'));
if(isNaN(ans)||ans<0||ans>3)return toast('Invalid answer index','error');

db.ref('tests/'+testId+'/questions').once('value',s=>{
const qs=s.val()||[];
qs.push({q,opts:optsArr,ans});
db.ref('tests/'+testId+'/questions').set(qs);
toast('Question added!','success');
});
}

function editQuestion(testId,idx){
db.ref('tests/'+testId+'/questions/'+idx).once('value',s=>{
const q=s.val();
const newQ=prompt('Edit question:',q.q);
if(!newQ)return;
const newOpts=prompt('Edit options (comma separated):',q.opts.join(', '));
if(!newOpts)return;
const optsArr=newOpts.split(',').map(o=>o.trim());
const newAns=parseInt(prompt('Correct answer index (0-3):',q.ans));
if(isNaN(newAns))return;

db.ref('tests/'+testId+'/questions/'+idx).set({q:newQ,opts:optsArr,ans:newAns});
toast('Question updated!','success');
});
}

function deleteQuestion(testId,idx){
if(!confirm('Delete this question?'))return;
db.ref('tests/'+testId+'/questions').once('value',s=>{
const qs=s.val()||[];
qs.splice(idx,1);
db.ref('tests/'+testId+'/questions').set(qs);
toast('Question deleted','success');
});
}

function loadAdminRooms(){
db.ref('rooms').on('value',s=>{
const rooms=s.val()||{};
let html=`<div class="admin-table-wrapper"><table class="admin-table">
<tr><th>Test</th><th>Player 1</th><th>Player 2</th><th>Status</th><th>Actions</th></tr>`;
Object.entries(rooms).forEach(([k,r])=>{
html+=`<tr>
<td>${r.testName}</td>
<td>${r.player1Name||'-'}</td>
<td>${r.player2Name||'Waiting...'}</td>
<td><span style="color:${r.status==='playing'?'var(--success)':r.status==='waiting'?'var(--warning)':'var(--text)'}">${r.status}</span></td>
<td><button class="btn btn-danger" style="padding:6px 10px" onclick="deleteRoom('${k}')"><i class="fas fa-trash"></i></button></td>
</tr>`;
});
html+='</table></div>';
if(Object.keys(rooms).length===0)html='<p style="color:#64748b">No active games</p>';
document.getElementById('adminContent').innerHTML=html;
});
}

function deleteRoom(id){
if(!confirm('Force end this game?'))return;
db.ref('rooms/'+id).remove();
toast('Game ended','success');
}

// Init
document.addEventListener('DOMContentLoaded',()=>{
initDB();
initEmojis();

// Load theme
const theme=localStorage.getItem('theme');
if(theme){
document.body.setAttribute('data-theme',theme);
document.getElementById('themeIcon').className=theme==='dark'?'fas fa-sun':'fas fa-moon';
}

// Auto login
const savedUser=localStorage.getItem('ofujeUser');
if(savedUser){
db.ref('users/'+savedUser).once('value',s=>{
if(s.exists()&&!s.val().restricted){
currentUser={...s.val(),code:savedUser};
showDashboard();
}else{
localStorage.removeItem('ofujeUser');
}
});
}

// Close emoji on outside click
document.addEventListener('click',e=>{
if(!e.target.closest('.emoji-picker')){
document.getElementById('emojiList').classList.remove('active');
}
});
});

// Add question programmatically (for manual code addition)
function addQuestionToTest(testId,question,options,correctIndex){
db.ref('tests/'+testId+'/questions').once('value',s=>{
const qs=s.val()||[];
qs.push({q:question,opts:options,ans:correctIndex});
db.ref('tests/'+testId+'/questions').set(qs);
console.log('Question added to',testId);
});
}
// Example: addQuestionToTest('testA','What is 2+2?',['3','4','5','6'],1);
</script>
</body>
</html>