<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofuje - Multiplayer CBT</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #f8fafc;
            --bg2: #ffffff;
            --bg3: #f1f5f9;
            --text: #1e293b;
            --text2: #64748b;
            --primary: #6366f1;
            --primary2: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow2: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }
        .dark {
            --bg: #0f172a;
            --bg2: #1e293b;
            --bg3: #334155;
            --text: #f8fafc;
            --text2: #94a3b8;
            --border: #475569;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: all 0.3s;
        }
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-fade { animation: fadeIn 0.5s ease; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-bounce { animation: bounce 1s infinite; }
        
        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            padding: 15px 25px;
            border-radius: 12px;
            background: var(--bg2);
            box-shadow: var(--shadow2);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        .toast i { font-size: 20px; }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary2); transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn-secondary { background: var(--bg3); color: var(--text); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Inputs */
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text2); font-size: 14px; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            background: var(--bg2);
            color: var(--text);
            transition: all 0.3s;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }
        
        /* Cards */
        .card {
            background: var(--bg2);
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        .card:hover { box-shadow: var(--shadow2); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 600; }
        
        /* Auth Page */
        .auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
        }
        .auth-box {
            background: var(--bg2);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow2);
            animation: fadeIn 0.5s ease;
        }
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .auth-logo h1 {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .auth-logo p { color: var(--text2); margin-top: 5px; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 30px; }
        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            background: var(--bg3);
            color: var(--text2);
        }
        .auth-tab.active { background: var(--primary); color: white; }
        .auth-footer { text-align: center; margin-top: 20px; color: var(--text2); font-size: 14px; }
        .auth-footer a { color: var(--primary); text-decoration: none; font-weight: 600; }
        
        /* Dashboard */
        .dashboard { min-height: 100vh; }
        .topbar {
            background: var(--bg2);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .topbar-left { display: flex; align-items: center; gap: 20px; }
        .topbar-logo { font-size: 24px; font-weight: 700; color: var(--primary); }
        .topbar-right { display: flex; align-items: center; gap: 20px; }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 50px;
            transition: all 0.3s;
        }
        .user-profile:hover { background: var(--bg3); }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        .user-info h4 { font-size: 14px; font-weight: 600; }
        .user-info p { font-size: 12px; color: var(--text2); }
        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg3);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text);
            transition: all 0.3s;
        }
        .theme-toggle:hover { background: var(--primary); color: white; }
        
        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            background: var(--bg2);
            color: var(--text2);
            border: 2px solid transparent;
        }
        .nav-tab:hover { border-color: var(--primary); }
        .nav-tab.active { background: var(--primary); color: white; }
        .nav-tab i { margin-right: 8px; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg2);
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
        }
        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        .stat-card .icon.blue { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .stat-card .icon.green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .stat-card .icon.orange { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-card .icon.red { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .stat-card h3 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .stat-card p { color: var(--text2); font-size: 14px; }
        
        /* Test Cards */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .test-card {
            background: var(--bg2);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        .test-card:hover { transform: translateY(-5px); box-shadow: var(--shadow2); }
        .test-card-header {
            padding: 25px;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            color: white;
        }
        .test-card-header h3 { font-size: 20px; margin-bottom: 5px; }
        .test-card-header p { opacity: 0.9; font-size: 14px; }
        .test-card-body { padding: 25px; }
        .test-card-body .info { display: flex; gap: 20px; margin-bottom: 20px; }
        .test-card-body .info span { display: flex; align-items: center; gap: 5px; color: var(--text2); font-size: 14px; }
        
        /* Leaderboard */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .leaderboard-table th { color: var(--text2); font-weight: 600; font-size: 14px; }
        .leaderboard-table tr:hover { background: var(--bg3); }
        .rank-badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffb800); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a86828); color: #fff; }
        .rank-default { background: var(--bg3); color: var(--text2); }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        .modal {
            background: var(--bg2);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .modal-header h2 { font-size: 20px; }
        .modal-close {
            width: 35px;
            height: 35px;
            border-radius: 10px;
            border: none;
            background: var(--bg3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text);
        }
        
        /* Waiting Room */
        .waiting-room {
            text-align: center;
            padding: 60px 20px;
        }
        .waiting-room .loader {
            width: 80px;
            height: 80px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .waiting-room h2 { font-size: 24px; margin-bottom: 10px; }
        .waiting-room p { color: var(--text2); margin-bottom: 30px; }
        
        /* Quiz Arena */
        .quiz-arena { min-height: 100vh; background: var(--bg); }
        .quiz-header {
            background: var(--bg2);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }
        .quiz-timer {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        .quiz-timer.warning { color: var(--danger); animation: pulse 1s infinite; }
        .quiz-content { display: flex; gap: 20px; padding: 30px; }
        .quiz-main { flex: 1; }
        .quiz-sidebar { width: 300px; }
        .question-card {
            background: var(--bg2);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .question-number {
            display: inline-block;
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .question-text { font-size: 18px; line-height: 1.6; margin-bottom: 25px; }
        .options-list { display: flex; flex-direction: column; gap: 12px; }
        .option-item {
            padding: 18px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .option-item:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
        .option-item.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .option-item .marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        .option-item.selected .marker { background: var(--primary); color: white; border-color: var(--primary); }
        .question-nav { display: flex; justify-content: space-between; gap: 15px; }
        
        /* Opponent Panel */
        .opponent-panel {
            background: var(--bg2);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .opponent-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .opponent-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--bg3);
            border-radius: 10px;
        }
        .opponent-status .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        /* Communication Panel */
        .comm-panel {
            background: var(--bg2);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        .comm-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .comm-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: var(--bg3);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .comm-btn.active { background: var(--primary); color: white; }
        .comm-btn.muted { background: var(--danger); color: white; }
        .chat-box {
            height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--bg);
        }
        .chat-message { margin-bottom: 10px; }
        .chat-message.mine { text-align: right; }
        .chat-message .bubble {
            display: inline-block;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            font-size: 14px;
        }
        .chat-message.mine .bubble { background: var(--primary); color: white; border-bottom-right-radius: 5px; }
        .chat-message.other .bubble { background: var(--bg3); border-bottom-left-radius: 5px; }
        .chat-input { display: flex; gap: 10px; }
        .chat-input input { flex: 1; }
        .emoji-picker {
            position: relative;
        }
        .emoji-list {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: var(--bg2);
            border-radius: 10px;
            padding: 10px;
            box-shadow: var(--shadow2);
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            width: 240px;
        }
        .emoji-list span {
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            text-align: center;
        }
        .emoji-list span:hover { background: var(--bg3); }
        
        /* Results */
        .results-modal {
            text-align: center;
        }
        .results-score {
            font-size: 72px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }
        .results-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin: 30px 0;
            align-items: center;
        }
        .result-player {
            padding: 20px;
            background: var(--bg3);
            border-radius: 12px;
        }
        .result-player.winner { background: rgba(16, 185, 129, 0.1); border: 2px solid var(--success); }
        .result-player.loser { background: rgba(239, 68, 68, 0.1); border: 2px solid var(--danger); }
        .vs-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .point-change {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        .point-change.positive { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .point-change.negative { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        
        /* Question Navigator */
        .question-navigator {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 20px;
        }
        .q-nav-item {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }
        .q-nav-item.answered { background: var(--primary); color: white; border-color: var(--primary); }
        .q-nav-item.current { border-color: var(--warning); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3); }
        
        /* Settings */
        .settings-section { margin-bottom: 30px; }
        .settings-section h3 { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        
        /* Admin Panel */
        .admin-sidebar {
            width: 250px;
            background: var(--bg2);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        .admin-main { margin-left: 250px; padding: 30px; }
        .admin-nav { margin-top: 30px; }
        .admin-nav-item {
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 5px;
            color: var(--text2);
        }
        .admin-nav-item:hover, .admin-nav-item.active { background: var(--primary); color: white; }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg2);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .data-table th, .data-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .data-table th { background: var(--bg3); font-weight: 600; color: var(--text2); }
        .data-table tr:hover { background: var(--bg3); }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-badge.active { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .status-badge.restricted { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .quiz-content { flex-direction: column; }
            .quiz-sidebar { width: 100%; }
            .topbar { padding: 15px; }
            .user-info { display: none; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .nav-tabs { overflow-x: auto; flex-wrap: nowrap; }
            .nav-tab { white-space: nowrap; }
            .admin-sidebar { width: 60px; padding: 10px; }
            .admin-sidebar .logo-text, .admin-nav-item span { display: none; }
            .admin-main { margin-left: 60px; }
            .results-comparison { grid-template-columns: 1fr; }
            .vs-badge { margin: 0 auto; }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Auth Page -->
    <div id="authPage" class="auth-page">
        <div class="auth-box animate-fade">
            <div class="auth-logo">
                <h1>Ofuje</h1>
                <p>Multiplayer CBT Platform</p>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
                <div class="auth-tab" onclick="switchAuthTab('admin')">Admin</div>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="input-group">
                    <label>Access Code</label>
                    <input type="text" id="loginCode" placeholder="Enter your access code" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%">
                    <i class="ri-login-box-line"></i> Login
                </button>
            </form>
            
            <!-- Register Form -->
            <form id="registerForm" class="hidden" onsubmit="handleRegister(event)">
                <div class="input-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your full name" required>
                </div>
                <div class="input-group">
                    <label>School</label>
                    <input type="text" id="regSchool" placeholder="Enter your school" required>
                </div>
                <div class="input-group">
                    <label>Preferred Access Code</label>
                    <input type="text" id="regCode" placeholder="Create your unique access code" required minlength="4">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%">
                    <i class="ri-user-add-line"></i> Register
                </button>
            </form>
            
            <!-- Admin Login Form -->
            <form id="adminForm" class="hidden" onsubmit="handleAdminLogin(event)">
                <div class="input-group">
                    <label>Admin Password</label>
                    <input type="password" id="adminPass" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%">
                    <i class="ri-admin-line"></i> Admin Login
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard hidden">
        <div class="topbar">
            <div class="topbar-left">
                <span class="topbar-logo">Ofuje</span>
            </div>
            <div class="topbar-right">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="ri-moon-line" id="themeIcon"></i>
                </button>
                <div class="user-profile" onclick="showSettings()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <h4 id="userName">User Name</h4>
                        <p id="userPoints">0 points</p>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="ri-logout-box-line"></i> Logout
                </button>
            </div>
        </div>
        
        <div class="container" style="padding-top: 30px">
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('tests')">
                    <i class="ri-file-list-3-line"></i> Tests
                </div>
                <div class="nav-tab" onclick="switchTab('records')">
                    <i class="ri-history-line"></i> My Records
                </div>
                <div class="nav-tab" onclick="switchTab('leaderboard')">
                    <i class="ri-trophy-line"></i> Leaderboard
                </div>
                <div class="nav-tab" onclick="switchTab('users')">
                    <i class="ri-team-line"></i> Users
                </div>
                <div class="nav-tab" onclick="switchTab('settings')">
                    <i class="ri-settings-3-line"></i> Settings
                </div>
            </div>
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card animate-fade">
                    <div class="icon blue"><i class="ri-trophy-line"></i></div>
                    <h3 id="statPoints">0</h3>
                    <p>Total Points</p>
                </div>
                <div class="stat-card animate-fade">
                    <div class="icon green"><i class="ri-check-double-line"></i></div>
                    <h3 id="statWins">0</h3>
                    <p>Wins</p>
                </div>
                <div class="stat-card animate-fade">
                    <div class="icon red"><i class="ri-close-line"></i></div>
                    <h3 id="statLosses">0</h3>
                    <p>Losses</p>
                </div>
                <div class="stat-card animate-fade">
                    <div class="icon orange"><i class="ri-medal-line"></i></div>
                    <h3 id="statRank">#-</h3>
                    <p>Current Rank</p>
                </div>
            </div>
            
            <!-- Tests Tab -->
            <div id="testsTab" class="tab-content">
                <h2 style="margin-bottom: 20px">Available Tests</h2>
                <div class="test-grid" id="testGrid"></div>
            </div>
            
            <!-- Records Tab -->
            <div id="recordsTab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Test Records</h3>
                    </div>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Test</th>
                                <th>Score</th>
                                <th>Opponent</th>
                                <th>Result</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Leaderboard Tab -->
            <div id="leaderboardTab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Global Leaderboard</h3>
                    </div>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>School</th>
                                <th>Points</th>
                                <th>Wins</th>
                                <th>Losses</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Users Tab -->
            <div id="usersTab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Users</h3>
                    </div>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>School</th>
                                <th>Points</th>
                                <th>Tests Taken</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content hidden">
                <div class="card">
                    <h2 style="margin-bottom: 30px">Account Settings</h2>
                    <div class="settings-section">
                        <h3>Update Profile</h3>
                        <div class="input-group">
                            <label>Name</label>
                            <input type="text" id="settingsName" placeholder="Your name">
                        </div>
                        <div class="input-group">
                            <label>New Access Code</label>
                            <input type="text" id="settingsCode" placeholder="New access code">
                        </div>
                        <button class="btn btn-primary" onclick="updateProfile()">
                            <i class="ri-save-line"></i> Save Changes
                        </button>
                    </div>
                    <div class="settings-section">
                        <h3>Danger Zone</h3>
                        <button class="btn btn-danger" onclick="deleteAccount()">
                            <i class="ri-delete-bin-line"></i> Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Code Modal -->
    <div id="testCodeModal" class="modal-overlay hidden">
        <div class="modal animate-fade">
            <div class="modal-header">
                <h2>Enter Test Code</h2>
                <button class="modal-close" onclick="closeModal('testCodeModal')">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <p style="color: var(--text2); margin-bottom: 20px">Enter the 6-digit alphanumeric code to access this test.</p>
            <form onsubmit="verifyTestCode(event)">
                <div class="input-group">
                    <label>Test Code</label>
                    <input type="text" id="testCodeInput" placeholder="Enter 6-digit code" maxlength="6" required style="text-transform: uppercase; letter-spacing: 5px; text-align: center; font-size: 20px">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%">
                    <i class="ri-lock-unlock-line"></i> Verify & Enter
                </button>
            </form>
        </div>
    </div>

    <!-- Waiting Room -->
    <div id="waitingRoom" class="hidden">
        <div class="topbar">
            <span class="topbar-logo">Ofuje</span>
            <button class="btn btn-secondary" onclick="leaveWaitingRoom()">
                <i class="ri-arrow-left-line"></i> Leave
            </button>
        </div>
        <div class="waiting-room animate-fade">
            <div class="loader"></div>
            <h2>Waiting for Opponent...</h2>
            <p>The test will begin when another player joins.</p>
            <p style="margin-top: 20px; font-size: 14px; color: var(--text2)">Test: <strong id="waitingTestName">-</strong></p>
            <p style="font-size: 14px; color: var(--text2)">Players waiting: <strong id="waitingCount">1</strong></p>
        </div>
    </div>

    <!-- Quiz Arena -->
    <div id="quizArena" class="quiz-arena hidden">
        <div class="quiz-header">
            <div class="topbar-logo">Ofuje</div>
            <div class="quiz-timer" id="quizTimer">
                <i class="ri-time-line"></i>
                <span id="timerDisplay">60:00</span>
            </div>
            <button class="btn btn-danger" id="submitBtn" onclick="submitQuiz()">
                <i class="ri-check-line"></i> Submit
            </button>
        </div>
        
        <div class="quiz-content">
            <div class="quiz-main">
                <div class="question-card animate-fade" id="questionCard">
                    <span class="question-number" id="questionNumber">Question 1</span>
                    <p class="question-text" id="questionText">Loading question...</p>
                    <div class="options-list" id="optionsList"></div>
                </div>
                <div class="question-nav">
                    <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()">
                        <i class="ri-arrow-left-line"></i> Previous
                    </button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">
                        Next <i class="ri-arrow-right-line"></i>
                    </button>
                </div>
            </div>
            
            <div class="quiz-sidebar">
                <div class="opponent-panel">
                    <h4 style="margin-bottom: 15px">Opponent</h4>
                    <div class="opponent-header">
                        <div class="user-avatar" id="opponentAvatar">O</div>
                        <div>
                            <h4 id="opponentName">Opponent</h4>
                            <p style="font-size: 12px; color: var(--text2)" id="opponentSchool">School</p>
                        </div>
                    </div>
                    <div class="opponent-status">
                        <span class="dot"></span>
                        <span>On Question: <strong id="opponentQuestion">1</strong></span>
                    </div>
                    <div class="question-navigator" id="questionNav"></div>
                </div>
                
                <div class="comm-panel">
                    <h4 style="margin-bottom: 15px">Communication</h4>
                    <div class="comm-controls">
                        <button class="comm-btn" id="micBtn" onclick="toggleMic()">
                            <i class="ri-mic-line"></i>
                        </button>
                        <button class="comm-btn" id="speakerBtn" onclick="toggleSpeaker()">
                            <i class="ri-volume-up-line"></i>
                        </button>
                    </div>
                    <div class="chat-box" id="chatBox"></div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type a message...">
                        <div class="emoji-picker">
                            <button class="btn btn-secondary" onclick="toggleEmoji()">üòä</button>
                            <div class="emoji-list hidden" id="emojiList">
                                <span onclick="addEmoji('üòÄ')">üòÄ</span>
                                <span onclick="addEmoji('üòÇ')">üòÇ</span>
                                <span onclick="addEmoji('üòä')">üòä</span>
                                <span onclick="addEmoji('ü§î')">ü§î</span>
                                <span onclick="addEmoji('üòé')">üòé</span>
                                <span onclick="addEmoji('üî•')">üî•</span>
                                <span onclick="addEmoji('üëç')">üëç</span>
                                <span onclick="addEmoji('üëè')">üëè</span>
                                <span onclick="addEmoji('üí™')">üí™</span>
                                <span onclick="addEmoji('üéâ')">üéâ</span>
                                <span onclick="addEmoji('‚ú®')">‚ú®</span>
                                <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="ri-send-plane-line"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal-overlay hidden">
        <div class="modal results-modal animate-fade" style="max-width: 600px">
            <h2>Quiz Complete!</h2>
            <div class="results-score" id="resultScore">0%</div>
            <div class="results-comparison">
                <div class="result-player" id="resultMe">
                    <div class="user-avatar" style="width: 60px; height: 60px; margin: 0 auto 10px; font-size: 24px" id="resultMeAvatar">Y</div>
                    <h3 id="resultMeName">You</h3>
                    <p style="font-size: 28px; font-weight: 700; margin: 10px 0" id="resultMeScore">0/10</p>
                    <div class="point-change" id="resultMeChange">+0</div>
                    <p style="margin-top: 10px; color: var(--text2)">Total: <strong id="resultMeTotal">0</strong> points</p>
                </div>
                <div class="vs-badge">VS</div>
                <div class="result-player" id="resultOpponent">
                    <div class="user-avatar" style="width: 60px; height: 60px; margin: 0 auto 10px; font-size: 24px" id="resultOpponentAvatar">O</div>
                    <h3 id="resultOpponentName">Opponent</h3>
                    <p style="font-size: 28px; font-weight: 700; margin: 10px 0" id="resultOpponentScore">0/10</p>
                    <div class="point-change" id="resultOpponentChange">+0</div>
                    <p style="margin-top: 10px; color: var(--text2)">Total: <strong id="resultOpponentTotal">0</strong> points</p>
                </div>
            </div>
            <button class="btn btn-primary" onclick="backToDashboard()" style="width: 100%">
                <i class="ri-home-line"></i> Back to Dashboard
            </button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <div class="admin-sidebar">
            <div class="topbar-logo" style="padding: 10px 0"><span class="logo-text">Ofuje</span> Admin</div>
            <nav class="admin-nav">
                <div class="admin-nav-item active" onclick="switchAdminTab('users')">
                    <i class="ri-team-line"></i> <span>Users</span>
                </div>
                <div class="admin-nav-item" onclick="switchAdminTab('tests')">
                    <i class="ri-file-list-3-line"></i> <span>Tests</span>
                </div>
                <div class="admin-nav-item" onclick="switchAdminTab('questions')">
                    <i class="ri-question-line"></i> <span>Questions</span>
                </div>
                <div class="admin-nav-item" onclick="adminLogout()">
                    <i class="ri-logout-box-line"></i> <span>Logout</span>
                </div>
            </nav>
        </div>
        
        <div class="admin-main">
            <h1 style="margin-bottom: 30px">Admin Dashboard</h1>
            
            <!-- Admin Users Tab -->
            <div id="adminUsersTab" class="admin-tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Manage Users</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>School</th>
                                <th>Access Code</th>
                                <th>Points</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Admin Tests Tab -->
            <div id="adminTestsTab" class="admin-tab-content hidden">
                <div class="card" style="margin-bottom: 20px">
                    <div class="card-header">
                        <h3 class="card-title">Add New Test</h3>
                    </div>
                    <form onsubmit="addTest(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end">
                            <div class="input-group" style="margin: 0">
                                <label>Test Name</label>
                                <input type="text" id="newTestName" required>
                            </div>
                            <div class="input-group" style="margin: 0">
                                <label>Description</label>
                                <input type="text" id="newTestDesc" required>
                            </div>
                            <div class="input-group" style="margin: 0">
                                <label>Access Code (6 chars)</label>
                                <input type="text" id="newTestCode" maxlength="6" minlength="6" required style="text-transform: uppercase">
                            </div>
                            <button type="submit" class="btn btn-primary">Add Test</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Manage Tests</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Test Name</th>
                                <th>Description</th>
                                <th>Access Code</th>
                                <th>Questions</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminTestsBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Admin Questions Tab -->
            <div id="adminQuestionsTab" class="admin-tab-content hidden">
                <div class="card" style="margin-bottom: 20px">
                    <div class="card-header">
                        <h3 class="card-title">Add New Question</h3>
                    </div>
                    <form onsubmit="addQuestion(event)">
                        <div class="input-group">
                            <label>Select Test</label>
                            <select id="questionTestSelect" required></select>
                        </div>
                        <div class="input-group">
                            <label>Question</label>
                            <textarea id="newQuestion" rows="3" required></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
                            <div class="input-group">
                                <label>Option A</label>
                                <input type="text" id="optionA" required>
                            </div>
                            <div class="input-group">
                                <label>Option B</label>
                                <input type="text" id="optionB" required>
                            </div>
                            <div class="input-group">
                                <label>Option C</label>
                                <input type="text" id="optionC" required>
                            </div>
                            <div class="input-group">
                                <label>Option D</label>
                                <input type="text" id="optionD" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Correct Answer</label>
                            <select id="correctAnswer" required>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Question</button>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Manage Questions</h3>
                    </div>
                    <div class="input-group">
                        <label>Filter by Test</label>
                        <select id="filterTestSelect" onchange="loadAdminQuestions()"></select>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Question</th>
                                <th>Correct Answer</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminQuestionsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - Replace with your own config
        const firebaseConfig = {
apiKey: "AIzaSyDofEQ2jiMIXji7y-fGopDQcLY8dhixGk4",
  authDomain: "danz-66ffa.firebaseapp.com",
  projectId: "danz-66ffa",
  storageBucket: "danz-66ffa.firebasestorage.app",
  messagingSenderId: "570041531960",
  appId: "1:570041531960:web:24b77baa80aba9636c30cd"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // State
        let currentUser = null;
        let currentTest = null;
        let currentSession = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let answers = {};
        let timerInterval = null;
        let timeRemaining = 3600;
        let localStream = null;
        let peerConnection = null;
        let isMicMuted = false;
        let isSpeakerMuted = false;

        // Default Data
        const defaultTests = {
            test1: {
                id: 'test1',
                name: 'Mathematics Challenge',
                description: 'Basic arithmetic and algebra',
                code: 'MATH01',
                duration: 3600
            },
            test2: {
                id: 'test2',
                name: 'Science Quiz',
                description: 'General science knowledge',
                code: 'SCI123',
                duration: 3600
            }
        };

        const defaultQuestions = {
            test1: {
                q1: {
                    question: 'What is 15 + 27?',
                    options: { A: '42', B: '41', C: '43', D: '40' },
                    correct: 'A'
                },
                q2: {
                    question: 'Solve for x: 2x + 5 = 15',
                    options: { A: 'x = 4', B: 'x = 5', C: 'x = 6', D: 'x = 7' },
                    correct: 'B'
                }
            },
            test2: {
                q1: {
                    question: 'What is the chemical symbol for water?',
                    options: { A: 'H2O', B: 'CO2', C: 'NaCl', D: 'O2' },
                    correct: 'A'
                },
                q2: {
                    question: 'Which planet is known as the Red Planet?',
                    options: { A: 'Venus', B: 'Mars', C: 'Jupiter', D: 'Saturn' },
                    correct: 'B'
                }
            }
        };

        // Initialize default data
        async function initializeDefaults() {
            const testsRef = db.ref('tests');
            const snapshot = await testsRef.once('value');
            if (!snapshot.exists()) {
                await testsRef.set(defaultTests);
                await db.ref('questions').set(defaultQuestions);
            }
        }
        initializeDefaults();

        // Toast Notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: 'ri-check-line', error: 'ri-close-line', warning: 'ri-alert-line', info: 'ri-information-line' };
            toast.innerHTML = `<i class="${icons[type] || icons.info}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const icon = document.getElementById('themeIcon');
            icon.className = document.body.classList.contains('dark') ? 'ri-sun-line' : 'ri-moon-line';
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') toggleTheme();

        // Auth Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach((t, i) => {
                t.classList.toggle('active', ['login', 'register', 'admin'][i] === tab);
            });
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
            document.getElementById('adminForm').classList.toggle('hidden', tab !== 'admin');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const code = document.getElementById('loginCode').value.trim();
            const snapshot = await db.ref('users').orderByChild('accessCode').equalTo(code).once('value');
            const data = snapshot.val();
            if (data) {
                const userId = Object.keys(data)[0];
                const user = { id: userId, ...data[userId] };
                if (user.status === 'restricted') {
                    showToast('Your account is restricted', 'error');
                    return;
                }
                currentUser = user;
                localStorage.setItem('userId', userId);
                showDashboard();
                showToast('Welcome back, ' + user.name, 'success');
            } else {
                showToast('Invalid access code', 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value.trim();
            const school = document.getElementById('regSchool').value.trim();
            const code = document.getElementById('regCode').value.trim();
            
            const existing = await db.ref('users').orderByChild('accessCode').equalTo(code).once('value');
            if (existing.exists()) {
                showToast('Access code already taken', 'error');
                return;
            }
            
            const newUser = {
                name, school, accessCode: code,
                points: 0, wins: 0, losses: 0,
                status: 'active',
                createdAt: Date.now()
            };
            const ref = await db.ref('users').push(newUser);
            currentUser = { id: ref.key, ...newUser };
            localStorage.setItem('userId', ref.key);
            showDashboard();
            showToast('Registration successful!', 'success');
        }

        function handleAdminLogin(e) {
            e.preventDefault();
            const pass = document.getElementById('adminPass').value;
            if (pass === 'admin123') {
                document.getElementById('authPage').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadAdminData();
                showToast('Admin access granted', 'success');
            } else {
                showToast('Invalid admin password', 'error');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('userId');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('authPage').classList.remove('hidden');
            showToast('Logged out successfully', 'success');
        }

        // Dashboard Functions
        async function showDashboard() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            updateUserUI();
            loadTests();
            loadLeaderboard();
            loadRecords();
            loadAllUsers();
            
            // Listen for user updates
            db.ref('users/' + currentUser.id).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    currentUser = { id: currentUser.id, ...snapshot.val() };
                    updateUserUI();
                }
            });
        }

        function updateUserUI() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userPoints').textContent = currentUser.points + ' points';
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('statPoints').textContent = currentUser.points;
            document.getElementById('statWins').textContent = currentUser.wins || 0;
            document.getElementById('statLosses').textContent = currentUser.losses || 0;
            document.getElementById('settingsName').value = currentUser.name;
            document.getElementById('settingsCode').value = currentUser.accessCode;
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.nav-tab').classList.add('active');
            ['tests', 'records', 'leaderboard', 'users', 'settings'].forEach(t => {
                document.getElementById(t + 'Tab').classList.toggle('hidden', t !== tab);
            });
        }

        async function loadTests() {
            const snapshot = await db.ref('tests').once('value');
            const tests = snapshot.val() || {};
            const grid = document.getElementById('testGrid');
            grid.innerHTML = '';
            Object.entries(tests).forEach(([id, test]) => {
                grid.innerHTML += `
                    <div class="test-card animate-fade">
                        <div class="test-card-header">
                            <h3>${test.name}</h3>
                            <p>${test.description}</p>
                        </div>
                        <div class="test-card-body">
                            <div class="info">
                                <span><i class="ri-time-line"></i> 60 mins</span>
                                <span><i class="ri-team-line"></i> Multiplayer</span>
                            </div>
                            <button class="btn btn-primary" style="width: 100%" onclick="startTest('${id}')">
                                <i class="ri-play-line"></i> Start Test
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        async function loadLeaderboard() {
            const snapshot = await db.ref('users').orderByChild('points').once('value');
            const users = [];
            snapshot.forEach(child => users.push({ id: child.key, ...child.val() }));
            users.sort((a, b) => b.points - a.points);
            
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            users.forEach((user, i) => {
                const rankClass = i < 3 ? `rank-${i + 1}` : 'rank-default';
                tbody.innerHTML += `
                    <tr>
                        <td><span class="rank-badge ${rankClass}">${i + 1}</span></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px">
                                <div class="user-avatar" style="width: 35px; height: 35px; font-size: 14px">${user.name.charAt(0)}</div>
                                ${user.name} ${user.id === currentUser.id ? '<span style="color: var(--primary)">(You)</span>' : ''}
                            </div>
                        </td>
                        <td>${user.school}</td>
                        <td><strong>${user.points}</strong></td>
                        <td style="color: var(--success)">${user.wins || 0}</td>
                        <td style="color: var(--danger)">${user.losses || 0}</td>
                    </tr>
                `;
                if (user.id === currentUser.id) document.getElementById('statRank').textContent = '#' + (i + 1);
            });
        }

        async function loadRecords() {
            const snapshot = await db.ref('records').orderByChild('date').once('value');
            const records = [];
            snapshot.forEach(child => {
                const record = child.val();
                if (record.player1 === currentUser.id || record.player2 === currentUser.id) {
                    records.push(record);
                }
            });
            records.reverse();
            
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = records.length ? '' : '<tr><td colspan="6" style="text-align: center; color: var(--text2)">No records yet</td></tr>';
            records.forEach(record => {
                const isPlayer1 = record.player1 === currentUser.id;
                const myScore = isPlayer1 ? record.score1 : record.score2;
                const opponentScore = isPlayer1 ? record.score2 : record.score1;
                const opponentName = isPlayer1 ? record.player2Name : record.player1Name;
                const won = myScore > opponentScore;
                const draw = myScore === opponentScore;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(record.date).toLocaleDateString()}</td>
                        <td>${record.testName}</td>
                        <td>${myScore}/${record.total}</td>
                        <td>${opponentName}</td>
                        <td><span class="status-badge ${won ? 'active' : 'restricted'}">${draw ? 'Draw' : (won ? 'Won' : 'Lost')}</span></td>
                        <td class="${won ? '' : 'point-change negative'}" style="color: ${won ? 'var(--success)' : 'var(--danger)'}">${won ? '+10' : (draw ? '0' : '-5')}</td>
                    </tr>
                `;
            });
        }

        async function loadAllUsers() {
            const snapshot = await db.ref('users').once('value');
            const tbody = document.getElementById('usersBody');
            tbody.innerHTML = '';
            snapshot.forEach(child => {
                const user = child.val();
                tbody.innerHTML += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.school}</td>
                        <td>${user.points}</td>
                        <td>${(user.wins || 0) + (user.losses || 0)}</td>
                        <td><span class="status-badge ${user.status === 'active' ? 'active' : 'restricted'}">${user.status || 'active'}</span></td>
                    </tr>
                `;
            });
        }

        // Settings Functions
        async function updateProfile() {
            const name = document.getElementById('settingsName').value.trim();
            const code = document.getElementById('settingsCode').value.trim();
            
            if (code !== currentUser.accessCode) {
                const existing = await db.ref('users').orderByChild('accessCode').equalTo(code).once('value');
                if (existing.exists()) {
                    showToast('Access code already taken', 'error');
                    return;
                }
            }
            
            await db.ref('users/' + currentUser.id).update({ name, accessCode: code });
            showToast('Profile updated successfully', 'success');
        }

        async function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This cannot be undone.')) {
                await db.ref('users/' + currentUser.id).remove();
                logout();
                showToast('Account deleted', 'success');
            }
        }

        function showSettings() {
            switchTab('settings');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.nav-tab:nth-child(5)').classList.add('active');
        }

        // Test Functions
        function startTest(testId) {
            currentTest = testId;
            document.getElementById('testCodeModal').classList.remove('hidden');
        }

        async function verifyTestCode(e) {
            e.preventDefault();
            const code = document.getElementById('testCodeInput').value.toUpperCase();
            const snapshot = await db.ref('tests/' + currentTest).once('value');
            const test = snapshot.val();
            
            if (test && test.code === code) {
                closeModal('testCodeModal');
                enterWaitingRoom(test);
            } else {
                showToast('Invalid test code', 'error');
            }
        }

        async function enterWaitingRoom(test) {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('waitingRoom').classList.remove('hidden');
            document.getElementById('waitingTestName').textContent = test.name;
            
            // Join waiting room
            const waitingRef = db.ref('waiting/' + currentTest);
            await waitingRef.child(currentUser.id).set({
                name: currentUser.name,
                school: currentUser.school,
                joinedAt: Date.now()
            });
            
            // Listen for opponent
            waitingRef.on('value', async (snapshot) => {
                const waiters = snapshot.val();
                if (!waiters) return;
                
                const ids = Object.keys(waiters);
                document.getElementById('waitingCount').textContent = ids.length;
                
                if (ids.length >= 2) {
                    // Create match
                    const opponent = ids.find(id => id !== currentUser.id);
                    if (opponent) {
                        const sessionId = [currentUser.id, opponent].sort().join('_');
                        const existingSession = await db.ref('sessions/' + sessionId).once('value');
                        
                        if (!existingSession.exists()) {
                            // Create session
                            await db.ref('sessions/' + sessionId).set({
                                testId: currentTest,
                                testName: test.name,
                                player1: currentUser.id,
                                player2: opponent,
                                player1Name: currentUser.name,
                                player2Name: waiters[opponent].name,
                                player1School: currentUser.school,
                                player2School: waiters[opponent].school,
                                startTime: Date.now(),
                                status: 'active'
                            });
                        }
                        
                        currentSession = sessionId;
                        waitingRef.off();
                        await waitingRef.child(currentUser.id).remove();
                        startQuiz(test, waiters[opponent]);
                    }
                }
            });
        }

        function leaveWaitingRoom() {
            db.ref('waiting/' + currentTest + '/' + currentUser.id).remove();
            db.ref('waiting/' + currentTest).off();
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        async function startQuiz(test, opponent) {
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('quizArena').classList.remove('hidden');
            
            // Load questions
            const snapshot = await db.ref('questions/' + currentTest).once('value');
            const questionsData = snapshot.val() || {};
            questions = Object.entries(questionsData).map(([id, q]) => ({ id, ...q }));
            
            // Setup opponent info
            document.getElementById('opponentName').textContent = opponent.name;
            document.getElementById('opponentSchool').textContent = opponent.school;
            document.getElementById('opponentAvatar').textContent = opponent.name.charAt(0);
            
            // Setup question navigator
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            questions.forEach((_, i) => {
                nav.innerHTML += `<div class="q-nav-item" onclick="goToQuestion(${i})">${i + 1}</div>`;
            });
            
            // Show first question
            showQuestion(0);
            startTimer();
            setupCommunication();
            
            // Listen for opponent progress
            db.ref('sessions/' + currentSession + '/progress').on('value', (snapshot) => {
                const progress = snapshot.val() || {};
                const opponentId = Object.keys(progress).find(id => id !== currentUser.id);
                if (opponentId && progress[opponentId]) {
                    document.getElementById('opponentQuestion').textContent = (progress[opponentId].currentQuestion || 0) + 1;
                }
            });
            
            // Listen for submission
            db.ref('sessions/' + currentSession + '/submitted').on('value', async (snapshot) => {
                const submitted = snapshot.val();
                if (submitted) {
                    await handleQuizEnd();
                }
            });
        }

        function showQuestion(index) {
            currentQuestionIndex = index;
            const q = questions[index];
            document.getElementById('questionNumber').textContent = `Question ${index + 1} of ${questions.length}`;
            document.getElementById('questionText').textContent = q.question;
            
            const optionsList = document.getElementById('optionsList');
            optionsList.innerHTML = '';
            Object.entries(q.options).forEach(([key, value]) => {
                optionsList.innerHTML += `
                    <div class="option-item ${answers[q.id] === key ? 'selected' : ''}" onclick="selectOption('${q.id}', '${key}')">
                        <span class="marker">${key}</span>
                        <span>${value}</span>
                    </div>
                `;
            });
            
            updateQuestionNav();
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').textContent = index === questions.length - 1 ? 'Finish' : 'Next';
            
            // Update progress
            db.ref('sessions/' + currentSession + '/progress/' + currentUser.id).set({
                currentQuestion: index,
                answered: Object.keys(answers).length
            });
        }

        function selectOption(questionId, option) {
            answers[questionId] = option;
            showQuestion(currentQuestionIndex);
        }

        function updateQuestionNav() {
            document.querySelectorAll('.q-nav-item').forEach((item, i) => {
                item.classList.remove('current', 'answered');
                if (i === currentQuestionIndex) item.classList.add('current');
                if (answers[questions[i].id]) item.classList.add('answered');
            });
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) showQuestion(currentQuestionIndex - 1);
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        }

        function goToQuestion(index) {
            showQuestion(index);
        }

        function startTimer() {
            timeRemaining = 3600;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    submitQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timeRemaining / 60);
            const secs = timeRemaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            document.getElementById('quizTimer').classList.toggle('warning', timeRemaining <= 300);
        }

        async function submitQuiz() {
            clearInterval(timerInterval);
            await db.ref('sessions/' + currentSession + '/submitted').set(true);
            await db.ref('sessions/' + currentSession + '/answers/' + currentUser.id).set(answers);
        }

        async function handleQuizEnd() {
            clearInterval(timerInterval);
            db.ref('sessions/' + currentSession + '/progress').off();
            db.ref('sessions/' + currentSession + '/submitted').off();
            
            // Wait for all answers
            await new Promise(r => setTimeout(r, 1000));
            
            // Calculate scores
            const sessionData = (await db.ref('sessions/' + currentSession).once('value')).val();
            const allAnswers = sessionData.answers || {};
            
            let myScore = 0, opponentScore = 0;
            questions.forEach(q => {
                if (allAnswers[currentUser.id]?.[q.id] === q.correct) myScore++;
                const opponentId = sessionData.player1 === currentUser.id ? sessionData.player2 : sessionData.player1;
                if (allAnswers[opponentId]?.[q.id] === q.correct) opponentScore++;
            });
            
            const isPlayer1 = sessionData.player1 === currentUser.id;
            const opponentName = isPlayer1 ? sessionData.player2Name : sessionData.player1Name;
            
            // Update points
            let myPointChange = 0, opponentPointChange = 0;
            if (myScore > opponentScore) {
                myPointChange = 10;
                opponentPointChange = currentUser.points >= 5 ? -5 : 0;
            } else if (myScore < opponentScore) {
                myPointChange = currentUser.points >= 5 ? -5 : 0;
                opponentPointChange = 10;
            }
            
            const newPoints = Math.max(0, currentUser.points + myPointChange);
            await db.ref('users/' + currentUser.id).update({
                points: newPoints,
                wins: (currentUser.wins || 0) + (myScore > opponentScore ? 1 : 0),
                losses: (currentUser.losses || 0) + (myScore < opponentScore ? 1 : 0)
            });
            
            // Save record
            await db.ref('records').push({
                testId: currentTest,
                testName: sessionData.testName,
                player1: sessionData.player1,
                player2: sessionData.player2,
                player1Name: sessionData.player1Name,
                player2Name: sessionData.player2Name,
                score1: isPlayer1 ? myScore : opponentScore,
                score2: isPlayer1 ? opponentScore : myScore,
                total: questions.length,
                date: Date.now()
            });
            
            // Show results
            document.getElementById('resultScore').textContent = Math.round((myScore / questions.length) * 100) + '%';
            document.getElementById('resultMeAvatar').textContent = currentUser.name.charAt(0);
            document.getElementById('resultMeName').textContent = currentUser.name;
            document.getElementById('resultMeScore').textContent = `${myScore}/${questions.length}`;
            document.getElementById('resultMeChange').textContent = (myPointChange >= 0 ? '+' : '') + myPointChange;
            document.getElementById('resultMeChange').className = `point-change ${myPointChange >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('resultMeTotal').textContent = newPoints;
            document.getElementById('resultMe').className = `result-player ${myScore > opponentScore ? 'winner' : (myScore < opponentScore ? 'loser' : '')}`;
            
            document.getElementById('resultOpponentAvatar').textContent = opponentName.charAt(0);
            document.getElementById('resultOpponentName').textContent = opponentName;
            document.getElementById('resultOpponentScore').textContent = `${opponentScore}/${questions.length}`;
            document.getElementById('resultOpponentChange').textContent = (opponentPointChange >= 0 ? '+' : '') + opponentPointChange;
            document.getElementById('resultOpponentChange').className = `point-change ${opponentPointChange >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('resultOpponent').className = `result-player ${opponentScore > myScore ? 'winner' : (opponentScore < myScore ? 'loser' : '')}`;
            
            document.getElementById('resultsModal').classList.remove('hidden');
        }

        function backToDashboard() {
            document.getElementById('quizArena').classList.add('hidden');
            document.getElementById('resultsModal').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadLeaderboard();
            loadRecords();
            answers = {};
            currentSession = null;
        }

        // Communication Functions
        function setupCommunication() {
            // Chat listener
            db.ref('sessions/' + currentSession + '/chat').on('child_added', (snapshot) => {
                const msg = snapshot.val();
                addChatMessage(msg.text, msg.sender === currentUser.id);
            });
            
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (text) {
                db.ref('sessions/' + currentSession + '/chat').push({
                    sender: currentUser.id,
                    text,
                    time: Date.now()
                });
                input.value = '';
            }
        }

        function addChatMessage(text, isMine) {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML += `
                <div class="chat-message ${isMine ? 'mine' : 'other'}">
                    <div class="bubble">${text}</div>
                </div>
            `;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function toggleEmoji() {
            document.getElementById('emojiList').classList.toggle('hidden');
        }

        function addEmoji(emoji) {
            document.getElementById('chatInput').value += emoji;
            document.getElementById('emojiList').classList.add('hidden');
        }

        async function toggleMic() {
            const btn = document.getElementById('micBtn');
            isMicMuted = !isMicMuted;
            btn.classList.toggle('muted', isMicMuted);
            btn.innerHTML = isMicMuted ? '<i class="ri-mic-off-line"></i>' : '<i class="ri-mic-line"></i>';
            
            if (!localStream && !isMicMuted) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    setupWebRTC();
                    showToast('Microphone enabled', 'success');
                } catch (e) {
                    showToast('Could not access microphone', 'error');
                }
            } else if (localStream) {
                localStream.getAudioTracks().forEach(track => track.enabled = !isMicMuted);
            }
        }

        function toggleSpeaker() {
            const btn = document.getElementById('speakerBtn');
            isSpeakerMuted = !isSpeakerMuted;
            btn.classList.toggle('muted', isSpeakerMuted);
            btn.innerHTML = isSpeakerMuted ? '<i class="ri-volume-mute-line"></i>' : '<i class="ri-volume-up-line"></i>';
            
            const audio = document.querySelector('audio');
            if (audio) audio.muted = isSpeakerMuted;
        }

        function setupWebRTC() {
            // Simplified WebRTC setup - for full implementation, you'd need a signaling server
            showToast('Voice chat ready', 'success');
        }

        // Modal Functions
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // Admin Functions
        function adminLogout() {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('authPage').classList.remove('hidden');
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-nav-item').forEach(i => i.classList.remove('active'));
            event.target.closest('.admin-nav-item').classList.add('active');
            ['users', 'tests', 'questions'].forEach(t => {
                document.getElementById('admin' + t.charAt(0).toUpperCase() + t.slice(1) + 'Tab').classList.toggle('hidden', t !== tab);
            });
        }

        async function loadAdminData() {
            await loadAdminUsers();
            await loadAdminTests();
            await loadAdminQuestions();
        }

        async function loadAdminUsers() {
            const snapshot = await db.ref('users').once('value');
            const tbody = document.getElementById('adminUsersBody');
            tbody.innerHTML = '';
            snapshot.forEach(child => {
                const user = { id: child.key, ...child.val() };
                tbody.innerHTML += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.school}</td>
                        <td><code>${user.accessCode}</code></td>
                        <td>${user.points}</td>
                        <td><span class="status-badge ${user.status === 'restricted' ? 'restricted' : 'active'}">${user.status || 'active'}</span></td>
                        <td>
                            <button class="btn btn-secondary" onclick="toggleUserStatus('${user.id}', '${user.status}')">
                                ${user.status === 'restricted' ? 'Activate' : 'Restrict'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'restricted' ? 'active' : 'restricted';
            await db.ref('users/' + userId).update({ status: newStatus });
            loadAdminUsers();
            showToast('User status updated', 'success');
        }

        async function deleteUser(userId) {
            if (confirm('Delete this user?')) {
                await db.ref('users/' + userId).remove();
                loadAdminUsers();
                showToast('User deleted', 'success');
            }
        }

        async function loadAdminTests() {
            const snapshot = await db.ref('tests').once('value');
            const tests = snapshot.val() || {};
            const tbody = document.getElementById('adminTestsBody');
            tbody.innerHTML = '';
            
            const questionsSnapshot = await db.ref('questions').once('value');
            const allQuestions = questionsSnapshot.val() || {};
            
            Object.entries(tests).forEach(([id, test]) => {
                const qCount = Object.keys(allQuestions[id] || {}).length;
                tbody.innerHTML += `
                    <tr>
                        <td>${test.name}</td>
                        <td>${test.description}</td>
                        <td><code>${test.code}</code></td>
                        <td>${qCount}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteTest('${id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            // Update question selects
            const selects = [document.getElementById('questionTestSelect'), document.getElementById('filterTestSelect')];
            selects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Select Test</option>';
                    Object.entries(tests).forEach(([id, test]) => {
                        select.innerHTML += `<option value="${id}">${test.name}</option>`;
                    });
                }
            });
        }

        async function addTest(e) {
            e.preventDefault();
            const name = document.getElementById('newTestName').value;
            const description = document.getElementById('newTestDesc').value;
            const code = document.getElementById('newTestCode').value.toUpperCase();
            
            const id = 'test' + Date.now();
            await db.ref('tests/' + id).set({ id, name, description, code, duration: 3600 });
            e.target.reset();
            loadAdminTests();
            showToast('Test added successfully', 'success');
        }

        async function deleteTest(testId) {
            if (confirm('Delete this test and all its questions?')) {
                await db.ref('tests/' + testId).remove();
                await db.ref('questions/' + testId).remove();
                loadAdminTests();
                loadAdminQuestions();
                showToast('Test deleted', 'success');
            }
        }

        async function loadAdminQuestions() {
            const testId = document.getElementById('filterTestSelect')?.value;
            const tbody = document.getElementById('adminQuestionsBody');
            tbody.innerHTML = '';
            
            if (!testId) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text2)">Select a test to view questions</td></tr>';
                return;
            }
            
            const snapshot = await db.ref('questions/' + testId).once('value');
            const questions = snapshot.val() || {};
            
            let i = 1;
            Object.entries(questions).forEach(([id, q]) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${i++}</td>
                        <td>${q.question.substring(0, 50)}...</td>
                        <td>${q.correct}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteQuestion('${testId}', '${id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            if (Object.keys(questions).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text2)">No questions yet</td></tr>';
            }
        }

        async function addQuestion(e) {
            e.preventDefault();
            const testId = document.getElementById('questionTestSelect').value;
            if (!testId) {
                showToast('Please select a test', 'error');
                return;
            }
            
            const question = {
                question: document.getElementById('newQuestion').value,
                options: {
                    A: document.getElementById('optionA').value,
                    B: document.getElementById('optionB').value,
                    C: document.getElementById('optionC').value,
                    D: document.getElementById('optionD').value
                },
                correct: document.getElementById('correctAnswer').value
            };
            
            await db.ref('questions/' + testId).push(question);
            e.target.reset();
            document.getElementById('filterTestSelect').value = testId;
            loadAdminQuestions();
            loadAdminTests();
            showToast('Question added successfully', 'success');
        }

        async function deleteQuestion(testId, questionId) {
            if (confirm('Delete this question?')) {
                await db.ref('questions/' + testId + '/' + questionId).remove();
                loadAdminQuestions();
                loadAdminTests();
                showToast('Question deleted', 'success');
            }
        }

        // Auto-login check
        async function checkAuth() {
            const userId = localStorage.getItem('userId');
            if (userId) {
                const snapshot = await db.ref('users/' + userId).once('value');
                if (snapshot.exists()) {
                    currentUser = { id: userId, ...snapshot.val() };
                    if (currentUser.status !== 'restricted') {
                        showDashboard();
                        return;
                    }
                }
            }
        }
        checkAuth();

        // Add questions manually from code
        function addQuestionsManually(testId, questionsArray) {
            questionsArray.forEach(q => {
                db.ref('questions/' + testId).push(q);
            });
        }

        // Example: Add questions manually
        // addQuestionsManually('test1', [
        //     { question: 'What is 2+2?', options: {A: '3', B: '4', C: '5', D: '6'}, correct: 'B' }
        // ]);
    </script>
</body>
</html>