<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofuje - Multiplayer Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}
        :root{--bg:#667eea;--bg2:#764ba2;--glass:rgba(255,255,255,0.15);--glass-border:rgba(255,255,255,0.3);--text:#fff;--card:rgba(255,255,255,0.1)}
        .dark{--bg:#1a1a2e;--bg2:#16213e;--glass:rgba(0,0,0,0.3);--glass-border:rgba(255,255,255,0.1);--text:#fff;--card:rgba(255,255,255,0.05)}
        body{min-height:100vh;background:linear-gradient(135deg,var(--bg),var(--bg2));color:var(--text);overflow-x:hidden}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .glass{background:var(--glass);backdrop-filter:blur(20px);border-radius:20px;border:1px solid var(--glass-border);box-shadow:0 8px 32px rgba(0,0,0,0.1)}
        .hidden{display:none!important}
        .btn{padding:12px 30px;border:none;border-radius:12px;cursor:pointer;font-weight:600;transition:all .3s;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
        .btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(102,126,234,0.4)}
        .btn-secondary{background:var(--glass);border:1px solid var(--glass-border)}
        input,select{width:100%;padding:15px;border:1px solid var(--glass-border);border-radius:12px;background:var(--glass);color:var(--text);font-size:16px;backdrop-filter:blur(10px)}
        input::placeholder{color:rgba(255,255,255,0.6)}
        input:focus{outline:none;border-color:#667eea}
        
        /* Auth */
        #auth{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
        .auth-box{width:100%;max-width:420px;padding:40px}
        .logo{text-align:center;margin-bottom:30px}
        .logo h1{font-size:2.5rem;background:linear-gradient(135deg,#fff,#a8c0ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .logo p{opacity:.8;margin-top:5px}
        .tabs{display:flex;gap:10px;margin-bottom:30px}
        .tab{flex:1;padding:12px;text-align:center;cursor:pointer;border-radius:10px;background:var(--card);transition:.3s}
        .tab.active{background:linear-gradient(135deg,#667eea,#764ba2)}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;font-weight:500}
        
        /* Dashboard */
        .dashboard-header{display:flex;justify-content:space-between;align-items:center;padding:20px 30px;margin-bottom:30px}
        .user-info{display:flex;align-items:center;gap:15px}
        .avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:600}
        .user-details h3{font-size:1.1rem}
        .user-details p{font-size:.85rem;opacity:.7}
        .header-actions{display:flex;gap:15px;align-items:center}
        .icon-btn{width:45px;height:45px;border-radius:12px;background:var(--glass);border:1px solid var(--glass-border);color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.3s}
        .icon-btn:hover{background:rgba(255,255,255,0.2)}
        
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{padding:25px;text-align:center}
        .stat-card i{font-size:2rem;margin-bottom:15px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .stat-card h3{font-size:2rem;margin-bottom:5px}
        .stat-card p{opacity:.7;font-size:.9rem}
        
        .section-title{font-size:1.3rem;margin-bottom:20px;display:flex;align-items:center;gap:10px}
        .section-title i{color:#667eea}
        
        .tests-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
        .test-card{padding:25px;cursor:pointer;transition:.3s}
        .test-card:hover{transform:translateY(-5px);box-shadow:0 15px 40px rgba(0,0,0,0.2)}
        .test-card h4{font-size:1.2rem;margin-bottom:10px}
        .test-card p{opacity:.7;font-size:.9rem;margin-bottom:15px}
        .test-meta{display:flex;gap:15px;font-size:.85rem;opacity:.6}
        
        .leaderboard{padding:25px}
        .leaderboard-item{display:flex;align-items:center;gap:15px;padding:15px;border-radius:12px;margin-bottom:10px;background:var(--card)}
        .leaderboard-item.current-user{border:2px solid #667eea;background:rgba(102,126,234,0.2)}
        .rank{width:35px;height:35px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.9rem}
        .rank.gold{background:linear-gradient(135deg,#f7971e,#ffd200)}
        .rank.silver{background:linear-gradient(135deg,#bdc3c7,#2c3e50)}
        .rank.bronze{background:linear-gradient(135deg,#c97b18,#8b4513)}
        .lb-info{flex:1}
        .lb-info h4{font-size:1rem}
        .lb-info p{font-size:.85rem;opacity:.7}
        .lb-points{font-weight:600;color:#ffd200}
        
        .records{padding:25px;max-height:400px;overflow-y:auto}
        .record-item{padding:15px;border-radius:12px;margin-bottom:10px;background:var(--card);display:flex;justify-content:space-between;align-items:center}
        .record-item.win{border-left:3px solid #4ade80}
        .record-item.loss{border-left:3px solid #f87171}
        .record-item.draw{border-left:3px solid #fbbf24}
        
        /* Waiting Room */
        #waiting{text-align:center;padding:50px 20px}
        .waiting-animation{width:150px;height:150px;margin:30px auto;border-radius:50%;background:var(--glass);display:flex;align-items:center;justify-content:center;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(102,126,234,0.4)}50%{transform:scale(1.05);box-shadow:0 0 0 30px rgba(102,126,234,0)}}
        .waiting-animation i{font-size:3rem}
        #waiting h2{font-size:1.8rem;margin-bottom:10px}
        #waiting p{opacity:.7;margin-bottom:30px}
        
        /* Quiz */
        .quiz-header{display:flex;justify-content:space-between;align-items:center;padding:20px 30px;margin-bottom:20px;flex-wrap:wrap;gap:15px}
        .timer{font-size:1.5rem;font-weight:600;display:flex;align-items:center;gap:10px}
        .timer i{color:#f87171}
        .voice-controls{display:flex;gap:10px}
        
        .players-bar{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;padding:0 20px}
        .player-status{padding:20px;display:flex;align-items:center;gap:15px}
        .player-status.you{border:2px solid #667eea}
        .player-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-weight:600}
        .player-info{flex:1}
        .player-info h4{font-size:1rem;margin-bottom:5px}
        .player-progress{font-size:.85rem;opacity:.8}
        .player-score{font-size:1.5rem;font-weight:700;color:#4ade80}
        
        .question-container{max-width:800px;margin:0 auto;padding:30px}
        .question-number{font-size:.9rem;opacity:.7;margin-bottom:10px}
        .question-text{font-size:1.3rem;margin-bottom:30px;line-height:1.6}
        .options{display:grid;gap:15px}
        .option{padding:20px;border-radius:12px;cursor:pointer;transition:.3s;background:var(--glass);border:2px solid transparent}
        .option:hover{background:rgba(255,255,255,0.2)}
        .option.selected{border-color:#667eea;background:rgba(102,126,234,0.2)}
        .option.correct{border-color:#4ade80;background:rgba(74,222,128,0.2)}
        .option.wrong{border-color:#f87171;background:rgba(248,113,113,0.2)}
        
        .quiz-nav{display:flex;justify-content:space-between;margin-top:30px;gap:15px;flex-wrap:wrap}
        
        /* Results */
        #results{padding:20px}
        .results-header{text-align:center;margin-bottom:30px}
        .result-icon{font-size:5rem;margin-bottom:20px}
        .result-icon.win{color:#4ade80}
        .result-icon.loss{color:#f87171}
        .result-icon.draw{color:#fbbf24}
        .results-comparison{display:grid;grid-template-columns:1fr auto 1fr;gap:30px;max-width:600px;margin:0 auto 30px;align-items:center}
        .result-player{padding:30px}
        .result-player h3{font-size:1.2rem;margin-bottom:15px}
        .result-player .score{font-size:3rem;font-weight:700;margin-bottom:10px}
        .result-player .points{font-size:1.1rem}
        .points.positive{color:#4ade80}
        .points.negative{color:#f87171}
        .vs{font-size:1.5rem;font-weight:700;opacity:.5}
        
        /* Answer Review */
        .answers-review{max-width:900px;margin:30px auto;padding:25px}
        .answers-review h3{text-align:center;margin-bottom:25px;font-size:1.4rem}
        .answer-item{margin-bottom:25px;padding:20px;border-radius:15px;background:var(--card)}
        .answer-question{font-size:1.1rem;margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid var(--glass-border)}
        .answer-question span{opacity:.6;font-size:.9rem}
        .answer-options{display:grid;gap:10px;margin-bottom:15px}
        .answer-option{padding:12px 15px;border-radius:10px;background:var(--glass);display:flex;align-items:center;gap:10px;font-size:.95rem}
        .answer-option.correct-answer{background:rgba(74,222,128,0.2);border:1px solid #4ade80}
        .answer-option.wrong-answer{background:rgba(248,113,113,0.2);border:1px solid #f87171}
        .answer-option i{font-size:.8rem}
        .player-answers{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px;padding-top:15px;border-top:1px solid var(--glass-border)}
        .player-answer{padding:12px;border-radius:10px;background:var(--glass)}
        .player-answer.correct{border-left:3px solid #4ade80}
        .player-answer.wrong{border-left:3px solid #f87171}
        .player-answer h5{font-size:.85rem;opacity:.7;margin-bottom:5px}
        .player-answer p{font-size:.95rem;display:flex;align-items:center;gap:8px}
        .player-answer i.fa-check{color:#4ade80}
        .player-answer i.fa-times{color:#f87171}
        
        /* Code Entry */
        .code-modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
        .code-box{padding:40px;max-width:400px;width:100%;text-align:center}
        .code-box h3{margin-bottom:20px}
        .code-box input{margin-bottom:20px}
        
        @media(max-width:768px){
            .dashboard-header{flex-direction:column;text-align:center;gap:20px}
            .players-bar{grid-template-columns:1fr}
            .results-comparison{grid-template-columns:1fr;gap:15px}
            .vs{display:none}
            .quiz-header{justify-content:center}
            .player-answers{grid-template-columns:1fr}
        }
        
        ::-webkit-scrollbar{width:8px}
        ::-webkit-scrollbar-track{background:var(--glass)}
        ::-webkit-scrollbar-thumb{background:#667eea;border-radius:10px}
    </style>
</head>
<body>
    <!-- Auth Section -->
    <section id="auth">
        <div class="auth-box glass">
            <div class="logo">
                <h1><i class="fas fa-brain"></i> Ofuje</h1>
                <p>Multiplayer Quiz Platform</p>
            </div>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('login')">Login</div>
                <div class="tab" onclick="switchTab('register')">Register</div>
            </div>
            <div id="loginForm">
                <div class="form-group">
                    <label>Access Code</label>
                    <input type="text" id="loginCode" placeholder="Enter your access code">
                </div>
                <button class="btn" style="width:100%" onclick="login()">Login</button>
            </div>
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Preferred Access Code</label>
                    <input type="text" id="regCode" placeholder="Create your unique code">
                </div>
                <button class="btn" style="width:100%" onclick="register()">Register</button>
            </div>
        </div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="hidden">
        <div class="container">
            <div class="dashboard-header glass">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <h3 id="userName">User</h3>
                        <p id="userCode">Code: ****</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleDarkMode()"><i class="fas fa-moon" id="themeIcon"></i></button>
                    <button class="icon-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card glass">
                    <i class="fas fa-trophy"></i>
                    <h3 id="totalPoints">0</h3>
                    <p>Total Points</p>
                </div>
                <div class="stat-card glass">
                    <i class="fas fa-check-circle"></i>
                    <h3 id="totalWins">0</h3>
                    <p>Total Wins</p>
                </div>
                <div class="stat-card glass">
                    <i class="fas fa-times-circle"></i>
                    <h3 id="totalLosses">0</h3>
                    <p>Total Losses</p>
                </div>
                <div class="stat-card glass">
                    <i class="fas fa-gamepad"></i>
                    <h3 id="totalGames">0</h3>
                    <p>Games Played</p>
                </div>
            </div>

            <h2 class="section-title"><i class="fas fa-clipboard-list"></i> Available Tests</h2>
            <div class="tests-grid" id="testsGrid"></div>

            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px">
                <div>
                    <h2 class="section-title"><i class="fas fa-medal"></i> Leaderboard</h2>
                    <div class="leaderboard glass" id="leaderboard"></div>
                </div>
                <div>
                    <h2 class="section-title"><i class="fas fa-history"></i> Your Records</h2>
                    <div class="records glass" id="records"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Code Entry Modal -->
    <div id="codeModal" class="code-modal hidden">
        <div class="code-box glass">
            <h3><i class="fas fa-lock"></i> Enter Access Code</h3>
            <p style="opacity:.7;margin-bottom:20px">Enter the test access code to proceed</p>
            <input type="text" id="testAccessCode" placeholder="Enter code...">
            <button class="btn" onclick="verifyTestCode()">Verify & Start</button>
            <button class="btn btn-secondary" style="margin-top:10px" onclick="closeCodeModal()">Cancel</button>
        </div>
    </div>

    <!-- Waiting Room -->
    <section id="waiting" class="hidden">
        <div class="container">
            <div class="glass" style="max-width:500px;margin:0 auto;padding:50px">
                <div class="waiting-animation">
                    <i class="fas fa-users"></i>
                </div>
                <h2>Waiting for Opponent</h2>
                <p id="waitingTest">Test: General Knowledge</p>
                <p style="margin-bottom:30px">Please wait while we find an opponent...</p>
                <button class="btn btn-secondary" onclick="cancelWaiting()">Cancel</button>
            </div>
        </div>
    </section>

    <!-- Quiz Section -->
    <section id="quiz" class="hidden">
        <div class="container">
            <div class="quiz-header glass">
                <div class="timer"><i class="fas fa-clock"></i><span id="timerDisplay">60:00</span></div>
                <div class="voice-controls">
                    <button class="icon-btn" id="micBtn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                    <button class="icon-btn" id="speakerBtn" onclick="toggleSpeaker()"><i class="fas fa-volume-up"></i></button>
                </div>
            </div>

            <div class="players-bar">
                <div class="player-status glass you">
                    <div class="player-avatar" id="p1Avatar">Y</div>
                    <div class="player-info">
                        <h4 id="p1Name">You</h4>
                        <p class="player-progress">Question <span id="p1Question">1</span>/<span class="totalQs">2</span></p>
                    </div>
                    <div class="player-score" id="p1Score">0</div>
                </div>
                <div class="player-status glass">
                    <div class="player-avatar" id="p2Avatar">O</div>
                    <div class="player-info">
                        <h4 id="p2Name">Opponent</h4>
                        <p class="player-progress">Question <span id="p2Question">1</span>/<span class="totalQs">2</span></p>
                    </div>
                    <div class="player-score" id="p2Score">0</div>
                </div>
            </div>

            <div class="question-container glass">
                <p class="question-number">Question <span id="currentQ">1</span> of <span id="totalQ">2</span></p>
                <h3 class="question-text" id="questionText">Loading question...</h3>
                <div class="options" id="optionsContainer"></div>
                <div class="quiz-nav">
                    <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()">Previous</button>
                    <button class="btn" id="nextBtn" onclick="nextQuestion()">Next</button>
                    <button class="btn hidden" id="submitBtn" onclick="submitQuiz()" style="background:linear-gradient(135deg,#4ade80,#22c55e)">Submit</button>
                </div>
            </div>
        </div>
        <audio id="remoteAudio" autoplay></audio>
    </section>

    <!-- Results -->
    <section id="results" class="hidden">
        <div class="container">
            <div class="glass results-header" style="max-width:700px;margin:0 auto;padding:50px">
                <div class="result-icon" id="resultIcon"><i class="fas fa-trophy"></i></div>
                <h2 id="resultTitle">You Won!</h2>
                <div class="results-comparison">
                    <div class="result-player glass">
                        <h3 id="resP1Name">You</h3>
                        <div class="score" id="resP1Score">0</div>
                        <div class="points" id="resP1Points">+10 points</div>
                    </div>
                    <div class="vs">VS</div>
                    <div class="result-player glass">
                        <h3 id="resP2Name">Opponent</h3>
                        <div class="score" id="resP2Score">0</div>
                        <div class="points" id="resP2Points">-5 points</div>
                    </div>
                </div>
                <div style="margin-top:20px">
                    <p>Your new total: <strong id="newTotal">0</strong> points</p>
                </div>
            </div>
            
            <!-- Answer Review Section -->
            <div class="answers-review glass" id="answersReview">
                <h3><i class="fas fa-clipboard-check"></i> Answer Review</h3>
                <div id="answersContainer"></div>
            </div>
            
            <div style="text-align:center;margin-top:30px">
                <button class="btn" onclick="backToDashboard()">Back to Dashboard</button>
            </div>
        </div>
    </section>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCvM6vwsuPSacx92MOIrc2oDw6LZAMcvRs",
            authDomain: "biggg-611d9.firebaseapp.com",
            projectId: "biggg-611d9",
            storageBucket: "biggg-611d9.firebasestorage.app",
            messagingSenderId: "281791078644",
            appId: "1:281791078644:web:d6a1851c4b0274bbdd7ea1",
            measurementId: "G-SE40TBC5Y6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // State
        let currentUser = null;
        let currentTest = null;
        let currentRoom = null;
        let currentQuestionIndex = 0;
        let answers = {};
        let timerInterval = null;
        let timeRemaining = 3600;
        let darkMode = localStorage.getItem('darkMode') === 'true';
        let localStream = null;
        let peerConnection = null;
        let micEnabled = true;
        let speakerEnabled = true;
        let hasSubmitted = false;

        // Tests Data
        const tests = {
            test1: {
                id: 'test1',
                name: 'General Knowledge',
                description: 'Test your general knowledge',
                questions: [
                    { q: 'What is the capital of France?', options: ['London', 'Berlin', 'Paris', 'Madrid'], correct: 2 },
                    { q: 'Which planet is known as the Red Planet?', options: ['Venus', 'Mars', 'Jupiter', 'Saturn'], correct: 1 }
                ]
            },
            test2: {
                id: 'test2',
                name: 'Science Quiz',
                description: 'Test your science knowledge',
                questions: [
                    { q: 'What is H2O commonly known as?', options: ['Salt', 'Sugar', 'Water', 'Oil'], correct: 2 },
                    { q: 'What is the speed of light?', options: ['300,000 km/s', '150,000 km/s', '500,000 km/s', '100,000 km/s'], correct: 0 }
                ]
            }
        };

        // Init
        if (darkMode) {
            document.body.classList.add('dark');
            document.getElementById('themeIcon').className = 'fas fa-sun';
        }
        initTests();

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === (tab === 'login' ? 0 : 1)));
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab === 'login');
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const code = document.getElementById('regCode').value.trim();
            if (!name || !code) return alert('Please fill all fields');
            if (code.length < 3) return alert('Access code must be at least 3 characters');
            
            const snapshot = await db.ref('users/' + code).once('value');
            if (snapshot.exists()) return alert('Access code already exists');
            
            await db.ref('users/' + code).set({ 
                name, 
                code, 
                points: 0, 
                wins: 0, 
                losses: 0, 
                draws: 0,
                games: 0, 
                records: [],
                createdAt: Date.now()
            });
            alert('Registration successful! Please login.');
            switchTab('login');
        }

        async function login() {
            const code = document.getElementById('loginCode').value.trim();
            if (!code) return alert('Please enter access code');
            
            const snapshot = await db.ref('users/' + code).once('value');
            if (!snapshot.exists()) return alert('Invalid access code');
            
            currentUser = { ...snapshot.val(), code };
            showDashboard();
        }

        function showDashboard() {
            document.getElementById('auth').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            updateDashboard();
            listenToLeaderboard();
            listenToUserUpdates();
        }

        function listenToUserUpdates() {
            db.ref('users/' + currentUser.code).on('value', snap => {
                if (snap.exists()) {
                    currentUser = { ...snap.val(), code: currentUser.code };
                    updateDashboard();
                }
            });
        }

        function updateDashboard() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userCode').textContent = 'Code: ' + currentUser.code;
            document.getElementById('userAvatar').textContent = currentUser.name[0].toUpperCase();
            document.getElementById('totalPoints').textContent = currentUser.points || 0;
            document.getElementById('totalWins').textContent = currentUser.wins || 0;
            document.getElementById('totalLosses').textContent = currentUser.losses || 0;
            document.getElementById('totalGames').textContent = currentUser.games || 0;
            
            const recordsEl = document.getElementById('records');
            const records = currentUser.records || [];
            recordsEl.innerHTML = records.slice(-10).reverse().map(r => `
                <div class="record-item ${r.result}">
                    <div>
                        <strong>${r.test}</strong>
                        <p style="font-size:.85rem;opacity:.7">vs ${r.opponent} â€¢ ${r.date}</p>
                    </div>
                    <div style="text-align:right">
                        <strong>${r.score}/${r.total}</strong>
                        <p class="${r.result === 'win' ? 'positive' : r.result === 'loss' ? 'negative' : ''}" style="font-size:.85rem">
                            ${r.result === 'win' ? '+10' : r.result === 'loss' ? '-5' : '0'}
                        </p>
                    </div>
                </div>
            `).join('') || '<p style="text-align:center;opacity:.7">No records yet</p>';
        }

        function initTests() {
            document.getElementById('testsGrid').innerHTML = Object.values(tests).map(t => `
                <div class="test-card glass" onclick="selectTest('${t.id}')">
                    <h4><i class="fas fa-file-alt"></i> ${t.name}</h4>
                    <p>${t.description}</p>
                    <div class="test-meta">
                        <span><i class="fas fa-question-circle"></i> ${t.questions.length} Questions</span>
                        <span><i class="fas fa-clock"></i> 60 min</span>
                    </div>
                </div>
            `).join('');
        }

        function selectTest(testId) {
            currentTest = tests[testId];
            document.getElementById('codeModal').classList.remove('hidden');
        }

        function closeCodeModal() {
            document.getElementById('codeModal').classList.add('hidden');
            document.getElementById('testAccessCode').value = '';
        }

        function verifyTestCode() {
            const code = document.getElementById('testAccessCode').value.trim();
            if (code !== 'OFUJE2024') return alert('Invalid test access code');
            closeCodeModal();
            joinWaitingRoom();
        }

        async function joinWaitingRoom() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('waiting').classList.remove('hidden');
            document.getElementById('waitingTest').textContent = 'Test: ' + currentTest.name;

            const roomsRef = db.ref('waiting/' + currentTest.id);
            const snapshot = await roomsRef.once('value');
            
            if (snapshot.exists()) {
                const waitingUsers = Object.entries(snapshot.val());
                const otherUser = waitingUsers.find(([key]) => key !== currentUser.code);
                
                if (otherUser) {
                    currentRoom = currentUser.code + '_' + otherUser[0] + '_' + Date.now();
                    await db.ref('rooms/' + currentRoom).set({
                        test: currentTest.id,
                        players: { 
                            [currentUser.code]: { name: currentUser.name, score: 0, question: 0, done: false, answers: {} },
                            [otherUser[0]]: { name: otherUser[1].name, score: 0, question: 0, done: false, answers: {} }
                        },
                        status: 'active', 
                        startTime: Date.now()
                    });
                    await db.ref('waiting/' + currentTest.id + '/' + otherUser[0]).remove();
                    startQuiz();
                    return;
                }
            }
            
            await db.ref('waiting/' + currentTest.id + '/' + currentUser.code).set({ name: currentUser.name });
            
            db.ref('rooms').orderByChild('status').equalTo('active').on('child_added', snap => {
                const room = snap.val();
                if (room.players && room.players[currentUser.code] && room.test === currentTest.id) {
                    currentRoom = snap.key;
                    db.ref('waiting/' + currentTest.id + '/' + currentUser.code).remove();
                    startQuiz();
                }
            });
        }

        function cancelWaiting() {
            db.ref('waiting/' + currentTest.id + '/' + currentUser.code).remove();
            db.ref('rooms').off();
            document.getElementById('waiting').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        async function startQuiz() {
            document.getElementById('waiting').classList.add('hidden');
            document.getElementById('quiz').classList.remove('hidden');
            currentQuestionIndex = 0;
            answers = {};
            timeRemaining = 3600;
            hasSubmitted = false;
            
            const roomData = (await db.ref('rooms/' + currentRoom).once('value')).val();
            const players = Object.entries(roomData.players);
            const opponent = players.find(p => p[0] !== currentUser.code);
            
            document.getElementById('p1Name').textContent = currentUser.name;
            document.getElementById('p1Avatar').textContent = currentUser.name[0];
            document.getElementById('p2Name').textContent = opponent[1].name;
            document.getElementById('p2Avatar').textContent = opponent[1].name[0];
            
            // Update total questions display
            document.querySelectorAll('.totalQs').forEach(el => el.textContent = currentTest.questions.length);
            
            displayQuestion();
            startTimer();
            listenToRoom();
            setupVoiceChat();
        }

        function displayQuestion() {
            const q = currentTest.questions[currentQuestionIndex];
            document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQ').textContent = currentTest.questions.length;
            document.getElementById('questionText').textContent = q.q;
            document.getElementById('optionsContainer').innerHTML = q.options.map((opt, i) => `
                <div class="option ${answers[currentQuestionIndex] === i ? 'selected' : ''}" onclick="selectOption(${i})">${opt}</div>
            `).join('');
            
            document.getElementById('prevBtn').classList.toggle('hidden', currentQuestionIndex === 0);
            document.getElementById('nextBtn').classList.toggle('hidden', currentQuestionIndex === currentTest.questions.length - 1);
            document.getElementById('submitBtn').classList.toggle('hidden', currentQuestionIndex !== currentTest.questions.length - 1);
        }

        function selectOption(index) {
            answers[currentQuestionIndex] = index;
            displayQuestion();
            updatePlayerProgress();
        }

        async function updatePlayerProgress() {
            const score = Object.entries(answers).filter(([qi, ai]) => currentTest.questions[parseInt(qi)].correct === ai).length;
            await db.ref('rooms/' + currentRoom + '/players/' + currentUser.code).update({
                score, 
                question: Object.keys(answers).length,
                answers: answers
            });
        }

        function prevQuestion() { 
            if (currentQuestionIndex > 0) { 
                currentQuestionIndex--; 
                displayQuestion(); 
            } 
        }
        
        function nextQuestion() { 
            if (currentQuestionIndex < currentTest.questions.length - 1) { 
                currentQuestionIndex++; 
                displayQuestion(); 
                updatePlayerProgress(); 
            } 
        }

        async function submitQuiz() {
            if (hasSubmitted) return;
            hasSubmitted = true;
            
            clearInterval(timerInterval);
            const score = Object.entries(answers).filter(([qi, ai]) => currentTest.questions[parseInt(qi)].correct === ai).length;
            
            await db.ref('rooms/' + currentRoom + '/players/' + currentUser.code).update({ 
                score, 
                done: true,
                answers: answers,
                submitTime: Date.now()
            });
            
            // Check if both players are done
            const roomSnap = await db.ref('rooms/' + currentRoom).once('value');
            const roomData = roomSnap.val();
            const players = Object.values(roomData.players);
            
            if (players.every(p => p.done)) {
                await db.ref('rooms/' + currentRoom + '/status').set('finished');
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                const mins = Math.floor(timeRemaining / 60);
                const secs = timeRemaining % 60;
                document.getElementById('timerDisplay').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                if (timeRemaining <= 0) submitQuiz();
            }, 1000);
        }

        function listenToRoom() {
            db.ref('rooms/' + currentRoom).on('value', async snap => {
                const room = snap.val();
                if (!room) return;
                
                const players = Object.entries(room.players);
                const me = players.find(p => p[0] === currentUser.code)[1];
                const opp = players.find(p => p[0] !== currentUser.code);
                
                document.getElementById('p1Score').textContent = me.score || 0;
                document.getElementById('p1Question').textContent = me.question || 0;
                document.getElementById('p2Score').textContent = opp[1].score || 0;
                document.getElementById('p2Question').textContent = opp[1].question || 0;
                
                if (room.status === 'finished') {
                    showResults(me, opp, room);
                }
            });
        }

        async function showResults(me, opp, roomData) {
            clearInterval(timerInterval);
            db.ref('rooms/' + currentRoom).off();
            
            if (peerConnection) { 
                peerConnection.close(); 
                peerConnection = null; 
            }
            if (localStream) { 
                localStream.getTracks().forEach(t => t.stop()); 
                localStream = null; 
            }
            
            document.getElementById('quiz').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            
            const myScore = me.score || 0;
            const oppScore = opp[1].score || 0;
            const won = myScore > oppScore;
            const draw = myScore === oppScore;
            const pointChange = draw ? 0 : (won ? 10 : -5);
            
            document.getElementById('resultIcon').className = 'result-icon ' + (draw ? 'draw' : (won ? 'win' : 'loss'));
            document.getElementById('resultIcon').innerHTML = `<i class="fas fa-${draw ? 'handshake' : (won ? 'trophy' : 'sad-tear')}"></i>`;
            document.getElementById('resultTitle').textContent = draw ? "It's a Draw!" : (won ? 'You Won!' : 'You Lost!');
            
            document.getElementById('resP1Name').textContent = currentUser.name;
            document.getElementById('resP1Score').textContent = myScore + '/' + currentTest.questions.length;
            document.getElementById('resP1Points').textContent = (pointChange >= 0 ? '+' : '') + pointChange + ' points';
            document.getElementById('resP1Points').className = 'points ' + (pointChange >= 0 ? 'positive' : 'negative');
            
            document.getElementById('resP2Name').textContent = opp[1].name;
            document.getElementById('resP2Score').textContent = oppScore + '/' + currentTest.questions.length;
            const oppPoints = draw ? 0 : (won ? -5 : 10);
            document.getElementById('resP2Points').textContent = (oppPoints >= 0 ? '+' : '') + oppPoints + ' points';
            document.getElementById('resP2Points').className = 'points ' + (oppPoints >= 0 ? 'positive' : 'negative');
            
            // Display answer review
            displayAnswerReview(me, opp);
            
            const newPoints = Math.max(0, (currentUser.points || 0) + pointChange);
            document.getElementById('newTotal').textContent = newPoints;
            
            const newRecord = {
                test: currentTest.name, 
                opponent: opp[1].name, 
                score: myScore, 
                total: currentTest.questions.length,
                result: draw ? 'draw' : (won ? 'win' : 'loss'), 
                date: new Date().toLocaleDateString()
            };
            
            await db.ref('users/' + currentUser.code).update({
                points: newPoints,
                wins: (currentUser.wins || 0) + (won && !draw ? 1 : 0),
                losses: (currentUser.losses || 0) + (!won && !draw ? 1 : 0),
                draws: (currentUser.draws || 0) + (draw ? 1 : 0),
                games: (currentUser.games || 0) + 1,
                records: [...(currentUser.records || []), newRecord]
            });
            
            currentUser.points = newPoints;
            currentUser.wins = (currentUser.wins || 0) + (won && !draw ? 1 : 0);
            currentUser.losses = (currentUser.losses || 0) + (!won && !draw ? 1 : 0);
            currentUser.draws = (currentUser.draws || 0) + (draw ? 1 : 0);
            currentUser.games = (currentUser.games || 0) + 1;
            currentUser.records = [...(currentUser.records || []), newRecord];
        }

        function displayAnswerReview(me, opp) {
            const myAnswers = me.answers || {};
            const oppAnswers = opp[1].answers || {};
            const oppName = opp[1].name;
            
            let html = '';
            
            currentTest.questions.forEach((question, index) => {
                const myAnswer = myAnswers[index];
                const oppAnswer = oppAnswers[index];
                const correctAnswer = question.correct;
                
                const myCorrect = myAnswer === correctAnswer;
                const oppCorrect = oppAnswer === correctAnswer;
                
                html += `
                    <div class="answer-item">
                        <div class="answer-question">
                            <span>Question ${index + 1}</span>
                            <p style="margin-top:8px;font-weight:500">${question.q}</p>
                        </div>
                        <div class="answer-options">
                            ${question.options.map((opt, i) => `
                                <div class="answer-option ${i === correctAnswer ? 'correct-answer' : ''}">
                                    ${i === correctAnswer ? '<i class="fas fa-check" style="color:#4ade80"></i>' : '<i class="fas fa-circle" style="opacity:0.3"></i>'}
                                    ${opt}
                                    ${i === correctAnswer ? '<span style="margin-left:auto;font-size:.8rem;opacity:.7">(Correct Answer)</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div class="player-answers">
                            <div class="player-answer ${myCorrect ? 'correct' : 'wrong'}">
                                <h5>${currentUser.name} (You)</h5>
                                <p>
                                    <i class="fas fa-${myCorrect ? 'check' : 'times'}"></i>
                                    ${myAnswer !== undefined ? question.options[myAnswer] : 'No answer'}
                                </p>
                            </div>
                            <div class="player-answer ${oppCorrect ? 'correct' : 'wrong'}">
                                <h5>${oppName}</h5>
                                <p>
                                    <i class="fas fa-${oppCorrect ? 'check' : 'times'}"></i>
                                    ${oppAnswer !== undefined ? question.options[oppAnswer] : 'No answer'}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('answersContainer').innerHTML = html;
        }

        function backToDashboard() {
            document.getElementById('results').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            currentRoom = null;
            updateDashboard();
        }

        function listenToLeaderboard() {
            db.ref('users').orderByChild('points').on('value', snap => {
                const users = [];
                snap.forEach(child => {
                    const userData = child.val();
                    users.push({
                        ...userData,
                        code: child.key
                    });
                });
                
                // Sort by points descending
                users.sort((a, b) => (b.points || 0) - (a.points || 0));
                
                const leaderboardEl = document.getElementById('leaderboard');
                
                if (users.length === 0) {
                    leaderboardEl.innerHTML = '<p style="text-align:center;opacity:.7">No players yet</p>';
                    return;
                }
                
                leaderboardEl.innerHTML = users.slice(0, 10).map((u, i) => `
                    <div class="leaderboard-item ${currentUser && u.code === currentUser.code ? 'current-user' : ''}">
                        <div class="rank ${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}">${i + 1}</div>
                        <div class="lb-info">
                            <h4>${u.name} ${currentUser && u.code === currentUser.code ? '(You)' : ''}</h4>
                            <p>${u.wins || 0}W - ${u.losses || 0}L - ${u.draws || 0}D</p>
                        </div>
                        <div class="lb-points">${u.points || 0} pts</div>
                    </div>
                `).join('');
            });
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark', darkMode);
            document.getElementById('themeIcon').className = 'fas fa-' + (darkMode ? 'sun' : 'moon');
            localStorage.setItem('darkMode', darkMode);
        }

        function logout() {
            db.ref('users/' + currentUser.code).off();
            db.ref('users').off();
            currentUser = null;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('auth').classList.remove('hidden');
            document.getElementById('loginCode').value = '';
        }

        // Voice Chat using WebRTC
        async function setupVoiceChat() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
                peerConnection = new RTCPeerConnection(config);
                
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                peerConnection.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];
                peerConnection.onicecandidate = e => {
                    if (e.candidate) db.ref('rooms/' + currentRoom + '/ice/' + currentUser.code).push(e.candidate.toJSON());
                };

                const players = Object.keys((await db.ref('rooms/' + currentRoom + '/players').once('value')).val());
                const isInitiator = players[0] === currentUser.code;
                
                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    await db.ref('rooms/' + currentRoom + '/offer').set(offer);
                    
                    db.ref('rooms/' + currentRoom + '/answer').on('value', async snap => {
                        if (snap.val() && peerConnection && !peerConnection.currentRemoteDescription) {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                        }
                    });
                } else {
                    db.ref('rooms/' + currentRoom + '/offer').on('value', async snap => {
                        if (snap.val() && peerConnection && !peerConnection.currentRemoteDescription) {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                            const answer = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);
                            await db.ref('rooms/' + currentRoom + '/answer').set(answer);
                        }
                    });
                }

                const oppCode = players.find(p => p !== currentUser.code);
                db.ref('rooms/' + currentRoom + '/ice/' + oppCode).on('child_added', snap => {
                    if (peerConnection) {
                        peerConnection.addIceCandidate(new RTCIceCandidate(snap.val()));
                    }
                });
            } catch (err) { 
                console.log('Voice chat error:', err); 
            }
        }

        function toggleMic() {
            micEnabled = !micEnabled;
            if (localStream) localStream.getAudioTracks().forEach(t => t.enabled = micEnabled);
            document.querySelector('#micBtn i').className = 'fas fa-microphone' + (micEnabled ? '' : '-slash');
        }

        function toggleSpeaker() {
            speakerEnabled = !speakerEnabled;
            document.getElementById('remoteAudio').muted = !speakerEnabled;
            document.querySelector('#speakerBtn i').className = 'fas fa-volume-' + (speakerEnabled ? 'up' : 'mute');
        }
    </script>
</body>
</html>