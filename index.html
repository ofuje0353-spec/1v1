<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofuje - Multiplayer CBT</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--bg:#f0f2f5;--card:#fff;--text:#1a1a2e;--text2:#666;--primary:#6366f1;--primary2:#4f46e5;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--shadow:0 4px 20px rgba(0,0,0,.1);--radius:16px}
        .dark{--bg:#0f0f23;--card:#1a1a2e;--text:#fff;--text2:#a0a0b0;--shadow:0 4px 20px rgba(0,0,0,.4)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Poppins',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:.3s}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .hidden{display:none!important}
        .card{background:var(--card);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);margin-bottom:20px}
        .btn{padding:12px 24px;border:none;border-radius:12px;cursor:pointer;font-weight:600;transition:.3s;font-size:14px}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(99,102,241,.4)}
        .btn-success{background:var(--success);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
        input,select{width:100%;padding:14px;border:2px solid transparent;border-radius:12px;background:var(--bg);color:var(--text);font-size:14px;transition:.3s}
        input:focus,select:focus{outline:none;border-color:var(--primary)}
        .input-group{margin-bottom:16px}
        .input-group label{display:block;margin-bottom:8px;font-weight:500;color:var(--text2)}
        
        /* Auth Page */
        .auth-page{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
        .auth-card{background:var(--card);border-radius:24px;padding:40px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
        .auth-card h1{text-align:center;margin-bottom:8px;font-size:32px;background:linear-gradient(135deg,var(--primary),#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .auth-card p{text-align:center;color:var(--text2);margin-bottom:24px}
        .tabs{display:flex;gap:8px;margin-bottom:24px}
        .tab{flex:1;padding:12px;text-align:center;border-radius:12px;cursor:pointer;font-weight:600;transition:.3s;background:var(--bg)}
        .tab.active{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff}
        .profile-upload{width:100px;height:100px;border-radius:50%;margin:0 auto 20px;border:3px dashed var(--primary);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative}
        .profile-upload img{width:100%;height:100%;object-fit:cover}
        .profile-upload i{font-size:32px;color:var(--primary)}
        
        /* Dashboard */
        .dashboard{padding:20px}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
        .user-info{display:flex;align-items:center;gap:16px}
        .user-avatar{width:50px;height:50px;border-radius:50%;object-fit:cover;border:3px solid var(--primary)}
        .user-name{font-weight:600;font-size:18px}
        .user-points{color:var(--primary);font-weight:700}
        .header-actions{display:flex;gap:12px;align-items:center}
        .icon-btn{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:var(--card);border:none;cursor:pointer;color:var(--text);transition:.3s;box-shadow:var(--shadow)}
        .icon-btn:hover{transform:scale(1.05);color:var(--primary)}
        
        /* Stats */
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
        .stat-card{background:linear-gradient(135deg,var(--primary),#a855f7);border-radius:var(--radius);padding:24px;color:#fff}
        .stat-card.success{background:linear-gradient(135deg,var(--success),#059669)}
        .stat-card.warning{background:linear-gradient(135deg,var(--warning),#d97706)}
        .stat-card.danger{background:linear-gradient(135deg,var(--danger),#dc2626)}
        .stat-value{font-size:32px;font-weight:700}
        .stat-label{opacity:.8;font-size:14px}
        
        /* Tests Grid */
        .tests-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
        .test-card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:.3s}
        .test-card:hover{transform:translateY(-4px)}
        .test-header{background:linear-gradient(135deg,var(--primary),#a855f7);padding:24px;color:#fff}
        .test-body{padding:20px}
        .test-title{font-size:20px;font-weight:700;margin-bottom:8px}
        .test-info{display:flex;gap:16px;margin:16px 0;color:var(--text2);font-size:13px}
        
        /* Modal */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;backdrop-filter:blur(4px)}
        .modal-content{background:var(--card);border-radius:var(--radius);width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:slideUp .3s}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{padding:20px;border-bottom:1px solid var(--bg);display:flex;justify-content:space-between;align-items:center}
        .modal-header h2{font-size:20px}
        .modal-body{padding:20px}
        .close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:var(--text2)}
        
        /* Quiz Page */
        .quiz-page{min-height:100vh;background:var(--bg)}
        .quiz-header{background:var(--card);padding:16px 24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;box-shadow:var(--shadow)}
        .timer{font-size:24px;font-weight:700;color:var(--danger)}
        .players-status{display:flex;gap:20px}
        .player-card{display:flex;align-items:center;gap:12px;background:var(--bg);padding:12px 16px;border-radius:12px}
        .player-card img{width:40px;height:40px;border-radius:50%;object-fit:cover}
        .player-card.you{border:2px solid var(--success)}
        .player-card.opponent{border:2px solid var(--warning)}
        .question-num{font-size:12px;color:var(--text2)}
        
        .quiz-content{max-width:800px;margin:40px auto;padding:20px}
        .question-card{background:var(--card);border-radius:var(--radius);padding:32px;box-shadow:var(--shadow)}
        .question-progress{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
        .q-dot{width:32px;height:32px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;cursor:pointer;transition:.3s}
        .q-dot.current{background:var(--primary);color:#fff}
        .q-dot.answered{background:var(--success);color:#fff}
        .question-text{font-size:18px;font-weight:500;margin-bottom:24px;line-height:1.6}
        .options{display:flex;flex-direction:column;gap:12px}
        .option{padding:16px 20px;border:2px solid var(--bg);border-radius:12px;cursor:pointer;transition:.3s;display:flex;align-items:center;gap:12px}
        .option:hover{border-color:var(--primary);background:rgba(99,102,241,.1)}
        .option.selected{border-color:var(--primary);background:rgba(99,102,241,.15)}
        .option-letter{width:32px;height:32px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-weight:600}
        .option.selected .option-letter{background:var(--primary);color:#fff}
        
        .quiz-nav{display:flex;justify-content:space-between;margin-top:24px}
        
        /* Chat */
        .chat-panel{position:fixed;right:20px;bottom:20px;width:350px;max-height:500px;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;z-index:100}
        .chat-header{padding:16px;border-bottom:1px solid var(--bg);display:flex;justify-content:space-between;align-items:center}
        .chat-messages{flex:1;padding:16px;overflow-y:auto;max-height:300px}
        .chat-message{margin-bottom:12px;max-width:80%}
        .chat-message.mine{margin-left:auto}
        .message-bubble{padding:10px 14px;border-radius:16px;font-size:14px}
        .chat-message.mine .message-bubble{background:var(--primary);color:#fff;border-bottom-right-radius:4px}
        .chat-message.other .message-bubble{background:var(--bg);border-bottom-left-radius:4px}
        .chat-input{padding:16px;border-top:1px solid var(--bg);display:flex;gap:8px}
        .chat-input input{flex:1}
        .emoji-picker{position:absolute;bottom:70px;right:16px;background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow);display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
        .emoji-picker span{font-size:20px;cursor:pointer;padding:4px;border-radius:4px;transition:.2s}
        .emoji-picker span:hover{background:var(--bg)}
        
        /* Voice Controls */
        .voice-controls{display:flex;gap:8px;padding:12px;border-top:1px solid var(--bg)}
        .voice-btn{flex:1;padding:10px;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;font-size:13px;transition:.3s}
        .voice-btn.active{background:var(--success);color:#fff}
        .voice-btn.muted{background:var(--danger);color:#fff}
        .voice-btn:not(.active):not(.muted){background:var(--bg)}
        
        /* Results */
        .results-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
        .results-card{background:var(--card);border-radius:24px;padding:40px;max-width:600px;width:100%;text-align:center;box-shadow:var(--shadow)}
        .result-icon{font-size:80px;margin-bottom:16px}
        .result-icon.win{color:#fbbf24}
        .result-icon.lose{color:#9ca3af}
        .results-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin:32px 0}
        .result-player{background:var(--bg);padding:24px;border-radius:16px}
        .result-player img{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:12px}
        .result-score{font-size:48px;font-weight:700;color:var(--primary)}
        .point-change{font-size:20px;font-weight:600;margin-top:8px}
        .point-change.positive{color:var(--success)}
        .point-change.negative{color:var(--danger)}
        
        /* Leaderboard */
        .leaderboard-list{max-height:400px;overflow-y:auto}
        .leaderboard-item{display:flex;align-items:center;gap:16px;padding:16px;border-bottom:1px solid var(--bg)}
        .rank{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
        .rank.gold{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#fff}
        .rank.silver{background:linear-gradient(135deg,#9ca3af,#6b7280);color:#fff}
        .rank.bronze{background:linear-gradient(135deg,#f97316,#ea580c);color:#fff}
        .leaderboard-item img{width:44px;height:44px;border-radius:50%;object-fit:cover}
        .lb-info{flex:1}
        .lb-name{font-weight:600}
        .lb-stats{font-size:12px;color:var(--text2)}
        .lb-points{font-weight:700;color:var(--primary)}
        
        /* Waiting Room */
        .waiting-room{text-align:center;padding:60px 20px}
        .waiting-animation{width:120px;height:120px;margin:0 auto 24px;position:relative}
        .waiting-animation::before{content:'';position:absolute;inset:0;border:4px solid var(--bg);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .waiting-users{display:flex;justify-content:center;gap:40px;margin-top:32px}
        .waiting-user{text-align:center}
        .waiting-user img{width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary)}
        .waiting-user .placeholder{width:80px;height:80px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;border:3px dashed var(--text2)}
        
        /* Admin */
        .admin-nav{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
        .admin-tab{padding:12px 20px;border-radius:12px;background:var(--bg);cursor:pointer;font-weight:500;transition:.3s}
        .admin-tab.active{background:var(--primary);color:#fff}
        .admin-table{width:100%;border-collapse:collapse}
        .admin-table th,.admin-table td{padding:14px;text-align:left;border-bottom:1px solid var(--bg)}
        .admin-table th{font-weight:600;color:var(--text2)}
        .admin-table img{width:40px;height:40px;border-radius:50%;object-fit:cover}
        .status-badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
        .status-badge.active{background:rgba(16,185,129,.2);color:var(--success)}
        .status-badge.restricted{background:rgba(239,68,68,.2);color:var(--danger)}
        
        /* Records */
        .record-item{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--bg)}
        .record-info{display:flex;align-items:center;gap:12px}
        .record-result{font-weight:700;padding:6px 14px;border-radius:8px}
        .record-result.win{background:rgba(16,185,129,.2);color:var(--success)}
        .record-result.loss{background:rgba(239,68,68,.2);color:var(--danger)}
        
        @media(max-width:768px){
            .chat-panel{right:10px;left:10px;width:auto}
            .results-grid{grid-template-columns:1fr}
            .players-status{flex-direction:column}
        }
    </style>
</head>
<body>
    <!-- Auth Page -->
    <div id="authPage" class="auth-page">
        <div class="auth-card">
            <h1>üéØ Ofuje</h1>
            <p>Multiplayer CBT Platform</p>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('login')">Login</div>
                <div class="tab" onclick="switchTab('register')">Register</div>
            </div>
            <div id="loginForm">
                <div class="input-group">
                    <label>Access Code</label>
                    <input type="text" id="loginCode" placeholder="Enter your access code">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="login()">Login</button>
                <p style="text-align:center;margin-top:16px;color:var(--text2)">
                    <a href="#" onclick="showAdminLogin()" style="color:var(--primary)">Admin Login</a>
                </p>
            </div>
            <div id="registerForm" class="hidden">
                <div class="profile-upload" onclick="document.getElementById('profileInput').click()">
                    <img id="profilePreview" class="hidden">
                    <i class="fas fa-camera"></i>
                </div>
                <input type="file" id="profileInput" accept="image/*" class="hidden" onchange="previewImage(this)">
                <div class="input-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your name">
                </div>
                <div class="input-group">
                    <label>Access Code</label>
                    <input type="text" id="regCode" placeholder="Create your access code">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="register()">Register</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard hidden">
        <div class="container">
            <div class="header">
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="">
                    <div>
                        <div id="userName" class="user-name">User</div>
                        <div id="userPoints" class="user-points">0 Points</div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
                    <button class="icon-btn" onclick="showLeaderboard()"><i class="fas fa-trophy"></i></button>
                    <button class="icon-btn" onclick="showRecords()"><i class="fas fa-history"></i></button>
                    <button class="icon-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card"><div class="stat-value" id="totalGames">0</div><div class="stat-label">Total Games</div></div>
                <div class="stat-card success"><div class="stat-value" id="wins">0</div><div class="stat-label">Wins</div></div>
                <div class="stat-card danger"><div class="stat-value" id="losses">0</div><div class="stat-label">Losses</div></div>
                <div class="stat-card warning"><div class="stat-value" id="rank">-</div><div class="stat-label">Rank</div></div>
            </div>

            <h2 style="margin-bottom:20px">Available Tests</h2>
            <div id="testsGrid" class="tests-grid"></div>
        </div>
    </div>

    <!-- Waiting Room -->
    <div id="waitingRoom" class="hidden">
        <div class="container">
            <div class="card waiting-room">
                <div class="waiting-animation"></div>
                <h2>Waiting for Opponent...</h2>
                <p style="color:var(--text2);margin-top:8px">Share the test code with a friend to start!</p>
                <div class="waiting-users">
                    <div class="waiting-user">
                        <img id="waitingUser1" src="">
                        <p id="waitingName1" style="margin-top:8px;font-weight:600">You</p>
                    </div>
                    <div class="waiting-user">
                        <div id="waitingUser2Placeholder" class="placeholder"><i class="fas fa-user-plus"></i></div>
                        <img id="waitingUser2" class="hidden" src="">
                        <p id="waitingName2" style="margin-top:8px;font-weight:600">Waiting...</p>
                    </div>
                </div>
                <button class="btn btn-outline" style="margin-top:32px" onclick="cancelWaiting()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Quiz Page -->
    <div id="quizPage" class="quiz-page hidden">
        <div class="quiz-header">
            <div style="display:flex;align-items:center;gap:16px">
                <h3 id="quizTitle">Test</h3>
                <div class="timer"><i class="fas fa-clock"></i> <span id="timerDisplay">60:00</span></div>
            </div>
            <div class="players-status">
                <div class="player-card you">
                    <img id="quizUserAvatar" src="">
                    <div>
                        <div id="quizUserName" style="font-weight:600">You</div>
                        <div class="question-num">Q<span id="myQuestionNum">1</span></div>
                    </div>
                </div>
                <div class="player-card opponent">
                    <img id="opponentAvatar" src="">
                    <div>
                        <div id="opponentName" style="font-weight:600">Opponent</div>
                        <div class="question-num">Q<span id="opponentQuestionNum">1</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="quiz-content">
            <div class="question-card">
                <div id="questionProgress" class="question-progress"></div>
                <div class="question-text" id="questionText">Question goes here?</div>
                <div id="optionsContainer" class="options"></div>
                <div class="quiz-nav">
                    <button class="btn btn-outline" onclick="prevQuestion()"><i class="fas fa-arrow-left"></i> Previous</button>
                    <button class="btn btn-primary" onclick="nextQuestion()">Next <i class="fas fa-arrow-right"></i></button>
                    <button class="btn btn-success" id="submitBtn" onclick="submitQuiz()"><i class="fas fa-check"></i> Submit</button>
                </div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div id="chatPanel" class="chat-panel hidden">
            <div class="chat-header">
                <span><i class="fas fa-comments"></i> Chat</span>
                <button class="close-btn" onclick="toggleChat()">√ó</button>
            </div>
            <div id="chatMessages" class="chat-messages"></div>
            <div id="emojiPicker" class="emoji-picker hidden">
                <span onclick="addEmoji('üòÄ')">üòÄ</span><span onclick="addEmoji('üòÇ')">üòÇ</span>
                <span onclick="addEmoji('üéâ')">üéâ</span><span onclick="addEmoji('üëç')">üëç</span>
                <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="addEmoji('üî•')">üî•</span>
                <span onclick="addEmoji('üí™')">üí™</span><span onclick="addEmoji('üèÜ')">üèÜ</span>
                <span onclick="addEmoji('üòé')">üòé</span><span onclick="addEmoji('ü§î')">ü§î</span>
                <span onclick="addEmoji('üëè')">üëè</span><span onclick="addEmoji('‚ú®')">‚ú®</span>
            </div>
            <div class="voice-controls">
                <button id="micBtn" class="voice-btn" onclick="toggleMic()"><i class="fas fa-microphone"></i> Mic</button>
                <button id="speakerBtn" class="voice-btn" onclick="toggleSpeaker()"><i class="fas fa-volume-up"></i> Speaker</button>
            </div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMessage()">
                <button class="icon-btn" onclick="toggleEmoji()"><i class="fas fa-smile"></i></button>
                <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <button id="chatToggle" class="icon-btn" style="position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;background:var(--primary);color:#fff" onclick="toggleChat()">
            <i class="fas fa-comments"></i>
        </button>
    </div>

    <!-- Results Page -->
    <div id="resultsPage" class="results-page hidden">
        <div class="results-card">
            <div id="resultIcon" class="result-icon win">üèÜ</div>
            <h1 id="resultTitle">Victory!</h1>
            <p id="resultSubtitle" style="color:var(--text2)">Congratulations on your win!</p>
            <div class="results-grid">
                <div class="result-player">
                    <img id="result1Avatar" src="">
                    <h3 id="result1Name">You</h3>
                    <div id="result1Score" class="result-score">0</div>
                    <div>Correct Answers</div>
                    <div id="result1Points" class="point-change positive">+10</div>
                    <div id="result1Total" style="margin-top:8px;color:var(--text2)">Total: 0 pts</div>
                </div>
                <div class="result-player">
                    <img id="result2Avatar" src="">
                    <h3 id="result2Name">Opponent</h3>
                    <div id="result2Score" class="result-score">0</div>
                    <div>Correct Answers</div>
                    <div id="result2Points" class="point-change negative">-5</div>
                    <div id="result2Total" style="margin-top:8px;color:var(--text2)">Total: 0 pts</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="backToDashboard()">Back to Dashboard</button>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="adminPage" class="dashboard hidden">
        <div class="container">
            <div class="header">
                <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
                    <button class="icon-btn" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
            <div class="admin-nav">
                <div class="admin-tab active" onclick="switchAdminTab('users')">Users</div>
                <div class="admin-tab" onclick="switchAdminTab('tests')">Tests</div>
                <div class="admin-tab" onclick="switchAdminTab('questions')">Questions</div>
            </div>
            <div id="adminContent" class="card"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Modal</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalBody" class="modal-body"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration - Replace with your config
        const firebaseConfig = {
apiKey: "AIzaSyDofEQ2jiMIXji7y-fGopDQcLY8dhixGk4",
  authDomain: "danz-66ffa.firebaseapp.com",
  projectId: "danz-66ffa",
  storageBucket: "danz-66ffa.firebasestorage.app",
  messagingSenderId: "570041531960",
  appId: "1:570041531960:web:24b77baa80aba9636c30cd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        // State
        let currentUser = null;
        let currentTest = null;
        let currentSession = null;
        let currentQuestion = 0;
        let answers = {};
        let timer = null;
        let timeLeft = 3600;
        let localStream = null;
        let micEnabled = false;
        let speakerEnabled = true;
        let peerConnection = null;

        // Default Tests with Questions (can add manually here)
        const defaultTests = {
            testA: {
                id: 'testA',
                name: 'General Knowledge',
                code: 'ABC123',
                duration: 3600,
                questions: [
                    { q: 'What is the capital of France?', options: ['London', 'Berlin', 'Paris', 'Madrid'], answer: 2 },
                    { q: 'What is 15 √ó 8?', options: ['100', '120', '130', '115'], answer: 1 }
                ]
            },
            testB: {
                id: 'testB',
                name: 'Science Quiz',
                code: 'XYZ789',
                duration: 3600,
                questions: [
                    { q: 'What is H2O commonly known as?', options: ['Salt', 'Water', 'Sugar', 'Oxygen'], answer: 1 },
                    { q: 'What planet is known as the Red Planet?', options: ['Venus', 'Jupiter', 'Mars', 'Saturn'], answer: 2 }
                ]
            }
        };

        // Initialize default data
        async function initDefaults() {
            const testsSnap = await db.ref('tests').once('value');
            if (!testsSnap.exists()) {
                await db.ref('tests').set(defaultTests);
            }
        }
        initDefaults();

        // Auth Functions
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        }

        function previewImage(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('profilePreview').src = e.target.result;
                    document.getElementById('profilePreview').classList.remove('hidden');
                    document.querySelector('.profile-upload i').classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const code = document.getElementById('regCode').value.trim();
            const file = document.getElementById('profileInput').files[0];
            
            if (!name || !code) return alert('Please fill all fields');
            
            const existing = await db.ref('users').orderByChild('code').equalTo(code).once('value');
            if (existing.exists()) return alert('Access code already exists');
            
            let photoURL = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(name) + '&background=6366f1&color=fff';
            
            if (file) {
                const ref = storage.ref('profiles/' + code);
                await ref.put(file);
                photoURL = await ref.getDownloadURL();
            }
            
            await db.ref('users/' + code).set({
                name, code, photoURL, points: 0, wins: 0, losses: 0, status: 'active', createdAt: Date.now()
            });
            
            alert('Registration successful! Please login.');
            switchTab('login');
            document.querySelector('.tab:first-child').click();
        }

        async function login() {
            const code = document.getElementById('loginCode').value.trim();
            if (!code) return alert('Enter access code');
            
            const snap = await db.ref('users/' + code).once('value');
            if (!snap.exists()) return alert('Invalid access code');
            
            const user = snap.val();
            if (user.status === 'restricted') return alert('Account restricted');
            
            currentUser = { ...user, code };
            localStorage.setItem('ofujeUser', code);
            showDashboard();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('ofujeUser');
            location.reload();
        }

        // Dashboard
        async function showDashboard() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('userAvatar').src = currentUser.photoURL;
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userPoints').textContent = currentUser.points + ' Points';
            document.getElementById('totalGames').textContent = (currentUser.wins || 0) + (currentUser.losses || 0);
            document.getElementById('wins').textContent = currentUser.wins || 0;
            document.getElementById('losses').textContent = currentUser.losses || 0;
            
            // Calculate rank
            const usersSnap = await db.ref('users').orderByChild('points').once('value');
            let rank = 1;
            const users = [];
            usersSnap.forEach(s => users.unshift(s.val()));
            users.forEach((u, i) => { if (u.code === currentUser.code) rank = i + 1; });
            document.getElementById('rank').textContent = '#' + rank;
            
            loadTests();
        }

        async function loadTests() {
            const snap = await db.ref('tests').once('value');
            const tests = snap.val() || {};
            const grid = document.getElementById('testsGrid');
            grid.innerHTML = '';
            
            Object.values(tests).forEach(test => {
                grid.innerHTML += `
                    <div class="test-card">
                        <div class="test-header">
                            <div class="test-title">${test.name}</div>
                            <div>${test.questions?.length || 0} Questions</div>
                        </div>
                        <div class="test-body">
                            <div class="test-info">
                                <span><i class="fas fa-clock"></i> 60 min</span>
                                <span><i class="fas fa-users"></i> Multiplayer</span>
                            </div>
                            <button class="btn btn-primary" style="width:100%" onclick="attemptTest('${test.id}')">Attempt Test</button>
                        </div>
                    </div>
                `;
            });
        }

        // Test Functions
        function attemptTest(testId) {
            document.getElementById('modalTitle').textContent = 'Enter Test Code';
            document.getElementById('modalBody').innerHTML = `
                <div class="input-group">
                    <label>6-Digit Alphanumeric Code</label>
                    <input type="text" id="testCodeInput" placeholder="e.g., ABC123" maxlength="6">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="verifyTestCode('${testId}')">Start Test</button>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        async function verifyTestCode(testId) {
            const code = document.getElementById('testCodeInput').value.toUpperCase();
            const snap = await db.ref('tests/' + testId).once('value');
            const test = snap.val();
            
            if (test.code !== code) return alert('Invalid test code');
            
            currentTest = { ...test, id: testId };
            closeModal();
            joinWaitingRoom();
        }

        async function joinWaitingRoom() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('waitingRoom').classList.remove('hidden');
            
            document.getElementById('waitingUser1').src = currentUser.photoURL;
            document.getElementById('waitingName1').textContent = currentUser.name;
            
            // Find or create session
            const sessionsRef = db.ref('sessions/' + currentTest.id);
            const waiting = await sessionsRef.orderByChild('status').equalTo('waiting').once('value');
            
            let sessionKey;
            if (waiting.exists()) {
                const sessions = waiting.val();
                sessionKey = Object.keys(sessions)[0];
                currentSession = { key: sessionKey, ...sessions[sessionKey] };
                
                await sessionsRef.child(sessionKey).update({
                    player2: currentUser.code,
                    player2Name: currentUser.name,
                    player2Photo: currentUser.photoURL,
                    status: 'active',
                    startTime: Date.now()
                });
            } else {
                const newSession = sessionsRef.push();
                sessionKey = newSession.key;
                await newSession.set({
                    testId: currentTest.id,
                    player1: currentUser.code,
                    player1Name: currentUser.name,
                    player1Photo: currentUser.photoURL,
                    status: 'waiting',
                    createdAt: Date.now()
                });
                currentSession = { key: sessionKey, player1: currentUser.code };
            }
            
            // Listen for opponent
            sessionsRef.child(sessionKey).on('value', snap => {
                const session = snap.val();
                if (!session) return;
                
                currentSession = { key: sessionKey, ...session };
                
                const isPlayer1 = session.player1 === currentUser.code;
                const opponent = isPlayer1 ? 
                    { name: session.player2Name, photo: session.player2Photo, code: session.player2 } :
                    { name: session.player1Name, photo: session.player1Photo, code: session.player1 };
                
                if (opponent.code) {
                    document.getElementById('waitingUser2Placeholder').classList.add('hidden');
                    document.getElementById('waitingUser2').classList.remove('hidden');
                    document.getElementById('waitingUser2').src = opponent.photo;
                    document.getElementById('waitingName2').textContent = opponent.name;
                }
                
                if (session.status === 'active') {
                    startQuiz(opponent);
                }
                
                if (session.status === 'completed') {
                    showResults();
                }
            });
        }

        function cancelWaiting() {
            if (currentSession?.key) {
                db.ref('sessions/' + currentTest.id + '/' + currentSession.key).remove();
            }
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            currentSession = null;
        }

        // Quiz Functions
        function startQuiz(opponent) {
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('quizPage').classList.remove('hidden');
            
            document.getElementById('quizTitle').textContent = currentTest.name;
            document.getElementById('quizUserAvatar').src = currentUser.photoURL;
            document.getElementById('quizUserName').textContent = currentUser.name;
            document.getElementById('opponentAvatar').src = opponent.photo;
            document.getElementById('opponentName').textContent = opponent.name;
            
            currentQuestion = 0;
            answers = {};
            timeLeft = currentTest.duration || 3600;
            
            renderQuestion();
            startTimer();
            listenToOpponent();
        }

        function renderQuestion() {
            const q = currentTest.questions[currentQuestion];
            document.getElementById('questionText').textContent = q.q;
            document.getElementById('myQuestionNum').textContent = currentQuestion + 1;
            
            // Progress dots
            let dots = '';
            currentTest.questions.forEach((_, i) => {
                const cls = i === currentQuestion ? 'current' : (answers[i] !== undefined ? 'answered' : '');
                dots += `<div class="q-dot ${cls}" onclick="goToQuestion(${i})">${i + 1}</div>`;
            });
            document.getElementById('questionProgress').innerHTML = dots;
            
            // Options
            const letters = ['A', 'B', 'C', 'D'];
            let opts = '';
            q.options.forEach((opt, i) => {
                const sel = answers[currentQuestion] === i ? 'selected' : '';
                opts += `<div class="option ${sel}" onclick="selectOption(${i})">
                    <div class="option-letter">${letters[i]}</div>
                    <div>${opt}</div>
                </div>`;
            });
            document.getElementById('optionsContainer').innerHTML = opts;
            
            // Update Firebase with current question
            const isPlayer1 = currentSession.player1 === currentUser.code;
            const field = isPlayer1 ? 'player1Q' : 'player2Q';
            db.ref('sessions/' + currentTest.id + '/' + currentSession.key).update({ [field]: currentQuestion + 1 });
        }

        function selectOption(idx) {
            answers[currentQuestion] = idx;
            renderQuestion();
        }

        function goToQuestion(idx) {
            currentQuestion = idx;
            renderQuestion();
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestion < currentTest.questions.length - 1) {
                currentQuestion++;
                renderQuestion();
            }
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('timerDisplay').textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                if (timeLeft <= 0) submitQuiz();
            }, 1000);
        }

        function listenToOpponent() {
            db.ref('sessions/' + currentTest.id + '/' + currentSession.key).on('value', snap => {
                const session = snap.val();
                if (!session) return;
                
                const isPlayer1 = session.player1 === currentUser.code;
                const opQ = isPlayer1 ? session.player2Q : session.player1Q;
                document.getElementById('opponentQuestionNum').textContent = opQ || 1;
                
                if (session.status === 'completed') {
                    showResults();
                }
            });
            
            // Listen for chat
            db.ref('chats/' + currentSession.key).on('child_added', snap => {
                const msg = snap.val();
                addChatMessage(msg.sender !== currentUser.code, msg.text, msg.senderName);
            });
        }

        async function submitQuiz() {
            clearInterval(timer);
            
            // Calculate score
            let score = 0;
            currentTest.questions.forEach((q, i) => {
                if (answers[i] === q.answer) score++;
            });
            
            const isPlayer1 = currentSession.player1 === currentUser.code;
            const updates = {
                status: 'completed',
                [isPlayer1 ? 'player1Score' : 'player2Score']: score,
                [isPlayer1 ? 'player1Answers' : 'player2Answers']: answers
            };
            
            await db.ref('sessions/' + currentTest.id + '/' + currentSession.key).update(updates);
        }

        async function showResults() {
            clearInterval(timer);
            
            const snap = await db.ref('sessions/' + currentTest.id + '/' + currentSession.key).once('value');
            const session = snap.val();
            
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('resultsPage').classList.remove('hidden');
            
            const isPlayer1 = session.player1 === currentUser.code;
            const myScore = isPlayer1 ? session.player1Score : session.player2Score;
            const opScore = isPlayer1 ? session.player2Score : session.player1Score;
            
            const won = myScore > opScore;
            const tie = myScore === opScore;
            
            document.getElementById('resultIcon').textContent = won ? 'üèÜ' : (tie ? 'ü§ù' : 'üò¢');
            document.getElementById('resultIcon').className = 'result-icon ' + (won ? 'win' : 'lose');
            document.getElementById('resultTitle').textContent = won ? 'Victory!' : (tie ? 'It\'s a Tie!' : 'Defeat');
            document.getElementById('resultSubtitle').textContent = won ? 'Congratulations!' : (tie ? 'Great match!' : 'Better luck next time!');
            
            document.getElementById('result1Avatar').src = currentUser.photoURL;
            document.getElementById('result1Name').textContent = currentUser.name;
            document.getElementById('result1Score').textContent = myScore;
            
            document.getElementById('result2Avatar').src = isPlayer1 ? session.player2Photo : session.player1Photo;
            document.getElementById('result2Name').textContent = isPlayer1 ? session.player2Name : session.player1Name;
            document.getElementById('result2Score').textContent = opScore;
            
            // Update points
            const pointChange = won ? 10 : (tie ? 0 : (currentUser.points >= 5 ? -5 : -currentUser.points));
            const newPoints = Math.max(0, currentUser.points + pointChange);
            
            await db.ref('users/' + currentUser.code).update({
                points: newPoints,
                wins: currentUser.wins + (won ? 1 : 0),
                losses: currentUser.losses + (!won && !tie ? 1 : 0)
            });
            
            // Save record
            await db.ref('records/' + currentUser.code).push({
                testId: currentTest.id,
                testName: currentTest.name,
                opponent: isPlayer1 ? session.player2Name : session.player1Name,
                myScore, opScore, result: won ? 'win' : (tie ? 'tie' : 'loss'),
                pointChange, date: Date.now()
            });
            
            document.getElementById('result1Points').textContent = (pointChange >= 0 ? '+' : '') + pointChange;
            document.getElementById('result1Points').className = 'point-change ' + (pointChange >= 0 ? 'positive' : 'negative');
            document.getElementById('result1Total').textContent = 'Total: ' + newPoints + ' pts';
            
            const opWon = opScore > myScore;
            const opPointChange = opWon ? 10 : (tie ? 0 : -5);
            document.getElementById('result2Points').textContent = (opPointChange >= 0 ? '+' : '') + opPointChange;
            document.getElementById('result2Points').className = 'point-change ' + (opPointChange >= 0 ? 'positive' : 'negative');
            
            currentUser.points = newPoints;
            currentUser.wins += won ? 1 : 0;
            currentUser.losses += (!won && !tie ? 1 : 0);
        }

        function backToDashboard() {
            document.getElementById('resultsPage').classList.add('hidden');
            currentSession = null;
            currentTest = null;
            showDashboard();
        }

        // Chat Functions
        function toggleChat() {
            document.getElementById('chatPanel').classList.toggle('hidden');
            document.getElementById('chatToggle').classList.toggle('hidden');
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentSession) return;
            
            db.ref('chats/' + currentSession.key).push({
                sender: currentUser.code,
                senderName: currentUser.name,
                text, time: Date.now()
            });
            input.value = '';
        }

        function addChatMessage(isOther, text, name) {
            const div = document.createElement('div');
            div.className = 'chat-message ' + (isOther ? 'other' : 'mine');
            div.innerHTML = `<div class="message-bubble">${isOther ? `<b>${name}:</b> ` : ''}${text}</div>`;
            document.getElementById('chatMessages').appendChild(div);
            document.getElementById('chatMessages').scrollTop = 999999;
        }

        function toggleEmoji() {
            document.getElementById('emojiPicker').classList.toggle('hidden');
        }

        function addEmoji(emoji) {
            document.getElementById('chatInput').value += emoji;
            document.getElementById('emojiPicker').classList.add('hidden');
        }

        // Voice Functions
        async function toggleMic() {
            const btn = document.getElementById('micBtn');
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    micEnabled = true;
                    btn.classList.add('active');
                    btn.classList.remove('muted');
                    setupWebRTC();
                } catch(e) {
                    alert('Microphone access denied');
                }
            } else {
                micEnabled = !micEnabled;
                localStream.getAudioTracks()[0].enabled = micEnabled;
                btn.classList.toggle('active', micEnabled);
                btn.classList.toggle('muted', !micEnabled);
            }
        }

        function toggleSpeaker() {
            speakerEnabled = !speakerEnabled;
            const btn = document.getElementById('speakerBtn');
            btn.classList.toggle('active', speakerEnabled);
            btn.classList.toggle('muted', !speakerEnabled);
            const audio = document.getElementById('remoteAudio');
            if (audio) audio.muted = !speakerEnabled;
        }

        async function setupWebRTC() {
            // Simplified WebRTC signaling through Firebase
            const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
            peerConnection = new RTCPeerConnection(config);
            
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            peerConnection.ontrack = event => {
                let audio = document.getElementById('remoteAudio');
                if (!audio) {
                    audio = document.createElement('audio');
                    audio.id = 'remoteAudio';
                    audio.autoplay = true;
                    document.body.appendChild(audio);
                }
                audio.srcObject = event.streams[0];
            };
            
            const isPlayer1 = currentSession.player1 === currentUser.code;
            const signalingRef = db.ref('signaling/' + currentSession.key);
            
            peerConnection.onicecandidate = e => {
                if (e.candidate) {
                    signalingRef.child(isPlayer1 ? 'ice1' : 'ice2').push(e.candidate.toJSON());
                }
            };
            
            if (isPlayer1) {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                signalingRef.child('offer').set(offer.toJSON());
                
                signalingRef.child('answer').on('value', async snap => {
                    if (snap.val() && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(snap.val());
                    }
                });
                
                signalingRef.child('ice2').on('child_added', snap => {
                    peerConnection.addIceCandidate(new RTCIceCandidate(snap.val()));
                });
            } else {
                signalingRef.child('offer').on('value', async snap => {
                    if (snap.val() && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(snap.val());
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        signalingRef.child('answer').set(answer.toJSON());
                    }
                });
                
                signalingRef.child('ice1').on('child_added', snap => {
                    peerConnection.addIceCandidate(new RTCIceCandidate(snap.val()));
                });
            }
        }

        // Leaderboard & Records
        async function showLeaderboard() {
            const snap = await db.ref('users').orderByChild('points').once('value');
            const users = [];
            snap.forEach(s => users.unshift({ ...s.val(), code: s.key }));
            
            let html = '<div class="leaderboard-list">';
            users.forEach((u, i) => {
                const rankClass = i === 0 ? 'gold' : (i === 1 ? 'silver' : (i === 2 ? 'bronze' : ''));
                html += `<div class="leaderboard-item">
                    <div class="rank ${rankClass}">${i + 1}</div>
                    <img src="${u.photoURL}">
                    <div class="lb-info">
                        <div class="lb-name">${u.name}</div>
                        <div class="lb-stats">${u.wins || 0}W - ${u.losses || 0}L</div>
                    </div>
                    <div class="lb-points">${u.points || 0} pts</div>
                </div>`;
            });
            html += '</div>';
            
            document.getElementById('modalTitle').textContent = 'üèÜ Leaderboard';
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modal').classList.remove('hidden');
        }

        async function showRecords() {
            const snap = await db.ref('records/' + currentUser.code).orderByChild('date').once('value');
            const records = [];
            snap.forEach(s => records.unshift(s.val()));
            
            let html = records.length ? '' : '<p style="text-align:center;color:var(--text2)">No records yet</p>';
            records.forEach(r => {
                html += `<div class="record-item">
                    <div class="record-info">
                        <div>
                            <div style="font-weight:600">${r.testName}</div>
                            <div style="font-size:12px;color:var(--text2)">vs ${r.opponent} ‚Ä¢ ${r.myScore}-${r.opScore}</div>
                        </div>
                    </div>
                    <div class="record-result ${r.result}">${r.result.toUpperCase()} (${r.pointChange >= 0 ? '+' : ''}${r.pointChange})</div>
                </div>`;
            });
            
            document.getElementById('modalTitle').textContent = 'üìú My Records';
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', document.body.classList.contains('dark'));
        }

        // Admin Functions
        function showAdminLogin() {
            document.getElementById('modalTitle').textContent = 'Admin Login';
            document.getElementById('modalBody').innerHTML = `
                <div class="input-group">
                    <label>Admin Password</label>
                    <input type="password" id="adminPass" placeholder="Enter admin password">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="adminLogin()">Login</button>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        async function adminLogin() {
            const pass = document.getElementById('adminPass').value;
            const snap = await db.ref('admin/password').once('value');
            
            // Default admin password: admin123
            const adminPass = snap.val() || 'admin123';
            if (pass !== adminPass) return alert('Invalid password');
            
            closeModal();
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
            loadAdminUsers();
        }

        function logoutAdmin() {
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('authPage').classList.remove('hidden');
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            if (tab === 'users') loadAdminUsers();
            else if (tab === 'tests') loadAdminTests();
            else loadAdminQuestions();
        }

        async function loadAdminUsers() {
            const snap = await db.ref('users').once('value');
            const users = snap.val() || {};
            
            let html = `<table class="admin-table">
                <tr><th>Photo</th><th>Name</th><th>Code</th><th>Points</th><th>Status</th><th>Actions</th></tr>`;
            
            Object.entries(users).forEach(([code, u]) => {
                html += `<tr>
                    <td><img src="${u.photoURL}"></td>
                    <td>${u.name}</td>
                    <td>${code}</td>
                    <td>${u.points || 0}</td>
                    <td><span class="status-badge ${u.status}">${u.status}</span></td>
                    <td>
                        <button class="btn btn-outline" onclick="toggleUserStatus('${code}','${u.status}')">${u.status === 'active' ? 'Restrict' : 'Activate'}</button>
                        <button class="btn btn-danger" onclick="deleteUser('${code}')">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</table>';
            document.getElementById('adminContent').innerHTML = html;
        }

        async function toggleUserStatus(code, status) {
            await db.ref('users/' + code + '/status').set(status === 'active' ? 'restricted' : 'active');
            loadAdminUsers();
        }

        async function deleteUser(code) {
            if (!confirm('Delete this user?')) return;
            await db.ref('users/' + code).remove();
            await db.ref('records/' + code).remove();
            loadAdminUsers();
        }

        async function loadAdminTests() {
            const snap = await db.ref('tests').once('value');
            const tests = snap.val() || {};
            
            let html = `<button class="btn btn-primary" style="margin-bottom:16px" onclick="showAddTest()"><i class="fas fa-plus"></i> Add Test</button>
                <table class="admin-table">
                <tr><th>Name</th><th>Code</th><th>Questions</th><th>Actions</th></tr>`;
            
            Object.entries(tests).forEach(([id, t]) => {
                html += `<tr>
                    <td>${t.name}</td>
                    <td>${t.code}</td>
                    <td>${t.questions?.length || 0}</td>
                    <td>
                        <button class="btn btn-outline" onclick="editTest('${id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteTest('${id}')">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</table>';
            document.getElementById('adminContent').innerHTML = html;
        }

        function showAddTest() {
            document.getElementById('modalTitle').textContent = 'Add Test';
            document.getElementById('modalBody').innerHTML = `
                <div class="input-group">
                    <label>Test Name</label>
                    <input type="text" id="testName" placeholder="e.g., Math Quiz">
                </div>
                <div class="input-group">
                    <label>Test Code (6 characters)</label>
                    <input type="text" id="testCode" placeholder="e.g., MTH001" maxlength="6">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="addTest()">Add Test</button>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        async function addTest() {
            const name = document.getElementById('testName').value.trim();
            const code = document.getElementById('testCode').value.toUpperCase().trim();
            if (!name || !code) return alert('Fill all fields');
            
            const id = 'test' + Date.now();
            await db.ref('tests/' + id).set({ id, name, code, questions: [], duration: 3600 });
            closeModal();
            loadAdminTests();
        }

        async function deleteTest(id) {
            if (!confirm('Delete this test?')) return;
            await db.ref('tests/' + id).remove();
            loadAdminTests();
        }

        async function loadAdminQuestions() {
            const snap = await db.ref('tests').once('value');
            const tests = snap.val() || {};
            
            let html = `<div class="input-group">
                <label>Select Test</label>
                <select id="questionTestSelect" onchange="loadQuestionsForTest()">
                    <option value="">Select a test</option>
                    ${Object.entries(tests).map(([id, t]) => `<option value="${id}">${t.name}</option>`).join('')}
                </select>
            </div>
            <div id="questionsContainer"></div>`;
            
            document.getElementById('adminContent').innerHTML = html;
        }

        async function loadQuestionsForTest() {
            const testId = document.getElementById('questionTestSelect').value;
            if (!testId) return;
            
            const snap = await db.ref('tests/' + testId + '/questions').once('value');
            const questions = snap.val() || [];
            
            let html = `<button class="btn btn-primary" style="margin-bottom:16px" onclick="showAddQuestion('${testId}')"><i class="fas fa-plus"></i> Add Question</button>
                <table class="admin-table">
                <tr><th>#</th><th>Question</th><th>Answer</th><th>Actions</th></tr>`;
            
            questions.forEach((q, i) => {
                html += `<tr>
                    <td>${i + 1}</td>
                    <td>${q.q.substring(0, 50)}...</td>
                    <td>${q.options[q.answer]}</td>
                    <td><button class="btn btn-danger" onclick="deleteQuestion('${testId}',${i})">Delete</button></td>
                </tr>`;
            });
            html += '</table>';
            document.getElementById('questionsContainer').innerHTML = html;
        }

        function showAddQuestion(testId) {
            document.getElementById('modalTitle').textContent = 'Add Question';
            document.getElementById('modalBody').innerHTML = `
                <div class="input-group">
                    <label>Question</label>
                    <input type="text" id="qQuestion" placeholder="Enter question">
                </div>
                <div class="input-group">
                    <label>Option A</label>
                    <input type="text" id="qOptA" placeholder="Option A">
                </div>
                <div class="input-group">
                    <label>Option B</label>
                    <input type="text" id="qOptB" placeholder="Option B">
                </div>
                <div class="input-group">
                    <label>Option C</label>
                    <input type="text" id="qOptC" placeholder="Option C">
                </div>
                <div class="input-group">
                    <label>Option D</label>
                    <input type="text" id="qOptD" placeholder="Option D">
                </div>
                <div class="input-group">
                    <label>Correct Answer</label>
                    <select id="qAnswer">
                        <option value="0">A</option>
                        <option value="1">B</option>
                        <option value="2">C</option>
                        <option value="3">D</option>
                    </select>
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="addQuestion('${testId}')">Add Question</button>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        async function addQuestion(testId) {
            const q = document.getElementById('qQuestion').value;
            const options = [
                document.getElementById('qOptA').value,
                document.getElementById('qOptB').value,
                document.getElementById('qOptC').value,
                document.getElementById('qOptD').value
            ];
            const answer = parseInt(document.getElementById('qAnswer').value);
            
            if (!q || options.some(o => !o)) return alert('Fill all fields');
            
            const snap = await db.ref('tests/' + testId + '/questions').once('value');
            const questions = snap.val() || [];
            questions.push({ q, options, answer });
            
            await db.ref('tests/' + testId + '/questions').set(questions);
            closeModal();
            loadQuestionsForTest();
        }

        async function deleteQuestion(testId, index) {
            if (!confirm('Delete this question?')) return;
            const snap = await db.ref('tests/' + testId + '/questions').once('value');
            const questions = snap.val() || [];
            questions.splice(index, 1);
            await db.ref('tests/' + testId + '/questions').set(questions);
            loadQuestionsForTest();
        }

        // Init
        (async function init() {
            if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark');
            
            const savedCode = localStorage.getItem('ofujeUser');
            if (savedCode) {
                const snap = await db.ref('users/' + savedCode).once('value');
                if (snap.exists()) {
                    currentUser = { ...snap.val(), code: savedCode };
                    showDashboard();
                }
            }
        })();
    </script>
</body>
</html>