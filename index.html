<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofuje - Multiplayer CBT</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dark {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: var(--transition);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }
        .card:hover { box-shadow: var(--shadow-lg); }
        .input-group { margin-bottom: 16px; }
        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px;
            background: var(--card);
            color: var(--text);
            transition: var(--transition);
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        /* Auth Page */
        #authPage {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            padding: 20px;
        }
        .auth-container {
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
            color: white;
        }
        .auth-logo h1 { font-size: 48px; font-weight: 700; }
        .auth-logo p { opacity: 0.9; margin-top: 8px; }
        .auth-card { background: var(--card); border-radius: 20px; padding: 40px; }
        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            background: var(--bg);
            border-radius: var(--radius);
            padding: 4px;
        }
        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
        }
        .auth-tab.active { background: var(--primary); color: white; }
        .admin-link {
            text-align: center;
            margin-top: 16px;
            color: white;
            opacity: 0.8;
            cursor: pointer;
        }
        .admin-link:hover { opacity: 1; }
        /* Dashboard */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--card);
            border-radius: var(--radius);
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        .user-info { display: flex; align-items: center; gap: 16px; }
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }
        .user-details h3 { font-size: 18px; }
        .user-details span { color: var(--text-secondary); font-size: 14px; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .theme-toggle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--card);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: var(--transition);
        }
        .theme-toggle:hover { border-color: var(--primary); color: var(--primary); }
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 12px 20px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-tab:hover, .nav-tab.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        /* Tests Grid */
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .test-card {
            position: relative;
            overflow: hidden;
        }
        .test-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        .test-card h3 { margin-bottom: 12px; font-size: 20px; }
        .test-card p { color: var(--text-secondary); margin-bottom: 16px; }
        .test-meta { display: flex; gap: 16px; margin-bottom: 16px; font-size: 14px; color: var(--text-secondary); }
        .test-meta span { display: flex; align-items: center; gap: 6px; }
        /* Leaderboard */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .leaderboard-table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 13px;
            text-transform: uppercase;
        }
        .leaderboard-table tr:hover { background: var(--bg); }
        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; }
        .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: white; }
        .rank-3 { background: linear-gradient(135deg, #fb923c, #ea580c); color: white; }
        .current-user { background: var(--primary) !important; color: white; }
        /* Waiting Room */
        #waitingRoom {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            padding: 20px;
        }
        .waiting-content { text-align: center; }
        .waiting-animation {
            width: 120px;
            height: 120px;
            margin: 0 auto 24px;
            position: relative;
        }
        .waiting-animation::before, .waiting-animation::after {
            content: '';
            position: absolute;
            border: 4px solid var(--primary);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        .waiting-animation::before { inset: 0; }
        .waiting-animation::after { inset: 20px; animation-delay: 0.5s; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.5; }
        }
        .waiting-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: var(--primary);
        }
        /* Quiz Page */
        #quizPage {
            min-height: 100vh;
            background: var(--bg);
            padding: 20px;
        }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--card);
            border-radius: var(--radius);
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .timer {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .timer.warning { color: var(--warning); }
        .timer.danger { color: var(--danger); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .players-status {
            display: flex;
            gap: 24px;
        }
        .player-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg);
            border-radius: var(--radius);
        }
        .player-status .avatar { width: 36px; height: 36px; font-size: 14px; }
        .player-status .question-indicator {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .quiz-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }
        @media (max-width: 900px) {
            .quiz-content { grid-template-columns: 1fr; }
        }
        .question-card { padding: 32px; }
        .question-number {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        .question-text {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        .options-list { display: flex; flex-direction: column; gap: 12px; }
        .option-item {
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .option-item:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
        .option-item.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .option-item.selected .option-letter { background: var(--primary); color: white; }
        .question-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
        }
        /* Chat Panel */
        .chat-panel { display: flex; flex-direction: column; gap: 16px; }
        .voice-controls {
            display: flex;
            gap: 12px;
        }
        .voice-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--card);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
        }
        .voice-btn:hover { border-color: var(--primary); }
        .voice-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .voice-btn.muted { background: var(--danger); color: white; border-color: var(--danger); }
        .chat-messages {
            flex: 1;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
        }
        .chat-message.sent {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message.received {
            align-self: flex-start;
            background: var(--card);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }
        .chat-input-area { display: flex; gap: 8px; }
        .chat-input-area input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--card);
            color: var(--text);
        }
        .emoji-picker {
            position: relative;
        }
        .emoji-btn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--card);
            cursor: pointer;
            font-size: 18px;
        }
        .emoji-panel {
            position: absolute;
            bottom: 50px;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            box-shadow: var(--shadow-lg);
        }
        .emoji-panel span {
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }
        .emoji-panel span:hover { background: var(--bg); }
        /* Results Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        .modal {
            background: var(--card);
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            animation: modalIn 0.3s ease;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }
        .result-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        .result-icon.win { background: linear-gradient(135deg, var(--secondary), #059669); color: white; }
        .result-icon.lose { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .result-icon.draw { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }
        .results-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
            margin: 24px 0;
        }
        .result-player { text-align: center; }
        .result-player .avatar { width: 60px; height: 60px; font-size: 24px; margin: 0 auto 12px; }
        .result-player .score { font-size: 32px; font-weight: 700; color: var(--primary); }
        .result-player .points-change { font-size: 14px; margin-top: 8px; }
        .result-player .points-change.positive { color: var(--secondary); }
        .result-player .points-change.negative { color: var(--danger); }
        .vs-badge {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-secondary);
        }
        /* Records */
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .record-item:last-child { border-bottom: none; }
        .record-info { display: flex; align-items: center; gap: 12px; }
        .record-result {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .record-result.win { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .record-result.lose { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        /* Settings */
        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }
        .settings-section:last-child { border-bottom: none; }
        .settings-section h3 {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* Admin */
        .admin-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .admin-card { margin-bottom: 16px; }
        .admin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .admin-actions { display: flex; gap: 8px; }
        .admin-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 16px 20px;
            border-radius: var(--radius);
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastIn 0.3s ease;
            min-width: 280px;
            box-shadow: var(--shadow-lg);
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .toast.success { background: var(--secondary); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--primary); }
        .toast.warning { background: var(--warning); }
        /* Question Grid */
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 16px;
        }
        .question-dot {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        .question-dot:hover { border-color: var(--primary); }
        .question-dot.answered { background: var(--primary); color: white; border-color: var(--primary); }
        .question-dot.current { border-color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            padding: 20px;
            text-align: center;
        }
        .stat-value { font-size: 32px; font-weight: 700; color: var(--primary); }
        .stat-label { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-header { flex-direction: column; text-align: center; }
            .header-actions { flex-wrap: wrap; justify-content: center; }
            .quiz-header { flex-direction: column; }
            .players-status { flex-direction: column; gap: 12px; }
            .modal { padding: 20px; }
        }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
    </style>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>

    <!-- Auth Page -->
    <div id="authPage">
        <div class="auth-container">
            <div class="auth-logo">
                <h1><i class="fas fa-graduation-cap"></i> Ofuje</h1>
                <p>Multiplayer CBT Platform</p>
            </div>
            <div class="auth-card card">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
                </div>
                <div id="loginForm">
                    <div class="input-group">
                        <label>Access Code</label>
                        <input type="text" id="loginCode" placeholder="Enter your access code">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="login()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
                <div id="registerForm" class="hidden">
                    <div class="input-group">
                        <label>Full Name</label>
                        <input type="text" id="regName" placeholder="Enter your full name">
                    </div>
                    <div class="input-group">
                        <label>School</label>
                        <input type="text" id="regSchool" placeholder="Enter your school">
                    </div>
                    <div class="input-group">
                        <label>Preferred Access Code</label>
                        <input type="text" id="regCode" placeholder="Create a unique access code">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="register()">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                </div>
            </div>
            <p class="admin-link" onclick="showAdminLogin()">
                <i class="fas fa-lock"></i> Admin Access
            </p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="hidden">
        <div class="container">
            <div class="dashboard-header">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <h3 id="userName">User Name</h3>
                        <span id="userSchool">School Name</span>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="stat-card card" style="padding: 10px 20px; margin: 0;">
                        <span style="color: var(--text-secondary);">Points:</span>
                        <span id="userPoints" style="font-weight: 700; color: var(--primary); margin-left: 8px;">0</span>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    <button class="btn btn-outline" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('tests')">
                    <i class="fas fa-clipboard-list"></i> Tests
                </button>
                <button class="nav-tab" onclick="switchTab('leaderboard')">
                    <i class="fas fa-trophy"></i> Leaderboard
                </button>
                <button class="nav-tab" onclick="switchTab('records')">
                    <i class="fas fa-history"></i> My Records
                </button>
                <button class="nav-tab" onclick="switchTab('users')">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="nav-tab" onclick="switchTab('settings')">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>

            <!-- Tests Tab -->
            <div id="testsTab">
                <h2 style="margin-bottom: 20px;">Available Tests</h2>
                <div class="tests-grid" id="testsGrid"></div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboardTab" class="hidden">
                <div class="card">
                    <h2 style="margin-bottom: 20px;"><i class="fas fa-trophy" style="color: var(--warning);"></i> Leaderboard</h2>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>School</th>
                                <th>Points</th>
                                <th>Matches</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Records Tab -->
            <div id="recordsTab" class="hidden">
                <div class="stats-grid">
                    <div class="stat-card card">
                        <div class="stat-value" id="totalMatches">0</div>
                        <div class="stat-label">Total Matches</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-value" id="totalWins">0</div>
                        <div class="stat-label">Wins</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-value" id="totalLosses">0</div>
                        <div class="stat-label">Losses</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-value" id="winRate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 16px;">Match History</h3>
                    <div id="recordsList"></div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="hidden">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">All Users</h2>
                    <div id="usersList"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="hidden">
                <div class="card">
                    <div class="settings-section">
                        <h3><i class="fas fa-user"></i> Profile Settings</h3>
                        <div class="input-group">
                            <label>Name</label>
                            <input type="text" id="settingsName">
                        </div>
                        <div class="input-group">
                            <label>Access Code</label>
                            <input type="text" id="settingsCode">
                        </div>
                        <button class="btn btn-primary" onclick="updateProfile()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                    <div class="settings-section">
                        <h3><i class="fas fa-trash"></i> Danger Zone</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">
                            Permanently delete your account and all associated data.
                        </p>
                        <button class="btn btn-danger" onclick="deleteAccount()">
                            <i class="fas fa-trash"></i> Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Code Modal -->
    <div id="testCodeModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 id="testCodeTitle">Enter Test Code</h2>
                <p style="color: var(--text-secondary); margin-top: 8px;">
                    Enter the 6-digit alphanumeric code to start the test
                </p>
            </div>
            <div class="input-group">
                <input type="text" id="testCodeInput" maxlength="6" placeholder="Enter test code" style="text-align: center; font-size: 24px; letter-spacing: 8px;">
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-outline" onclick="closeTestCodeModal()" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="submitTestCode()" style="flex: 1;">
                    <i class="fas fa-play"></i> Start Test
                </button>
            </div>
        </div>
    </div>

    <!-- Waiting Room -->
    <div id="waitingRoom" class="hidden">
        <div class="waiting-content">
            <div class="waiting-animation">
                <i class="fas fa-users waiting-icon"></i>
            </div>
            <h2>Waiting for Opponent</h2>
            <p style="color: var(--text-secondary); margin: 16px 0;">Looking for another player to join...</p>
            <div class="card" style="margin-top: 24px; text-align: left;">
                <p><strong>Test:</strong> <span id="waitingTestName"></span></p>
                <p style="margin-top: 8px;"><strong>Session ID:</strong> <span id="waitingSessionId"></span></p>
            </div>
            <button class="btn btn-outline" style="margin-top: 24px;" onclick="cancelWaiting()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>

    <!-- Quiz Page -->
    <div id="quizPage" class="hidden">
        <div class="container">
            <div class="quiz-header">
                <div class="timer" id="quizTimer">
                    <i class="fas fa-clock"></i>
                    <span>60:00</span>
                </div>
                <div class="players-status">
                    <div class="player-status">
                        <div class="avatar" id="player1Avatar">U</div>
                        <div>
                            <div id="player1Name">You</div>
                            <div class="question-indicator">Q<span id="player1Question">1</span></div>
                        </div>
                    </div>
                    <span style="font-weight: 700; color: var(--text-secondary);">VS</span>
                    <div class="player-status">
                        <div class="avatar" id="player2Avatar" style="background: linear-gradient(135deg, var(--secondary), #059669);">O</div>
                        <div>
                            <div id="player2Name">Opponent</div>
                            <div class="question-indicator">Q<span id="player2Question">1</span></div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="submitQuiz()">
                    <i class="fas fa-paper-plane"></i> Submit
                </button>
            </div>

            <div class="quiz-content">
                <div class="question-card card">
                    <div class="question-number">Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">2</span></div>
                    <div class="question-text" id="questionText">Loading question...</div>
                    <div class="options-list" id="optionsList"></div>
                    <div class="question-nav">
                        <button class="btn btn-outline" id="prevBtn" onclick="prevQuestion()">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div class="chat-panel">
                    <div class="card">
                        <h4 style="margin-bottom: 12px;"><i class="fas fa-microphone"></i> Voice Chat</h4>
                        <div class="voice-controls">
                            <button class="voice-btn" id="micBtn" onclick="toggleMic()">
                                <i class="fas fa-microphone"></i> Mic
                            </button>
                            <button class="voice-btn" id="speakerBtn" onclick="toggleSpeaker()">
                                <i class="fas fa-volume-up"></i> Speaker
                            </button>
                        </div>
                    </div>

                    <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                        <h4 style="margin-bottom: 12px;"><i class="fas fa-comments"></i> Chat</h4>
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-input-area">
                            <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMessage()">
                            <div class="emoji-picker">
                                <button class="emoji-btn" onclick="toggleEmojiPanel()">üòÄ</button>
                                <div class="emoji-panel hidden" id="emojiPanel">
                                    <span onclick="insertEmoji('üòÄ')">üòÄ</span>
                                    <span onclick="insertEmoji('üòÇ')">üòÇ</span>
                                    <span onclick="insertEmoji('üéâ')">üéâ</span>
                                    <span onclick="insertEmoji('üëç')">üëç</span>
                                    <span onclick="insertEmoji('üëè')">üëè</span>
                                    <span onclick="insertEmoji('üî•')">üî•</span>
                                    <span onclick="insertEmoji('üí™')">üí™</span>
                                    <span onclick="insertEmoji('ü§î')">ü§î</span>
                                    <span onclick="insertEmoji('üòÖ')">üòÖ</span>
                                    <span onclick="insertEmoji('üôè')">üôè</span>
                                    <span onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                                    <span onclick="insertEmoji('‚ú®')">‚ú®</span>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="sendMessage()" style="padding: 12px;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h4 style="margin-bottom: 12px;">Questions</h4>
                        <div class="questions-grid" id="questionsGrid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div class="result-icon" id="resultIcon">
                    <i class="fas fa-trophy"></i>
                </div>
                <h2 id="resultTitle">Quiz Complete!</h2>
                <p id="resultSubtitle" style="color: var(--text-secondary);"></p>
            </div>
            <div class="results-comparison">
                <div class="result-player">
                    <div class="avatar" id="result1Avatar">U</div>
                    <div id="result1Name">You</div>
                    <div class="score" id="result1Score">0</div>
                    <div class="points-change" id="result1Points">+0 points</div>
                </div>
                <div class="vs-badge">VS</div>
                <div class="result-player">
                    <div class="avatar" id="result2Avatar" style="background: linear-gradient(135deg, var(--secondary), #059669);">O</div>
                    <div id="result2Name">Opponent</div>
                    <div class="score" id="result2Score">0</div>
                    <div class="points-change" id="result2Points">+0 points</div>
                </div>
            </div>
            <div style="text-align: center; padding: 16px; background: var(--bg); border-radius: var(--radius); margin-bottom: 20px;">
                <span style="color: var(--text-secondary);">Your Total Points:</span>
                <span id="resultTotalPoints" style="font-size: 24px; font-weight: 700; color: var(--primary); margin-left: 8px;">0</span>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="closeResults()">
                <i class="fas fa-home"></i> Back to Dashboard
            </button>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="adminPage" class="hidden">
        <div class="container">
            <div class="dashboard-header">
                <div class="user-info">
                    <div class="avatar" style="background: var(--danger);"><i class="fas fa-shield-alt"></i></div>
                    <div class="user-details">
                        <h3>Admin Panel</h3>
                        <span>Manage Ofuje Platform</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon" id="themeIcon2"></i>
                    </button>
                    <button class="btn btn-outline" onclick="adminLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <div class="admin-tabs">
                <button class="nav-tab active" onclick="switchAdminTab('users')">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="nav-tab" onclick="switchAdminTab('tests')">
                    <i class="fas fa-clipboard-list"></i> Tests
                </button>
                <button class="nav-tab" onclick="switchAdminTab('questions')">
                    <i class="fas fa-question-circle"></i> Questions
                </button>
            </div>

            <!-- Admin Users -->
            <div id="adminUsersTab">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">All Users</h3>
                    <div id="adminUsersList"></div>
                </div>
            </div>

            <!-- Admin Tests -->
            <div id="adminTestsTab" class="hidden">
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 16px;">Add New Test</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="input-group" style="margin: 0;">
                            <label>Test Name</label>
                            <input type="text" id="newTestName" placeholder="Test name">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Test Code (6 chars)</label>
                            <input type="text" id="newTestCode" maxlength="6" placeholder="ABC123">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Description</label>
                            <input type="text" id="newTestDesc" placeholder="Description">
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 16px;" onclick="addTest()">
                        <i class="fas fa-plus"></i> Add Test
                    </button>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 20px;">All Tests</h3>
                    <div id="adminTestsList"></div>
                </div>
            </div>

            <!-- Admin Questions -->
            <div id="adminQuestionsTab" class="hidden">
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 16px;">Add New Question</h3>
                    <div class="input-group">
                        <label>Select Test</label>
                        <select id="questionTestId"></select>
                    </div>
                    <div class="input-group">
                        <label>Question Text</label>
                        <input type="text" id="newQuestionText" placeholder="Enter question">
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div class="input-group">
                            <label>Option A</label>
                            <input type="text" id="optionA" placeholder="Option A">
                        </div>
                        <div class="input-group">
                            <label>Option B</label>
                            <input type="text" id="optionB" placeholder="Option B">
                        </div>
                        <div class="input-group">
                            <label>Option C</label>
                            <input type="text" id="optionC" placeholder="Option C">
                        </div>
                        <div class="input-group">
                            <label>Option D</label>
                            <input type="text" id="optionD" placeholder="Option D">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Correct Answer</label>
                        <select id="correctAnswer">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addQuestion()">
                        <i class="fas fa-plus"></i> Add Question
                    </button>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 20px;">All Questions</h3>
                    <div id="adminQuestionsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-shield-alt"></i> Admin Login</h2>
            </div>
            <div class="input-group">
                <label>Admin Password</label>
                <input type="password" id="adminPassword" placeholder="Enter admin password">
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-outline" onclick="closeAdminLogin()" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="adminLogin()" style="flex: 1;">Login</button>
            </div>
        </div>
    </div>

    <audio id="remoteAudio" autoplay></audio>

    <script>
        // Firebase Configuration - Replace with your own
        const firebaseConfig = {
apiKey: "AIzaSyDofEQ2jiMIXji7y-fGopDQcLY8dhixGk4",
  authDomain: "danz-66ffa.firebaseapp.com",
  projectId: "danz-66ffa",
  storageBucket: "danz-66ffa.firebasestorage.app",
  messagingSenderId: "570041531960",
  appId: "1:570041531960:web:24b77baa80aba9636c30cd"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // State
        let currentUser = null;
        let currentTest = null;
        let currentSession = null;
        let currentQuestion = 0;
        let answers = {};
        let timerInterval = null;
        let timeRemaining = 3600;
        let localStream = null;
        let peerConnection = null;
        let micEnabled = true;
        let speakerEnabled = true;

        // Default Data Initialization
        async function initializeDefaultData() {
            const testsRef = db.ref('tests');
            const snapshot = await testsRef.once('value');
            if (!snapshot.exists()) {
                const defaultTests = {
                    test1: {
                        id: 'test1',
                        name: 'Mathematics Basic',
                        code: 'MATH01',
                        description: 'Basic mathematics test',
                        duration: 3600,
                        questions: {
                            q1: {
                                text: 'What is 15 + 27?',
                                options: { A: '42', B: '41', C: '43', D: '40' },
                                correct: 'A'
                            },
                            q2: {
                                text: 'What is 8 √ó 7?',
                                options: { A: '54', B: '56', C: '58', D: '52' },
                                correct: 'B'
                            }
                        }
                    },
                    test2: {
                        id: 'test2',
                        name: 'English Grammar',
                        code: 'ENG001',
                        description: 'Basic English grammar test',
                        duration: 3600,
                        questions: {
                            q1: {
                                text: 'Choose the correct spelling:',
                                options: { A: 'Recieve', B: 'Receive', C: 'Receve', D: 'Receeve' },
                                correct: 'B'
                            },
                            q2: {
                                text: 'Which is a noun?',
                                options: { A: 'Run', B: 'Beautiful', C: 'Happiness', D: 'Quickly' },
                                correct: 'C'
                            }
                        }
                    }
                };
                await testsRef.set(defaultTests);
            }
        }

        // Toast Notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: 'check-circle', error: 'times-circle', warning: 'exclamation-circle', info: 'info-circle' };
            toast.innerHTML = `<i class="fas fa-${icons[type]}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const icon = document.body.classList.contains('dark') ? 'sun' : 'moon';
            document.getElementById('themeIcon').className = `fas fa-${icon}`;
            if (document.getElementById('themeIcon2')) {
                document.getElementById('themeIcon2').className = `fas fa-${icon}`;
            }
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }

        // Auth Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const school = document.getElementById('regSchool').value.trim();
            const code = document.getElementById('regCode').value.trim();

            if (!name || !school || !code) {
                showToast('Please fill all fields', 'error');
                return;
            }

            const usersRef = db.ref('users');
            const snapshot = await usersRef.orderByChild('code').equalTo(code).once('value');
            
            if (snapshot.exists()) {
                showToast('Access code already taken', 'error');
                return;
            }

            const newUser = {
                name, school, code,
                points: 0,
                matches: 0,
                wins: 0,
                losses: 0,
                createdAt: Date.now(),
                restricted: false
            };

            const userRef = usersRef.push();
            await userRef.set({ ...newUser, id: userRef.key });
            showToast('Registration successful! You can now login.', 'success');
            switchAuthTab('login');
            document.getElementById('loginCode').value = code;
        }

        async function login() {
            const code = document.getElementById('loginCode').value.trim();
            if (!code) {
                showToast('Please enter your access code', 'error');
                return;
            }

            const snapshot = await db.ref('users').orderByChild('code').equalTo(code).once('value');
            if (!snapshot.exists()) {
                showToast('Invalid access code', 'error');
                return;
            }

            const userData = Object.values(snapshot.val())[0];
            if (userData.restricted) {
                showToast('Your account has been restricted', 'error');
                return;
            }

            currentUser = userData;
            localStorage.setItem('ofujeUser', JSON.stringify(currentUser));
            showDashboard();
            showToast(`Welcome back, ${currentUser.name}!`, 'success');
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('ofujeUser');
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('authPage').classList.remove('hidden');
            showToast('Logged out successfully', 'info');
        }

        // Dashboard Functions
        function showDashboard() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            updateUserInfo();
            loadTests();
            loadLeaderboard();
            loadRecords();
            loadUsers();
            loadSettings();
        }

        function updateUserInfo() {
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userSchool').textContent = currentUser.school;
            document.getElementById('userPoints').textContent = currentUser.points || 0;
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            ['tests', 'leaderboard', 'records', 'users', 'settings'].forEach(t => {
                document.getElementById(t + 'Tab').classList.toggle('hidden', t !== tab);
            });
        }

        // Tests Functions
        async function loadTests() {
            const snapshot = await db.ref('tests').once('value');
            const tests = snapshot.val() || {};
            const grid = document.getElementById('testsGrid');
            grid.innerHTML = '';

            Object.values(tests).forEach(test => {
                const questionCount = test.questions ? Object.keys(test.questions).length : 0;
                grid.innerHTML += `
                    <div class="test-card card">
                        <h3>${test.name}</h3>
                        <p>${test.description}</p>
                        <div class="test-meta">
                            <span><i class="fas fa-question-circle"></i> ${questionCount} Questions</span>
                            <span><i class="fas fa-clock"></i> 60 min</span>
                        </div>
                        <button class="btn btn-primary" onclick="openTestCode('${test.id}')">
                            <i class="fas fa-play"></i> Start Test
                        </button>
                    </div>
                `;
            });
        }

        function openTestCode(testId) {
            currentTest = testId;
            document.getElementById('testCodeModal').classList.remove('hidden');
            document.getElementById('testCodeInput').value = '';
            document.getElementById('testCodeInput').focus();
        }

        function closeTestCodeModal() {
            document.getElementById('testCodeModal').classList.add('hidden');
            currentTest = null;
        }

        async function submitTestCode() {
            const code = document.getElementById('testCodeInput').value.trim().toUpperCase();
            if (code.length !== 6) {
                showToast('Please enter a 6-digit code', 'error');
                return;
            }

            const snapshot = await db.ref(`tests/${currentTest}`).once('value');
            const test = snapshot.val();

            if (test.code.toUpperCase() !== code) {
                showToast('Invalid test code', 'error');
                return;
            }

            closeTestCodeModal();
            joinWaitingRoom(test);
        }

        // Waiting Room & Matchmaking
        async function joinWaitingRoom(test) {
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('waitingRoom').classList.remove('hidden');
            document.getElementById('waitingTestName').textContent = test.name;

            const waitingRef = db.ref(`waiting/${test.id}`);
            const snapshot = await waitingRef.once('value');
            const waiting = snapshot.val();

            if (waiting && waiting.oderId !== currentUser.id) {
                // Join existing session
                currentSession = waiting.sessionId;
                await waitingRef.remove();
                await db.ref(`sessions/${currentSession}/player2`).set({
                    id: currentUser.id,
                    name: currentUser.name,
                    currentQuestion: 1,
                    answers: {},
                    submitted: false
                });
                await db.ref(`sessions/${currentSession}/status`).set('active');
                startQuiz(test);
            } else {
                // Create new waiting entry
                currentSession = db.ref('sessions').push().key;
                document.getElementById('waitingSessionId').textContent = currentSession.slice(-8);

                await waitingRef.set({
                    oderId: currentUser.id,
                    sessionId: currentSession,
                    testId: test.id,
                    createdAt: Date.now()
                });

                await db.ref(`sessions/${currentSession}`).set({
                    testId: test.id,
                    status: 'waiting',
                    player1: {
                        id: currentUser.id,
                        name: currentUser.name,
                        currentQuestion: 1,
                        answers: {},
                        submitted: false
                    },
                    startedAt: null,
                    messages: {}
                });

                // Listen for player2
                db.ref(`sessions/${currentSession}/player2`).on('value', snap => {
                    if (snap.exists()) {
                        db.ref(`sessions/${currentSession}/player2`).off();
                        startQuiz(test);
                    }
                });
            }
        }

        function cancelWaiting() {
            if (currentSession) {
                db.ref(`sessions/${currentSession}`).remove();
                db.ref(`waiting`).orderByChild('sessionId').equalTo(currentSession).once('value', snap => {
                    if (snap.exists()) {
                        Object.keys(snap.val()).forEach(key => db.ref(`waiting/${key}`).remove());
                    }
                });
            }
            currentSession = null;
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
        }

        // Quiz Functions
        async function startQuiz(test) {
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('quizPage').classList.remove('hidden');

            const sessionSnap = await db.ref(`sessions/${currentSession}`).once('value');
            const session = sessionSnap.val();
            const isPlayer1 = session.player1.id === currentUser.id;
            const opponent = isPlayer1 ? session.player2 : session.player1;

            // Update start time if player1
            if (isPlayer1 && !session.startedAt) {
                await db.ref(`sessions/${currentSession}/startedAt`).set(Date.now());
            }

            // Set up UI
            document.getElementById('player1Name').textContent = currentUser.name;
            document.getElementById('player1Avatar').textContent = currentUser.name.charAt(0);
            document.getElementById('player2Name').textContent = opponent.name;
            document.getElementById('player2Avatar').textContent = opponent.name.charAt(0);

            // Load questions
            const questionsSnap = await db.ref(`tests/${test.id}/questions`).once('value');
            window.quizQuestions = Object.entries(questionsSnap.val() || {}).map(([id, q]) => ({ id, ...q }));
            document.getElementById('totalQuestions').textContent = window.quizQuestions.length;

            // Initialize answers
            answers = {};
            currentQuestion = 0;
            displayQuestion();
            buildQuestionsGrid();

            // Start timer
            timeRemaining = 3600;
            startTimer();

            // Listen for opponent updates
            const opponentPath = isPlayer1 ? 'player2' : 'player1';
            db.ref(`sessions/${currentSession}/${opponentPath}`).on('value', snap => {
                const data = snap.val();
                if (data) {
                    document.getElementById('player2Question').textContent = data.currentQuestion || 1;
                    if (data.submitted) {
                        showToast('Opponent has submitted!', 'info');
                        endQuiz();
                    }
                }
            });

            // Listen for messages
            db.ref(`sessions/${currentSession}/messages`).on('child_added', snap => {
                const msg = snap.val();
                if (msg.senderId !== currentUser.id) {
                    addChatMessage(msg.text, 'received');
                }
            });

            // Initialize WebRTC
            initializeWebRTC(isPlayer1);
        }

        function displayQuestion() {
            const q = window.quizQuestions[currentQuestion];
            document.getElementById('currentQuestionNum').textContent = currentQuestion + 1;
            document.getElementById('player1Question').textContent = currentQuestion + 1;
            document.getElementById('questionText').textContent = q.text;

            const optionsList = document.getElementById('optionsList');
            optionsList.innerHTML = '';

            Object.entries(q.options).forEach(([letter, text]) => {
                const selected = answers[q.id] === letter ? 'selected' : '';
                optionsList.innerHTML += `
                    <div class="option-item ${selected}" onclick="selectOption('${q.id}', '${letter}')">
                        <span class="option-letter">${letter}</span>
                        <span>${text}</span>
                    </div>
                `;
            });

            document.getElementById('prevBtn').disabled = currentQuestion === 0;
            document.getElementById('nextBtn').textContent = currentQuestion === window.quizQuestions.length - 1 ? 'Finish' : 'Next';

            // Update Firebase
            const playerPath = getPlayerPath();
            db.ref(`sessions/${currentSession}/${playerPath}/currentQuestion`).set(currentQuestion + 1);
        }

        function selectOption(questionId, letter) {
            answers[questionId] = letter;
            displayQuestion();
            updateQuestionsGrid();

            const playerPath = getPlayerPath();
            db.ref(`sessions/${currentSession}/${playerPath}/answers`).set(answers);
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                displayQuestion();
                updateQuestionsGrid();
            }
        }

        function nextQuestion() {
            if (currentQuestion < window.quizQuestions.length - 1) {
                currentQuestion++;
                displayQuestion();
                updateQuestionsGrid();
            }
        }

        function buildQuestionsGrid() {
            const grid = document.getElementById('questionsGrid');
            grid.innerHTML = '';
            window.quizQuestions.forEach((q, i) => {
                grid.innerHTML += `
                    <div class="question-dot ${i === currentQuestion ? 'current' : ''}" 
                         onclick="goToQuestion(${i})">${i + 1}</div>
                `;
            });
        }

        function updateQuestionsGrid() {
            document.querySelectorAll('.question-dot').forEach((dot, i) => {
                dot.className = 'question-dot';
                if (i === currentQuestion) dot.classList.add('current');
                if (answers[window.quizQuestions[i].id]) dot.classList.add('answered');
            });
        }

        function goToQuestion(index) {
            currentQuestion = index;
            displayQuestion();
            updateQuestionsGrid();
        }

        function getPlayerPath() {
            return db.ref(`sessions/${currentSession}/player1/id`).once('value').then(snap => 
                snap.val() === currentUser.id ? 'player1' : 'player2'
            );
        }

        // Timer
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    submitQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timeRemaining / 60);
            const secs = timeRemaining % 60;
            const display = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            const timerEl = document.getElementById('quizTimer');
            timerEl.querySelector('span').textContent = display;
            timerEl.classList.remove('warning', 'danger');
            if (timeRemaining <= 300) timerEl.classList.add('danger');
            else if (timeRemaining <= 600) timerEl.classList.add('warning');
        }

        // Submit Quiz
        async function submitQuiz() {
            clearInterval(timerInterval);
            
            const sessionSnap = await db.ref(`sessions/${currentSession}`).once('value');
            const session = sessionSnap.val();
            const isPlayer1 = session.player1.id === currentUser.id;
            const playerPath = isPlayer1 ? 'player1' : 'player2';

            await db.ref(`sessions/${currentSession}/${playerPath}/submitted`).set(true);
            await db.ref(`sessions/${currentSession}/${playerPath}/answers`).set(answers);

            endQuiz();
        }

        async function endQuiz() {
            clearInterval(timerInterval);
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());

            // Calculate scores
            const sessionSnap = await db.ref(`sessions/${currentSession}`).once('value');
            const session = sessionSnap.val();
            const testSnap = await db.ref(`tests/${session.testId}/questions`).once('value');
            const questions = testSnap.val();

            const p1Score = calculateScore(session.player1.answers || {}, questions);
            const p2Score = calculateScore(session.player2.answers || {}, questions);

            const isPlayer1 = session.player1.id === currentUser.id;
            const myScore = isPlayer1 ? p1Score : p2Score;
            const opponentScore = isPlayer1 ? p2Score : p1Score;
            const opponent = isPlayer1 ? session.player2 : session.player1;

            // Determine winner
            let myPointChange = 0;
            let opponentPointChange = 0;
            let result = 'draw';

            if (myScore > opponentScore) {
                result = 'win';
                myPointChange = 10;
                opponentPointChange = currentUser.points >= 5 ? -5 : 0;
            } else if (myScore < opponentScore) {
                result = 'lose';
                myPointChange = currentUser.points >= 5 ? -5 : 0;
                opponentPointChange = 10;
            }

            // Update user points
            const newPoints = Math.max(0, (currentUser.points || 0) + myPointChange);
            await db.ref(`users/${currentUser.id}/points`).set(newPoints);
            await db.ref(`users/${currentUser.id}/matches`).set((currentUser.matches || 0) + 1);
            if (result === 'win') await db.ref(`users/${currentUser.id}/wins`).set((currentUser.wins || 0) + 1);
            if (result === 'lose') await db.ref(`users/${currentUser.id}/losses`).set((currentUser.losses || 0) + 1);

            // Save record
            await db.ref(`records/${currentUser.id}`).push({
                testId: session.testId,
                opponentId: opponent.id,
                opponentName: opponent.name,
                myScore,
                opponentScore,
                result,
                pointChange: myPointChange,
                timestamp: Date.now()
            });

            currentUser.points = newPoints;
            currentUser.matches = (currentUser.matches || 0) + 1;

            // Show results
            showResults(myScore, opponentScore, opponent, myPointChange, opponentPointChange, result, newPoints);
        }

        function calculateScore(answers, questions) {
            let score = 0;
            Object.entries(questions).forEach(([id, q]) => {
                if (answers[id] === q.correct) score++;
            });
            return score;
        }

        function showResults(myScore, opponentScore, opponent, myPointChange, opponentPointChange, result, totalPoints) {
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('resultsModal').classList.remove('hidden');

            const resultIcon = document.getElementById('resultIcon');
            resultIcon.className = `result-icon ${result}`;
            const icons = { win: 'trophy', lose: 'sad-tear', draw: 'handshake' };
            resultIcon.innerHTML = `<i class="fas fa-${icons[result]}"></i>`;

            const titles = { win: 'Victory!', lose: 'Defeat', draw: 'Draw!' };
            document.getElementById('resultTitle').textContent = titles[result];
            document.getElementById('resultSubtitle').textContent = result === 'win' ? 'Congratulations!' : result === 'lose' ? 'Better luck next time!' : 'Well matched!';

            document.getElementById('result1Avatar').textContent = currentUser.name.charAt(0);
            document.getElementById('result1Name').textContent = currentUser.name;
            document.getElementById('result1Score').textContent = myScore;
            document.getElementById('result1Points').textContent = `${myPointChange >= 0 ? '+' : ''}${myPointChange} points`;
            document.getElementById('result1Points').className = `points-change ${myPointChange >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('result2Avatar').textContent = opponent.name.charAt(0);
            document.getElementById('result2Name').textContent = opponent.name;
            document.getElementById('result2Score').textContent = opponentScore;
            document.getElementById('result2Points').textContent = `${opponentPointChange >= 0 ? '+' : ''}${opponentPointChange} points`;
            document.getElementById('result2Points').className = `points-change ${opponentPointChange >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('resultTotalPoints').textContent = totalPoints;
        }

        function closeResults() {
            document.getElementById('resultsModal').classList.add('hidden');
            currentSession = null;
            showDashboard();
        }

        // Leaderboard
        async function loadLeaderboard() {
            const snapshot = await db.ref('users').orderByChild('points').once('value');
            const users = [];
            snapshot.forEach(child => users.unshift(child.val()));

            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';

            users.forEach((user, i) => {
                const isCurrentUser = user.id === currentUser.id;
                const rankClass = i < 3 ? `rank-${i + 1}` : '';
                tbody.innerHTML += `
                    <tr class="${isCurrentUser ? 'current-user' : ''}">
                        <td><span class="rank-badge ${rankClass}">${i + 1}</span></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="avatar" style="width: 36px; height: 36px; font-size: 14px;">${user.name.charAt(0)}</div>
                                ${user.name} ${isCurrentUser ? '(You)' : ''}
                            </div>
                        </td>
                        <td>${user.school}</td>
                        <td><strong>${user.points || 0}</strong></td>
                        <td>${user.matches || 0}</td>
                    </tr>
                `;
            });
        }

        // Records
        async function loadRecords() {
            const snapshot = await db.ref(`records/${currentUser.id}`).orderByChild('timestamp').once('value');
            const records = [];
            snapshot.forEach(child => records.unshift(child.val()));

            const wins = records.filter(r => r.result === 'win').length;
            const losses = records.filter(r => r.result === 'lose').length;

            document.getElementById('totalMatches').textContent = records.length;
            document.getElementById('totalWins').textContent = wins;
            document.getElementById('totalLosses').textContent = losses;
            document.getElementById('winRate').textContent = records.length ? Math.round((wins / records.length) * 100) + '%' : '0%';

            const list = document.getElementById('recordsList');
            list.innerHTML = records.length ? '' : '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No matches yet</p>';

            records.slice(0, 20).forEach(record => {
                const date = new Date(record.timestamp).toLocaleDateString();
                list.innerHTML += `
                    <div class="record-item">
                        <div class="record-info">
                            <div class="avatar" style="width: 40px; height: 40px; font-size: 16px;">${record.opponentName.charAt(0)}</div>
                            <div>
                                <strong>vs ${record.opponentName}</strong>
                                <div style="font-size: 12px; color: var(--text-secondary);">${date} ‚Ä¢ Score: ${record.myScore} - ${record.opponentScore}</div>
                            </div>
                        </div>
                        <span class="record-result ${record.result}">${record.result.toUpperCase()} (${record.pointChange >= 0 ? '+' : ''}${record.pointChange})</span>
                    </div>
                `;
            });
        }

        // Users
        async function loadUsers() {
            const snapshot = await db.ref('users').once('value');
            const users = Object.values(snapshot.val() || {});

            const list = document.getElementById('usersList');
            list.innerHTML = '';

            users.forEach(user => {
                if (user.id !== currentUser.id) {
                    list.innerHTML += `
                        <div class="record-item">
                            <div class="record-info">
                                <div class="avatar" style="width: 40px; height: 40px; font-size: 16px;">${user.name.charAt(0)}</div>
                                <div>
                                    <strong>${user.name}</strong>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${user.school}</div>
                                </div>
                            </div>
                            <span style="font-weight: 600; color: var(--primary);">${user.points || 0} pts</span>
                        </div>
                    `;
                }
            });
        }

        // Settings
        function loadSettings() {
            document.getElementById('settingsName').value = currentUser.name;
            document.getElementById('settingsCode').value = currentUser.code;
        }

        async function updateProfile() {
            const name = document.getElementById('settingsName').value.trim();
            const code = document.getElementById('settingsCode').value.trim();

            if (!name || !code) {
                showToast('Please fill all fields', 'error');
                return;
            }

            if (code !== currentUser.code) {
                const snapshot = await db.ref('users').orderByChild('code').equalTo(code).once('value');
                if (snapshot.exists()) {
                    showToast('Access code already taken', 'error');
                    return;
                }
            }

            await db.ref(`users/${currentUser.id}`).update({ name, code });
            currentUser.name = name;
            currentUser.code = code;
            localStorage.setItem('ofujeUser', JSON.stringify(currentUser));
            updateUserInfo();
            showToast('Profile updated successfully', 'success');
        }

        async function deleteAccount() {
            if (!confirm('Are you sure you want to delete your account? This cannot be undone.')) return;
            
            await db.ref(`users/${currentUser.id}`).remove();
            await db.ref(`records/${currentUser.id}`).remove();
            logout();
            showToast('Account deleted successfully', 'info');
        }

        // Chat Functions
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            db.ref(`sessions/${currentSession}/messages`).push({
                senderId: currentUser.id,
                senderName: currentUser.name,
                text,
                timestamp: Date.now()
            });

            addChatMessage(text, 'sent');
            input.value = '';
        }

        function addChatMessage(text, type) {
            const container = document.getElementById('chatMessages');
            container.innerHTML += `<div class="chat-message ${type}">${text}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        function toggleEmojiPanel() {
            document.getElementById('emojiPanel').classList.toggle('hidden');
        }

        function insertEmoji(emoji) {
            document.getElementById('chatInput').value += emoji;
            document.getElementById('emojiPanel').classList.add('hidden');
        }

        // WebRTC Voice Chat
        async function initializeWebRTC(isInitiator) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
                peerConnection = new RTCPeerConnection(config);

                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = event => {
                    document.getElementById('remoteAudio').srcObject = event.streams[0];
                };

                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        db.ref(`sessions/${currentSession}/ice/${isInitiator ? 'caller' : 'callee'}`).push(event.candidate.toJSON());
                    }
                };

                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    await db.ref(`sessions/${currentSession}/offer`).set(offer);

                    db.ref(`sessions/${currentSession}/answer`).on('value', async snap => {
                        if (snap.exists() && peerConnection.signalingState !== 'stable') {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                        }
                    });
                } else {
                    db.ref(`sessions/${currentSession}/offer`).on('value', async snap => {
                        if (snap.exists() && !peerConnection.currentRemoteDescription) {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                            const answer = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);
                            await db.ref(`sessions/${currentSession}/answer`).set(answer);
                        }
                    });
                }

                const icePath = isInitiator ? 'callee' : 'caller';
                db.ref(`sessions/${currentSession}/ice/${icePath}`).on('child_added', async snap => {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(snap.val()));
                });

            } catch (error) {
                console.log('WebRTC error:', error);
            }
        }

        function toggleMic() {
            micEnabled = !micEnabled;
            if (localStream) {
                localStream.getAudioTracks().forEach(track => track.enabled = micEnabled);
            }
            const btn = document.getElementById('micBtn');
            btn.classList.toggle('muted', !micEnabled);
            btn.innerHTML = `<i class="fas fa-microphone${micEnabled ? '' : '-slash'}"></i> Mic`;
        }

        function toggleSpeaker() {
            speakerEnabled = !speakerEnabled;
            document.getElementById('remoteAudio').muted = !speakerEnabled;
            const btn = document.getElementById('speakerBtn');
            btn.classList.toggle('muted', !speakerEnabled);
            btn.innerHTML = `<i class="fas fa-volume-${speakerEnabled ? 'up' : 'mute'}"></i> Speaker`;
        }

        // Admin Functions
        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }

        function closeAdminLogin() {
            document.getElementById('adminLoginModal').classList.add('hidden');
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'admin123') {
                closeAdminLogin();
                document.getElementById('authPage').classList.add('hidden');
                document.getElementById('adminPage').classList.remove('hidden');
                loadAdminData();
                showToast('Admin login successful', 'success');
            } else {
                showToast('Invalid admin password', 'error');
            }
        }

        function adminLogout() {
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('authPage').classList.remove('hidden');
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tabs .nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            ['Users', 'Tests', 'Questions'].forEach(t => {
                document.getElementById('admin' + t + 'Tab').classList.toggle('hidden', t.toLowerCase() !== tab);
            });
        }

        async function loadAdminData() {
            await loadAdminUsers();
            await loadAdminTests();
            await loadAdminQuestions();
        }

        async function loadAdminUsers() {
            const snapshot = await db.ref('users').once('value');
            const users = Object.values(snapshot.val() || {});

            const list = document.getElementById('adminUsersList');
            list.innerHTML = '';

            users.forEach(user => {
                list.innerHTML += `
                    <div class="admin-card card">
                        <div class="admin-card-header">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="avatar" style="width: 40px; height: 40px; font-size: 16px;">${user.name.charAt(0)}</div>
                                <div>
                                    <strong>${user.name}</strong>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${user.school} ‚Ä¢ ${user.points || 0} pts</div>
                                </div>
                            </div>
                            <div class="admin-actions">
                                <button style="background: var(--warning); color: white;" onclick="adjustPoints('${user.id}', ${user.points || 0})">
                                    <i class="fas fa-coins"></i> Points
                                </button>
                                <button style="background: ${user.restricted ? 'var(--secondary)' : 'var(--warning)'}; color: white;" 
                                        onclick="toggleRestrict('${user.id}', ${user.restricted || false})">
                                    <i class="fas fa-${user.restricted ? 'unlock' : 'lock'}"></i>
                                </button>
                                <button style="background: var(--danger); color: white;" onclick="adminDeleteUser('${user.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        async function adjustPoints(userId, currentPoints) {
            const newPoints = prompt('Enter new points value:', currentPoints);
            if (newPoints !== null) {
                await db.ref(`users/${userId}/points`).set(parseInt(newPoints) || 0);
                loadAdminUsers();
                showToast('Points updated', 'success');
            }
        }

        async function toggleRestrict(userId, isRestricted) {
            await db.ref(`users/${userId}/restricted`).set(!isRestricted);
            loadAdminUsers();
            showToast(isRestricted ? 'User unrestricted' : 'User restricted', 'info');
        }

        async function adminDeleteUser(userId) {
            if (!confirm('Delete this user?')) return;
            await db.ref(`users/${userId}`).remove();
            await db.ref(`records/${userId}`).remove();
            loadAdminUsers();
            showToast('User deleted', 'success');
        }

        async function loadAdminTests() {
            const snapshot = await db.ref('tests').once('value');
            const tests = Object.values(snapshot.val() || {});

            const list = document.getElementById('adminTestsList');
            list.innerHTML = '';

            const select = document.getElementById('questionTestId');
            select.innerHTML = '';

            tests.forEach(test => {
                const qCount = test.questions ? Object.keys(test.questions).length : 0;
                list.innerHTML += `
                    <div class="admin-card card">
                        <div class="admin-card-header">
                            <div>
                                <strong>${test.name}</strong>
                                <div style="font-size: 12px; color: var(--text-secondary);">Code: ${test.code} ‚Ä¢ ${qCount} questions</div>
                            </div>
                            <div class="admin-actions">
                                <button style="background: var(--danger); color: white;" onclick="deleteTest('${test.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                select.innerHTML += `<option value="${test.id}">${test.name}</option>`;
            });
        }

        async function addTest() {
            const name = document.getElementById('newTestName').value.trim();
            const code = document.getElementById('newTestCode').value.trim().toUpperCase();
            const desc = document.getElementById('newTestDesc').value.trim();

            if (!name || !code || code.length !== 6) {
                showToast('Please fill all fields correctly', 'error');
                return;
            }

            const testRef = db.ref('tests').push();
            await testRef.set({
                id: testRef.key,
                name,
                code,
                description: desc || name,
                duration: 3600,
                questions: {}
            });

            document.getElementById('newTestName').value = '';
            document.getElementById('newTestCode').value = '';
            document.getElementById('newTestDesc').value = '';

            loadAdminTests();
            showToast('Test added successfully', 'success');
        }

        async function deleteTest(testId) {
            if (!confirm('Delete this test?')) return;
            await db.ref(`tests/${testId}`).remove();
            loadAdminTests();
            showToast('Test deleted', 'success');
        }

        async function loadAdminQuestions() {
            const snapshot = await db.ref('tests').once('value');
            const tests = snapshot.val() || {};

            const list = document.getElementById('adminQuestionsList');
            list.innerHTML = '';

            Object.values(tests).forEach(test => {
                if (test.questions) {
                    Object.entries(test.questions).forEach(([qId, q]) => {
                        list.innerHTML += `
                            <div class="admin-card card">
                                <div class="admin-card-header">
                                    <div>
                                        <span style="font-size: 12px; color: var(--primary); font-weight: 600;">${test.name}</span>
                                        <div style="margin-top: 4px;"><strong>${q.text}</strong></div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                            A: ${q.options.A} | B: ${q.options.B} | C: ${q.options.C} | D: ${q.options.D}
                                            <br>Correct: ${q.correct}
                                        </div>
                                    </div>
                                    <div class="admin-actions">
                                        <button style="background: var(--danger); color: white;" onclick="deleteQuestion('${test.id}', '${qId}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            });
        }

        async function addQuestion() {
            const testId = document.getElementById('questionTestId').value;
            const text = document.getElementById('newQuestionText').value.trim();
            const optionA = document.getElementById('optionA').value.trim();
            const optionB = document.getElementById('optionB').value.trim();
            const optionC = document.getElementById('optionC').value.trim();
            const optionD = document.getElementById('optionD').value.trim();
            const correct = document.getElementById('correctAnswer').value;

            if (!testId || !text || !optionA || !optionB || !optionC || !optionD) {
                showToast('Please fill all fields', 'error');
                return;
            }

            const qRef = db.ref(`tests/${testId}/questions`).push();
            await qRef.set({
                text,
                options: { A: optionA, B: optionB, C: optionC, D: optionD },
                correct
            });

            document.getElementById('newQuestionText').value = '';
            document.getElementById('optionA').value = '';
            document.getElementById('optionB').value = '';
            document.getElementById('optionC').value = '';
            document.getElementById('optionD').value = '';

            loadAdminQuestions();
            loadAdminTests();
            showToast('Question added successfully', 'success');
        }

        async function deleteQuestion(testId, questionId) {
            if (!confirm('Delete this question?')) return;
            await db.ref(`tests/${testId}/questions/${questionId}`).remove();
            loadAdminQuestions();
            loadAdminTests();
            showToast('Question deleted', 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Load theme
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            }

            // Initialize default data
            await initializeDefaultData();

            // Check for saved user
            const savedUser = localStorage.getItem('ofujeUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                // Verify user still exists
                const snapshot = await db.ref(`users/${currentUser.id}`).once('value');
                if (snapshot.exists() && !snapshot.val().restricted) {
                    currentUser = snapshot.val();
                    showDashboard();
                } else {
                    localStorage.removeItem('ofujeUser');
                }
            }
        });

        // Close emoji panel when clicking outside
        document.addEventListener('click', e => {
            if (!e.target.closest('.emoji-picker')) {
                document.getElementById('emojiPanel')?.classList.add('hidden');
            }
        });
    </script>
</body>
</html>