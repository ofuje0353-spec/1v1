<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofuje - Multiplayer CBT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --radius: 12px;
        }
        .dark {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-group { margin-bottom: 16px; }
        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--card);
            color: var(--text);
            transition: border-color 0.2s;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        /* Auth Page */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
        }
        .auth-card {
            width: 100%;
            max-width: 420px;
            background: var(--card);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .auth-logo h1 {
            font-size: 36px;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            background: var(--bg);
            border-radius: 10px;
            padding: 4px;
        }
        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .auth-tab.active {
            background: var(--primary);
            color: white;
        }
        /* Dashboard */
        .dashboard { padding: 20px; }
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--card);
            border-radius: var(--radius);
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        .user-info h3 { font-size: 16px; }
        .user-info p { font-size: 12px; color: var(--text-secondary); }
        .topbar-actions { display: flex; gap: 12px; align-items: center; }
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .icon-btn:hover { background: var(--primary); color: white; }
        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 12px 20px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .nav-tab.active, .nav-tab:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        /* Grid */
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        /* Stats */
        .stat-card {
            text-align: center;
            padding: 24px;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: var(--primary);
        }
        .stat-label { color: var(--text-secondary); margin-top: 4px; }
        /* Test Cards */
        .test-card {
            position: relative;
            overflow: hidden;
        }
        .test-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        .test-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
        .test-title { font-size: 20px; font-weight: bold; }
        .test-badge {
            padding: 4px 12px;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 12px;
        }
        .test-info { display: flex; gap: 20px; margin: 16px 0; color: var(--text-secondary); font-size: 14px; }
        .test-info span { display: flex; align-items: center; gap: 6px; }
        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        .leaderboard-item:hover { background: var(--bg); }
        .leaderboard-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 16px;
        }
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4a); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #daa06d); color: #fff; }
        .rank-other { background: var(--bg); }
        .leaderboard-user { flex: 1; }
        .leaderboard-user h4 { margin-bottom: 2px; }
        .leaderboard-user p { font-size: 12px; color: var(--text-secondary); }
        .leaderboard-points { font-weight: bold; color: var(--primary); font-size: 18px; }
        /* Battle */
        .battle-lobby { text-align: center; padding: 40px; }
        .battle-waiting {
            padding: 40px;
            text-align: center;
        }
        .waiting-animation {
            width: 80px;
            height: 80px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .battle-list { max-height: 300px; overflow-y: auto; }
        .battle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .battle-item:hover { border-color: var(--primary); background: var(--bg); }
        /* Quiz */
        .quiz-container { max-width: 900px; margin: 0 auto; }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .quiz-timer {
            font-size: 24px;
            font-weight: bold;
            color: var(--danger);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .quiz-progress {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .progress-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .progress-dot.current { border-color: var(--primary); background: var(--primary); color: white; }
        .progress-dot.answered { background: var(--secondary); color: white; border-color: var(--secondary); }
        .opponent-status {
            background: var(--bg);
            padding: 12px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .opponent-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--warning);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .question-card { margin-bottom: 24px; }
        .question-text { font-size: 20px; margin-bottom: 24px; line-height: 1.6; }
        .options-list { display: flex; flex-direction: column; gap: 12px; }
        .option-item {
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .option-item:hover { border-color: var(--primary); }
        .option-item.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .option-item.selected .option-letter { background: var(--primary); color: white; }
        .quiz-nav { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
        /* Chat */
        .chat-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 350px;
            max-height: 500px;
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
        }
        .chat-header {
            padding: 16px;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            max-height: 300px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 14px;
        }
        .chat-message.sent {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-message.received {
            background: var(--bg);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-input {
            display: flex;
            padding: 12px;
            border-top: 1px solid var(--border);
            gap: 8px;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: var(--bg);
            color: var(--text);
        }
        .emoji-picker {
            position: absolute;
            bottom: 60px;
            right: 12px;
            background: var(--card);
            border-radius: 10px;
            padding: 10px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            width: 200px;
            gap: 5px;
        }
        .emoji-btn {
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .emoji-btn:hover { background: var(--bg); }
        /* Voice Controls */
        .voice-controls {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid var(--border);
        }
        .voice-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 12px;
            transition: all 0.2s;
        }
        .voice-btn.active { background: var(--secondary); color: white; }
        .voice-btn.muted { background: var(--danger); color: white; }
        /* Results */
        .results-card { text-align: center; }
        .result-icon { font-size: 80px; margin-bottom: 20px; }
        .result-win { color: var(--secondary); }
        .result-lose { color: var(--danger); }
        .result-draw { color: var(--warning); }
        .results-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin: 30px 0;
        }
        .result-player { text-align: center; }
        .result-player .avatar { width: 70px; height: 70px; font-size: 28px; margin: 0 auto 12px; }
        .result-score { font-size: 48px; font-weight: bold; }
        .result-vs { font-size: 24px; font-weight: bold; color: var(--text-secondary); }
        .points-change {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }
        .points-positive { background: rgba(16, 185, 129, 0.2); color: var(--secondary); }
        .points-negative { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        /* Settings */
        .settings-section { margin-bottom: 30px; }
        .settings-section h3 { margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-success { background: var(--secondary); }
        .toast-error { background: var(--danger); }
        .toast-warning { background: var(--warning); }
        .toast-info { background: var(--primary); }
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        .modal {
            background: var(--card);
            border-radius: var(--radius);
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { font-size: 24px; }
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg);
            cursor: pointer;
            font-size: 18px;
        }
        /* Admin */
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .admin-table th, .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .admin-table th { background: var(--bg); font-weight: 600; }
        .admin-table tr:hover { background: var(--bg); }
        .admin-actions { display: flex; gap: 6px; }
        .admin-actions button {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        /* Responsive */
        @media (max-width: 768px) {
            .topbar { flex-direction: column; gap: 16px; text-align: center; }
            .nav-tabs { justify-content: center; }
            .quiz-header { justify-content: center; }
            .results-comparison { grid-template-columns: 1fr; gap: 20px; }
            .chat-panel { right: 10px; left: 10px; width: auto; }
            .auth-card { padding: 24px; }
        }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        /* Record Table */
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .record-result {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .record-win { background: rgba(16, 185, 129, 0.2); color: var(--secondary); }
        .record-lose { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .record-draw { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    </style>
</head>
<body>
    <div id="app">
        <!-- Auth Page -->
        <div id="authPage" class="auth-container">
            <div class="auth-card">
                <div class="auth-logo">
                    <h1><i class="fas fa-bolt"></i> Ofuje</h1>
                    <p style="color: var(--text-secondary); margin-top: 8px;">Multiplayer CBT Platform</p>
                </div>
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                    <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
                </div>
                <div id="loginForm">
                    <div class="input-group">
                        <label>Access Code</label>
                        <input type="text" id="loginCode" placeholder="Enter your access code">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="login()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-outline" onclick="showAdminLogin()">
                            <i class="fas fa-user-shield"></i> Admin Login
                        </button>
                    </div>
                </div>
                <div id="registerForm" class="hidden">
                    <div class="input-group">
                        <label>Full Name</label>
                        <input type="text" id="regName" placeholder="Enter your full name">
                    </div>
                    <div class="input-group">
                        <label>School</label>
                        <input type="text" id="regSchool" placeholder="Enter your school name">
                    </div>
                    <div class="input-group">
                        <label>Preferred Access Code</label>
                        <input type="text" id="regCode" placeholder="Create your unique access code">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="register()">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboardPage" class="hidden dashboard container">
            <div class="topbar">
                <div class="user-profile">
                    <div class="avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <h3 id="userName">User Name</h3>
                        <p id="userSchool">School Name</p>
                    </div>
                </div>
                <div class="topbar-actions">
                    <div style="text-align: right; margin-right: 16px;">
                        <span style="font-size: 12px; color: var(--text-secondary);">Points</span>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary);" id="userPoints">0</div>
                    </div>
                    <button class="icon-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                        <i class="fas fa-moon" id="darkModeIcon"></i>
                    </button>
                    <button class="icon-btn" onclick="showSettings()" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="icon-btn" onclick="logout()" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showSection('tests')">
                    <i class="fas fa-file-alt"></i> Tests
                </div>
                <div class="nav-tab" onclick="showSection('leaderboard')">
                    <i class="fas fa-trophy"></i> Leaderboard
                </div>
                <div class="nav-tab" onclick="showSection('records')">
                    <i class="fas fa-history"></i> My Records
                </div>
                <div class="nav-tab" onclick="showSection('users')">
                    <i class="fas fa-users"></i> Users
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-3" style="margin-bottom: 24px;">
                <div class="card stat-card">
                    <div class="stat-value" id="statWins">0</div>
                    <div class="stat-label">Wins</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="statLosses">0</div>
                    <div class="stat-label">Losses</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-value" id="statTests">0</div>
                    <div class="stat-label">Tests Taken</div>
                </div>
            </div>

            <!-- Tests Section -->
            <div id="testsSection">
                <h2 style="margin-bottom: 20px;"><i class="fas fa-file-alt"></i> Available Tests</h2>
                <div class="grid grid-2" id="testsList"></div>
            </div>

            <!-- Leaderboard Section -->
            <div id="leaderboardSection" class="hidden">
                <h2 style="margin-bottom: 20px;"><i class="fas fa-trophy"></i> Leaderboard</h2>
                <div class="card">
                    <div id="leaderboardList"></div>
                </div>
            </div>

            <!-- Records Section -->
            <div id="recordsSection" class="hidden">
                <h2 style="margin-bottom: 20px;"><i class="fas fa-history"></i> My Battle Records</h2>
                <div class="card">
                    <div id="recordsList"></div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="hidden">
                <h2 style="margin-bottom: 20px;"><i class="fas fa-users"></i> All Users</h2>
                <div class="card">
                    <div id="usersList"></div>
                </div>
            </div>
        </div>

        <!-- Battle Lobby -->
        <div id="battleLobbyPage" class="hidden container">
            <div class="card battle-lobby">
                <button class="btn btn-outline" onclick="leaveBattleLobby()" style="position: absolute; top: 20px; left: 20px;">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h2 id="battleTestName" style="margin-bottom: 10px;"></h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">Choose how you want to battle</p>
                
                <div class="input-group">
                    <label>Enter Test Code (6-digit alphanumeric)</label>
                    <input type="text" id="testCodeInput" placeholder="e.g., ABC123" maxlength="6" style="text-transform: uppercase; text-align: center; font-size: 24px; letter-spacing: 8px;">
                </div>
                
                <div class="grid grid-2" style="margin-top: 30px;">
                    <div class="card" style="cursor: pointer;" onclick="createBattle()">
                        <i class="fas fa-plus-circle" style="font-size: 48px; color: var(--primary); margin-bottom: 16px;"></i>
                        <h3>Create Battle</h3>
                        <p style="color: var(--text-secondary); font-size: 14px;">Start a new battle and wait for opponent</p>
                    </div>
                    <div class="card" style="cursor: pointer;" onclick="showBattleList()">
                        <i class="fas fa-list" style="font-size: 48px; color: var(--secondary); margin-bottom: 16px;"></i>
                        <h3>Join Battle</h3>
                        <p style="color: var(--text-secondary); font-size: 14px;">Join an existing battle</p>
                    </div>
                </div>

                <div id="battleListContainer" class="hidden" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 16px;">Available Battles</h3>
                    <div class="battle-list" id="battleList"></div>
                </div>
            </div>
        </div>

        <!-- Waiting Room -->
        <div id="waitingRoomPage" class="hidden container">
            <div class="card battle-waiting">
                <div class="waiting-animation"></div>
                <h2>Waiting for Opponent...</h2>
                <p style="color: var(--text-secondary); margin-top: 10px;">Share the battle code with your friend</p>
                <div style="font-size: 32px; font-weight: bold; margin: 20px 0; letter-spacing: 4px;" id="waitingBattleId"></div>
                <button class="btn btn-danger" onclick="cancelBattle()">
                    <i class="fas fa-times"></i> Cancel Battle
                </button>
            </div>
        </div>

        <!-- Quiz Page -->
        <div id="quizPage" class="hidden container">
            <div class="quiz-container">
                <div class="quiz-header">
                    <div class="quiz-timer">
                        <i class="fas fa-clock"></i>
                        <span id="quizTimer">60:00</span>
                    </div>
                    <div class="opponent-status">
                        <div class="opponent-avatar" id="opponentAvatar">O</div>
                        <div>
                            <div style="font-weight: bold;" id="opponentName">Opponent</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                Question: <span id="opponentQuestion">1</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="quiz-progress" id="quizProgress"></div>

                <div class="card question-card" style="margin-top: 24px;">
                    <div style="color: var(--text-secondary); margin-bottom: 12px;">
                        Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">2</span>
                    </div>
                    <div class="question-text" id="questionText"></div>
                    <div class="options-list" id="optionsList"></div>
                </div>

                <div class="quiz-nav">
                    <button class="btn btn-outline" id="prevBtn" onclick="prevQuestion()">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    <button class="btn btn-secondary" id="submitBtn" onclick="submitQuiz()">
                        <i class="fas fa-check"></i> Submit
                    </button>
                </div>
            </div>

            <!-- Chat Toggle -->
            <button class="icon-btn" onclick="toggleChat()" style="position: fixed; bottom: 20px; right: 380px; z-index: 999;">
                <i class="fas fa-comments"></i>
            </button>

            <!-- Chat Panel -->
            <div class="chat-panel hidden" id="chatPanel">
                <div class="chat-header">
                    <span><i class="fas fa-comments"></i> Chat</span>
                    <button class="icon-btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="toggleChat()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="voice-controls">
                    <button class="voice-btn active" id="micBtn" onclick="toggleMic()">
                        <i class="fas fa-microphone"></i> Mic
                    </button>
                    <button class="voice-btn active" id="speakerBtn" onclick="toggleSpeaker()">
                        <i class="fas fa-volume-up"></i> Speaker
                    </button>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input">
                    <button class="icon-btn" onclick="toggleEmoji()">
                        <i class="fas fa-smile"></i>
                    </button>
                    <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="icon-btn" style="background: var(--primary); color: white;" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="emoji-picker hidden" id="emojiPicker"></div>
            </div>
        </div>

        <!-- Results Page -->
        <div id="resultsPage" class="hidden container">
            <div class="card results-card">
                <div id="resultIcon" class="result-icon"></div>
                <h1 id="resultTitle">You Won!</h1>
                
                <div class="results-comparison">
                    <div class="result-player">
                        <div class="avatar" id="resultMyAvatar">Y</div>
                        <h3 id="resultMyName">You</h3>
                        <div class="result-score" id="resultMyScore">0</div>
                        <div class="points-change" id="resultMyPoints">+10</div>
                        <div style="margin-top: 8px; color: var(--text-secondary);">
                            Total: <span id="resultMyTotal">0</span> pts
                        </div>
                    </div>
                    <div class="result-vs">VS</div>
                    <div class="result-player">
                        <div class="avatar" style="background: var(--warning);" id="resultOpponentAvatar">O</div>
                        <h3 id="resultOpponentName">Opponent</h3>
                        <div class="result-score" id="resultOpponentScore">0</div>
                        <div class="points-change" id="resultOpponentPoints">-5</div>
                        <div style="margin-top: 8px; color: var(--text-secondary);">
                            Total: <span id="resultOpponentTotal">0</span> pts
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="goToDashboard()">
                        <i class="fas fa-home"></i> Dashboard
                    </button>
                    <button class="btn btn-secondary" onclick="playAgain()">
                        <i class="fas fa-redo"></i> Play Again
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="hidden container">
            <div class="topbar">
                <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
                <button class="btn btn-danger" onclick="adminLogout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <div class="admin-tabs">
                <button class="btn btn-primary" onclick="showAdminSection('adminUsers')">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="btn btn-outline" onclick="showAdminSection('adminTests')">
                    <i class="fas fa-file-alt"></i> Tests
                </button>
                <button class="btn btn-outline" onclick="showAdminSection('adminQuestions')">
                    <i class="fas fa-question-circle"></i> Questions
                </button>
            </div>

            <!-- Admin Users -->
            <div id="adminUsers" class="card">
                <h3 style="margin-bottom: 20px;">Manage Users</h3>
                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>School</th>
                                <th>Code</th>
                                <th>Points</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Tests -->
            <div id="adminTests" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Manage Tests</h3>
                    <button class="btn btn-primary" onclick="showAddTestModal()">
                        <i class="fas fa-plus"></i> Add Test
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Code</th>
                                <th>Questions</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminTestsList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Questions -->
            <div id="adminQuestions" class="card hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
                    <h3>Manage Questions</h3>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <select id="adminTestSelect" onchange="loadAdminQuestions()" style="padding: 10px; border-radius: 8px; border: 2px solid var(--border);">
                            <option value="">Select Test</option>
                        </select>
                        <button class="btn btn-primary" onclick="showAddQuestionModal()">
                            <i class="fas fa-plus"></i> Add Question
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Question</th>
                                <th>Options</th>
                                <th>Answer</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminQuestionsList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="settings-section">
                <h3><i class="fas fa-user"></i> Profile</h3>
                <div class="input-group">
                    <label>Name</label>
                    <input type="text" id="settingsName">
                </div>
                <div class="input-group">
                    <label>Access Code</label>
                    <input type="text" id="settingsCode">
                </div>
                <button class="btn btn-primary" onclick="updateProfile()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
            <div class="settings-section">
                <h3><i class="fas fa-trash"></i> Danger Zone</h3>
                <button class="btn btn-danger" onclick="deleteAccount()">
                    <i class="fas fa-user-times"></i> Delete Account
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
                <button class="modal-close" onclick="closeModal('adminLoginModal')">&times;</button>
            </div>
            <div class="input-group">
                <label>Admin Password</label>
                <input type="password" id="adminPassword" placeholder="Enter admin password">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="adminLogin()">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
        </div>
    </div>

    <!-- Add Test Modal -->
    <div id="addTestModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-plus"></i> Add Test</h2>
                <button class="modal-close" onclick="closeModal('addTestModal')">&times;</button>
            </div>
            <div class="input-group">
                <label>Test Name</label>
                <input type="text" id="newTestName" placeholder="e.g., Mathematics Test">
            </div>
            <div class="input-group">
                <label>Test Code (6-digit alphanumeric)</label>
                <input type="text" id="newTestCode" placeholder="e.g., MATH01" maxlength="6">
            </div>
            <div class="input-group">
                <label>Duration (minutes)</label>
                <input type="number" id="newTestDuration" value="60" min="1">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="addTest()">
                <i class="fas fa-plus"></i> Add Test
            </button>
        </div>
    </div>

    <!-- Add/Edit Question Modal -->
    <div id="addQuestionModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 id="questionModalTitle"><i class="fas fa-plus"></i> Add Question</h2>
                <button class="modal-close" onclick="closeModal('addQuestionModal')">&times;</button>
            </div>
            <div class="input-group">
                <label>Question Text</label>
                <textarea id="newQuestionText" rows="3" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; resize: vertical;"></textarea>
            </div>
            <div class="input-group">
                <label>Option A</label>
                <input type="text" id="newOptionA">
            </div>
            <div class="input-group">
                <label>Option B</label>
                <input type="text" id="newOptionB">
            </div>
            <div class="input-group">
                <label>Option C</label>
                <input type="text" id="newOptionC">
            </div>
            <div class="input-group">
                <label>Option D</label>
                <input type="text" id="newOptionD">
            </div>
            <div class="input-group">
                <label>Correct Answer</label>
                <select id="newCorrectAnswer" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="saveQuestion()">
                <i class="fas fa-save"></i> Save Question
            </button>
        </div>
    </div>

    <!-- Edit Score Modal -->
    <div id="editScoreModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Edit Score</h2>
                <button class="modal-close" onclick="closeModal('editScoreModal')">&times;</button>
            </div>
            <div class="input-group">
                <label>User: <span id="editScoreUserName"></span></label>
                <input type="number" id="editScoreValue" min="0">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="saveScore()">
                <i class="fas fa-save"></i> Save Score
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Firebase Configuration - Replace with your own
        const firebaseConfig = {
apiKey: "AIzaSyDofEQ2jiMIXji7y-fGopDQcLY8dhixGk4",
  authDomain: "danz-66ffa.firebaseapp.com",
  projectId: "danz-66ffa",
  storageBucket: "danz-66ffa.firebasestorage.app",
  messagingSenderId: "570041531960",
  appId: "1:570041531960:web:24b77baa80aba9636c30cd"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Global State
        let currentUser = null;
        let currentTest = null;
        let currentBattle = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let quizTimer = null;
        let timeRemaining = 3600;
        let localStream = null;
        let micEnabled = true;
        let speakerEnabled = true;
        let editingQuestionId = null;
        let editingScoreUserId = null;

        // Emojis
        const emojis = ['üòÄ','üòÇ','üòç','ü§î','üëç','üëé','üéâ','üî•','üíØ','‚ù§Ô∏è','üòé','üôå','üëè','üí™','ü§ù','üòä','üò¢','üò°','ü§Ø','ü•≥'];

        // Default Tests Data
        const defaultTests = {
            test1: {
                id: 'test1',
                name: 'General Knowledge Test A',
                code: 'GEN001',
                duration: 60,
                questions: {
                    q1: {
                        text: 'What is the capital of France?',
                        options: { A: 'London', B: 'Paris', C: 'Berlin', D: 'Madrid' },
                        answer: 'B'
                    },
                    q2: {
                        text: 'Which planet is known as the Red Planet?',
                        options: { A: 'Venus', B: 'Jupiter', C: 'Mars', D: 'Saturn' },
                        answer: 'C'
                    }
                }
            },
            test2: {
                id: 'test2',
                name: 'Science Quiz Test B',
                code: 'SCI002',
                duration: 60,
                questions: {
                    q1: {
                        text: 'What is H2O commonly known as?',
                        options: { A: 'Salt', B: 'Water', C: 'Sugar', D: 'Acid' },
                        answer: 'B'
                    },
                    q2: {
                        text: 'What gas do plants absorb from the atmosphere?',
                        options: { A: 'Oxygen', B: 'Nitrogen', C: 'Carbon Dioxide', D: 'Hydrogen' },
                        answer: 'C'
                    }
                }
            }
        };

        // Initialize App
        async function initApp() {
            // Initialize default tests if not exists
            const testsSnapshot = await db.ref('tests').once('value');
            if (!testsSnapshot.exists()) {
                await db.ref('tests').set(defaultTests);
            }

            // Check for saved user
            const savedUser = localStorage.getItem('ofujeUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                const userSnapshot = await db.ref(`users/${userData.id}`).once('value');
                if (userSnapshot.exists() && !userSnapshot.val().restricted) {
                    currentUser = { id: userData.id, ...userSnapshot.val() };
                    showDashboard();
                }
            }

            // Initialize emoji picker
            const emojiPicker = document.getElementById('emojiPicker');
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji-btn';
                span.textContent = emoji;
                span.onclick = () => insertEmoji(emoji);
                emojiPicker.appendChild(span);
            });

            // Load dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark');
                document.getElementById('darkModeIcon').className = 'fas fa-sun';
            }
        }

        // Toast Notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const icons = { success: 'check-circle', error: 'times-circle', warning: 'exclamation-circle', info: 'info-circle' };
            toast.innerHTML = `<i class="fas fa-${icons[type]}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Auth Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.auth-tab:${tab === 'login' ? 'first' : 'last'}-child`).classList.add('active');
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        }

        async function login() {
            const code = document.getElementById('loginCode').value.trim();
            if (!code) return showToast('Please enter your access code', 'error');

            const snapshot = await db.ref('users').orderByChild('code').equalTo(code).once('value');
            if (!snapshot.exists()) return showToast('Invalid access code', 'error');

            const userId = Object.keys(snapshot.val())[0];
            const userData = snapshot.val()[userId];

            if (userData.restricted) return showToast('Your account has been restricted', 'error');

            currentUser = { id: userId, ...userData };
            localStorage.setItem('ofujeUser', JSON.stringify({ id: userId }));
            showToast('Welcome back, ' + userData.name + '!', 'success');
            showDashboard();
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const school = document.getElementById('regSchool').value.trim();
            const code = document.getElementById('regCode').value.trim();

            if (!name || !school || !code) return showToast('Please fill all fields', 'error');

            const existingCode = await db.ref('users').orderByChild('code').equalTo(code).once('value');
            if (existingCode.exists()) return showToast('Access code already taken', 'error');

            const newUser = db.ref('users').push();
            const userData = { name, school, code, points: 0, wins: 0, losses: 0, draws: 0, restricted: false };
            await newUser.set(userData);

            currentUser = { id: newUser.key, ...userData };
            localStorage.setItem('ofujeUser', JSON.stringify({ id: newUser.key }));
            showToast('Account created successfully!', 'success');
            showDashboard();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('ofujeUser');
            hideAllPages();
            document.getElementById('authPage').classList.remove('hidden');
            showToast('Logged out successfully', 'info');
        }

        // Dashboard
        function showDashboard() {
            hideAllPages();
            document.getElementById('dashboardPage').classList.remove('hidden');
            updateUserInfo();
            loadTests();
            loadLeaderboard();
            loadRecords();
            loadUsers();

            // Listen for user updates
            db.ref(`users/${currentUser.id}`).on('value', snapshot => {
                if (snapshot.exists()) {
                    currentUser = { id: currentUser.id, ...snapshot.val() };
                    updateUserInfo();
                }
            });
        }

        function updateUserInfo() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userSchool').textContent = currentUser.school;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('userPoints').textContent = currentUser.points || 0;
            document.getElementById('statWins').textContent = currentUser.wins || 0;
            document.getElementById('statLosses').textContent = currentUser.losses || 0;
            document.getElementById('statTests').textContent = (currentUser.wins || 0) + (currentUser.losses || 0) + (currentUser.draws || 0);
        }

        function showSection(section) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.nav-tab').classList.add('active');
            ['tests', 'leaderboard', 'records', 'users'].forEach(s => {
                document.getElementById(s + 'Section').classList.toggle('hidden', s !== section);
            });
        }

        async function loadTests() {
            const snapshot = await db.ref('tests').once('value');
            const tests = snapshot.val() || {};
            const container = document.getElementById('testsList');
            container.innerHTML = '';

            Object.entries(tests).forEach(([id, test]) => {
                const questionCount = test.questions ? Object.keys(test.questions).length : 0;
                container.innerHTML += `
                    <div class="card test-card">
                        <div class="test-header">
                            <h3 class="test-title">${test.name}</h3>
                            <span class="test-badge">${questionCount} Questions</span>
                        </div>
                        <div class="test-info">
                            <span><i class="fas fa-clock"></i> ${test.duration || 60} mins</span>
                            <span><i class="fas fa-users"></i> 2 Players</span>
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="startBattle('${id}')">
                            <i class="fas fa-gamepad"></i> Start Battle
                        </button>
                    </div>
                `;
            });
        }

        async function loadLeaderboard() {
            const snapshot = await db.ref('users').orderByChild('points').once('value');
            const users = [];
            snapshot.forEach(child => {
                if (!child.val().restricted) users.push({ id: child.key, ...child.val() });
            });
            users.reverse();

            const container = document.getElementById('leaderboardList');
            container.innerHTML = users.map((user, i) => `
                <div class="leaderboard-item ${user.id === currentUser.id ? 'style="background: rgba(99, 102, 241, 0.1);"' : ''}">
                    <div class="leaderboard-rank ${i < 3 ? 'rank-' + (i + 1) : 'rank-other'}">${i + 1}</div>
                    <div class="avatar" style="margin-right: 12px;">${user.name.charAt(0).toUpperCase()}</div>
                    <div class="leaderboard-user">
                        <h4>${user.name} ${user.id === currentUser.id ? '(You)' : ''}</h4>
                        <p>${user.school}</p>
                    </div>
                    <div class="leaderboard-points">${user.points || 0} pts</div>
                </div>
            `).join('');
        }

        async function loadRecords() {
            const snapshot = await db.ref(`records/${currentUser.id}`).orderByChild('timestamp').once('value');
            const records = [];
            snapshot.forEach(child => records.push({ id: child.key, ...child.val() }));
            records.reverse();

            const container = document.getElementById('recordsList');
            if (records.length === 0) {
                container.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--text-secondary);">No battle records yet</p>';
                return;
            }

            container.innerHTML = records.map(record => `
                <div class="record-item">
                    <div>
                        <strong>${record.testName}</strong>
                        <p style="font-size: 12px; color: var(--text-secondary);">vs ${record.opponentName}</p>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${record.myScore} - ${record.opponentScore}</div>
                    </div>
                    <span class="record-result ${record.result === 'win' ? 'record-win' : record.result === 'lose' ? 'record-lose' : 'record-draw'}">
                        ${record.result.toUpperCase()}
                    </span>
                </div>
            `).join('');
        }

        async function loadUsers() {
            const snapshot = await db.ref('users').once('value');
            const users = [];
            snapshot.forEach(child => {
                if (!child.val().restricted && child.key !== currentUser.id) {
                    users.push({ id: child.key, ...child.val() });
                }
            });

            const container = document.getElementById('usersList');
            container.innerHTML = users.map(user => `
                <div class="leaderboard-item">
                    <div class="avatar" style="margin-right: 12px;">${user.name.charAt(0).toUpperCase()}</div>
                    <div class="leaderboard-user">
                        <h4>${user.name}</h4>
                        <p>${user.school}</p>
                    </div>
                    <div class="leaderboard-points">${user.points || 0} pts</div>
                </div>
            `).join('');
        }

        // Battle System
        async function startBattle(testId) {
            const testSnapshot = await db.ref(`tests/${testId}`).once('value');
            currentTest = { id: testId, ...testSnapshot.val() };
            hideAllPages();
            document.getElementById('battleLobbyPage').classList.remove('hidden');
            document.getElementById('battleTestName').textContent = currentTest.name;
            document.getElementById('testCodeInput').value = '';
            document.getElementById('battleListContainer').classList.add('hidden');
        }

        function leaveBattleLobby() {
            currentTest = null;
            showDashboard();
        }

        async function createBattle() {
            const testCode = document.getElementById('testCodeInput').value.trim().toUpperCase();
            if (testCode.length !== 6) return showToast('Please enter a valid 6-digit test code', 'error');
            if (testCode !== currentTest.code.toUpperCase()) return showToast('Invalid test code', 'error');

            const battleRef = db.ref('battles').push();
            await battleRef.set({
                testId: currentTest.id,
                testName: currentTest.name,
                creator: currentUser.id,
                creatorName: currentUser.name,
                status: 'waiting',
                createdAt: Date.now()
            });

            currentBattle = { id: battleRef.key };
            showWaitingRoom(battleRef.key);

            // Listen for opponent joining
            battleRef.on('value', async snapshot => {
                const battle = snapshot.val();
                if (battle && battle.status === 'ready' && battle.opponent) {
                    showToast('Opponent joined! Starting battle...', 'success');
                    await startQuiz(battle);
                }
            });
        }

        async function showBattleList() {
            const testCode = document.getElementById('testCodeInput').value.trim().toUpperCase();
            if (testCode.length !== 6) return showToast('Please enter a valid 6-digit test code', 'error');
            if (testCode !== currentTest.code.toUpperCase()) return showToast('Invalid test code', 'error');

            const container = document.getElementById('battleListContainer');
            const listContainer = document.getElementById('battleList');
            container.classList.remove('hidden');

            db.ref('battles').orderByChild('status').equalTo('waiting').on('value', snapshot => {
                listContainer.innerHTML = '';
                snapshot.forEach(child => {
                    const battle = child.val();
                    if (battle.testId === currentTest.id && battle.creator !== currentUser.id) {
                        listContainer.innerHTML += `
                            <div class="battle-item" onclick="joinBattle('${child.key}')">
                                <div>
                                    <strong>${battle.creatorName}</strong>
                                    <p style="font-size: 12px; color: var(--text-secondary);">${battle.testName}</p>
                                </div>
                                <button class="btn btn-primary btn-sm">Join</button>
                            </div>
                        `;
                    }
                });
                if (listContainer.innerHTML === '') {
                    listContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--text-secondary);">No battles available</p>';
                }
            });
        }

        async function joinBattle(battleId) {
            const battleRef = db.ref(`battles/${battleId}`);
            const snapshot = await battleRef.once('value');
            const battle = snapshot.val();

            if (!battle || battle.status !== 'waiting') return showToast('Battle no longer available', 'error');

            await battleRef.update({
                opponent: currentUser.id,
                opponentName: currentUser.name,
                status: 'ready'
            });

            currentBattle = { id: battleId };
            showToast('Joined battle! Starting...', 'success');

            const updatedSnapshot = await battleRef.once('value');
            await startQuiz(updatedSnapshot.val());
        }

        function showWaitingRoom(battleId) {
            hideAllPages();
            document.getElementById('waitingRoomPage').classList.remove('hidden');
            document.getElementById('waitingBattleId').textContent = battleId.slice(-6).toUpperCase();
        }

        async function cancelBattle() {
            if (currentBattle) {
                await db.ref(`battles/${currentBattle.id}`).remove();
            }
            currentBattle = null;
            showDashboard();
            showToast('Battle cancelled', 'info');
        }

        // Quiz System
        async function startQuiz(battle) {
            const testSnapshot = await db.ref(`tests/${battle.testId}`).once('value');
            currentTest = { id: battle.testId, ...testSnapshot.val() };
            currentBattle = { ...currentBattle, ...battle };
            currentQuestionIndex = 0;
            userAnswers = {};
            timeRemaining = (currentTest.duration || 60) * 60;

            hideAllPages();
            document.getElementById('quizPage').classList.remove('hidden');
            document.getElementById('chatPanel').classList.add('hidden');

            // Set opponent info
            const isCreator = currentBattle.creator === currentUser.id;
            const opponentId = isCreator ? currentBattle.opponent : currentBattle.creator;
            const opponentName = isCreator ? currentBattle.opponentName : currentBattle.creatorName;
            document.getElementById('opponentName').textContent = opponentName;
            document.getElementById('opponentAvatar').textContent = opponentName.charAt(0).toUpperCase();

            // Initialize battle state
            await db.ref(`battles/${currentBattle.id}/state/${currentUser.id}`).set({
                currentQuestion: 1,
                submitted: false
            });

            // Listen for opponent's progress
            db.ref(`battles/${currentBattle.id}/state/${opponentId}`).on('value', snapshot => {
                const state = snapshot.val();
                if (state) {
                    document.getElementById('opponentQuestion').textContent = state.currentQuestion || 1;
                    if (state.submitted && !state.handled) {
                        endQuiz();
                    }
                }
            });

            // Listen for chat messages
            db.ref(`battles/${currentBattle.id}/chat`).on('child_added', snapshot => {
                const msg = snapshot.val();
                if (msg.sender !== currentUser.id) {
                    appendChatMessage(msg.text, false);
                }
            });

            loadQuestion();
            startTimer();
            setupVoiceChat();
        }

        function loadQuestion() {
            const questions = Object.entries(currentTest.questions || {});
            const [qId, question] = questions[currentQuestionIndex];
            const total = questions.length;

            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = total;
            document.getElementById('questionText').textContent = question.text;

            const optionsList = document.getElementById('optionsList');
            optionsList.innerHTML = '';
            ['A', 'B', 'C', 'D'].forEach(letter => {
                if (question.options[letter]) {
                    const selected = userAnswers[qId] === letter ? 'selected' : '';
                    optionsList.innerHTML += `
                        <div class="option-item ${selected}" onclick="selectOption('${qId}', '${letter}')">
                            <div class="option-letter">${letter}</div>
                            <div>${question.options[letter]}</div>
                        </div>
                    `;
                }
            });

            // Update progress dots
            const progress = document.getElementById('quizProgress');
            progress.innerHTML = questions.map(([id], i) => `
                <div class="progress-dot ${i === currentQuestionIndex ? 'current' : ''} ${userAnswers[id] ? 'answered' : ''}" onclick="goToQuestion(${i})">${i + 1}</div>
            `).join('');

            // Update nav buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').classList.toggle('hidden', currentQuestionIndex === total - 1);
            document.getElementById('submitBtn').classList.toggle('hidden', currentQuestionIndex !== total - 1);

            // Update battle state
            db.ref(`battles/${currentBattle.id}/state/${currentUser.id}/currentQuestion`).set(currentQuestionIndex + 1);
        }

        function selectOption(questionId, answer) {
            userAnswers[questionId] = answer;
            loadQuestion();
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function nextQuestion() {
            const total = Object.keys(currentTest.questions || {}).length;
            if (currentQuestionIndex < total - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        }

        function goToQuestion(index) {
            currentQuestionIndex = index;
            loadQuestion();
        }

        function startTimer() {
            const timerDisplay = document.getElementById('quizTimer');
            quizTimer = setInterval(() => {
                timeRemaining--;
                const mins = Math.floor(timeRemaining / 60);
                const secs = timeRemaining % 60;
                timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                if (timeRemaining <= 0) {
                    endQuiz();
                }
            }, 1000);
        }

        async function submitQuiz() {
            if (!confirm('Are you sure you want to submit?')) return;
            await db.ref(`battles/${currentBattle.id}/state/${currentUser.id}`).update({
                submitted: true,
                answers: userAnswers
            });
            endQuiz();
        }

        async function endQuiz() {
            clearInterval(quizTimer);
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            // Calculate scores
            const questions = currentTest.questions || {};
            let myScore = 0;
            Object.entries(userAnswers).forEach(([qId, ans]) => {
                if (questions[qId] && questions[qId].answer === ans) myScore++;
            });

            // Get opponent's score
            const isCreator = currentBattle.creator === currentUser.id;
            const opponentId = isCreator ? currentBattle.opponent : currentBattle.creator;
            const opponentName = isCreator ? currentBattle.opponentName : currentBattle.creatorName;

            await db.ref(`battles/${currentBattle.id}/state/${currentUser.id}`).update({
                score: myScore,
                submitted: true
            });

            // Wait for opponent's score
            const stateSnapshot = await db.ref(`battles/${currentBattle.id}/state`).once('value');
            const state = stateSnapshot.val() || {};
            const opponentState = state[opponentId] || {};
            
            let opponentScore = 0;
            if (opponentState.answers) {
                Object.entries(opponentState.answers).forEach(([qId, ans]) => {
                    if (questions[qId] && questions[qId].answer === ans) opponentScore++;
                });
            }

            // Determine result and update points
            let result, myPointChange, opponentPointChange;
            if (myScore > opponentScore) {
                result = 'win';
                myPointChange = 10;
                opponentPointChange = -5;
            } else if (myScore < opponentScore) {
                result = 'lose';
                myPointChange = -5;
                opponentPointChange = 10;
            } else {
                result = 'draw';
                myPointChange = 0;
                opponentPointChange = 0;
            }

            // Update user points
            const myUserRef = db.ref(`users/${currentUser.id}`);
            const mySnapshot = await myUserRef.once('value');
            const myData = mySnapshot.val();
            let newPoints = (myData.points || 0) + myPointChange;
            if (newPoints < 0) newPoints = 0;

            await myUserRef.update({
                points: newPoints,
                wins: (myData.wins || 0) + (result === 'win' ? 1 : 0),
                losses: (myData.losses || 0) + (result === 'lose' ? 1 : 0),
                draws: (myData.draws || 0) + (result === 'draw' ? 1 : 0)
            });

            // Save record
            await db.ref(`records/${currentUser.id}`).push({
                testId: currentTest.id,
                testName: currentTest.name,
                opponentId,
                opponentName,
                myScore,
                opponentScore,
                result,
                pointChange: myPointChange,
                timestamp: Date.now()
            });

            // Get opponent's total points
            const opponentSnapshot = await db.ref(`users/${opponentId}`).once('value');
            const opponentData = opponentSnapshot.val() || {};
            let opponentNewPoints = (opponentData.points || 0) + opponentPointChange;
            if (opponentNewPoints < 0) opponentNewPoints = 0;

            // Show results
            showResults({
                result,
                myName: currentUser.name,
                myScore,
                myPointChange,
                myTotal: newPoints,
                opponentName,
                opponentScore,
                opponentPointChange,
                opponentTotal: opponentNewPoints
            });
        }

        function showResults(data) {
            hideAllPages();
            document.getElementById('resultsPage').classList.remove('hidden');

            const icons = { win: 'üèÜ', lose: 'üò¢', draw: 'ü§ù' };
            const titles = { win: 'You Won!', lose: 'You Lost!', draw: "It's a Draw!" };
            const classes = { win: 'result-win', lose: 'result-lose', draw: 'result-draw' };

            document.getElementById('resultIcon').textContent = icons[data.result];
            document.getElementById('resultIcon').className = `result-icon ${classes[data.result]}`;
            document.getElementById('resultTitle').textContent = titles[data.result];

            document.getElementById('resultMyAvatar').textContent = data.myName.charAt(0).toUpperCase();
            document.getElementById('resultMyName').textContent = data.myName;
            document.getElementById('resultMyScore').textContent = data.myScore;
            document.getElementById('resultMyPoints').textContent = data.myPointChange >= 0 ? `+${data.myPointChange}` : data.myPointChange;
            document.getElementById('resultMyPoints').className = `points-change ${data.myPointChange >= 0 ? 'points-positive' : 'points-negative'}`;
            document.getElementById('resultMyTotal').textContent = data.myTotal;

            document.getElementById('resultOpponentAvatar').textContent = data.opponentName.charAt(0).toUpperCase();
            document.getElementById('resultOpponentName').textContent = data.opponentName;
            document.getElementById('resultOpponentScore').textContent = data.opponentScore;
            document.getElementById('resultOpponentPoints').textContent = data.opponentPointChange >= 0 ? `+${data.opponentPointChange}` : data.opponentPointChange;
            document.getElementById('resultOpponentPoints').className = `points-change ${data.opponentPointChange >= 0 ? 'points-positive' : 'points-negative'}`;
            document.getElementById('resultOpponentTotal').textContent = data.opponentTotal;
        }

        function goToDashboard() {
            currentBattle = null;
            currentTest = null;
            showDashboard();
        }

        function playAgain() {
            if (currentTest) {
                startBattle(currentTest.id);
            } else {
                goToDashboard();
            }
        }

        // Chat System
        function toggleChat() {
            document.getElementById('chatPanel').classList.toggle('hidden');
        }

        function toggleEmoji() {
            document.getElementById('emojiPicker').classList.toggle('hidden');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('chatInput');
            input.value += emoji;
            document.getElementById('emojiPicker').classList.add('hidden');
            input.focus();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentBattle) return;

            db.ref(`battles/${currentBattle.id}/chat`).push({
                sender: currentUser.id,
                text,
                timestamp: Date.now()
            });

            appendChatMessage(text, true);
            input.value = '';
        }

        function appendChatMessage(text, sent) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `chat-message ${sent ? 'sent' : 'received'}`;
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Voice Chat
        async function setupVoiceChat() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // In a real implementation, you would set up WebRTC peer connection here
                // For simplicity, this is a basic setup
            } catch (err) {
                console.log('Voice chat not available:', err);
            }
        }

        function toggleMic() {
            micEnabled = !micEnabled;
            const btn = document.getElementById('micBtn');
            btn.classList.toggle('muted', !micEnabled);
            btn.innerHTML = `<i class="fas fa-microphone${micEnabled ? '' : '-slash'}"></i> Mic`;
            if (localStream) {
                localStream.getAudioTracks().forEach(track => track.enabled = micEnabled);
            }
        }

        function toggleSpeaker() {
            speakerEnabled = !speakerEnabled;
            const btn = document.getElementById('speakerBtn');
            btn.classList.toggle('muted', !speakerEnabled);
            btn.innerHTML = `<i class="fas fa-volume-${speakerEnabled ? 'up' : 'mute'}"></i> Speaker`;
        }

        // Settings
        function showSettings() {
            document.getElementById('settingsName').value = currentUser.name;
            document.getElementById('settingsCode').value = currentUser.code;
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        async function updateProfile() {
            const name = document.getElementById('settingsName').value.trim();
            const code = document.getElementById('settingsCode').value.trim();

            if (!name || !code) return showToast('Please fill all fields', 'error');

            // Check if code is taken by another user
            if (code !== currentUser.code) {
                const existingCode = await db.ref('users').orderByChild('code').equalTo(code).once('value');
                if (existingCode.exists()) return showToast('Access code already taken', 'error');
            }

            await db.ref(`users/${currentUser.id}`).update({ name, code });
            currentUser.name = name;
            currentUser.code = code;
            updateUserInfo();
            closeModal('settingsModal');
            showToast('Profile updated successfully', 'success');
        }

        async function deleteAccount() {
            if (!confirm('Are you sure you want to delete your account? This cannot be undone.')) return;
            
            await db.ref(`users/${currentUser.id}`).remove();
            await db.ref(`records/${currentUser.id}`).remove();
            logout();
            showToast('Account deleted', 'info');
        }

        // Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('darkModeIcon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Admin Functions
        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'admin123') { // Change this to your admin password
                closeModal('adminLoginModal');
                hideAllPages();
                document.getElementById('adminPage').classList.remove('hidden');
                loadAdminData();
                showToast('Welcome, Admin!', 'success');
            } else {
                showToast('Invalid password', 'error');
            }
        }

        function adminLogout() {
            hideAllPages();
            document.getElementById('authPage').classList.remove('hidden');
        }

        function showAdminSection(section) {
            document.querySelectorAll('.admin-tabs .btn').forEach(b => b.classList.remove('btn-primary'));
            document.querySelectorAll('.admin-tabs .btn').forEach(b => b.classList.add('btn-outline'));
            event.target.classList.remove('btn-outline');
            event.target.classList.add('btn-primary');
            
            ['adminUsers', 'adminTests', 'adminQuestions'].forEach(s => {
                document.getElementById(s).classList.toggle('hidden', s !== section);
            });
        }

        async function loadAdminData() {
            // Load users
            const usersSnapshot = await db.ref('users').once('value');
            const users = usersSnapshot.val() || {};
            const usersList = document.getElementById('adminUsersList');
            usersList.innerHTML = '';
            
            Object.entries(users).forEach(([id, user]) => {
                usersList.innerHTML += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.school}</td>
                        <td>${user.code}</td>
                        <td>${user.points || 0}</td>
                        <td><span style="color: ${user.restricted ? 'var(--danger)' : 'var(--secondary)'};">${user.restricted ? 'Restricted' : 'Active'}</span></td>
                        <td class="admin-actions">
                            <button onclick="editScore('${id}', '${user.name}', ${user.points || 0})" style="background: var(--primary); color: white;"><i class="fas fa-edit"></i></button>
                            <button onclick="toggleRestrict('${id}', ${!user.restricted})" style="background: var(--warning); color: white;"><i class="fas fa-${user.restricted ? 'unlock' : 'lock'}"></i></button>
                            <button onclick="deleteUser('${id}')" style="background: var(--danger); color: white;"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            // Load tests
            const testsSnapshot = await db.ref('tests').once('value');
            const tests = testsSnapshot.val() || {};
            const testsList = document.getElementById('adminTestsList');
            const testSelect = document.getElementById('adminTestSelect');
            testsList.innerHTML = '';
            testSelect.innerHTML = '<option value="">Select Test</option>';

            Object.entries(tests).forEach(([id, test]) => {
                const questionCount = test.questions ? Object.keys(test.questions).length : 0;
                testsList.innerHTML += `
                    <tr>
                        <td>${test.name}</td>
                        <td>${test.code}</td>
                        <td>${questionCount}</td>
                        <td>${test.duration || 60} mins</td>
                        <td class="admin-actions">
                            <button onclick="deleteTest('${id}')" style="background: var(--danger); color: white;"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                testSelect.innerHTML += `<option value="${id}">${test.name}</option>`;
            });
        }

        function editScore(userId, userName, currentScore) {
            editingScoreUserId = userId;
            document.getElementById('editScoreUserName').textContent = userName;
            document.getElementById('editScoreValue').value = currentScore;
            document.getElementById('editScoreModal').classList.remove('hidden');
        }

        async function saveScore() {
            const newScore = parseInt(document.getElementById('editScoreValue').value) || 0;
            await db.ref(`users/${editingScoreUserId}/points`).set(newScore);
            closeModal('editScoreModal');
            loadAdminData();
            showToast('Score updated', 'success');
        }

        async function toggleRestrict(userId, restrict) {
            await db.ref(`users/${userId}/restricted`).set(restrict);
            loadAdminData();
            showToast(`User ${restrict ? 'restricted' : 'unrestricted'}`, 'success');
        }

        async function deleteUser(userId) {
            if (!confirm('Delete this user?')) return;
            await db.ref(`users/${userId}`).remove();
            await db.ref(`records/${userId}`).remove();
            loadAdminData();
            showToast('User deleted', 'success');
        }

        function showAddTestModal() {
            document.getElementById('newTestName').value = '';
            document.getElementById('newTestCode').value = '';
            document.getElementById('newTestDuration').value = 60;
            document.getElementById('addTestModal').classList.remove('hidden');
        }

        async function addTest() {
            const name = document.getElementById('newTestName').value.trim();
            const code = document.getElementById('newTestCode').value.trim().toUpperCase();
            const duration = parseInt(document.getElementById('newTestDuration').value) || 60;

            if (!name || code.length !== 6) return showToast('Please fill all fields correctly', 'error');

            await db.ref('tests').push({ name, code, duration, questions: {} });
            closeModal('addTestModal');
            loadAdminData();
            showToast('Test added', 'success');
        }

        async function deleteTest(testId) {
            if (!confirm('Delete this test and all its questions?')) return;
            await db.ref(`tests/${testId}`).remove();
            loadAdminData();
            showToast('Test deleted', 'success');
        }

        async function loadAdminQuestions() {
            const testId = document.getElementById('adminTestSelect').value;
            const container = document.getElementById('adminQuestionsList');
            
            if (!testId) {
                container.innerHTML = '<tr><td colspan="5" style="text-align: center;">Select a test</td></tr>';
                return;
            }

            const snapshot = await db.ref(`tests/${testId}/questions`).once('value');
            const questions = snapshot.val() || {};
            container.innerHTML = '';

            Object.entries(questions).forEach(([id, q], i) => {
                container.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${q.text.substring(0, 50)}...</td>
                        <td>A: ${q.options.A}, B: ${q.options.B}, C: ${q.options.C}, D: ${q.options.D}</td>
                        <td>${q.answer}</td>
                        <td class="admin-actions">
                            <button onclick="editQuestion('${testId}', '${id}')" style="background: var(--primary); color: white;"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteQuestion('${testId}', '${id}')" style="background: var(--danger); color: white;"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            if (Object.keys(questions).length === 0) {
                container.innerHTML = '<tr><td colspan="5" style="text-align: center;">No questions</td></tr>';
            }
        }

        function showAddQuestionModal() {
            const testId = document.getElementById('adminTestSelect').value;
            if (!testId) return showToast('Select a test first', 'error');

            editingQuestionId = null;
            document.getElementById('questionModalTitle').innerHTML = '<i class="fas fa-plus"></i> Add Question';
            document.getElementById('newQuestionText').value = '';
            document.getElementById('newOptionA').value = '';
            document.getElementById('newOptionB').value = '';
            document.getElementById('newOptionC').value = '';
            document.getElementById('newOptionD').value = '';
            document.getElementById('newCorrectAnswer').value = 'A';
            document.getElementById('addQuestionModal').classList.remove('hidden');
        }

        async function editQuestion(testId, questionId) {
            editingQuestionId = questionId;
            const snapshot = await db.ref(`tests/${testId}/questions/${questionId}`).once('value');
            const q = snapshot.val();

            document.getElementById('questionModalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Question';
            document.getElementById('newQuestionText').value = q.text;
            document.getElementById('newOptionA').value = q.options.A;
            document.getElementById('newOptionB').value = q.options.B;
            document.getElementById('newOptionC').value = q.options.C;
            document.getElementById('newOptionD').value = q.options.D;
            document.getElementById('newCorrectAnswer').value = q.answer;
            document.getElementById('addQuestionModal').classList.remove('hidden');
        }

        async function saveQuestion() {
            const testId = document.getElementById('adminTestSelect').value;
            const text = document.getElementById('newQuestionText').value.trim();
            const optionA = document.getElementById('newOptionA').value.trim();
            const optionB = document.getElementById('newOptionB').value.trim();
            const optionC = document.getElementById('newOptionC').value.trim();
            const optionD = document.getElementById('newOptionD').value.trim();
            const answer = document.getElementById('newCorrectAnswer').value;

            if (!text || !optionA || !optionB || !optionC || !optionD) {
                return showToast('Please fill all fields', 'error');
            }

            const questionData = {
                text,
                options: { A: optionA, B: optionB, C: optionC, D: optionD },
                answer
            };

            if (editingQuestionId) {
                await db.ref(`tests/${testId}/questions/${editingQuestionId}`).set(questionData);
            } else {
                await db.ref(`tests/${testId}/questions`).push(questionData);
            }

            closeModal('addQuestionModal');
            loadAdminQuestions();
            showToast('Question saved', 'success');
        }

        async function deleteQuestion(testId, questionId) {
            if (!confirm('Delete this question?')) return;
            await db.ref(`tests/${testId}/questions/${questionId}`).remove();
            loadAdminQuestions();
            showToast('Question deleted', 'success');
        }

        // Utility Functions
        function hideAllPages() {
            document.querySelectorAll('#app > div').forEach(p => p.classList.add('hidden'));
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Initialize
        initApp();
    </script>
</body>
</html>