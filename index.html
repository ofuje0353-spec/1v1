<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofuje - Multiplayer CBT</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass: rgba(255,255,255,0.15);
            --glass-border: rgba(255,255,255,0.3);
            --text: #fff;
            --text-muted: rgba(255,255,255,0.7);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        .dark {
            --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --glass: rgba(0,0,0,0.3);
            --glass-border: rgba(255,255,255,0.1);
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            transition: all 0.3s;
        }
        .glass {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        /* Auth Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .auth-box {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            text-align: center;
        }
        .auth-box h1 { font-size: 3rem; margin-bottom: 10px; }
        .auth-box .subtitle { color: var(--text-muted); margin-bottom: 30px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        .tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab.active, .tab:hover { background: var(--glass); }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            padding: 15px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text);
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }
        input:focus { border-color: #fff; }
        input::placeholder { color: var(--text-muted); }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            width: 100%;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .btn-secondary { background: var(--glass); color: var(--text); border: 1px solid var(--glass-border); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }

        /* Dashboard */
        .dashboard { padding: 20px; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            margin-bottom: 30px;
        }
        .logo { font-size: 1.8rem; font-weight: bold; }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .user-details h3 { font-size: 1rem; }
        .user-details p { font-size: 0.8rem; color: var(--text-muted); }
        .header-actions { display: flex; gap: 10px; }
        .icon-btn {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.25); }

        /* Nav */
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav-btn {
            padding: 12px 24px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav-btn.active, .nav-btn:hover { background: rgba(255,255,255,0.25); }

        /* Cards */
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .card { padding: 25px; }
        .card h3 { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Tests */
        .test-card {
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .test-card:hover { transform: translateY(-5px); }
        .test-card h4 { font-size: 1.2rem; margin-bottom: 10px; }
        .test-card p { color: var(--text-muted); font-size: 0.9rem; }
        .test-meta {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        .test-meta span { display: flex; align-items: center; gap: 5px; }

        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            background: var(--glass);
        }
        .rank {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .rank.gold { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .rank.silver { background: linear-gradient(135deg, #9ca3af, #6b7280); }
        .rank.bronze { background: linear-gradient(135deg, #b45309, #92400e); }
        .leaderboard-info { flex: 1; }
        .leaderboard-points { font-weight: bold; font-size: 1.1rem; }

        /* Quiz */
        .quiz-container { max-width: 900px; margin: 0 auto; }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            margin-bottom: 20px;
        }
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .timer.warning { color: var(--warning); }
        .timer.danger { color: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .players-status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .player-card {
            flex: 1;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .player-card.you { border-left: 4px solid var(--success); }
        .player-card.opponent { border-left: 4px solid var(--warning); }
        .player-status { flex: 1; }
        .player-question { font-size: 0.85rem; color: var(--text-muted); }

        .question-card { padding: 30px; margin-bottom: 20px; }
        .question-number { color: var(--text-muted); margin-bottom: 10px; }
        .question-text { font-size: 1.3rem; margin-bottom: 25px; line-height: 1.6; }
        .options { display: grid; gap: 12px; }
        .option {
            padding: 18px 20px;
            background: var(--glass);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .option:hover { background: rgba(255,255,255,0.2); }
        .option.selected { border-color: var(--success); background: rgba(16,185,129,0.2); }
        .option-letter {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .quiz-nav {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        /* Voice Controls */
        .voice-controls {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-radius: 12px;
            background: var(--glass);
        }
        .voice-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: all 0.3s;
        }
        .voice-btn.mic { background: var(--success); color: #fff; }
        .voice-btn.mic.off { background: var(--danger); }
        .voice-btn.speaker { background: #3b82f6; color: #fff; }
        .voice-btn.speaker.off { background: var(--danger); }

        /* Waiting Room */
        .waiting-room {
            text-align: center;
            padding: 60px 30px;
        }
        .waiting-room h2 { font-size: 2rem; margin-bottom: 20px; }
        .waiting-room p { color: var(--text-muted); margin-bottom: 30px; }
        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid var(--glass);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Results */
        .results-container { text-align: center; padding: 40px; }
        .results-container h2 { font-size: 2.5rem; margin-bottom: 30px; }
        .results-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: center; margin-bottom: 30px; }
        .result-card { padding: 30px; text-align: center; }
        .result-card h3 { font-size: 1.3rem; margin-bottom: 10px; }
        .result-score { font-size: 3rem; font-weight: bold; margin-bottom: 10px; }
        .result-card.winner { border: 3px solid var(--success); }
        .result-card.loser { border: 3px solid var(--danger); }
        .vs-text { font-size: 2rem; font-weight: bold; color: var(--text-muted); }
        .point-change { font-size: 1.2rem; margin-top: 10px; }
        .point-change.positive { color: var(--success); }
        .point-change.negative { color: var(--danger); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal {
            width: 100%;
            max-width: 450px;
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h3 { margin-bottom: 20px; text-align: center; }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Admin */
        .admin-section { margin-bottom: 30px; }
        .admin-section h3 { margin-bottom: 15px; }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        .admin-table th, .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }
        .admin-table th { color: var(--text-muted); font-weight: 500; }
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
        }
        .badge-success { background: var(--success); }
        .badge-danger { background: var(--danger); }

        /* Records */
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 12px;
            background: var(--glass);
            margin-bottom: 10px;
        }
        .record-info h4 { margin-bottom: 5px; }
        .record-info p { font-size: 0.85rem; color: var(--text-muted); }
        .record-score { text-align: right; }

        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .results-grid { grid-template-columns: 1fr; }
            .vs-text { order: -1; }
            .quiz-nav { flex-direction: column; }
            .players-status { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-box glass">
            <h1>ðŸŽ“ Ofuje</h1>
            <p class="subtitle">Multiplayer CBT Platform</p>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('login')">Login</button>
                <button class="tab" onclick="switchTab('register')">Register</button>
            </div>
            <div id="loginForm">
                <div class="form-group">
                    <label>Access Code</label>
                    <input type="text" id="loginCode" placeholder="Enter your access code">
                </div>
                <button class="btn btn-primary" onclick="login()">
                    <i class="ri-login-box-line"></i> Login
                </button>
            </div>
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Preferred Access Code</label>
                    <input type="text" id="regCode" placeholder="Create your unique code">
                </div>
                <button class="btn btn-primary" onclick="register()">
                    <i class="ri-user-add-line"></i> Register
                </button>
            </div>
            <div style="margin-top:20px">
                <button class="btn btn-secondary btn-sm" onclick="showAdminLogin()">
                    <i class="ri-admin-line"></i> Admin
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal-overlay hidden">
        <div class="modal glass">
            <h3><i class="ri-admin-line"></i> Admin Login</h3>
            <div class="form-group">
                <label>Admin Code</label>
                <input type="password" id="adminCode" placeholder="Enter admin code">
            </div>
            <button class="btn btn-primary" onclick="adminLogin()">Login</button>
            <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="hideAdminLogin()">Cancel</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard hidden">
        <div class="container">
            <div class="header glass">
                <div class="logo">ðŸŽ“ Ofuje</div>
                <div class="user-info">
                    <div class="avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <h3 id="userName">User</h3>
                        <p><span id="userPoints">0</span> points</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                        <i class="ri-moon-line" id="darkModeIcon"></i>
                    </button>
                    <button class="icon-btn" onclick="logout()" title="Logout">
                        <i class="ri-logout-box-line"></i>
                    </button>
                </div>
            </div>

            <div class="nav">
                <button class="nav-btn active" onclick="showSection('tests')">
                    <i class="ri-file-list-3-line"></i> Tests
                </button>
                <button class="nav-btn" onclick="showSection('records')">
                    <i class="ri-history-line"></i> My Records
                </button>
                <button class="nav-btn" onclick="showSection('leaderboard')">
                    <i class="ri-trophy-line"></i> Leaderboard
                </button>
                <button class="nav-btn" onclick="showSection('users')">
                    <i class="ri-group-line"></i> Users
                </button>
            </div>

            <!-- Tests Section -->
            <div id="testsSection" class="section">
                <div class="grid grid-2">
                    <div class="test-card glass" onclick="selectTest('test1')">
                        <h4><i class="ri-test-tube-fill"></i> UTME BIOLOGY</h4>
                        <p>Test your knowledge across various topics</p>
                        <div class="test-meta">
                            <span><i class="ri-question-line"></i> 40 Questions</span>
                            <span><i class="ri-time-line"></i> 1 Hour</span>
                        </div>
                    </div>
                    <div class="test-card glass" onclick="selectTest('test2')">
                        <h4><i class="ri-code-box-line"></i>UTME CHEMISTRY</h4>
                        <p>CHEMISTRY GOT YOU</p>
                        <div class="test-meta">
                            <span><i class="ri-question-line"></i> 40 Questions</span>
                            <span><i class="ri-time-line"></i> 1 Hour</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records Section -->
            <div id="recordsSection" class="section hidden">
                <div class="card glass">
                    <h3><i class="ri-history-line"></i> My Test Records</h3>
                    <div id="recordsList"></div>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div id="leaderboardSection" class="section hidden">
                <div class="card glass">
                    <h3><i class="ri-trophy-line"></i> Leaderboard</h3>
                    <div id="leaderboardList"></div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="section hidden">
                <div class="card glass">
                    <h3><i class="ri-group-line"></i> All Users</h3>
                    <div id="usersList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Code Modal -->
    <div id="testCodeModal" class="modal-overlay hidden">
        <div class="modal glass">
            <h3><i class="ri-lock-line"></i> Enter Test Code</h3>
            <p style="color:var(--text-muted);margin-bottom:20px;text-align:center">Enter the test access code to proceed</p>
            <div class="form-group">
                <input type="text" id="testAccessCode" placeholder="Enter code">
            </div>
            <button class="btn btn-primary" onclick="verifyTestCode()">Proceed</button>
            <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="hideTestCodeModal()">Cancel</button>
        </div>
    </div>

    <!-- Waiting Room -->
    <div id="waitingRoom" class="hidden">
        <div class="container">
            <div class="waiting-room glass">
                <div class="loader"></div>
                <h2>Waiting for Opponent...</h2>
                <p>The test will begin when another user joins</p>
                <p id="waitingTestName" style="margin-top:10px;font-weight:bold"></p>
                <button class="btn btn-secondary" style="margin-top:20px" onclick="cancelWaiting()">
                    <i class="ri-close-line"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quizScreen" class="hidden">
        <div class="quiz-container">
            <div class="quiz-header glass">
                <div>
                    <h2 id="quizTitle">Quiz</h2>
                </div>
                <div class="timer" id="timer">
                    <i class="ri-time-line"></i>
                    <span id="timerDisplay">60:00</span>
                </div>
            </div>

            <div class="players-status">
                <div class="player-card glass you">
                    <div class="avatar" id="myQuizAvatar">A</div>
                    <div class="player-status">
                        <strong id="myQuizName">You</strong>
                        <p class="player-question">Question <span id="myCurrentQ">1</span></p>
                    </div>
                </div>
                <div class="player-card glass opponent">
                    <div class="avatar" id="oppQuizAvatar">B</div>
                    <div class="player-status">
                        <strong id="oppQuizName">Opponent</strong>
                        <p class="player-question">Question <span id="oppCurrentQ">1</span></p>
                    </div>
                </div>
                <div class="voice-controls">
                    <button class="voice-btn mic" id="micBtn" onclick="toggleMic()">
                        <i class="ri-mic-line"></i>
                    </button>
                    <button class="voice-btn speaker" id="speakerBtn" onclick="toggleSpeaker()">
                        <i class="ri-volume-up-line"></i>
                    </button>
                </div>
            </div>

            <div class="question-card glass">
                <p class="question-number">Question <span id="questionNum">1</span> of <span id="totalQuestions">2</span></p>
                <p class="question-text" id="questionText">Loading...</p>
                <div class="options" id="optionsContainer"></div>
            </div>

            <div class="quiz-nav">
                <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()">
                    <i class="ri-arrow-left-line"></i> Previous
                </button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">
                    Next <i class="ri-arrow-right-line"></i>
                </button>
                <button class="btn btn-success hidden" id="submitBtn" onclick="submitQuiz()">
                    <i class="ri-check-line"></i> Submit
                </button>
            </div>
        </div>
        <audio id="remoteAudio" autoplay></audio>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" class="hidden">
        <div class="container">
            <div class="results-container glass">
                <h2 id="resultTitle">ðŸŽ‰ Results</h2>
                <div class="results-grid">
                    <div class="result-card glass" id="myResultCard">
                        <h3 id="myResultName">You</h3>
                        <div class="result-score" id="myResultScore">0/2</div>
                        <p class="point-change" id="myPointChange">+0 points</p>
                        <p style="margin-top:10px">Total: <strong id="myTotalPoints">0</strong> pts</p>
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="result-card glass" id="oppResultCard">
                        <h3 id="oppResultName">Opponent</h3>
                        <div class="result-score" id="oppResultScore">0/2</div>
                        <p class="point-change" id="oppPointChange">+0 points</p>
                        <p style="margin-top:10px">Total: <strong id="oppTotalPoints">0</strong> pts</p>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="backToDashboard()">
                    <i class="ri-arrow-left-line"></i> Back to Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard hidden">
        <div class="container">
            <div class="header glass">
                <div class="logo">ðŸŽ“ Ofuje Admin</div>
                <button class="btn btn-secondary" onclick="logoutAdmin()">
                    <i class="ri-logout-box-line"></i> Logout
                </button>
            </div>

            <div class="nav">
                <button class="nav-btn active" onclick="showAdminSection('users')">
                    <i class="ri-group-line"></i> Users
                </button>
                <button class="nav-btn" onclick="showAdminSection('questions')">
                    <i class="ri-question-line"></i> Questions
                </button>
            </div>

            <div id="adminUsersSection" class="admin-section">
                <div class="card glass">
                    <h3>Manage Users</h3>
                    <div style="overflow-x:auto">
                        <table class="admin-table">
                            <thead>
                                <tr><th>Name</th><th>Code</th><th>Points</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="adminUsersList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="adminQuestionsSection" class="admin-section hidden">
                <div class="card glass">
                    <h3>Manage Questions</h3>
                    <button class="btn btn-primary btn-sm" style="margin-bottom:20px" onclick="showAddQuestion()">
                        <i class="ri-add-line"></i> Add Question
                    </button>
                    <div id="adminQuestionsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="addQuestionModal" class="modal-overlay hidden">
        <div class="modal glass" style="max-width:600px">
            <h3>Add Question</h3>
            <div class="form-group">
                <label>Test</label>
                <select id="qTest">
                    <option value="test1">UTME Biology</option>
                    <option value="test2">UTME CHEMISTRY</option>
                </select>
            </div>
            <div class="form-group">
                <label>Question</label>
                <textarea id="qText" rows="3" placeholder="Enter question"></textarea>
            </div>
            <div class="form-group">
                <label>Option A</label>
                <input type="text" id="qOptA" placeholder="Option A">
            </div>
            <div class="form-group">
                <label>Option B</label>
                <input type="text" id="qOptB" placeholder="Option B">
            </div>
            <div class="form-group">
                <label>Option C</label>
                <input type="text" id="qOptC" placeholder="Option C">
            </div>
            <div class="form-group">
                <label>Option D</label>
                <input type="text" id="qOptD" placeholder="Option D">
            </div>
            <div class="form-group">
                <label>Correct Answer</label>
                <select id="qCorrect">
                    <option value="0">A</option>
                    <option value="1">B</option>
                    <option value="2">C</option>
                    <option value="3">D</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="addQuestion()">Add Question</button>
            <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="hideAddQuestion()">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, update, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';

        // Firebase Config - Replace with your config
        const firebaseConfig = {
  apiKey: "AIzaSyCVsJWPuTG26HfbdWdvPu65zMd6IldCIKE",
  authDomain: "ofjj-3d77f.firebaseapp.com",
  projectId: "ofjj-3d77f",
  storageBucket: "ofjj-3d77f.firebasestorage.app",
  messagingSenderId: "529373630534",
  appId: "1:529373630534:web:2b9acd7ae4f98c28583a47",
  measurementId: "G-QZHM5DFDTY"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // State
        let currentUser = null;
        let currentTest = null;
        let currentSession = null;
        let questions = [];
        let currentQ = 0;
        let answers = {};
        let timerInterval = null;
        let timeLeft = 3600;
        let localStream = null;
        let peerConnection = null;
        let micOn = true;
        let speakerOn = true;

        // Initialize default data
        async function initDefaults() {
            const testsRef = ref(db, 'tests');
            const snapshot = await get(testsRef);
            if (!snapshot.exists()) {
                await set(ref(db, 'tests/test1'), {
                    title: 'UTME Biology',
                    questions: [
  { q: 'Which organelle is responsible for energy production in cells?', opts: ['Ribosome', 'Mitochondrion', 'Nucleus', 'Lysosome'], ans: 1 },
  { q: 'The movement of water molecules across a semi-permeable membrane is called?', opts: ['Diffusion', 'Active transport', 'Osmosis', 'Translocation'], ans: 2 },
  { q: 'Which level of organization comes immediately after tissue?', opts: ['Cell', 'System', 'Organ', 'Organism'], ans: 2 },
  { q: 'The functional unit of the kidney is the?', opts: ['Neuron', 'Nephron', 'Alveolus', 'Glomerulus'], ans: 1 },
  { q: 'Which blood group is known as the universal donor?', opts: ['AB', 'A', 'O', 'B'], ans: 2 },
  { q: 'In flowering plants, fertilization takes place in the?', opts: ['Anther', 'Ovary', 'Stigma', 'Style'], ans: 1 },
  { q: 'Which structure controls activities of the cell?', opts: ['Cytoplasm', 'Cell wall', 'Nucleus', 'Vacuole'], ans: 2 },
  { q: 'The main function of xylem tissue is to?', opts: ['Transport food', 'Support the plant', 'Transport water', 'Store starch'], ans: 2 },
  { q: 'Which process releases energy from food substances?', opts: ['Respiration', 'Photosynthesis', 'Transpiration', 'Excretion'], ans: 0 },
  { q: 'A dominant trait is one that?', opts: ['Is always harmful', 'Appears only in females', 'Masks another trait', 'Never changes'], ans: 2 },
  { q: 'Which part of the human eye controls the amount of light entering?', opts: ['Lens', 'Retina', 'Iris', 'Cornea'], ans: 2 },
  { q: 'The simplest form of life is the?', opts: ['Virus', 'Bacterium', 'Protozoan', 'Alga'], ans: 1 },
  { q: 'Which gas is released during photosynthesis?', opts: ['Carbon dioxide', 'Nitrogen', 'Oxygen', 'Hydrogen'], ans: 2 },
  { q: 'The mode of nutrition in fungi is?', opts: ['Autotrophic', 'Holozoic', 'Saprophytic', 'Parasitic'], ans: 2 },
  { q: 'Which organ is mainly responsible for detoxification?', opts: ['Kidney', 'Liver', 'Heart', 'Pancreas'], ans: 1 },
  { q: 'The transfer of pollen from anther to stigma is called?', opts: ['Fertilization', 'Pollination', 'Germination', 'Dispersal'], ans: 1 },
  { q: 'Which class of vertebrates has moist skin?', opts: ['Reptiles', 'Birds', 'Mammals', 'Amphibians'], ans: 3 },
  { q: 'The genetic makeup of an organism is known as its?', opts: ['Phenotype', 'Genotype', 'Trait', 'Variation'], ans: 1 },
  { q: 'Which structure is absent in animal cells?', opts: ['Mitochondrion', 'Nucleus', 'Cell wall', 'Ribosome'], ans: 2 },
  { q: 'The process by which green plants make food is?', opts: ['Respiration', 'Photosynthesis', 'Translocation', 'Excretion'], ans: 1 },
  { q: 'Which organism shows both plant and animal characteristics?', opts: ['Amoeba', 'Paramecium', 'Euglena', 'Chlamydomonas'], ans: 2 },
  { q: 'The removal of metabolic waste from the body is called?', opts: ['Respiration', 'Excretion', 'Nutrition', 'Circulation'], ans: 1 },
  { q: 'Which part of the brain controls balance?', opts: ['Cerebrum', 'Medulla', 'Cerebellum', 'Hypothalamus'], ans: 2 },
  { q: 'An example of a biotic factor is?', opts: ['Temperature', 'Rainfall', 'Soil', 'Bacteria'], ans: 3 },
  { q: 'The exchange of gases in humans occurs in the?', opts: ['Bronchi', 'Trachea', 'Alveoli', 'Larynx'], ans: 2 },
  { q: 'Which vitamin is produced in the skin by sunlight?', opts: ['Vitamin A', 'Vitamin B', 'Vitamin C', 'Vitamin D'], ans: 3 },
  { q: 'The green pigment in leaves responsible for photosynthesis is?', opts: ['Carotene', 'Xanthophyll', 'Chlorophyll', 'Anthocyanin'], ans: 2 },
  { q: 'Which blood vessel carries blood away from the heart?', opts: ['Vein', 'Capillary', 'Artery', 'Venule'], ans: 2 },
  { q: 'A habitat is best described as?', opts: ['A feeding relationship', 'Where an organism lives', 'A group of organisms', 'A physical feature'], ans: 1 },
  { q: 'Which disease is caused by a virus?', opts: ['Tuberculosis', 'Malaria', 'Measles', 'Cholera'], ans: 2 },
  { q: 'The smallest unit of life is the?', opts: ['Tissue', 'Organ', 'Cell', 'System'], ans: 2 },
  { q: 'Which process leads to increase in size of an organism?', opts: ['Reproduction', 'Growth', 'Respiration', 'Movement'], ans: 1 },
  { q: 'Which part of a flower develops into a fruit?', opts: ['Ovule', 'Ovary', 'Petal', 'Sepal'], ans: 1 },
  { q: 'The ability of an organism to respond to stimuli is called?', opts: ['Adaptation', 'Irritability', 'Variation', 'Mutation'], ans: 1 },
  { q: 'Which structure is used for breathing in insects?', opts: ['Gills', 'Lungs', 'Spiracles', 'Skin'], ans: 2 },
  { q: 'An example of an inherited characteristic is?', opts: ['Scar', 'Language', 'Eye colour', 'Tribe'], ans: 2 },
  { q: 'Which kingdom includes mushrooms?', opts: ['Plantae', 'Protista', 'Animalia', 'Fungi'], ans: 3 },
  { q: 'The process by which organisms produce offspring is?', opts: ['Growth', 'Respiration', 'Reproduction', 'Excretion'], ans: 2 },
  { q: 'Which organ pumps blood round the body?', opts: ['Liver', 'Heart', 'Kidney', 'Lung'], ans: 1 }
]
                });
                await set(ref(db, 'tests/test2'), {
                    title: 'UTME CHEMISTRY',
                    questions: [
  { q: 'Which of the following particles has no electrical charge?', opts: ['Proton', 'Electron', 'Neutron', 'Ion'], ans: 2 },
  { q: 'The SI unit of temperature is?', opts: ['Celsius', 'Fahrenheit', 'Kelvin', 'Joule'], ans: 2 },
  { q: 'Which of these elements is a metalloid?', opts: ['Sodium', 'Silicon', 'Sulphur', 'Calcium'], ans: 1 },
  { q: 'The process of separating a mixture using a separating funnel is based on difference in?', opts: ['Density', 'Solubility', 'Particle size', 'Boiling point'], ans: 0 },
  { q: 'Which gas is evolved when calcium carbonate reacts with dilute acid?', opts: ['Hydrogen', 'Oxygen', 'Carbon dioxide', 'Nitrogen'], ans: 2 },
  { q: 'The valency of aluminium is?', opts: ['1', '2', '3', '4'], ans: 2 },
  { q: 'Which of the following solutions will have the lowest pH?', opts: ['NaOH', 'NaCl', 'HCl', 'NHâ‚„OH'], ans: 2 },
  { q: 'The process by which liquid changes to gas at all temperatures is?', opts: ['Boiling', 'Evaporation', 'Condensation', 'Sublimation'], ans: 1 },
  { q: 'Which substance is used as an electrolyte in a leadâ€“acid battery?', opts: ['Nitric acid', 'Hydrochloric acid', 'Sulphuric acid', 'Ethanoic acid'], ans: 2 },
  { q: 'An example of a base is?', opts: ['Hâ‚‚SOâ‚„', 'NaOH', 'HNOâ‚ƒ', 'HCl'], ans: 1 },
  { q: 'Which method is best for separating dyes in ink?', opts: ['Filtration', 'Distillation', 'Chromatography', 'Evaporation'], ans: 2 },
  { q: 'The mass number of an atom is the total number of?', opts: ['Protons only', 'Neutrons only', 'Electrons and protons', 'Protons and neutrons'], ans: 3 },
  { q: 'Which of the following is an exothermic reaction?', opts: ['Photosynthesis', 'Melting of ice', 'Combustion', 'Dissolving ammonium chloride'], ans: 2 },
  { q: 'Which gas has a choking smell?', opts: ['Oxygen', 'Hydrogen', 'Chlorine', 'Nitrogen'], ans: 2 },
  { q: 'The main purpose of galvanizing iron is to?', opts: ['Increase strength', 'Prevent rusting', 'Improve conductivity', 'Change colour'], ans: 1 },
  { q: 'Which of these is an alloy?', opts: ['Brass', 'Iron', 'Copper', 'Aluminium'], ans: 0 },
  { q: 'The reaction between an acid and a base produces salt and?', opts: ['Water', 'Hydrogen', 'Oxygen', 'Carbon dioxide'], ans: 0 },
  { q: 'Which compound turns blue litmus paper red?', opts: ['NaOH', 'NHâ‚ƒ', 'HCl', 'NaCl'], ans: 2 },
  { q: 'The common name for calcium hydroxide solution is?', opts: ['Slaked lime', 'Limewater', 'Quicklime', 'Washing soda'], ans: 1 },
  { q: 'Which factor increases the rate of chemical reaction?', opts: ['Lower temperature', 'Smaller surface area', 'Presence of catalyst', 'Lower concentration'], ans: 2 },
  { q: 'Which of the following is NOT a fossil fuel?', opts: ['Coal', 'Petroleum', 'Natural gas', 'Charcoal'], ans: 3 },
  { q: 'The gas used in welding metals is?', opts: ['Oxygen', 'Hydrogen', 'Acetylene', 'Nitrogen'], ans: 2 },
  { q: 'Which element has the highest electronegativity?', opts: ['Oxygen', 'Fluorine', 'Chlorine', 'Nitrogen'], ans: 1 },
  { q: 'An example of a transition metal is?', opts: ['Sodium', 'Magnesium', 'Iron', 'Potassium'], ans: 2 },
  { q: 'Which compound is responsible for hardness of water?', opts: ['Sodium chloride', 'Calcium bicarbonate', 'Potassium nitrate', 'Ammonium sulphate'], ans: 1 },
  { q: 'The flame used for laboratory heating is the?', opts: ['Candle flame', 'Bunsen burner', 'Kerosene lamp', 'Spirit lamp'], ans: 1 },
  { q: 'Which gas is used in the manufacture of ammonia?', opts: ['Oxygen', 'Nitrogen', 'Carbon dioxide', 'Chlorine'], ans: 1 },
  { q: 'The process of breaking down a compound using electricity is?', opts: ['Electrolysis', 'Neutralization', 'Oxidation', 'Reduction'], ans: 0 },
  { q: 'Which of the following is an acidic oxide?', opts: ['Naâ‚‚O', 'CaO', 'SOâ‚‚', 'MgO'], ans: 2 },
  { q: 'The pH value of a strong alkali is close to?', opts: ['1', '7', '14', '5'], ans: 2 },
  { q: 'Which metal is extracted by electrolysis?', opts: ['Iron', 'Copper', 'Aluminium', 'Zinc'], ans: 2 },
  { q: 'The chemical formula of ammonia is?', opts: ['NHâ‚‚', 'NHâ‚ƒ', 'NOâ‚‚', 'Nâ‚‚Hâ‚„'], ans: 1 },
  { q: 'Which indicator turns yellow in acidic solution?', opts: ['Phenolphthalein', 'Blue litmus', 'Methyl orange', 'Universal indicator'], ans: 2 },
  { q: 'The major component of air is?', opts: ['Oxygen', 'Carbon dioxide', 'Nitrogen', 'Argon'], ans: 2 },
  { q: 'Which of the following is a strong acid?', opts: ['Ethanoic acid', 'Carbonic acid', 'Hydrochloric acid', 'Citric acid'], ans: 2 },
  { q: 'The process of rusting requires water and?', opts: ['Hydrogen', 'Nitrogen', 'Carbon dioxide', 'Oxygen'], ans: 3 },
  { q: 'Which substance is used to soften hard water?', opts: ['Sodium chloride', 'Washing soda', 'Baking soda', 'Calcium oxide'], ans: 1 },
  { q: 'Which of the following is a reducing agent?', opts: ['Oxygen', 'Chlorine', 'Carbon monoxide', 'Nitric acid'], ans: 2 },
  { q: 'The IUPAC name of common salt is?', opts: ['Sodium carbonate', 'Sodium chloride', 'Sodium hydroxide', 'Sodium nitrate'], ans: 1 }
]
                });
            }
        }
        initDefaults();

        // Auth Functions
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        };

        window.login = async () => {
            const code = document.getElementById('loginCode').value.trim();
            if (!code) return alert('Enter access code');
            const snapshot = await get(ref(db, `users/${code}`));
            if (!snapshot.exists()) return alert('Invalid code');
            const user = snapshot.val();
            if (user.restricted) return alert('Account restricted');
            currentUser = { code, ...user };
            showDashboard();
        };

        window.register = async () => {
            const name = document.getElementById('regName').value.trim();
            const code = document.getElementById('regCode').value.trim();
            if (!name || !code) return alert('Fill all fields');
            const snapshot = await get(ref(db, `users/${code}`));
            if (snapshot.exists()) return alert('Code already taken');
            await set(ref(db, `users/${code}`), { name, points: 0, restricted: false, created: Date.now() });
            alert('Registered! Please login');
            switchTab('login');
        };

        window.logout = () => {
            currentUser = null;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
        };

        function showDashboard() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('userPoints').textContent = currentUser.points || 0;
            loadLeaderboard();
            loadRecords();
            loadUsers();
        }

        // Navigation
        window.showSection = (section) => {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`${section}Section`).classList.remove('hidden');
            event.target.classList.add('active');
        };

        // Dark Mode
        window.toggleDarkMode = () => {
            document.body.classList.toggle('dark');
            const icon = document.getElementById('darkModeIcon');
            icon.className = document.body.classList.contains('dark') ? 'ri-sun-line' : 'ri-moon-line';
        };

        // Test Selection
        window.selectTest = (testId) => {
            currentTest = testId;
            document.getElementById('testCodeModal').classList.remove('hidden');
        };

        window.hideTestCodeModal = () => {
            document.getElementById('testCodeModal').classList.add('hidden');
        };

        window.verifyTestCode = async () => {
            const code = document.getElementById('testAccessCode').value.trim();
            if (code !== 'OFUJE2024') return alert('Invalid test code');
            hideTestCodeModal();
            joinWaitingRoom();
        };

        // Waiting Room
        async function joinWaitingRoom() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('waitingRoom').classList.remove('hidden');
            
            const testSnapshot = await get(ref(db, `tests/${currentTest}`));
            const testData = testSnapshot.val();
            document.getElementById('waitingTestName').textContent = testData.title;

            // Check for waiting session
            const waitingRef = ref(db, `waiting/${currentTest}`);
            const waitingSnapshot = await get(waitingRef);
            
            if (waitingSnapshot.exists()) {
                const sessions = waitingSnapshot.val();
                const waitingSession = Object.entries(sessions).find(([k, v]) => v.status === 'waiting' && v.user1 !== currentUser.code);
                
                if (waitingSession) {
                    const [sessionId, session] = waitingSession;
                    currentSession = sessionId;
                    await update(ref(db, `waiting/${currentTest}/${sessionId}`), {
                        user2: currentUser.code,
                        user2Name: currentUser.name,
                        status: 'ready'
                    });
                    startQuiz(session.user1Name, testData);
                    return;
                }
            }

            // Create new waiting session
            const newSession = push(ref(db, `waiting/${currentTest}`));
            currentSession = newSession.key;
            await set(newSession, {
                user1: currentUser.code,
                user1Name: currentUser.name,
                status: 'waiting',
                created: Date.now()
            });

            onDisconnect(newSession).remove();

            // Listen for opponent
            onValue(ref(db, `waiting/${currentTest}/${currentSession}`), (snapshot) => {
                const data = snapshot.val();
                if (data && data.status === 'ready' && data.user2) {
                    startQuiz(data.user2Name, testData);
                }
            });
        }

        window.cancelWaiting = async () => {
            if (currentSession) {
                await remove(ref(db, `waiting/${currentTest}/${currentSession}`));
            }
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        };

        // Quiz
        async function startQuiz(opponentName, testData) {
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');

            questions = testData.questions;
            document.getElementById('quizTitle').textContent = testData.title;
            document.getElementById('totalQuestions').textContent = questions.length;
            document.getElementById('myQuizName').textContent = currentUser.name;
            document.getElementById('myQuizAvatar').textContent = currentUser.name.charAt(0);
            document.getElementById('oppQuizName').textContent = opponentName;
            document.getElementById('oppQuizAvatar').textContent = opponentName.charAt(0);

            currentQ = 0;
            answers = {};
            timeLeft = 3600;
            
            await set(ref(db, `sessions/${currentSession}/users/${currentUser.code}`), {
                name: currentUser.name,
                currentQ: 1,
                submitted: false,
                score: 0
            });

            displayQuestion();
            startTimer();
            listenToSession();
            setupVoiceChat();
        }

        function displayQuestion() {
            const q = questions[currentQ];
            document.getElementById('questionNum').textContent = currentQ + 1;
            document.getElementById('questionText').textContent = q.q;
            document.getElementById('myCurrentQ').textContent = currentQ + 1;

            const optionsHtml = q.opts.map((opt, i) => `
                <div class="option ${answers[currentQ] === i ? 'selected' : ''}" onclick="selectOption(${i})">
                    <span class="option-letter">${String.fromCharCode(65 + i)}</span>
                    <span>${opt}</span>
                </div>
            `).join('');
            document.getElementById('optionsContainer').innerHTML = optionsHtml;

            document.getElementById('prevBtn').classList.toggle('hidden', currentQ === 0);
            document.getElementById('nextBtn').classList.toggle('hidden', currentQ === questions.length - 1);
            document.getElementById('submitBtn').classList.toggle('hidden', currentQ !== questions.length - 1);

            update(ref(db, `sessions/${currentSession}/users/${currentUser.code}`), { currentQ: currentQ + 1 });
        }

        window.selectOption = (index) => {
            answers[currentQ] = index;
            displayQuestion();
        };

        window.prevQuestion = () => { if (currentQ > 0) { currentQ--; displayQuestion(); } };
        window.nextQuestion = () => { if (currentQ < questions.length - 1) { currentQ++; displayQuestion(); } };

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('timerDisplay').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                const timerEl = document.getElementById('timer');
                timerEl.classList.toggle('warning', timeLeft <= 300 && timeLeft > 60);
                timerEl.classList.toggle('danger', timeLeft <= 60);
                
                if (timeLeft <= 0) submitQuiz();
            }, 1000);
        }

        function listenToSession() {
            onValue(ref(db, `sessions/${currentSession}`), (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                Object.entries(data.users || {}).forEach(([code, user]) => {
                    if (code !== currentUser.code) {
                        document.getElementById('oppCurrentQ').textContent = user.currentQ || 1;
                        if (user.submitted && !data.users[currentUser.code]?.submitted) {
                            submitQuiz();
                        }
                    }
                });

                if (data.completed) showResults(data);
            });
        }

        window.submitQuiz = async () => {
            clearInterval(timerInterval);
            
            let score = 0;
            questions.forEach((q, i) => {
                if (answers[i] === q.ans) score++;
            });

            await update(ref(db, `sessions/${currentSession}/users/${currentUser.code}`), {
                submitted: true,
                score,
                answers
            });

            // Check if both submitted
            const sessionSnapshot = await get(ref(db, `sessions/${currentSession}`));
            const sessionData = sessionSnapshot.val();
            const users = Object.values(sessionData.users || {});
            
            if (users.every(u => u.submitted)) {
                await update(ref(db, `sessions/${currentSession}`), { completed: true });
            }
        };

        async function showResults(sessionData) {
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');

            const users = Object.entries(sessionData.users);
            const myData = users.find(([code]) => code === currentUser.code)[1];
            const oppData = users.find(([code]) => code !== currentUser.code);
            const oppCode = oppData[0];
            const oppInfo = oppData[1];

            const myScore = myData.score;
            const oppScore = oppInfo.score;
            const iWon = myScore > oppScore;
            const isDraw = myScore === oppScore;

            const myPointChange = isDraw ? 0 : (iWon ? 10 : -5);
            const oppPointChange = isDraw ? 0 : (iWon ? -5 : 10);

            // Update points
            const myNewPoints = (currentUser.points || 0) + myPointChange;
            await update(ref(db, `users/${currentUser.code}`), { points: myNewPoints });

            const oppSnapshot = await get(ref(db, `users/${oppCode}`));
            const oppUser = oppSnapshot.val();
            const oppNewPoints = (oppUser.points || 0) + oppPointChange;
            await update(ref(db, `users/${oppCode}`), { points: oppNewPoints });

            // Save records
            await push(ref(db, 'records'), {
                test: currentTest,
                user1: currentUser.code,
                user1Name: currentUser.name,
                user1Score: myScore,
                user2: oppCode,
                user2Name: oppInfo.name,
                user2Score: oppScore,
                date: Date.now()
            });

            // Display results
            document.getElementById('resultTitle').textContent = isDraw ? 'ðŸ¤ It\'s a Draw!' : (iWon ? 'ðŸŽ‰ You Won!' : 'ðŸ˜” You Lost');
            document.getElementById('myResultName').textContent = currentUser.name;
            document.getElementById('myResultScore').textContent = `${myScore}/${questions.length}`;
            document.getElementById('myPointChange').textContent = `${myPointChange >= 0 ? '+' : ''}${myPointChange} points`;
            document.getElementById('myPointChange').className = `point-change ${myPointChange >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('myTotalPoints').textContent = myNewPoints;
            document.getElementById('myResultCard').className = `result-card glass ${iWon ? 'winner' : (isDraw ? '' : 'loser')}`;

            document.getElementById('oppResultName').textContent = oppInfo.name;
            document.getElementById('oppResultScore').textContent = `${oppScore}/${questions.length}`;
            document.getElementById('oppPointChange').textContent = `${oppPointChange >= 0 ? '+' : ''}${oppPointChange} points`;
            document.getElementById('oppPointChange').className = `point-change ${oppPointChange >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('oppTotalPoints').textContent = oppNewPoints;
            document.getElementById('oppResultCard').className = `result-card glass ${!iWon && !isDraw ? 'winner' : (isDraw ? '' : 'loser')}`;

            currentUser.points = myNewPoints;

            // Cleanup
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (peerConnection) peerConnection.close();
            await remove(ref(db, `waiting/${currentTest}/${currentSession}`));
        }

        window.backToDashboard = () => {
            document.getElementById('resultsScreen').classList.add('hidden');
            showDashboard();
        };

        // Voice Chat
        async function setupVoiceChat() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
                peerConnection = new RTCPeerConnection(config);
                
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                
                peerConnection.ontrack = (e) => {
                    document.getElementById('remoteAudio').srcObject = e.streams[0];
                };

                peerConnection.onicecandidate = (e) => {
                    if (e.candidate) {
                        push(ref(db, `sessions/${currentSession}/ice/${currentUser.code}`), e.candidate.toJSON());
                    }
                };

                // Signaling
                const isInitiator = (await get(ref(db, `waiting/${currentTest}/${currentSession}`))).val()?.user1 === currentUser.code;
                
                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    await set(ref(db, `sessions/${currentSession}/offer`), { type: offer.type, sdp: offer.sdp });
                    
                    onValue(ref(db, `sessions/${currentSession}/answer`), async (snap) => {
                        if (snap.exists() && peerConnection.signalingState !== 'stable') {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                        }
                    });
                } else {
                    onValue(ref(db, `sessions/${currentSession}/offer`), async (snap) => {
                        if (snap.exists()) {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                            const answer = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);
                            await set(ref(db, `sessions/${currentSession}/answer`), { type: answer.type, sdp: answer.sdp });
                        }
                    });
                }

                // ICE candidates
                onValue(ref(db, `sessions/${currentSession}/ice`), (snap) => {
                    if (!snap.exists()) return;
                    Object.entries(snap.val()).forEach(([code, candidates]) => {
                        if (code !== currentUser.code) {
                            Object.values(candidates).forEach(c => {
                                peerConnection.addIceCandidate(new RTCIceCandidate(c)).catch(() => {});
                            });
                        }
                    });
                });
            } catch (err) {
                console.log('Voice chat unavailable:', err);
            }
        }

        window.toggleMic = () => {
            micOn = !micOn;
            if (localStream) {
                localStream.getAudioTracks().forEach(t => t.enabled = micOn);
            }
            const btn = document.getElementById('micBtn');
            btn.classList.toggle('off', !micOn);
            btn.innerHTML = `<i class="ri-mic-${micOn ? 'line' : 'off-line'}"></i>`;
        };

        window.toggleSpeaker = () => {
            speakerOn = !speakerOn;
            document.getElementById('remoteAudio').muted = !speakerOn;
            const btn = document.getElementById('speakerBtn');
            btn.classList.toggle('off', !speakerOn);
            btn.innerHTML = `<i class="ri-volume-${speakerOn ? 'up' : 'mute'}-line"></i>`;
        };

        // Data Loading
        async function loadLeaderboard() {
            const snapshot = await get(ref(db, 'users'));
            if (!snapshot.exists()) return;
            
            const users = Object.entries(snapshot.val())
                .filter(([_, u]) => !u.restricted)
                .sort((a, b) => (b[1].points || 0) - (a[1].points || 0));

            document.getElementById('leaderboardList').innerHTML = users.map(([code, user], i) => `
                <div class="leaderboard-item">
                    <div class="rank ${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}">${i + 1}</div>
                    <div class="avatar">${user.name.charAt(0)}</div>
                    <div class="leaderboard-info">
                        <strong>${user.name}</strong>
                        ${code === currentUser.code ? '<span style="font-size:0.8rem;color:var(--success)">(You)</span>' : ''}
                    </div>
                    <div class="leaderboard-points">${user.points || 0} pts</div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No users yet</p>';
        }

        async function loadRecords() {
            const snapshot = await get(ref(db, 'records'));
            if (!snapshot.exists()) {
                document.getElementById('recordsList').innerHTML = '<p style="color:var(--text-muted)">No records yet</p>';
                return;
            }
            
            const records = Object.values(snapshot.val())
                .filter(r => r.user1 === currentUser.code || r.user2 === currentUser.code)
                .sort((a, b) => b.date - a.date);

            document.getElementById('recordsList').innerHTML = records.map(r => {
                const isUser1 = r.user1 === currentUser.code;
                const myScore = isUser1 ? r.user1Score : r.user2Score;
                const oppScore = isUser1 ? r.user2Score : r.user1Score;
                const oppName = isUser1 ? r.user2Name : r.user1Name;
                const won = myScore > oppScore;
                const draw = myScore === oppScore;
                
                return `
                    <div class="record-item">
                        <div class="record-info">
                            <h4>vs ${oppName}</h4>
                            <p>${new Date(r.date).toLocaleDateString()}</p>
                        </div>
                        <div class="record-score">
                            <strong style="color:${won ? 'var(--success)' : draw ? 'var(--warning)' : 'var(--danger)'}">
                                ${myScore} - ${oppScore} ${won ? '(W)' : draw ? '(D)' : '(L)'}
                            </strong>
                        </div>
                    </div>
                `;
            }).join('') || '<p style="color:var(--text-muted)">No records yet</p>';
        }

        async function loadUsers() {
            const snapshot = await get(ref(db, 'users'));
            if (!snapshot.exists()) return;
            
            const users = Object.entries(snapshot.val()).filter(([code]) => code !== currentUser.code);

            document.getElementById('usersList').innerHTML = users.map(([code, user]) => `
                <div class="leaderboard-item">
                    <div class="avatar">${user.name.charAt(0)}</div>
                    <div class="leaderboard-info">
                        <strong>${user.name}</strong>
                        ${user.restricted ? '<span class="badge badge-danger">Restricted</span>' : ''}
                    </div>
                    <div class="leaderboard-points">${user.points || 0} pts</div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No other users</p>';
        }

        // Admin
        window.showAdminLogin = () => document.getElementById('adminLoginModal').classList.remove('hidden');
        window.hideAdminLogin = () => document.getElementById('adminLoginModal').classList.add('hidden');

        window.adminLogin = () => {
            if (document.getElementById('adminCode').value !== 'ADMIN2024') return alert('Invalid admin code');
            hideAdminLogin();
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadAdminData();
        };

        window.logoutAdmin = () => {
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
        };

        window.showAdminSection = (section) => {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`admin${section.charAt(0).toUpperCase() + section.slice(1)}Section`).classList.remove('hidden');
            event.target.classList.add('active');
        };

        async function loadAdminData() {
            // Load users
            const usersSnapshot = await get(ref(db, 'users'));
            if (usersSnapshot.exists()) {
                document.getElementById('adminUsersList').innerHTML = Object.entries(usersSnapshot.val()).map(([code, user]) => `
                    <tr>
                        <td>${user.name}</td>
                        <td><code>${code}</code></td>
                        <td>${user.points || 0}</td>
                        <td><span class="badge ${user.restricted ? 'badge-danger' : 'badge-success'}">${user.restricted ? 'Restricted' : 'Active'}</span></td>
                        <td>
                            <button class="btn btn-sm ${user.restricted ? 'btn-success' : 'btn-secondary'}" onclick="toggleRestrict('${code}', ${!user.restricted})">
                                ${user.restricted ? 'Unrestrict' : 'Restrict'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${code}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }

            // Load questions
            const testsSnapshot = await get(ref(db, 'tests'));
            if (testsSnapshot.exists()) {
                let html = '';
                Object.entries(testsSnapshot.val()).forEach(([testId, test]) => {
                    html += `<h4 style="margin:20px 0 10px">${test.title}</h4>`;
                    test.questions.forEach((q, i) => {
                        html += `
                            <div class="record-item">
                                <div class="record-info">
                                    <h4>${q.q}</h4>
                                    <p>Answer: ${q.opts[q.ans]}</p>
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="deleteQuestion('${testId}', ${i})">Delete</button>
                            </div>
                        `;
                    });
                });
                document.getElementById('adminQuestionsList').innerHTML = html;
            }
        }

        window.toggleRestrict = async (code, restrict) => {
            await update(ref(db, `users/${code}`), { restricted: restrict });
            loadAdminData();
        };

        window.deleteUser = async (code) => {
            if (!confirm('Delete this user?')) return;
            await remove(ref(db, `users/${code}`));
            loadAdminData();
        };

        window.showAddQuestion = () => document.getElementById('addQuestionModal').classList.remove('hidden');
        window.hideAddQuestion = () => document.getElementById('addQuestionModal').classList.add('hidden');

        window.addQuestion = async () => {
            const testId = document.getElementById('qTest').value;
            const q = {
                q: document.getElementById('qText').value,
                opts: [
                    document.getElementById('qOptA').value,
                    document.getElementById('qOptB').value,
                    document.getElementById('qOptC').value,
                    document.getElementById('qOptD').value
                ],
                ans: parseInt(document.getElementById('qCorrect').value)
            };
            if (!q.q || q.opts.some(o => !o)) return alert('Fill all fields');
            
            const snapshot = await get(ref(db, `tests/${testId}/questions`));
            const questions = snapshot.exists() ? snapshot.val() : [];
            questions.push(q);
            await set(ref(db, `tests/${testId}/questions`), questions);
            hideAddQuestion();
            loadAdminData();
            alert('Question added!');
        };

        window.deleteQuestion = async (testId, index) => {
            if (!confirm('Delete this question?')) return;
            const snapshot = await get(ref(db, `tests/${testId}/questions`));
            const questions = snapshot.val();
            questions.splice(index, 1);
            await set(ref(db, `tests/${testId}/questions`), questions);
            loadAdminData();
        };
    </script>
</body>
</html>