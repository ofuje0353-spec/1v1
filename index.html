<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofuje - Multiplayer CBT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--bg:#f0f2f5;--card:#fff;--text:#1a1a2e;--primary:#6c5ce7;--secondary:#a29bfe;--accent:#fd79a8;--success:#00b894;--danger:#d63031;--warning:#fdcb6e;--border:#dfe6e9;--shadow:0 10px 40px rgba(0,0,0,0.1)}
        [data-theme="dark"]{--bg:#1a1a2e;--card:#16213e;--text:#eee;--border:#0f3460;--shadow:0 10px 40px rgba(0,0,0,0.3)}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
        body{background:var(--bg);color:var(--text);min-height:100vh;transition:all .3s}
        .hidden{display:none!important}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .card{background:var(--card);border-radius:20px;padding:30px;box-shadow:var(--shadow);animation:fadeIn .5s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
        @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
        .btn{padding:12px 30px;border:none;border-radius:12px;cursor:pointer;font-weight:600;transition:all .3s;display:inline-flex;align-items:center;gap:8px}
        .btn:hover{transform:translateY(-2px)}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-success{background:var(--success);color:#fff}
        .btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
        input,select,textarea{width:100%;padding:15px;border:2px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);font-size:16px;transition:all .3s}
        input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(108,92,231,0.1)}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;font-weight:600}
        .toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px}
        .toast{padding:15px 25px;border-radius:12px;color:#fff;display:flex;align-items:center;gap:10px;animation:slideIn .3s;min-width:300px}
        .toast-success{background:var(--success)}
        .toast-error{background:var(--danger)}
        .toast-info{background:var(--primary)}
        .logo{font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;margin-bottom:30px}
        .auth-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .auth-card{width:100%;max-width:450px}
        .auth-tabs{display:flex;gap:10px;margin-bottom:30px}
        .auth-tab{flex:1;padding:15px;border:none;background:var(--border);border-radius:12px;cursor:pointer;font-weight:600;transition:all .3s}
        .auth-tab.active{background:var(--primary);color:#fff}
        .dashboard{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
        .sidebar{background:var(--card);padding:20px;border-right:1px solid var(--border)}
        .sidebar-header{display:flex;align-items:center;gap:15px;padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:20px}
        .avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.2rem}
        .nav-item{display:flex;align-items:center;gap:12px;padding:15px;border-radius:12px;cursor:pointer;transition:all .3s;margin-bottom:5px}
        .nav-item:hover,.nav-item.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
        .main-content{padding:30px;overflow-y:auto;max-height:100vh}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:var(--card);padding:25px;border-radius:16px;box-shadow:var(--shadow)}
        .stat-card i{font-size:2rem;margin-bottom:10px}
        .stat-value{font-size:2rem;font-weight:700}
        .stat-label{color:#888;font-size:.9rem}
        .tests-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
        .test-card{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);transition:all .3s}
        .test-card:hover{transform:translateY(-5px)}
        .test-header{background:linear-gradient(135deg,var(--primary),var(--secondary));padding:25px;color:#fff}
        .test-body{padding:25px}
        .battle-lobby{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
        .battle-card{background:var(--card);border-radius:16px;padding:25px;box-shadow:var(--shadow);border-left:4px solid var(--primary)}
        .quiz-container{display:grid;grid-template-columns:1fr 300px;gap:20px;height:calc(100vh - 100px)}
        .quiz-main{background:var(--card);border-radius:20px;padding:30px;display:flex;flex-direction:column}
        .quiz-sidebar{background:var(--card);border-radius:20px;padding:20px;display:flex;flex-direction:column;gap:15px}
        .timer{font-size:2.5rem;font-weight:700;text-align:center;color:var(--primary)}
        .question-nav{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
        .q-btn{width:40px;height:40px;border-radius:10px;border:2px solid var(--border);background:var(--card);cursor:pointer;font-weight:600;transition:all .3s}
        .q-btn.current{background:var(--primary);color:#fff;border-color:var(--primary)}
        .q-btn.answered{background:var(--success);color:#fff;border-color:var(--success)}
        .option{padding:20px;border:2px solid var(--border);border-radius:12px;cursor:pointer;transition:all .3s;margin-bottom:10px}
        .option:hover{border-color:var(--primary);background:rgba(108,92,231,0.1)}
        .option.selected{border-color:var(--primary);background:rgba(108,92,231,0.2)}
        .opponent-status{background:linear-gradient(135deg,var(--secondary),var(--accent));padding:15px;border-radius:12px;color:#fff;text-align:center}
        .chat-box{flex:1;overflow-y:auto;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px;max-height:200px}
        .chat-msg{padding:8px 12px;border-radius:10px;margin-bottom:8px;max-width:80%}
        .chat-msg.mine{background:var(--primary);color:#fff;margin-left:auto}
        .chat-msg.theirs{background:var(--border)}
        .chat-input{display:flex;gap:10px}
        .chat-input input{flex:1}
        .emoji-picker{display:flex;flex-wrap:wrap;gap:5px;padding:10px;background:var(--card);border-radius:12px;margin-bottom:10px}
        .emoji{cursor:pointer;font-size:1.5rem;padding:5px;border-radius:8px;transition:all .2s}
        .emoji:hover{background:var(--border);transform:scale(1.2)}
        .voice-controls{display:flex;gap:10px;justify-content:center}
        .voice-btn{width:50px;height:50px;border-radius:50%;border:none;cursor:pointer;font-size:1.2rem;transition:all .3s}
        .voice-btn.active{background:var(--success);color:#fff}
        .voice-btn.muted{background:var(--danger);color:#fff}
        .leaderboard{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
        .lb-header{background:linear-gradient(135deg,var(--primary),var(--accent));padding:20px;color:#fff;font-size:1.3rem;font-weight:700}
        .lb-item{display:flex;align-items:center;gap:15px;padding:15px 20px;border-bottom:1px solid var(--border);transition:all .3s}
        .lb-item:hover{background:rgba(108,92,231,0.05)}
        .lb-item.current-user{background:rgba(108,92,231,0.1)}
        .rank{width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
        .rank-1{background:linear-gradient(135deg,#ffd700,#ffb700);color:#fff}
        .rank-2{background:linear-gradient(135deg,#c0c0c0,#a0a0a0);color:#fff}
        .rank-3{background:linear-gradient(135deg,#cd7f32,#b87333);color:#fff}
        .results-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .3s}
        .results-card{background:var(--card);border-radius:24px;padding:40px;max-width:500px;width:90%;text-align:center;animation:bounce .5s}
        .result-crown{font-size:4rem;margin-bottom:20px}
        .score-display{font-size:3rem;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .point-change{font-size:1.5rem;margin:10px 0}
        .point-change.positive{color:var(--success)}
        .point-change.negative{color:var(--danger)}
        .admin-table{width:100%;border-collapse:collapse}
        .admin-table th,.admin-table td{padding:15px;text-align:left;border-bottom:1px solid var(--border)}
        .admin-table th{background:var(--primary);color:#fff}
        .admin-table tr:hover{background:rgba(108,92,231,0.05)}
        .toggle-switch{position:relative;width:60px;height:30px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .slider{position:absolute;inset:0;background:var(--border);border-radius:30px;cursor:pointer;transition:all .3s}
        .slider:before{content:'';position:absolute;width:24px;height:24px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:all .3s}
        input:checked+.slider{background:var(--primary)}
        input:checked+.slider:before{transform:translateX(30px)}
        .mobile-menu{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--card);padding:15px;border-top:1px solid var(--border);z-index:100}
        .mobile-nav{display:flex;justify-content:space-around}
        .mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:5px;font-size:.8rem;color:var(--text);cursor:pointer}
        .waiting-animation{display:flex;gap:10px;justify-content:center;margin:30px 0}
        .dot{width:15px;height:15px;background:var(--primary);border-radius:50%;animation:bounce 1.4s infinite}
        .dot:nth-child(2){animation-delay:.2s}
        .dot:nth-child(3){animation-delay:.4s}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000}
        .modal-content{background:var(--card);border-radius:20px;padding:30px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
        .settings-section{margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid var(--border)}
        .record-card{background:var(--card);border-radius:12px;padding:20px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow)}
        @media(max-width:900px){.dashboard{grid-template-columns:1fr}.sidebar{display:none}.mobile-menu{display:block}.quiz-container{grid-template-columns:1fr}.quiz-sidebar{position:fixed;bottom:70px;left:10px;right:10px;max-height:300px;z-index:99}}
        @media(max-width:600px){.stats-grid{grid-template-columns:1fr}.auth-card{padding:20px}.header{flex-direction:column;gap:15px}}
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- Auth Section -->
    <div id="authSection" class="auth-container">
        <div class="card auth-card">
            <div class="logo">Ofuje</div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Register</button>
            </div>
            <div id="loginForm">
                <div class="form-group">
                    <label><i class="fas fa-key"></i> Access Code</label>
                    <input type="text" id="loginCode" placeholder="Enter your access code">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <p style="text-align:center;margin-top:20px;color:#888">
                    <span style="cursor:pointer;color:var(--primary)" onclick="showAuthTab('admin')">Admin Login</span>
                </p>
            </div>
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-school"></i> School</label>
                    <input type="text" id="regSchool" placeholder="Enter your school">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-key"></i> Preferred Access Code</label>
                    <input type="text" id="regCode" placeholder="Create your unique access code">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="register()">
                    <i class="fas fa-user-plus"></i> Register
                </button>
            </div>
            <div id="adminLoginForm" class="hidden">
                <div class="form-group">
                    <label><i class="fas fa-shield-alt"></i> Admin Password</label>
                    <input type="password" id="adminPass" placeholder="Enter admin password">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="adminLogin()">
                    <i class="fas fa-lock"></i> Admin Login
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard hidden">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <div style="font-weight:700" id="userName">User</div>
                    <div style="font-size:.85rem;color:#888" id="userSchool">School</div>
                </div>
            </div>
            <nav>
                <div class="nav-item active" onclick="showSection('home')"><i class="fas fa-home"></i> Home</div>
                <div class="nav-item" onclick="showSection('tests')"><i class="fas fa-clipboard-list"></i> CBT Tests</div>
                <div class="nav-item" onclick="showSection('battles')"><i class="fas fa-gamepad"></i> Battles</div>
                <div class="nav-item" onclick="showSection('leaderboard')"><i class="fas fa-trophy"></i> Leaderboard</div>
                <div class="nav-item" onclick="showSection('records')"><i class="fas fa-history"></i> My Records</div>
                <div class="nav-item" onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</div>
            </nav>
            <div style="margin-top:auto;padding-top:20px;border-top:1px solid var(--border)">
                <div class="nav-item" onclick="toggleTheme()"><i class="fas fa-moon"></i> Dark Mode</div>
                <div class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</div>
            </div>
        </aside>
        <main class="main-content">
            <!-- Home Section -->
            <section id="homeSection">
                <div class="header">
                    <h1>Welcome back, <span id="welcomeName">User</span>! üëã</h1>
                </div>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left:4px solid var(--primary)">
                        <i class="fas fa-star" style="color:var(--primary)"></i>
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">Total Points</div>
                    </div>
                    <div class="stat-card" style="border-left:4px solid var(--success)">
                        <i class="fas fa-trophy" style="color:var(--success)"></i>
                        <div class="stat-value" id="totalWins">0</div>
                        <div class="stat-label">Victories</div>
                    </div>
                    <div class="stat-card" style="border-left:4px solid var(--danger)">
                        <i class="fas fa-times-circle" style="color:var(--danger)"></i>
                        <div class="stat-value" id="totalLosses">0</div>
                        <div class="stat-label">Defeats</div>
                    </div>
                    <div class="stat-card" style="border-left:4px solid var(--warning)">
                        <i class="fas fa-medal" style="color:var(--warning)"></i>
                        <div class="stat-value" id="userRank">#-</div>
                        <div class="stat-label">Your Rank</div>
                    </div>
                </div>
                <h2 style="margin-bottom:20px">Quick Actions</h2>
                <div class="tests-grid">
                    <div class="test-card" onclick="showSection('tests')">
                        <div class="test-header"><i class="fas fa-play-circle fa-2x"></i></div>
                        <div class="test-body">
                            <h3>Start a Test</h3>
                            <p style="color:#888;margin-top:10px">Choose from available CBT tests</p>
                        </div>
                    </div>
                    <div class="test-card" onclick="showSection('battles')">
                        <div class="test-header" style="background:linear-gradient(135deg,var(--accent),var(--danger))"><i class="fas fa-swords fa-2x"></i></div>
                        <div class="test-body">
                            <h3>Join Battle</h3>
                            <p style="color:#888;margin-top:10px">Compete with other users</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tests Section -->
            <section id="testsSection" class="hidden">
                <div class="header"><h1>Available Tests</h1></div>
                <div class="tests-grid" id="testsGrid"></div>
            </section>

            <!-- Battles Section -->
            <section id="battlesSection" class="hidden">
                <div class="header">
                    <h1>Battle Arena</h1>
                    <button class="btn btn-primary" onclick="showCreateBattle()">
                        <i class="fas fa-plus"></i> Create Battle
                    </button>
                </div>
                <h2 style="margin-bottom:20px">Active Battles</h2>
                <div class="battle-lobby" id="battleLobby"></div>
            </section>

            <!-- Leaderboard Section -->
            <section id="leaderboardSection" class="hidden">
                <div class="header"><h1>Leaderboard</h1></div>
                <div class="leaderboard">
                    <div class="lb-header"><i class="fas fa-trophy"></i> Top Players</div>
                    <div id="leaderboardList"></div>
                </div>
            </section>

            <!-- Records Section -->
            <section id="recordsSection" class="hidden">
                <div class="header"><h1>My Battle Records</h1></div>
                <div id="recordsList"></div>
            </section>

            <!-- Settings Section -->
            <section id="settingsSection" class="hidden">
                <div class="header"><h1>Settings</h1></div>
                <div class="card">
                    <div class="settings-section">
                        <h3 style="margin-bottom:20px"><i class="fas fa-user-edit"></i> Profile Settings</h3>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="settingsName">
                        </div>
                        <div class="form-group">
                            <label>School</label>
                            <input type="text" id="settingsSchool">
                        </div>
                        <div class="form-group">
                            <label>Access Code</label>
                            <input type="text" id="settingsCode">
                        </div>
                        <button class="btn btn-primary" onclick="updateProfile()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                    <div class="settings-section">
                        <h3 style="margin-bottom:20px"><i class="fas fa-palette"></i> Appearance</h3>
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <span>Dark Mode</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom:20px;color:var(--danger)"><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
                        <button class="btn btn-danger" onclick="deleteAccount()">
                            <i class="fas fa-trash"></i> Delete Account
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Quiz Section -->
    <div id="quizSection" class="hidden" style="padding:20px;max-width:1400px;margin:0 auto">
        <div class="quiz-container">
            <div class="quiz-main">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h2 id="testTitle">Test</h2>
                    <span id="questionCounter">Question 1 of 10</span>
                </div>
                <div id="questionText" style="font-size:1.3rem;margin-bottom:30px;flex:1"></div>
                <div id="optionsContainer"></div>
                <div style="display:flex;justify-content:space-between;margin-top:30px">
                    <button class="btn btn-outline" id="prevBtn" onclick="prevQuestion()">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    <button class="btn btn-success hidden" id="submitBtn" onclick="submitQuiz()">
                        <i class="fas fa-check"></i> Submit
                    </button>
                </div>
            </div>
            <div class="quiz-sidebar">
                <div class="timer" id="timer">60:00</div>
                <div class="opponent-status">
                    <div style="font-weight:700;margin-bottom:5px">Opponent</div>
                    <div id="opponentName">Waiting...</div>
                    <div style="margin-top:10px">Currently on: <span id="opponentQuestion">-</span></div>
                </div>
                <h4>Question Navigator</h4>
                <div class="question-nav" id="questionNav"></div>
                <h4>Voice Chat</h4>
                <div class="voice-controls">
                    <button class="voice-btn active" id="micBtn" onclick="toggleMic()">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="voice-btn active" id="speakerBtn" onclick="toggleSpeaker()">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
                <h4>Chat</h4>
                <div class="emoji-picker" id="emojiPicker"></div>
                <div class="chat-box" id="chatBox"></div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type message..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Waiting Room -->
    <div id="waitingRoom" class="hidden" style="min-height:100vh;display:flex;align-items:center;justify-content:center">
        <div class="card" style="text-align:center;max-width:500px">
            <h2 style="margin-bottom:20px">Waiting for Opponent</h2>
            <div class="waiting-animation">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            <p style="color:#888;margin-bottom:20px">Share the battle code with your friend!</p>
            <div style="background:var(--border);padding:20px;border-radius:12px;font-size:1.5rem;font-weight:700" id="waitingBattleCode">ABC123</div>
            <button class="btn btn-danger" style="margin-top:20px" onclick="cancelBattle()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <div class="dashboard" style="grid-template-columns:250px 1fr">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="avatar" style="background:var(--danger)"><i class="fas fa-shield-alt"></i></div>
                    <div>
                        <div style="font-weight:700">Admin Panel</div>
                        <div style="font-size:.85rem;color:#888">Ofuje</div>
                    </div>
                </div>
                <nav>
                    <div class="nav-item active" onclick="showAdminSection('users')"><i class="fas fa-users"></i> Users</div>
                    <div class="nav-item" onclick="showAdminSection('tests')"><i class="fas fa-clipboard-list"></i> Tests</div>
                    <div class="nav-item" onclick="showAdminSection('questions')"><i class="fas fa-question-circle"></i> Questions</div>
                </nav>
                <div style="margin-top:auto;padding-top:20px;border-top:1px solid var(--border)">
                    <div class="nav-item" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</div>
                </div>
            </aside>
            <main class="main-content">
                <!-- Admin Users -->
                <section id="adminUsers">
                    <div class="header">
                        <h1>User Management</h1>
                    </div>
                    <div class="card" style="overflow-x:auto">
                        <table class="admin-table" id="usersTable">
                            <thead><tr><th>Name</th><th>School</th><th>Code</th><th>Points</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </section>

                <!-- Admin Tests -->
                <section id="adminTests" class="hidden">
                    <div class="header">
                        <h1>Test Management</h1>
                        <button class="btn btn-primary" onclick="showAddTestModal()">
                            <i class="fas fa-plus"></i> Add Test
                        </button>
                    </div>
                    <div class="card" style="overflow-x:auto">
                        <table class="admin-table">
                            <thead><tr><th>Title</th><th>Code</th><th>Questions</th><th>Actions</th></tr></thead>
                            <tbody id="testsTableBody"></tbody>
                        </table>
                    </div>
                </section>

                <!-- Admin Questions -->
                <section id="adminQuestions" class="hidden">
                    <div class="header">
                        <h1>Question Management</h1>
                        <button class="btn btn-primary" onclick="showAddQuestionModal()">
                            <i class="fas fa-plus"></i> Add Question
                        </button>
                    </div>
                    <div class="form-group" style="max-width:300px">
                        <label>Select Test</label>
                        <select id="questionTestSelect" onchange="loadQuestionsForTest()">
                            <option value="">Select a test</option>
                        </select>
                    </div>
                    <div class="card" style="overflow-x:auto">
                        <table class="admin-table">
                            <thead><tr><th>Question</th><th>Options</th><th>Answer</th><th>Actions</th></tr></thead>
                            <tbody id="questionsTableBody"></tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <div class="mobile-nav">
            <div class="mobile-nav-item" onclick="showSection('home')"><i class="fas fa-home"></i>Home</div>
            <div class="mobile-nav-item" onclick="showSection('tests')"><i class="fas fa-clipboard-list"></i>Tests</div>
            <div class="mobile-nav-item" onclick="showSection('battles')"><i class="fas fa-gamepad"></i>Battle</div>
            <div class="mobile-nav-item" onclick="showSection('leaderboard')"><i class="fas fa-trophy"></i>Rank</div>
            <div class="mobile-nav-item" onclick="showSection('settings')"><i class="fas fa-cog"></i>More</div>
        </div>
    </div>

    <!-- Modals -->
    <div id="testCodeModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom:20px">Enter Test Code</h2>
            <div class="form-group">
                <input type="text" id="testCodeInput" placeholder="Enter 6-digit test code" maxlength="6">
            </div>
            <div style="display:flex;gap:10px">
                <button class="btn btn-outline" onclick="closeModal('testCodeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="verifyTestCode()">Start Test</button>
            </div>
        </div>
    </div>

    <div id="createBattleModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom:20px">Create Battle</h2>
            <div class="form-group">
                <label>Select Test</label>
                <select id="battleTestSelect"></select>
            </div>
            <div class="form-group">
                <label>Test Code</label>
                <input type="text" id="battleTestCode" placeholder="Enter test code" maxlength="6">
            </div>
            <div style="display:flex;gap:10px">
                <button class="btn btn-outline" onclick="closeModal('createBattleModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createBattle()">Create</button>
            </div>
        </div>
    </div>

    <div id="addTestModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom:20px">Add New Test</h2>
            <div class="form-group">
                <label>Test Title</label>
                <input type="text" id="newTestTitle">
            </div>
            <div class="form-group">
                <label>Test Code (6 chars)</label>
                <input type="text" id="newTestCode" maxlength="6">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="newTestDesc" rows="3"></textarea>
            </div>
            <div style="display:flex;gap:10px">
                <button class="btn btn-outline" onclick="closeModal('addTestModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addTest()">Add Test</button>
            </div>
        </div>
    </div>

    <div id="addQuestionModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom:20px" id="questionModalTitle">Add New Question</h2>
            <div class="form-group">
                <label>Test</label>
                <select id="newQuestionTest"></select>
            </div>
            <div class="form-group">
                <label>Question</label>
                <textarea id="newQuestionText" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Option A</label>
                <input type="text" id="optionA">
            </div>
            <div class="form-group">
                <label>Option B</label>
                <input type="text" id="optionB">
            </div>
            <div class="form-group">
                <label>Option C</label>
                <input type="text" id="optionC">
            </div>
            <div class="form-group">
                <label>Option D</label>
                <input type="text" id="optionD">
            </div>
            <div class="form-group">
                <label>Correct Answer</label>
                <select id="correctAnswer">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
            </div>
            <input type="hidden" id="editQuestionId">
            <div style="display:flex;gap:10px">
                <button class="btn btn-outline" onclick="closeModal('addQuestionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveQuestion()">Save</button>
            </div>
        </div>
    </div>

    <div id="editScoreModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom:20px">Edit User Score</h2>
            <div class="form-group">
                <label>Points</label>
                <input type="number" id="editScoreValue">
            </div>
            <input type="hidden" id="editScoreUserId">
            <div style="display:flex;gap:10px">
                <button class="btn btn-outline" onclick="closeModal('editScoreModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveUserScore()">Save</button>
            </div>
        </div>
    </div>

    <div id="resultsModal" class="results-modal hidden">
        <div class="results-card">
            <div class="result-crown" id="resultEmoji">üèÜ</div>
            <h1 id="resultTitle">Victory!</h1>
            <div class="score-display" id="yourScore">8/10</div>
            <div style="margin:10px 0;color:#888">Your Score</div>
            <div class="point-change" id="pointChange">+10 Points</div>
            <div style="margin:20px 0;padding:20px;background:var(--border);border-radius:12px">
                <div style="font-weight:700">Total Points: <span id="newTotalPoints">0</span></div>
            </div>
            <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
                <h3>Opponent: <span id="opponentResultName">User</span></h3>
                <div style="font-size:1.5rem;font-weight:700;margin:10px 0" id="opponentScore">5/10</div>
            </div>
            <button class="btn btn-primary" style="margin-top:20px;width:100%" onclick="closeResults()">
                <i class="fas fa-home"></i> Back to Dashboard
            </button>
        </div>
    </div>

    <script type="module">
        import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import{getDatabase,ref,set,get,push,onValue,update,remove,onDisconnect}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        // Firebase Config - Replace with your own
        const firebaseConfig={
apiKey: "AIzaSyDofEQ2jiMIXji7y-fGopDQcLY8dhixGk4",
  authDomain: "danz-66ffa.firebaseapp.com",
  projectId: "danz-66ffa",
  storageBucket: "danz-66ffa.firebasestorage.app",
  messagingSenderId: "570041531960",
  appId: "1:570041531960:web:24b77baa80aba9636c30cd"
        };

        const app=initializeApp(firebaseConfig);
        const db=getDatabase(app);

        // State
        let currentUser=null,currentTest=null,currentBattle=null,currentQuestionIndex=0;
        let answers={},timerInterval=null,battleListener=null;
        let questions=[],localStream=null,isMuted=false,isSpeakerOff=false;

        const emojis=['üòÄ','üòÇ','üéâ','üëç','üëé','üî•','üí™','ü§î','üòé','‚ù§Ô∏è','üò¢','üò°'];

        // Initialize
        window.onload=async()=>{
            initTheme();
            await initDefaultData();
            initEmojis();
        };

        async function initDefaultData(){
            const testsRef=ref(db,'tests');
            const snap=await get(testsRef);
            if(!snap.exists()){
                await set(ref(db,'tests/test1'),{
                    title:'Mathematics Test',code:'MATH01',description:'Basic mathematics quiz',
                    questions:{
                        q1:{text:'What is 5 + 3?',options:{A:'6',B:'7',C:'8',D:'9'},answer:'C'},
                        q2:{text:'What is 12 / 4?',options:{A:'2',B:'3',C:'4',D:'5'},answer:'B'}
                    }
                });
                await set(ref(db,'tests/test2'),{
                    title:'English Test',code:'ENG001',description:'Basic English quiz',
                    questions:{
                        q1:{text:'Which is a noun?',options:{A:'Run',B:'Beautiful',C:'Dog',D:'Quickly'},answer:'C'},
                        q2:{text:'Choose the correct spelling:',options:{A:'Recieve',B:'Receive',C:'Receve',D:'Receeve'},answer:'B'}
                    }
                });
            }
        }

        function initEmojis(){
            const picker=document.getElementById('emojiPicker');
            picker.innerHTML=emojis.map(e=>`<span class="emoji" onclick="insertEmoji('${e}')">${e}</span>`).join('');
        }
        window.insertEmoji=e=>{document.getElementById('chatInput').value+=e};

        // Theme
        function initTheme(){
            const theme=localStorage.getItem('theme')||'light';
            document.documentElement.setAttribute('data-theme',theme);
            if(document.getElementById('themeToggle'))document.getElementById('themeToggle').checked=theme==='dark';
        }
        window.toggleTheme=()=>{
            const current=document.documentElement.getAttribute('data-theme');
            const next=current==='dark'?'light':'dark';
            document.documentElement.setAttribute('data-theme',next);
            localStorage.setItem('theme',next);
            if(document.getElementById('themeToggle'))document.getElementById('themeToggle').checked=next==='dark';
        };

        // Toast
        window.showToast=(msg,type='info')=>{
            const toast=document.createElement('div');
            toast.className=`toast toast-${type}`;
            toast.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':type==='error'?'times-circle':'info-circle'}"></i>${msg}`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(()=>toast.remove(),3000);
        };

        // Auth
        window.showAuthTab=tab=>{
            document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.auth-tab')[tab==='login'?0:1].classList.add('active');
            document.getElementById('loginForm').classList.toggle('hidden',tab!=='login');
            document.getElementById('registerForm').classList.toggle('hidden',tab!=='register');
            document.getElementById('adminLoginForm').classList.toggle('hidden',tab!=='admin');
        };

        window.register=async()=>{
            const name=document.getElementById('regName').value.trim();
            const school=document.getElementById('regSchool').value.trim();
            const code=document.getElementById('regCode').value.trim();
            if(!name||!school||!code)return showToast('Please fill all fields','error');
            
            const usersRef=ref(db,'users');
            const snap=await get(usersRef);
            if(snap.exists()){
                const users=snap.val();
                if(Object.values(users).some(u=>u.code===code))return showToast('Code already exists','error');
            }
            const newUserRef=push(usersRef);
            await set(newUserRef,{name,school,code,points:0,wins:0,losses:0,status:'active',createdAt:Date.now()});
            showToast('Registration successful!','success');
            showAuthTab('login');
        };

        window.login=async()=>{
            const code=document.getElementById('loginCode').value.trim();
            if(!code)return showToast('Enter access code','error');
            
            const usersRef=ref(db,'users');
            const snap=await get(usersRef);
            if(snap.exists()){
                const users=snap.val();
                for(const[id,user]of Object.entries(users)){
                    if(user.code===code){
                        if(user.status==='restricted')return showToast('Account restricted','error');
                        currentUser={id,...user};
                        localStorage.setItem('userId',id);
                        showDashboard();
                        return;
                    }
                }
            }
            showToast('Invalid access code','error');
        };

        window.adminLogin=()=>{
            const pass=document.getElementById('adminPass').value;
            if(pass==='admin123'){
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                loadAdminData();
            }else showToast('Invalid password','error');
        };

        window.logout=()=>{
            currentUser=null;
            localStorage.removeItem('userId');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
        };

        window.adminLogout=()=>{
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
        };

        // Dashboard
        function showDashboard(){
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            updateUserInfo();
            loadTests();
            loadLeaderboard();
            loadRecords();
            loadBattles();
        }

        function updateUserInfo(){
            document.getElementById('userAvatar').textContent=currentUser.name.charAt(0).toUpperCase();
            document.getElementById('userName').textContent=currentUser.name;
            document.getElementById('userSchool').textContent=currentUser.school;
            document.getElementById('welcomeName').textContent=currentUser.name.split(' ')[0];
            document.getElementById('totalPoints').textContent=currentUser.points||0;
            document.getElementById('totalWins').textContent=currentUser.wins||0;
            document.getElementById('totalLosses').textContent=currentUser.losses||0;
            document.getElementById('settingsName').value=currentUser.name;
            document.getElementById('settingsSchool').value=currentUser.school;
            document.getElementById('settingsCode').value=currentUser.code;
        }

        window.showSection=section=>{
            document.querySelectorAll('.main-content section').forEach(s=>s.classList.add('hidden'));
            document.getElementById(section+'Section').classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            document.querySelectorAll('.nav-item')[['home','tests','battles','leaderboard','records','settings'].indexOf(section)].classList.add('active');
            if(section==='leaderboard')loadLeaderboard();
            if(section==='records')loadRecords();
            if(section==='battles')loadBattles();
        };

        // Tests
        async function loadTests(){
            const snap=await get(ref(db,'tests'));
            if(!snap.exists())return;
            const tests=snap.val();
            const grid=document.getElementById('testsGrid');
            grid.innerHTML='';
            Object.entries(tests).forEach(([id,test])=>{
                const qCount=test.questions?Object.keys(test.questions).length:0;
                grid.innerHTML+=`
                    <div class="test-card">
                        <div class="test-header">
                            <h3>${test.title}</h3>
                        </div>
                        <div class="test-body">
                            <p style="color:#888;margin-bottom:15px">${test.description||''}</p>
                            <p><i class="fas fa-question-circle"></i> ${qCount} Questions</p>
                            <p><i class="fas fa-clock"></i> 60 Minutes</p>
                            <button class="btn btn-primary" style="width:100%;margin-top:15px" onclick="selectTest('${id}')">
                                <i class="fas fa-play"></i> Start Test
                            </button>
                        </div>
                    </div>`;
            });
        }

        window.selectTest=id=>{
            currentTest=id;
            document.getElementById('testCodeModal').classList.remove('hidden');
        };

        window.verifyTestCode=async()=>{
            const code=document.getElementById('testCodeInput').value.trim().toUpperCase();
            const snap=await get(ref(db,`tests/${currentTest}`));
            if(snap.exists()&&snap.val().code===code){
                closeModal('testCodeModal');
                showCreateBattle();
            }else showToast('Invalid test code','error');
        };

        // Battles
        async function loadBattles(){
            const battlesRef=ref(db,'battles');
            onValue(battlesRef,snap=>{
                const lobby=document.getElementById('battleLobby');
                lobby.innerHTML='';
                if(!snap.exists()){
                    lobby.innerHTML='<p style="color:#888">No active battles. Create one!</p>';
                    return;
                }
                const battles=snap.val();
                Object.entries(battles).forEach(([id,battle])=>{
                    if(battle.status==='waiting'&&battle.player1!==currentUser.id){
                        lobby.innerHTML+=`
                            <div class="battle-card">
                                <h3>${battle.testTitle||'Test'}</h3>
                                <p style="color:#888;margin:10px 0">Created by: ${battle.player1Name}</p>
                                <p><i class="fas fa-users"></i> Waiting for opponent</p>
                                <button class="btn btn-primary" style="margin-top:15px" onclick="joinBattle('${id}')">
                                    <i class="fas fa-sign-in-alt"></i> Join Battle
                                </button>
                            </div>`;
                    }
                });
                if(!lobby.innerHTML)lobby.innerHTML='<p style="color:#888">No available battles. Create one!</p>';
            });
        }

        window.showCreateBattle=async()=>{
            const select=document.getElementById('battleTestSelect');
            const snap=await get(ref(db,'tests'));
            select.innerHTML='';
            if(snap.exists()){
                Object.entries(snap.val()).forEach(([id,test])=>{
                    select.innerHTML+=`<option value="${id}" data-code="${test.code}">${test.title}</option>`;
                });
            }
            if(currentTest)select.value=currentTest;
            document.getElementById('createBattleModal').classList.remove('hidden');
        };

        window.createBattle=async()=>{
            const testId=document.getElementById('battleTestSelect').value;
            const code=document.getElementById('battleTestCode').value.trim().toUpperCase();
            const snap=await get(ref(db,`tests/${testId}`));
            if(!snap.exists()||snap.val().code!==code)return showToast('Invalid test code','error');
            
            const test=snap.val();
            const battleRef=push(ref(db,'battles'));
            const battleId=battleRef.key;
            
            await set(battleRef,{
                testId,testTitle:test.title,player1:currentUser.id,player1Name:currentUser.name,
                player1Question:0,player1Answers:{},player1Score:null,
                player2:null,player2Name:null,player2Question:0,player2Answers:{},player2Score:null,
                status:'waiting',startTime:null,messages:{}
            });
            
            currentBattle=battleId;
            currentTest=testId;
            closeModal('createBattleModal');
            document.getElementById('waitingBattleCode').textContent=battleId.slice(-6).toUpperCase();
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('waitingRoom').classList.remove('hidden');
            
            battleListener=onValue(ref(db,`battles/${battleId}`),snap=>{
                if(snap.exists()&&snap.val().status==='active'){
                    document.getElementById('waitingRoom').classList.add('hidden');
                    startQuiz(snap.val());
                }
            });
        };

        window.joinBattle=async battleId=>{
            const snap=await get(ref(db,`battles/${battleId}`));
            if(!snap.exists())return showToast('Battle not found','error');
            
            const battle=snap.val();
            const testSnap=await get(ref(db,`tests/${battle.testId}`));
            const code=prompt('Enter test code:');
            if(!code||code.toUpperCase()!==testSnap.val().code)return showToast('Invalid test code','error');
            
            await update(ref(db,`battles/${battleId}`),{
                player2:currentUser.id,player2Name:currentUser.name,
                status:'active',startTime:Date.now()
            });
            
            currentBattle=battleId;
            currentTest=battle.testId;
            document.getElementById('dashboard').classList.add('hidden');
            startQuiz({...battle,player2:currentUser.id,player2Name:currentUser.name,status:'active'});
        };

        window.cancelBattle=async()=>{
            if(currentBattle)await remove(ref(db,`battles/${currentBattle}`));
            if(battleListener)battleListener();
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        };

        // Quiz
        async function startQuiz(battle){
            document.getElementById('quizSection').classList.remove('hidden');
            
            const testSnap=await get(ref(db,`tests/${currentTest}`));
            const test=testSnap.val();
            questions=Object.entries(test.questions).map(([id,q])=>({id,...q}));
            
            document.getElementById('testTitle').textContent=test.title;
            const isPlayer1=battle.player1===currentUser.id;
            document.getElementById('opponentName').textContent=isPlayer1?battle.player2Name:battle.player1Name;
            
            buildQuestionNav();
            showQuestion(0);
            startTimer(3600);
            
            onValue(ref(db,`battles/${currentBattle}`),snap=>{
                if(!snap.exists())return;
                const b=snap.val();
                const oppQ=isPlayer1?b.player2Question:b.player1Question;
                document.getElementById('opponentQuestion').textContent=`Q${(oppQ||0)+1}`;
                
                if(b.status==='completed'){
                    clearInterval(timerInterval);
                    showResults(b,isPlayer1);
                }
            });
            
            onValue(ref(db,`battles/${currentBattle}/messages`),snap=>{
                if(!snap.exists())return;
                const chatBox=document.getElementById('chatBox');
                chatBox.innerHTML='';
                Object.values(snap.val()).forEach(msg=>{
                    chatBox.innerHTML+=`<div class="chat-msg ${msg.userId===currentUser.id?'mine':'theirs'}">${msg.text}</div>`;
                });
                chatBox.scrollTop=chatBox.scrollHeight;
            });
        }

        function buildQuestionNav(){
            const nav=document.getElementById('questionNav');
            nav.innerHTML='';
            questions.forEach((q,i)=>{
                nav.innerHTML+=`<button class="q-btn ${i===0?'current':''}" onclick="goToQuestion(${i})">${i+1}</button>`;
            });
        }

        function showQuestion(index){
            currentQuestionIndex=index;
            const q=questions[index];
            document.getElementById('questionCounter').textContent=`Question ${index+1} of ${questions.length}`;
            document.getElementById('questionText').textContent=q.text;
            
            const container=document.getElementById('optionsContainer');
            container.innerHTML='';
            Object.entries(q.options).forEach(([key,val])=>{
                container.innerHTML+=`
                    <div class="option ${answers[q.id]===key?'selected':''}" onclick="selectOption('${q.id}','${key}')">
                        <strong>${key}.</strong> ${val}
                    </div>`;
            });
            
            document.getElementById('prevBtn').disabled=index===0;
            document.getElementById('nextBtn').classList.toggle('hidden',index===questions.length-1);
            document.getElementById('submitBtn').classList.toggle('hidden',index!==questions.length-1);
            
            document.querySelectorAll('.q-btn').forEach((btn,i)=>{
                btn.classList.toggle('current',i===index);
                btn.classList.toggle('answered',answers[questions[i].id]);
            });
            
            const isPlayer1=currentBattle&&currentUser.id;
            const field=isPlayer1?'player1Question':'player2Question';
            update(ref(db,`battles/${currentBattle}`),{[field]:index});
        }

        window.selectOption=(qId,opt)=>{
            answers[qId]=opt;
            showQuestion(currentQuestionIndex);
            const isPlayer1=currentUser.id;
            update(ref(db,`battles/${currentBattle}`),{
                [isPlayer1?'player1Answers':'player2Answers']:answers
            });
        };

        window.goToQuestion=i=>showQuestion(i);
        window.prevQuestion=()=>{if(currentQuestionIndex>0)showQuestion(currentQuestionIndex-1)};
        window.nextQuestion=()=>{if(currentQuestionIndex<questions.length-1)showQuestion(currentQuestionIndex+1)};

        function startTimer(seconds){
            let remaining=seconds;
            const display=document.getElementById('timer');
            timerInterval=setInterval(()=>{
                remaining--;
                const mins=Math.floor(remaining/60);
                const secs=remaining%60;
                display.textContent=`${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
                if(remaining<=0){clearInterval(timerInterval);submitQuiz()}
            },1000);
        }

        window.submitQuiz=async()=>{
            clearInterval(timerInterval);
            const snap=await get(ref(db,`battles/${currentBattle}`));
            const battle=snap.val();
            const isPlayer1=battle.player1===currentUser.id;
            
            let myScore=0;
            questions.forEach(q=>{if(answers[q.id]===q.answer)myScore++});
            
            await update(ref(db,`battles/${currentBattle}`),{
                [isPlayer1?'player1Score':'player2Score']:myScore,
                [isPlayer1?'player1Answers':'player2Answers']:answers,
                status:'completed'
            });
        };

        async function showResults(battle,isPlayer1){
            document.getElementById('quizSection').classList.add('hidden');
            const myScore=isPlayer1?battle.player1Score:battle.player2Score;
            const oppScore=isPlayer1?battle.player2Score:battle.player1Score;
            
            const won=myScore>oppScore;
            const tied=myScore===oppScore;
            let pointChange=tied?0:(won?10:-5);
            
            const userSnap=await get(ref(db,`users/${currentUser.id}`));
            let userPoints=(userSnap.val().points||0)+pointChange;
            if(userPoints<0)userPoints=0;
            
            const updateData={points:userPoints};
            if(won)updateData.wins=(userSnap.val().wins||0)+1;
            else if(!tied)updateData.losses=(userSnap.val().losses||0)+1;
            
            await update(ref(db,`users/${currentUser.id}`),updateData);
            
            await push(ref(db,`users/${currentUser.id}/records`),{
                testId:currentTest,opponent:isPlayer1?battle.player2Name:battle.player1Name,
                myScore,oppScore,pointChange,date:Date.now()
            });
            
            document.getElementById('resultEmoji').textContent=won?'üèÜ':(tied?'ü§ù':'üò¢');
            document.getElementById('resultTitle').textContent=won?'Victory!':(tied?'Draw!':'Defeat');
            document.getElementById('yourScore').textContent=`${myScore}/${questions.length}`;
            document.getElementById('pointChange').textContent=`${pointChange>=0?'+':''}${pointChange} Points`;
            document.getElementById('pointChange').className=`point-change ${pointChange>=0?'positive':'negative'}`;
            document.getElementById('newTotalPoints').textContent=userPoints;
            document.getElementById('opponentResultName').textContent=isPlayer1?battle.player2Name:battle.player1Name;
            document.getElementById('opponentScore').textContent=`${oppScore}/${questions.length}`;
            
            document.getElementById('resultsModal').classList.remove('hidden');
            currentUser.points=userPoints;
        }

        window.closeResults=()=>{
            document.getElementById('resultsModal').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            currentBattle=null;
            answers={};
            updateUserInfo();
            loadLeaderboard();
        };

        // Chat
        window.sendMessage=async()=>{
            const input=document.getElementById('chatInput');
            const text=input.value.trim();
            if(!text)return;
            await push(ref(db,`battles/${currentBattle}/messages`),{
                userId:currentUser.id,text,time:Date.now()
            });
            input.value='';
        };

        // Voice
        window.toggleMic=async()=>{
            const btn=document.getElementById('micBtn');
            isMuted=!isMuted;
            btn.classList.toggle('muted',isMuted);
            btn.classList.toggle('active',!isMuted);
            btn.innerHTML=`<i class="fas fa-microphone${isMuted?'-slash':''}"></i>`;
            if(localStream)localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted);
        };

        window.toggleSpeaker=()=>{
            const btn=document.getElementById('speakerBtn');
            isSpeakerOff=!isSpeakerOff;
            btn.classList.toggle('muted',isSpeakerOff);
            btn.classList.toggle('active',!isSpeakerOff);
            btn.innerHTML=`<i class="fas fa-volume-${isSpeakerOff?'mute':'up'}"></i>`;
        };

        // Leaderboard
        async function loadLeaderboard(){
            const snap=await get(ref(db,'users'));
            if(!snap.exists())return;
            const users=Object.entries(snap.val())
                .filter(([,u])=>u.status!=='restricted')
                .sort((a,b)=>(b[1].points||0)-(a[1].points||0));
            
            const list=document.getElementById('leaderboardList');
            list.innerHTML='';
            users.forEach(([id,user],i)=>{
                const rankClass=i<3?`rank-${i+1}`:'';
                list.innerHTML+=`
                    <div class="lb-item ${id===currentUser.id?'current-user':''}">
                        <div class="rank ${rankClass}">${i+1}</div>
                        <div class="avatar" style="width:40px;height:40px;font-size:1rem">${user.name.charAt(0)}</div>
                        <div style="flex:1">
                            <div style="font-weight:700">${user.name} ${id===currentUser.id?'(You)':''}</div>
                            <div style="font-size:.85rem;color:#888">${user.school}</div>
                        </div>
                        <div style="font-weight:700;font-size:1.2rem">${user.points||0}</div>
                    </div>`;
            });
            
            const userRank=users.findIndex(([id])=>id===currentUser.id)+1;
            document.getElementById('userRank').textContent=`#${userRank}`;
        }

        // Records
        async function loadRecords(){
            const snap=await get(ref(db,`users/${currentUser.id}/records`));
            const list=document.getElementById('recordsList');
            if(!snap.exists()){
                list.innerHTML='<p style="color:#888">No battle records yet.</p>';
                return;
            }
            list.innerHTML='';
            Object.values(snap.val()).reverse().forEach(record=>{
                const won=record.myScore>record.oppScore;
                list.innerHTML+=`
                    <div class="record-card">
                        <div>
                            <div style="font-weight:700">vs ${record.opponent}</div>
                            <div style="color:#888;font-size:.9rem">${new Date(record.date).toLocaleDateString()}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:1.2rem;font-weight:700">${record.myScore} - ${record.oppScore}</div>
                            <div style="color:${won?'var(--success)':'var(--danger)'}">${record.pointChange>=0?'+':''}${record.pointChange} pts</div>
                        </div>
                    </div>`;
            });
        }

        // Settings
        window.updateProfile=async()=>{
            const name=document.getElementById('settingsName').value.trim();
            const school=document.getElementById('settingsSchool').value.trim();
            const code=document.getElementById('settingsCode').value.trim();
            if(!name||!school||!code)return showToast('Fill all fields','error');
            
            if(code!==currentUser.code){
                const snap=await get(ref(db,'users'));
                if(snap.exists()&&Object.entries(snap.val()).some(([id,u])=>id!==currentUser.id&&u.code===code)){
                    return showToast('Code already taken','error');
                }
            }
            
            await update(ref(db,`users/${currentUser.id}`),{name,school,code});
            currentUser={...currentUser,name,school,code};
            updateUserInfo();
            showToast('Profile updated!','success');
        };

        window.deleteAccount=async()=>{
            if(!confirm('Are you sure you want to delete your account?'))return;
            await remove(ref(db,`users/${currentUser.id}`));
            logout();
            showToast('Account deleted','info');
        };

        // Admin
        async function loadAdminData(){
            loadAdminUsers();
            loadAdminTests();
            loadTestsForSelect();
        }

        async function loadAdminUsers(){
            const snap=await get(ref(db,'users'));
            const tbody=document.getElementById('usersTableBody');
            tbody.innerHTML='';
            if(!snap.exists())return;
            Object.entries(snap.val()).forEach(([id,user])=>{
                tbody.innerHTML+=`
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.school}</td>
                        <td>${user.code}</td>
                        <td>${user.points||0}</td>
                        <td><span style="color:${user.status==='restricted'?'var(--danger)':'var(--success)'}">${user.status||'active'}</span></td>
                        <td>
                            <button class="btn btn-outline" style="padding:5px 10px;font-size:.8rem" onclick="editUserScore('${id}',${user.points||0})">Edit Score</button>
                            <button class="btn btn-${user.status==='restricted'?'success':'warning'}" style="padding:5px 10px;font-size:.8rem" onclick="toggleUserStatus('${id}','${user.status}')">${user.status==='restricted'?'Unrestrict':'Restrict'}</button>
                            <button class="btn btn-danger" style="padding:5px 10px;font-size:.8rem" onclick="deleteUser('${id}')">Delete</button>
                        </td>
                    </tr>`;
            });
        }

        async function loadAdminTests(){
            const snap=await get(ref(db,'tests'));
            const tbody=document.getElementById('testsTableBody');
            tbody.innerHTML='';
            if(!snap.exists())return;
            Object.entries(snap.val()).forEach(([id,test])=>{
                const qCount=test.questions?Object.keys(test.questions).length:0;
                tbody.innerHTML+=`
                    <tr>
                        <td>${test.title}</td>
                        <td>${test.code}</td>
                        <td>${qCount}</td>
                        <td>
                            <button class="btn btn-danger" style="padding:5px 10px;font-size:.8rem" onclick="deleteTest('${id}')">Delete</button>
                        </td>
                    </tr>`;
            });
        }

        async function loadTestsForSelect(){
            const snap=await get(ref(db,'tests'));
            const selects=['questionTestSelect','newQuestionTest'];
            selects.forEach(id=>{
                const sel=document.getElementById(id);
                if(sel){
                    sel.innerHTML='<option value="">Select a test</option>';
                    if(snap.exists()){
                        Object.entries(snap.val()).forEach(([tid,test])=>{
                            sel.innerHTML+=`<option value="${tid}">${test.title}</option>`;
                        });
                    }
                }
            });
        }

        window.showAdminSection=section=>{
            document.getElementById('adminUsers').classList.toggle('hidden',section!=='users');
            document.getElementById('adminTests').classList.toggle('hidden',section!=='tests');
            document.getElementById('adminQuestions').classList.toggle('hidden',section!=='questions');
        };

        window.editUserScore=(id,score)=>{
            document.getElementById('editScoreUserId').value=id;
            document.getElementById('editScoreValue').value=score;
            document.getElementById('editScoreModal').classList.remove('hidden');
        };

        window.saveUserScore=async()=>{
            const id=document.getElementById('editScoreUserId').value;
            const score=parseInt(document.getElementById('editScoreValue').value)||0;
            await update(ref(db,`users/${id}`),{points:Math.max(0,score)});
            closeModal('editScoreModal');
            loadAdminUsers();
            showToast('Score updated','success');
        };

        window.toggleUserStatus=async(id,status)=>{
            await update(ref(db,`users/${id}`),{status:status==='restricted'?'active':'restricted'});
            loadAdminUsers();
            showToast('Status updated','success');
        };

        window.deleteUser=async id=>{
            if(!confirm('Delete this user?'))return;
            await remove(ref(db,`users/${id}`));
            loadAdminUsers();
            showToast('User deleted','success');
        };

        window.showAddTestModal=()=>document.getElementById('addTestModal').classList.remove('hidden');

        window.addTest=async()=>{
            const title=document.getElementById('newTestTitle').value.trim();
            const code=document.getElementById('newTestCode').value.trim().toUpperCase();
            const desc=document.getElementById('newTestDesc').value.trim();
            if(!title||!code)return showToast('Fill required fields','error');
            
            const newRef=push(ref(db,'tests'));
            await set(newRef,{title,code,description:desc,questions:{}});
            closeModal('addTestModal');
            loadAdminTests();
            loadTestsForSelect();
            showToast('Test added','success');
        };

        window.deleteTest=async id=>{
            if(!confirm('Delete this test?'))return;
            await remove(ref(db,`tests/${id}`));
            loadAdminTests();
            loadTestsForSelect();
            showToast('Test deleted','success');
        };

        window.showAddQuestionModal=()=>{
            document.getElementById('questionModalTitle').textContent='Add New Question';
            document.getElementById('editQuestionId').value='';
            ['newQuestionText','optionA','optionB','optionC','optionD'].forEach(id=>document.getElementById(id).value='');
            document.getElementById('addQuestionModal').classList.remove('hidden');
        };

        window.loadQuestionsForTest=async()=>{
            const testId=document.getElementById('questionTestSelect').value;
            const tbody=document.getElementById('questionsTableBody');
            tbody.innerHTML='';
            if(!testId)return;
            
            const snap=await get(ref(db,`tests/${testId}/questions`));
            if(!snap.exists())return;
            Object.entries(snap.val()).forEach(([qid,q])=>{
                tbody.innerHTML+=`
                    <tr>
                        <td>${q.text.substring(0,50)}...</td>
                        <td>A:${q.options.A}, B:${q.options.B}, C:${q.options.C}, D:${q.options.D}</td>
                        <td>${q.answer}</td>
                        <td>
                            <button class="btn btn-outline" style="padding:5px 10px;font-size:.8rem" onclick="editQuestion('${testId}','${qid}')">Edit</button>
                            <button class="btn btn-danger" style="padding:5px 10px;font-size:.8rem" onclick="deleteQuestion('${testId}','${qid}')">Delete</button>
                        </td>
                    </tr>`;
            });
        };

        window.editQuestion=async(testId,qid)=>{
            const snap=await get(ref(db,`tests/${testId}/questions/${qid}`));
            const q=snap.val();
            document.getElementById('questionModalTitle').textContent='Edit Question';
            document.getElementById('newQuestionTest').value=testId;
            document.getElementById('newQuestionText').value=q.text;
            document.getElementById('optionA').value=q.options.A;
            document.getElementById('optionB').value=q.options.B;
            document.getElementById('optionC').value=q.options.C;
            document.getElementById('optionD').value=q.options.D;
            document.getElementById('correctAnswer').value=q.answer;
            document.getElementById('editQuestionId').value=`${testId}/${qid}`;
            document.getElementById('addQuestionModal').classList.remove('hidden');
        };

        window.saveQuestion=async()=>{
            const testId=document.getElementById('newQuestionTest').value;
            const text=document.getElementById('newQuestionText').value.trim();
            const options={
                A:document.getElementById('optionA').value.trim(),
                B:document.getElementById('optionB').value.trim(),
                C:document.getElementById('optionC').value.trim(),
                D:document.getElementById('optionD').value.trim()
            };
            const answer=document.getElementById('correctAnswer').value;
            const editPath=document.getElementById('editQuestionId').value;
            
            if(!testId||!text||!options.A)return showToast('Fill required fields','error');
            
            if(editPath){
                await update(ref(db,`tests/${editPath}`),{text,options,answer});
            }else{
                await push(ref(db,`tests/${testId}/questions`),{text,options,answer});
            }
            closeModal('addQuestionModal');
            loadQuestionsForTest();
            loadAdminTests();
            showToast('Question saved','success');
        };

        window.deleteQuestion=async(testId,qid)=>{
            if(!confirm('Delete this question?'))return;
            await remove(ref(db,`tests/${testId}/questions/${qid}`));
            loadQuestionsForTest();
            showToast('Question deleted','success');
        };

        window.closeModal=id=>document.getElementById(id).classList.add('hidden');

        // Check stored session
        const storedUserId=localStorage.getItem('userId');
        if(storedUserId){
            get(ref(db,`users/${storedUserId}`)).then(snap=>{
                if(snap.exists()){
                    currentUser={id:storedUserId,...snap.val()};
                    showDashboard();
                }
            });
        }
    </script>
</body>
</html>