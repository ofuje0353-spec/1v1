<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofuje - Multiplayer CBT</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --bg-card: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 10px 40px rgba(0,0,0,0.1);
            --gradient: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
        }
        .dark {
            --bg: #0f172a;
            --bg-card: #1e293b;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: all 0.3s;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            font-size: 14px;
        }
        .btn-primary { background: var(--gradient); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(99,102,241,0.4); }
        .btn-secondary { background: var(--bg-card); color: var(--text); border: 2px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: var(--bg-card);
            color: var(--text);
            transition: all 0.3s;
            font-family: inherit;
        }
        .input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99,102,241,0.1); }
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        /* Auth Page */
        #authPage {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient);
            padding: 20px;
        }
        .auth-container {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 50px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }
        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }
        .auth-logo h1 {
            font-size: 42px;
            font-weight: 800;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        .auth-tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            background: var(--bg);
            color: var(--text-secondary);
        }
        .auth-tab.active { background: var(--gradient); color: white; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .profile-upload {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s;
            background: var(--bg);
        }
        .profile-upload:hover { border-color: var(--primary); }
        .profile-upload img { width: 100%; height: 100%; object-fit: cover; }
        .profile-upload i { font-size: 32px; color: var(--text-secondary); }

        /* Dashboard */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }
        .user-info h3 { font-size: 18px; font-weight: 600; }
        .user-info span { color: var(--text-secondary); font-size: 14px; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .theme-toggle {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            border: none;
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
        }
        .stat-card h4 { color: var(--text-secondary); font-size: 14px; margin-bottom: 8px; }
        .stat-card .value { font-size: 32px; font-weight: 700; }
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            background: var(--bg);
            color: var(--text-secondary);
            border: none;
        }
        .nav-tab.active { background: var(--gradient); color: white; }
        
        /* Tests Grid */
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .test-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        .test-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        .test-card h3 { margin-bottom: 10px; font-size: 20px; }
        .test-card p { color: var(--text-secondary); margin-bottom: 20px; }
        .test-meta { display: flex; gap: 20px; margin-bottom: 20px; }
        .test-meta span { display: flex; align-items: center; gap: 5px; font-size: 14px; color: var(--text-secondary); }

        /* Quiz Page */
        .quiz-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
            height: calc(100vh - 120px);
        }
        @media (max-width: 1024px) {
            .quiz-container { grid-template-columns: 1fr; height: auto; }
        }
        .quiz-main { display: flex; flex-direction: column; }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: var(--bg-card);
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 15px;
        }
        .timer {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }
        .timer.warning { color: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .players-status { display: flex; gap: 20px; }
        .player-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--bg);
            border-radius: 30px;
        }
        .player-status img { width: 32px; height: 32px; border-radius: 50%; }
        .player-status .q-num { font-weight: 600; color: var(--primary); }
        .question-card {
            flex: 1;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 35px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .question-number {
            display: inline-block;
            padding: 8px 16px;
            background: var(--gradient);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 25px;
        }
        .question-text { font-size: 20px; line-height: 1.6; margin-bottom: 30px; }
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option {
            padding: 18px 22px;
            border: 2px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .option:hover { border-color: var(--primary); background: rgba(99,102,241,0.05); }
        .option.selected { border-color: var(--primary); background: rgba(99,102,241,0.1); }
        .option-letter {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .option.selected .option-letter { background: var(--primary); color: white; }
        .quiz-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 15px;
        }
        
        /* Communication Sidebar */
        .comm-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .voice-panel {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        .voice-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .voice-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            background: var(--bg);
            color: var(--text);
        }
        .voice-btn.active { background: var(--primary); color: white; }
        .voice-btn.muted { background: var(--danger); color: white; }
        .chat-panel {
            flex: 1;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 16px;
            font-size: 14px;
        }
        .message.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .message.received { align-self: flex-start; background: var(--bg); border-bottom-left-radius: 4px; }
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }
        .chat-input-area input { flex: 1; }
        .emoji-btn {
            width: 45px;
            height: 45px;
            border: none;
            background: var(--bg);
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
        }
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            right: 15px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 250px;
        }
        .emoji-picker span { font-size: 24px; cursor: pointer; padding: 5px; transition: transform 0.2s; }
        .emoji-picker span:hover { transform: scale(1.3); }

        /* Leaderboard */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .leaderboard-table th { font-weight: 600; color: var(--text-secondary); font-size: 14px; }
        .leaderboard-table tr:hover { background: rgba(99,102,241,0.05); }
        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffb700); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #b87333); color: #fff; }

        /* Waiting Room */
        .waiting-room {
            text-align: center;
            padding: 80px 30px;
        }
        .waiting-room h2 { margin-bottom: 20px; }
        .waiting-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Results Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-content {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px;
            max-width: 550px;
            width: 100%;
            text-align: center;
        }
        .result-icon { font-size: 80px; margin-bottom: 20px; }
        .result-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        .result-player {
            padding: 25px;
            border-radius: 16px;
            background: var(--bg);
        }
        .result-player img { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; }
        .result-player h4 { margin-bottom: 5px; }
        .result-player .score { font-size: 36px; font-weight: 700; color: var(--primary); }
        .point-change { font-size: 18px; font-weight: 600; margin-top: 10px; }
        .point-change.positive { color: var(--success); }
        .point-change.negative { color: var(--danger); }

        /* Admin Panel */
        .admin-section { margin-bottom: 30px; }
        .admin-section h3 { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .admin-table th, .admin-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .admin-actions { display: flex; gap: 8px; }
        .admin-form { display: grid; gap: 15px; }
        .admin-form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }

        /* Waiting Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .auth-container { padding: 30px 25px; }
            .dashboard-header { flex-direction: column; align-items: flex-start; }
            .quiz-container { grid-template-columns: 1fr; }
            .result-stats { grid-template-columns: 1fr; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Auth Page -->
    <div id="authPage">
        <div class="auth-container">
            <div class="auth-logo">
                <h1>Ofuje</h1>
                <p style="color: var(--text-secondary); margin-top: 5px;">Multiplayer CBT Platform</p>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuth('login')">Login</div>
                <div class="auth-tab" onclick="switchAuth('register')">Register</div>
                <div class="auth-tab" onclick="switchAuth('admin')">Admin</div>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" onsubmit="login(event)">
                <div class="form-group">
                    <label>Access Code</label>
                    <input type="text" class="input" id="loginCode" placeholder="Enter your access code" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="hidden" onsubmit="register(event)">
                <div class="profile-upload" onclick="document.getElementById('profilePic').click()">
                    <img id="profilePreview" class="hidden">
                    <i id="uploadIcon" class="fas fa-camera"></i>
                </div>
                <input type="file" id="profilePic" accept="image/*" hidden onchange="previewImage(this)">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" class="input" id="regName" placeholder="Enter your name" required>
                </div>
                <div class="form-group">
                    <label>Access Code</label>
                    <input type="text" class="input" id="regCode" placeholder="Choose your unique access code" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </form>

            <!-- Admin Login -->
            <form id="adminForm" class="hidden" onsubmit="adminLogin(event)">
                <div class="form-group">
                    <label>Admin Password</label>
                    <input type="password" class="input" id="adminPass" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">
                    <i class="fas fa-shield-alt"></i> Admin Access
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="hidden container">
        <div class="dashboard-header">
            <div class="user-profile">
                <img id="userAvatar" class="user-avatar" src="" alt="">
                <div class="user-info">
                    <h3 id="userName"></h3>
                    <span id="userPoints">0 Points</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
                <button class="btn btn-secondary" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h4><i class="fas fa-trophy"></i> Total Points</h4>
                <div class="value" id="statPoints">0</div>
            </div>
            <div class="stat-card">
                <h4><i class="fas fa-check-circle"></i> Tests Taken</h4>
                <div class="value" id="statTests">0</div>
            </div>
            <div class="stat-card">
                <h4><i class="fas fa-medal"></i> Wins</h4>
                <div class="value" id="statWins">0</div>
            </div>
            <div class="stat-card">
                <h4><i class="fas fa-ranking-star"></i> Rank</h4>
                <div class="value" id="statRank">#0</div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('tests')"><i class="fas fa-book"></i> Tests</button>
            <button class="nav-tab" onclick="showTab('records')"><i class="fas fa-history"></i> My Records</button>
            <button class="nav-tab" onclick="showTab('leaderboard')"><i class="fas fa-trophy"></i> Leaderboard</button>
            <button class="nav-tab" onclick="showTab('users')"><i class="fas fa-users"></i> All Users</button>
        </div>

        <!-- Tests Section -->
        <div id="testsSection" class="card">
            <h2 style="margin-bottom: 25px;"><i class="fas fa-book-open"></i> Available Tests</h2>
            <div id="testsGrid" class="tests-grid"></div>
        </div>

        <!-- Records Section -->
        <div id="recordsSection" class="card hidden">
            <h2 style="margin-bottom: 25px;"><i class="fas fa-history"></i> My Test Records</h2>
            <div id="recordsList"></div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboardSection" class="card hidden">
            <h2 style="margin-bottom: 25px;"><i class="fas fa-trophy"></i> Leaderboard</h2>
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>User</th>
                        <th>Points</th>
                        <th>Wins</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody"></tbody>
            </table>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="card hidden">
            <h2 style="margin-bottom: 25px;"><i class="fas fa-users"></i> All Users</h2>
            <div id="usersList"></div>
        </div>
    </div>

    <!-- Test Code Modal -->
    <div id="testCodeModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom: 10px;">Enter Test Code</h2>
            <p style="color: var(--text-secondary); margin-bottom: 25px;">Enter the 6-digit alphanumeric code for <span id="testNameSpan"></span></p>
            <input type="text" class="input" id="testCodeInput" maxlength="6" placeholder="Enter code" style="text-align: center; font-size: 24px; letter-spacing: 8px; margin-bottom: 20px;">
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-secondary" style="flex:1" onclick="closeTestCodeModal()">Cancel</button>
                <button class="btn btn-primary" style="flex:1" onclick="verifyTestCode()">Start Test</button>
            </div>
        </div>
    </div>

    <!-- Waiting Room -->
    <div id="waitingRoom" class="modal hidden">
        <div class="modal-content waiting-room">
            <h2>Waiting for Opponent</h2>
            <p style="color: var(--text-secondary);">The test will begin when another user joins</p>
            <div class="waiting-spinner"></div>
            <p id="waitingStatus" style="color: var(--primary); font-weight: 600;">Searching for opponent...</p>
            <button class="btn btn-secondary" onclick="cancelWaiting()" style="margin-top: 20px;">Cancel</button>
        </div>
    </div>

    <!-- Quiz Page -->
    <div id="quizPage" class="hidden container">
        <div class="quiz-container">
            <div class="quiz-main">
                <div class="quiz-header">
                    <div class="timer" id="timer">60:00</div>
                    <div class="players-status">
                        <div class="player-status">
                            <img id="p1Avatar" src="" alt="">
                            <span id="p1Name">You</span>
                            <span class="q-num">Q<span id="p1Question">1</span></span>
                        </div>
                        <div class="player-status">
                            <img id="p2Avatar" src="" alt="">
                            <span id="p2Name">Opponent</span>
                            <span class="q-num">Q<span id="p2Question">1</span></span>
                        </div>
                    </div>
                </div>
                <div class="question-card">
                    <span class="question-number">Question <span id="currentQNum">1</span> of <span id="totalQNum">10</span></span>
                    <p class="question-text" id="questionText">Loading question...</p>
                    <div class="options" id="optionsContainer"></div>
                    <div class="quiz-nav">
                        <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()"><i class="fas fa-arrow-left"></i> Previous</button>
                        <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">Next <i class="fas fa-arrow-right"></i></button>
                        <button class="btn btn-success hidden" id="submitBtn" onclick="submitQuiz()"><i class="fas fa-check"></i> Submit</button>
                    </div>
                </div>
            </div>
            <div class="comm-sidebar">
                <div class="voice-panel">
                    <h4 style="text-align: center; margin-bottom: 15px;"><i class="fas fa-microphone"></i> Voice Chat</h4>
                    <div class="voice-controls">
                        <button class="voice-btn active" id="micBtn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
                        <button class="voice-btn active" id="speakerBtn" onclick="toggleSpeaker()"><i class="fas fa-volume-up"></i></button>
                    </div>
                    <audio id="remoteAudio" autoplay></audio>
                </div>
                <div class="chat-panel">
                    <div class="chat-header"><i class="fas fa-comments"></i> Chat</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area" style="position: relative;">
                        <input type="text" class="input" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMessage()">
                        <button class="emoji-btn" onclick="toggleEmojiPicker()">üòä</button>
                        <div class="emoji-picker hidden" id="emojiPicker"></div>
                        <button class="btn btn-primary" onclick="sendMessage()" style="padding: 12px 16px;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal hidden">
        <div class="modal-content">
            <div class="result-icon" id="resultIcon">üèÜ</div>
            <h2 id="resultTitle">Results</h2>
            <div class="result-stats">
                <div class="result-player">
                    <img id="result1Avatar" src="" alt="">
                    <h4 id="result1Name">You</h4>
                    <div class="score" id="result1Score">0/10</div>
                    <div class="point-change" id="result1Points">+0</div>
                    <div style="margin-top: 5px; color: var(--text-secondary);">Total: <span id="result1Total">0</span></div>
                </div>
                <div class="result-player">
                    <img id="result2Avatar" src="" alt="">
                    <h4 id="result2Name">Opponent</h4>
                    <div class="score" id="result2Score">0/10</div>
                    <div class="point-change" id="result2Points">+0</div>
                    <div style="margin-top: 5px; color: var(--text-secondary);">Total: <span id="result2Total">0</span></div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="backToDashboard()" style="width: 100%;">Back to Dashboard</button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPage" class="hidden container">
        <div class="dashboard-header">
            <h1 style="background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                <i class="fas fa-shield-alt"></i> Admin Panel
            </h1>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
                <button class="btn btn-secondary" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showAdminTab('users')"><i class="fas fa-users"></i> Users</button>
            <button class="nav-tab" onclick="showAdminTab('tests')"><i class="fas fa-book"></i> Tests</button>
            <button class="nav-tab" onclick="showAdminTab('questions')"><i class="fas fa-question-circle"></i> Questions</button>
        </div>

        <!-- Admin Users -->
        <div id="adminUsersSection" class="card admin-section">
            <h3><i class="fas fa-users"></i> Manage Users</h3>
            <table class="admin-table">
                <thead>
                    <tr><th>Avatar</th><th>Name</th><th>Code</th><th>Points</th><th>Status</th><th>Actions</th></tr>
                </thead>
                <tbody id="adminUsersBody"></tbody>
            </table>
        </div>

        <!-- Admin Tests -->
        <div id="adminTestsSection" class="card admin-section hidden">
            <h3><i class="fas fa-book"></i> Manage Tests</h3>
            <div class="admin-form" style="margin-bottom: 25px;">
                <h4>Add New Test</h4>
                <div class="admin-form-row">
                    <input type="text" class="input" id="newTestName" placeholder="Test Name">
                    <input type="text" class="input" id="newTestCode" placeholder="6-digit Access Code" maxlength="6">
                    <input type="text" class="input" id="newTestDesc" placeholder="Description">
                    <button class="btn btn-primary" onclick="addTest()"><i class="fas fa-plus"></i> Add Test</button>
                </div>
            </div>
            <table class="admin-table">
                <thead>
                    <tr><th>Name</th><th>Code</th><th>Questions</th><th>Actions</th></tr>
                </thead>
                <tbody id="adminTestsBody"></tbody>
            </table>
        </div>

        <!-- Admin Questions -->
        <div id="adminQuestionsSection" class="card admin-section hidden">
            <h3><i class="fas fa-question-circle"></i> Manage Questions</h3>
            <div class="admin-form" style="margin-bottom: 25px;">
                <h4>Add New Question</h4>
                <select class="input" id="questionTestSelect" style="margin-bottom: 10px;"></select>
                <textarea class="input" id="newQuestionText" placeholder="Question text" rows="3"></textarea>
                <div class="admin-form-row">
                    <input type="text" class="input" id="optionA" placeholder="Option A">
                    <input type="text" class="input" id="optionB" placeholder="Option B">
                    <input type="text" class="input" id="optionC" placeholder="Option C">
                    <input type="text" class="input" id="optionD" placeholder="Option D">
                </div>
                <div class="admin-form-row">
                    <select class="input" id="correctAnswer">
                        <option value="A">Correct: A</option>
                        <option value="B">Correct: B</option>
                        <option value="C">Correct: C</option>
                        <option value="D">Correct: D</option>
                    </select>
                    <button class="btn btn-primary" onclick="addQuestion()"><i class="fas fa-plus"></i> Add Question</button>
                </div>
            </div>
            <div id="adminQuestionsList"></div>
        </div>
    </div>

    <script>
        // Firebase Config - REPLACE WITH YOUR OWN
        const firebaseConfig = {
         apiKey: "AIzaSyC-nV1tKINigOUY9MMBj2qSfJpTA4U1_P8",
         authDomain: "multiplayer-b7a97.firebaseapp.com",
         projectId: "multiplayer-b7a97",
         storageBucket: "multiplayer-b7a97.firebasestorage.app",
         messagingSenderId: "902618834188",
         appId: "1:902618834188:web:b6840f5cba642b1c4ad529"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const rtdb = firebase.database();

        // State
        let currentUser = null;
        let currentTest = null;
        let currentSession = null;
        let questions = [];
        let answers = {};
        let currentQ = 0;
        let timerInterval = null;
        let timeLeft = 3600;
        let peerConnection = null;
        let localStream = null;
        let micEnabled = true;
        let speakerEnabled = true;
        let sessionUnsubscribe = null;

        // Emojis
        const emojis = ['üòÄ','üòÇ','ü§£','üòä','üòç','ü•≥','ü§î','üòé','üôÑ','üò¢','üò°','üëç','üëé','‚ù§Ô∏è','üî•','‚≠ê','üíØ','üéâ'];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initEmojis();
            initDefaultData();
            checkDarkMode();
        });

        function initEmojis() {
            const picker = document.getElementById('emojiPicker');
            emojis.forEach(e => {
                const span = document.createElement('span');
                span.textContent = e;
                span.onclick = () => {
                    document.getElementById('chatInput').value += e;
                    toggleEmojiPicker();
                };
                picker.appendChild(span);
            });
        }

        async function initDefaultData() {
            // Check if default tests exist
            const testsSnap = await db.collection('tests').get();
            if (testsSnap.empty) {
                // Add default tests
                const tests = [
                    { name: 'General Knowledge', code: 'GEN001', description: 'Test your general knowledge', createdAt: new Date() },
                    { name: 'Science Quiz', code: 'SCI002', description: 'Basic science questions', createdAt: new Date() }
                ];
                for (const test of tests) {
                    await db.collection('tests').add(test);
                }
            }
            
            // Check for default questions
            const questionsSnap = await db.collection('questions').get();
            if (questionsSnap.empty) {
                const testsSnap = await db.collection('tests').get();
                const testIds = testsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const defaultQuestions = [
                    { testId: testIds[0]?.id, text: 'What is the capital of France?', options: ['London', 'Paris', 'Berlin', 'Madrid'], correct: 'B' },
                    { testId: testIds[0]?.id, text: 'Which planet is known as the Red Planet?', options: ['Venus', 'Jupiter', 'Mars', 'Saturn'], correct: 'C' },
                    { testId: testIds[1]?.id, text: 'What is H2O commonly known as?', options: ['Salt', 'Water', 'Sugar', 'Oil'], correct: 'B' },
                    { testId: testIds[1]?.id, text: 'What gas do plants absorb from the atmosphere?', options: ['Oxygen', 'Nitrogen', 'Carbon Dioxide', 'Hydrogen'], correct: 'C' }
                ];
                
                for (const q of defaultQuestions) {
                    if (q.testId) await db.collection('questions').add(q);
                }
            }
        }

        // Auth Functions
        function switchAuth(type) {
            document.querySelectorAll('.auth-tab').forEach((t, i) => t.classList.toggle('active', 
                (type === 'login' && i === 0) || (type === 'register' && i === 1) || (type === 'admin' && i === 2)));
            document.getElementById('loginForm').classList.toggle('hidden', type !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', type !== 'register');
            document.getElementById('adminForm').classList.toggle('hidden', type !== 'admin');
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('profilePreview').src = e.target.result;
                    document.getElementById('profilePreview').classList.remove('hidden');
                    document.getElementById('uploadIcon').classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function login(e) {
            e.preventDefault();
            const code = document.getElementById('loginCode').value.trim();
            const userSnap = await db.collection('users').where('code', '==', code).get();
            
            if (userSnap.empty) {
                alert('Invalid access code!');
                return;
            }
            
            const userData = userSnap.docs[0];
            if (userData.data().restricted) {
                alert('Your account has been restricted!');
                return;
            }
            
            currentUser = { id: userData.id, ...userData.data() };
            localStorage.setItem('ofujeUser', JSON.stringify(currentUser));
            showDashboard();
        }

        async function register(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value.trim();
            const code = document.getElementById('regCode').value.trim();
            const fileInput = document.getElementById('profilePic');
            
            // Check if code exists
            const existing = await db.collection('users').where('code', '==', code).get();
            if (!existing.empty) {
                alert('Access code already taken!');
                return;
            }
            
            let photoURL = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(name) + '&background=6366f1&color=fff';
            
            if (fileInput.files[0]) {
                const ref = storage.ref('profiles/' + Date.now() + '_' + fileInput.files[0].name);
                await ref.put(fileInput.files[0]);
                photoURL = await ref.getDownloadURL();
            }
            
            const userRef = await db.collection('users').add({
                name, code, photoURL,
                points: 0, wins: 0, losses: 0, tests: 0,
                createdAt: new Date(), restricted: false
            });
            
            currentUser = { id: userRef.id, name, code, photoURL, points: 0, wins: 0, losses: 0, tests: 0 };
            localStorage.setItem('ofujeUser', JSON.stringify(currentUser));
            showDashboard();
        }

        function adminLogin(e) {
            e.preventDefault();
            if (document.getElementById('adminPass').value === 'admin123') {
                document.getElementById('authPage').classList.add('hidden');
                document.getElementById('adminPage').classList.remove('hidden');
                loadAdminData();
            } else {
                alert('Invalid admin password!');
            }
        }

        function logout() {
            localStorage.removeItem('ofujeUser');
            currentUser = null;
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('loginCode').value = '';
        }

        function adminLogout() {
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('authPage').classList.remove('hidden');
        }

        // Dashboard
        async function showDashboard() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            
            // Update user info
            document.getElementById('userAvatar').src = currentUser.photoURL;
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userPoints').textContent = currentUser.points + ' Points';
            
            await loadStats();
            await loadTests();
            await loadLeaderboard();
        }

        async function loadStats() {
            const userDoc = await db.collection('users').doc(currentUser.id).get();
            const data = userDoc.data();
            currentUser = { id: currentUser.id, ...data };
            
            document.getElementById('statPoints').textContent = data.points || 0;
            document.getElementById('statTests').textContent = data.tests || 0;
            document.getElementById('statWins').textContent = data.wins || 0;
            document.getElementById('userPoints').textContent = (data.points || 0) + ' Points';
            
            // Calculate rank
            const usersSnap = await db.collection('users').orderBy('points', 'desc').get();
            let rank = 1;
            usersSnap.forEach(doc => {
                if (doc.id === currentUser.id) document.getElementById('statRank').textContent = '#' + rank;
                rank++;
            });
        }

        async function loadTests() {
            const testsSnap = await db.collection('tests').get();
            const grid = document.getElementById('testsGrid');
            grid.innerHTML = '';
            
            for (const doc of testsSnap.docs) {
                const test = doc.data();
                const questionsSnap = await db.collection('questions').where('testId', '==', doc.id).get();
                
                grid.innerHTML += `
                    <div class="test-card">
                        <h3>${test.name}</h3>
                        <p>${test.description}</p>
                        <div class="test-meta">
                            <span><i class="fas fa-question-circle"></i> ${questionsSnap.size} Questions</span>
                            <span><i class="fas fa-clock"></i> 60 mins</span>
                            <span><i class="fas fa-users"></i> Multiplayer</span>
                        </div>
                        <button class="btn btn-primary" onclick="startTest('${doc.id}', '${test.name}')">
                            <i class="fas fa-play"></i> Start Test
                        </button>
                    </div>
                `;
            }
        }

        async function loadLeaderboard() {
            const usersSnap = await db.collection('users').orderBy('points', 'desc').limit(50).get();
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            
            let rank = 1;
            usersSnap.forEach(doc => {
                const u = doc.data();
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                tbody.innerHTML += `
                    <tr>
                        <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                        <td style="display:flex;align-items:center;gap:10px;">
                            <img src="${u.photoURL}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
                            ${u.name}
                        </td>
                        <td style="font-weight:600;color:var(--primary);">${u.points || 0}</td>
                        <td>${u.wins || 0}</td>
                    </tr>
                `;
                rank++;
            });
        }

        async function loadRecords() {
            const recordsSnap = await db.collection('records')
                .where('userId', '==', currentUser.id)
                .orderBy('date', 'desc')
                .get();
            
            const list = document.getElementById('recordsList');
            list.innerHTML = recordsSnap.empty ? '<p style="color:var(--text-secondary)">No records yet</p>' : '';
            
            recordsSnap.forEach(doc => {
                const r = doc.data();
                list.innerHTML += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;border-bottom:1px solid var(--border);">
                        <div>
                            <strong>${r.testName}</strong>
                            <p style="color:var(--text-secondary);font-size:14px;">${r.date?.toDate?.().toLocaleDateString() || 'N/A'}</p>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:20px;font-weight:700;color:var(--primary);">${r.score}/${r.total}</div>
                            <span class="${r.result === 'win' ? 'point-change positive' : 'point-change negative'}">
                                ${r.result === 'win' ? '+10' : r.result === 'loss' ? '-5' : '0'}
                            </span>
                        </div>
                    </div>
                `;
            });
        }

        async function loadAllUsers() {
            const usersSnap = await db.collection('users').orderBy('name').get();
            const list = document.getElementById('usersList');
            list.innerHTML = '';
            
            usersSnap.forEach(doc => {
                const u = doc.data();
                if (doc.id !== currentUser.id) {
                    list.innerHTML += `
                        <div style="display:flex;align-items:center;gap:15px;padding:15px;border-bottom:1px solid var(--border);">
                            <img src="${u.photoURL}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">
                            <div style="flex:1;">
                                <h4>${u.name}</h4>
                                <span style="color:var(--text-secondary);font-size:14px;">${u.points || 0} Points ‚Ä¢ ${u.wins || 0} Wins</span>
                            </div>
                        </div>
                    `;
                }
            });
        }

        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach((t, i) => t.classList.toggle('active', 
                (tab === 'tests' && i === 0) || (tab === 'records' && i === 1) || (tab === 'leaderboard' && i === 2) || (tab === 'users' && i === 3)));
            document.getElementById('testsSection').classList.toggle('hidden', tab !== 'tests');
            document.getElementById('recordsSection').classList.toggle('hidden', tab !== 'records');
            document.getElementById('leaderboardSection').classList.toggle('hidden', tab !== 'leaderboard');
            document.getElementById('usersSection').classList.toggle('hidden', tab !== 'users');
            
            if (tab === 'records') loadRecords();
            if (tab === 'leaderboard') loadLeaderboard();
            if (tab === 'users') loadAllUsers();
        }

        // Test Functions
        function startTest(testId, testName) {
            currentTest = { id: testId, name: testName };
            document.getElementById('testNameSpan').textContent = testName;
            document.getElementById('testCodeModal').classList.remove('hidden');
            document.getElementById('testCodeInput').value = '';
            document.getElementById('testCodeInput').focus();
        }

        function closeTestCodeModal() {
            document.getElementById('testCodeModal').classList.add('hidden');
        }

        async function verifyTestCode() {
            const code = document.getElementById('testCodeInput').value.trim().toUpperCase();
            const testDoc = await db.collection('tests').doc(currentTest.id).get();
            
            if (testDoc.data().code.toUpperCase() !== code) {
                alert('Invalid test code!');
                return;
            }
            
            closeTestCodeModal();
            await findOrCreateSession();
        }

        async function findOrCreateSession() {
            document.getElementById('waitingRoom').classList.remove('hidden');
            
            // Look for waiting session
            const waitingSnap = await db.collection('sessions')
                .where('testId', '==', currentTest.id)
                .where('status', '==', 'waiting')
                .limit(1)
                .get();
            
            if (!waitingSnap.empty) {
                // Join existing session
                const sessionDoc = waitingSnap.docs[0];
                currentSession = sessionDoc.id;
                
                await db.collection('sessions').doc(currentSession).update({
                    player2: currentUser.id,
                    player2Name: currentUser.name,
                    player2Photo: currentUser.photoURL,
                    status: 'active',
                    startTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                listenToSession();
            } else {
                // Create new session
                const sessionRef = await db.collection('sessions').add({
                    testId: currentTest.id,
                    testName: currentTest.name,
                    player1: currentUser.id,
                    player1Name: currentUser.name,
                    player1Photo: currentUser.photoURL,
                    player1Question: 1,
                    player1Answers: {},
                    player1Submitted: false,
                    player2: null,
                    player2Name: null,
                    player2Photo: null,
                    player2Question: 1,
                    player2Answers: {},
                    player2Submitted: false,
                    status: 'waiting',
                    messages: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                currentSession = sessionRef.id;
                listenToSession();
            }
        }

        function listenToSession() {
            sessionUnsubscribe = db.collection('sessions').doc(currentSession).onSnapshot(async doc => {
                const data = doc.data();
                
                if (data.status === 'active' && document.getElementById('waitingRoom').classList.contains('hidden') === false) {
                    document.getElementById('waitingRoom').classList.add('hidden');
                    await startQuiz(data);
                }
                
                if (data.status === 'active') {
                    updateOpponentStatus(data);
                    updateChat(data.messages || []);
                    
                    // Check if either player submitted
                    if ((data.player1Submitted || data.player2Submitted) && !data.completed) {
                        await endQuiz(data);
                    }
                }
            });
        }

        async function startQuiz(sessionData) {
            // Load questions
            const questionsSnap = await db.collection('questions').where('testId', '==', currentTest.id).get();
            questions = questionsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            if (questions.length === 0) {
                alert('No questions available for this test!');
                cancelWaiting();
                return;
            }
            
            // Set up UI
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('quizPage').classList.remove('hidden');
            
            const isPlayer1 = sessionData.player1 === currentUser.id;
            const opponent = isPlayer1 ? 
                { name: sessionData.player2Name, photo: sessionData.player2Photo } :
                { name: sessionData.player1Name, photo: sessionData.player1Photo };
            
            document.getElementById('p1Avatar').src = currentUser.photoURL;
            document.getElementById('p1Name').textContent = 'You';
            document.getElementById('p2Avatar').src = opponent.photo;
            document.getElementById('p2Name').textContent = opponent.name;
            
            document.getElementById('totalQNum').textContent = questions.length;
            
            answers = {};
            currentQ = 0;
            timeLeft = 3600;
            
            showQuestion();
            startTimer();
            initVoiceChat();
        }

        function showQuestion() {
            const q = questions[currentQ];
            document.getElementById('currentQNum').textContent = currentQ + 1;
            document.getElementById('questionText').textContent = q.text;
            
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            const letters = ['A', 'B', 'C', 'D'];
            q.options.forEach((opt, i) => {
                const div = document.createElement('div');
                div.className = 'option' + (answers[currentQ] === letters[i] ? ' selected' : '');
                div.innerHTML = `<span class="option-letter">${letters[i]}</span><span>${opt}</span>`;
                div.onclick = () => selectOption(letters[i]);
                container.appendChild(div);
            });
            
            document.getElementById('prevBtn').disabled = currentQ === 0;
            document.getElementById('nextBtn').classList.toggle('hidden', currentQ === questions.length - 1);
            document.getElementById('submitBtn').classList.toggle('hidden', currentQ !== questions.length - 1);
            
            // Update session with current question
            updateMyQuestion();
        }

        function selectOption(letter) {
            answers[currentQ] = letter;
            document.querySelectorAll('.option').forEach((opt, i) => {
                opt.classList.toggle('selected', ['A','B','C','D'][i] === letter);
            });
            updateMyAnswers();
        }

        function prevQuestion() {
            if (currentQ > 0) { currentQ--; showQuestion(); }
        }

        function nextQuestion() {
            if (currentQ < questions.length - 1) { currentQ++; showQuestion(); }
        }

        async function updateMyQuestion() {
            const isPlayer1 = (await db.collection('sessions').doc(currentSession).get()).data().player1 === currentUser.id;
            await db.collection('sessions').doc(currentSession).update({
                [isPlayer1 ? 'player1Question' : 'player2Question']: currentQ + 1
            });
        }

        async function updateMyAnswers() {
            const isPlayer1 = (await db.collection('sessions').doc(currentSession).get()).data().player1 === currentUser.id;
            await db.collection('sessions').doc(currentSession).update({
                [isPlayer1 ? 'player1Answers' : 'player2Answers']: answers
            });
        }

        function updateOpponentStatus(data) {
            const isPlayer1 = data.player1 === currentUser.id;
            document.getElementById('p2Question').textContent = isPlayer1 ? data.player2Question : data.player1Question;
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                const timerEl = document.getElementById('timer');
                timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                timerEl.classList.toggle('warning', timeLeft < 300);
                
                if (timeLeft <= 0) submitQuiz();
            }, 1000);
        }

        async function submitQuiz() {
            clearInterval(timerInterval);
            
            const sessionDoc = await db.collection('sessions').doc(currentSession).get();
            const isPlayer1 = sessionDoc.data().player1 === currentUser.id;
            
            await db.collection('sessions').doc(currentSession).update({
                [isPlayer1 ? 'player1Submitted' : 'player2Submitted']: true,
                [isPlayer1 ? 'player1Answers' : 'player2Answers']: answers
            });
        }

        async function endQuiz(sessionData) {
            // Mark as completed
            await db.collection('sessions').doc(currentSession).update({ completed: true });
            
            clearInterval(timerInterval);
            if (peerConnection) peerConnection.close();
            
            // Calculate scores
            const isPlayer1 = sessionData.player1 === currentUser.id;
            const myAnswers = isPlayer1 ? sessionData.player1Answers : sessionData.player2Answers;
            const oppAnswers = isPlayer1 ? sessionData.player2Answers : sessionData.player1Answers;
            
            let myScore = 0, oppScore = 0;
            questions.forEach((q, i) => {
                if (myAnswers[i] === q.correct) myScore++;
                if (oppAnswers[i] === q.correct) oppScore++;
            });
            
            // Determine winner and update points
            const isWin = myScore > oppScore;
            const isTie = myScore === oppScore;
            let myPointChange = isTie ? 0 : (isWin ? 10 : (currentUser.points >= 5 ? -5 : -currentUser.points));
            let oppPointChange = isTie ? 0 : (isWin ? ((sessionData[isPlayer1 ? 'player2Points' : 'player1Points'] || 0) >= 5 ? -5 : 0) : 10);
            
            // Get opponent's current points
            const oppUserId = isPlayer1 ? sessionData.player2 : sessionData.player1;
            const oppUserDoc = await db.collection('users').doc(oppUserId).get();
            const oppPoints = oppUserDoc.data().points || 0;
            
            if (!isWin && !isTie) {
                myPointChange = currentUser.points >= 5 ? -5 : -currentUser.points;
            }
            if (isWin) {
                oppPointChange = oppPoints >= 5 ? -5 : -oppPoints;
            }
            
            // Update user stats
            const newPoints = Math.max(0, currentUser.points + myPointChange);
            await db.collection('users').doc(currentUser.id).update({
                points: newPoints,
                tests: firebase.firestore.FieldValue.increment(1),
                wins: firebase.firestore.FieldValue.increment(isWin ? 1 : 0),
                losses: firebase.firestore.FieldValue.increment(!isWin && !isTie ? 1 : 0)
            });
            
            // Save record
            await db.collection('records').add({
                userId: currentUser.id,
                testId: currentTest.id,
                testName: currentTest.name,
                score: myScore,
                total: questions.length,
                result: isTie ? 'tie' : (isWin ? 'win' : 'loss'),
                date: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Show results
            const oppName = isPlayer1 ? sessionData.player2Name : sessionData.player1Name;
            const oppPhoto = isPlayer1 ? sessionData.player2Photo : sessionData.player1Photo;
            
            document.getElementById('resultIcon').textContent = isTie ? 'ü§ù' : (isWin ? 'üèÜ' : 'üòî');
            document.getElementById('resultTitle').textContent = isTie ? "It's a Tie!" : (isWin ? 'You Won!' : 'You Lost!');
            
            document.getElementById('result1Avatar').src = currentUser.photoURL;
            document.getElementById('result1Name').textContent = 'You';
            document.getElementById('result1Score').textContent = `${myScore}/${questions.length}`;
            document.getElementById('result1Points').textContent = (myPointChange >= 0 ? '+' : '') + myPointChange;
            document.getElementById('result1Points').className = 'point-change ' + (myPointChange >= 0 ? 'positive' : 'negative');
            document.getElementById('result1Total').textContent = newPoints;
            
            document.getElementById('result2Avatar').src = oppPhoto;
            document.getElementById('result2Name').textContent = oppName;
            document.getElementById('result2Score').textContent = `${oppScore}/${questions.length}`;
            document.getElementById('result2Points').textContent = (oppPointChange >= 0 ? '+' : '') + oppPointChange;
            document.getElementById('result2Points').className = 'point-change ' + (oppPointChange >= 0 ? 'positive' : 'negative');
            document.getElementById('result2Total').textContent = Math.max(0, oppPoints + oppPointChange);
            
            document.getElementById('resultsModal').classList.remove('hidden');
        }

        function cancelWaiting() {
            if (sessionUnsubscribe) sessionUnsubscribe();
            if (currentSession) {
                db.collection('sessions').doc(currentSession).delete();
            }
            document.getElementById('waitingRoom').classList.add('hidden');
            currentSession = null;
        }

        function backToDashboard() {
            if (sessionUnsubscribe) sessionUnsubscribe();
            document.getElementById('resultsModal').classList.add('hidden');
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            currentSession = null;
            loadStats();
            loadLeaderboard();
        }

        // Voice Chat
        async function initVoiceChat() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const sessionDoc = await db.collection('sessions').doc(currentSession).get();
                const isPlayer1 = sessionDoc.data().player1 === currentUser.id;
                
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                
                peerConnection.ontrack = e => {
                    document.getElementById('remoteAudio').srcObject = e.streams[0];
                };
                
                peerConnection.onicecandidate = e => {
                    if (e.candidate) {
                        rtdb.ref(`calls/${currentSession}/${isPlayer1 ? 'p1Candidates' : 'p2Candidates'}`).push(e.candidate.toJSON());
                    }
                };
                
                if (isPlayer1) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    await rtdb.ref(`calls/${currentSession}/offer`).set({ sdp: offer.sdp, type: offer.type });
                    
                    rtdb.ref(`calls/${currentSession}/answer`).on('value', async snap => {
                        if (snap.val() && !peerConnection.currentRemoteDescription) {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                        }
                    });
                    
                    rtdb.ref(`calls/${currentSession}/p2Candidates`).on('child_added', async snap => {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(snap.val()));
                    });
                } else {
                    rtdb.ref(`calls/${currentSession}/offer`).on('value', async snap => {
                        if (snap.val() && !peerConnection.currentRemoteDescription) {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                            const answer = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);
                            await rtdb.ref(`calls/${currentSession}/answer`).set({ sdp: answer.sdp, type: answer.type });
                        }
                    });
                    
                    rtdb.ref(`calls/${currentSession}/p1Candidates`).on('child_added', async snap => {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(snap.val()));
                    });
                }
            } catch (err) {
                console.log('Voice chat error:', err);
            }
        }

        function toggleMic() {
            micEnabled = !micEnabled;
            if (localStream) {
                localStream.getAudioTracks().forEach(track => track.enabled = micEnabled);
            }
            const btn = document.getElementById('micBtn');
            btn.classList.toggle('muted', !micEnabled);
            btn.innerHTML = `<i class="fas fa-microphone${micEnabled ? '' : '-slash'}"></i>`;
        }

        function toggleSpeaker() {
            speakerEnabled = !speakerEnabled;
            document.getElementById('remoteAudio').muted = !speakerEnabled;
            const btn = document.getElementById('speakerBtn');
            btn.classList.toggle('muted', !speakerEnabled);
            btn.innerHTML = `<i class="fas fa-volume-${speakerEnabled ? 'up' : 'mute'}"></i>`;
        }

        // Chat
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            
            await db.collection('sessions').doc(currentSession).update({
                messages: firebase.firestore.FieldValue.arrayUnion({
                    sender: currentUser.id,
                    text,
                    time: Date.now()
                })
            });
            
            input.value = '';
        }

        function updateChat(messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            
            messages.forEach(m => {
                const div = document.createElement('div');
                div.className = 'message ' + (m.sender === currentUser.id ? 'sent' : 'received');
                div.textContent = m.text;
                container.appendChild(div);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        function toggleEmojiPicker() {
            document.getElementById('emojiPicker').classList.toggle('hidden');
        }

        // Theme
        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('ofujeDark', document.body.classList.contains('dark'));
            document.querySelector('.theme-toggle i').className = document.body.classList.contains('dark') ? 'fas fa-sun' : 'fas fa-moon';
        }

        function checkDarkMode() {
            if (localStorage.getItem('ofujeDark') === 'true') {
                document.body.classList.add('dark');
                document.querySelector('.theme-toggle i').className = 'fas fa-sun';
            }
        }

        // Admin Functions
        async function loadAdminData() {
            await loadAdminUsers();
            await loadAdminTests();
            await loadAdminQuestions();
        }

        async function loadAdminUsers() {
            const usersSnap = await db.collection('users').orderBy('name').get();
            const tbody = document.getElementById('adminUsersBody');
            tbody.innerHTML = '';
            
            usersSnap.forEach(doc => {
                const u = doc.data();
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${u.photoURL}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;"></td>
                        <td>${u.name}</td>
                        <td><code>${u.code}</code></td>
                        <td>${u.points || 0}</td>
                        <td>${u.restricted ? '<span style="color:var(--danger)">Restricted</span>' : '<span style="color:var(--success)">Active</span>'}</td>
                        <td class="admin-actions">
                            <button class="btn btn-secondary" onclick="toggleRestrict('${doc.id}', ${!u.restricted})" style="padding:8px 12px;">
                                ${u.restricted ? 'Unrestrict' : 'Restrict'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteUser('${doc.id}')" style="padding:8px 12px;">Delete</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function toggleRestrict(userId, restrict) {
            await db.collection('users').doc(userId).update({ restricted: restrict });
            loadAdminUsers();
        }

        async function deleteUser(userId) {
            if (confirm('Delete this user?')) {
                await db.collection('users').doc(userId).delete();
                loadAdminUsers();
            }
        }

        async function loadAdminTests() {
            const testsSnap = await db.collection('tests').get();
            const tbody = document.getElementById('adminTestsBody');
            tbody.innerHTML = '';
            const select = document.getElementById('questionTestSelect');
            select.innerHTML = '';
            
            for (const doc of testsSnap.docs) {
                const t = doc.data();
                const qSnap = await db.collection('questions').where('testId', '==', doc.id).get();
                
                tbody.innerHTML += `
                    <tr>
                        <td>${t.name}</td>
                        <td><code>${t.code}</code></td>
                        <td>${qSnap.size}</td>
                        <td class="admin-actions">
                            <button class="btn btn-danger" onclick="deleteTest('${doc.id}')" style="padding:8px 12px;">Delete</button>
                        </td>
                    </tr>
                `;
                
                select.innerHTML += `<option value="${doc.id}">${t.name}</option>`;
            }
        }

        async function addTest() {
            const name = document.getElementById('newTestName').value.trim();
            const code = document.getElementById('newTestCode').value.trim().toUpperCase();
            const desc = document.getElementById('newTestDesc').value.trim();
            
            if (!name || !code) {
                alert('Please fill in all fields');
                return;
            }
            
            await db.collection('tests').add({
                name, code, description: desc,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            document.getElementById('newTestName').value = '';
            document.getElementById('newTestCode').value = '';
            document.getElementById('newTestDesc').value = '';
            
            loadAdminTests();
        }

        async function deleteTest(testId) {
            if (confirm('Delete this test and all its questions?')) {
                // Delete questions
                const qSnap = await db.collection('questions').where('testId', '==', testId).get();
                for (const doc of qSnap.docs) await doc.ref.delete();
                
                await db.collection('tests').doc(testId).delete();
                loadAdminTests();
                loadAdminQuestions();
            }
        }

        async function loadAdminQuestions() {
            const questionsSnap = await db.collection('questions').get();
            const list = document.getElementById('adminQuestionsList');
            list.innerHTML = '';
            
            for (const doc of questionsSnap.docs) {
                const q = doc.data();
                const testDoc = await db.collection('tests').doc(q.testId).get();
                const testName = testDoc.exists ? testDoc.data().name : 'Unknown';
                
                list.innerHTML += `
                    <div style="padding:15px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:start;">
                            <div>
                                <span style="background:var(--primary);color:white;padding:4px 10px;border-radius:20px;font-size:12px;">${testName}</span>
                                <p style="margin-top:10px;font-weight:500;">${q.text}</p>
                                <div style="margin-top:8px;font-size:14px;color:var(--text-secondary);">
                                    A: ${q.options[0]} | B: ${q.options[1]} | C: ${q.options[2]} | D: ${q.options[3]}
                                    <strong style="color:var(--success);margin-left:10px;">Answer: ${q.correct}</strong>
                                </div>
                            </div>
                            <button class="btn btn-danger" onclick="deleteQuestion('${doc.id}')" style="padding:8px 12px;">Delete</button>
                        </div>
                    </div>
                `;
            }
        }

        async function addQuestion() {
            const testId = document.getElementById('questionTestSelect').value;
            const text = document.getElementById('newQuestionText').value.trim();
            const optA = document.getElementById('optionA').value.trim();
            const optB = document.getElementById('optionB').value.trim();
            const optC = document.getElementById('optionC').value.trim();
            const optD = document.getElementById('optionD').value.trim();
            const correct = document.getElementById('correctAnswer').value;
            
            if (!testId || !text || !optA || !optB || !optC || !optD) {
                alert('Please fill in all fields');
                return;
            }
            
            await db.collection('questions').add({
                testId, text,
                options: [optA, optB, optC, optD],
                correct
            });
            
            document.getElementById('newQuestionText').value = '';
            document.getElementById('optionA').value = '';
            document.getElementById('optionB').value = '';
            document.getElementById('optionC').value = '';
            document.getElementById('optionD').value = '';
            
            loadAdminQuestions();
            loadAdminTests();
        }

        async function deleteQuestion(qId) {
            if (confirm('Delete this question?')) {
                await db.collection('questions').doc(qId).delete();
                loadAdminQuestions();
                loadAdminTests();
            }
        }

        function showAdminTab(tab) {
            document.querySelectorAll('#adminPage .nav-tab').forEach((t, i) => 
                t.classList.toggle('active', (tab === 'users' && i === 0) || (tab === 'tests' && i === 1) || (tab === 'questions' && i === 2)));
            document.getElementById('adminUsersSection').classList.toggle('hidden', tab !== 'users');
            document.getElementById('adminTestsSection').classList.toggle('hidden', tab !== 'tests');
            document.getElementById('adminQuestionsSection').classList.toggle('hidden', tab !== 'questions');
        }

        // Check for stored session
        const storedUser = localStorage.getItem('ofujeUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            showDashboard();
        }

        // Manual Question Addition Function (for code usage)
        async function addQuestionFromCode(testCode, questionText, options, correctAnswer) {
            const testSnap = await db.collection('tests').where('code', '==', testCode.toUpperCase()).get();
            if (testSnap.empty) {
                console.error('Test not found');
                return;
            }
            
            await db.collection('questions').add({
                testId: testSnap.docs[0].id,
                text: questionText,
                options: options,
                correct: correctAnswer.toUpperCase()
            });
            
            console.log('Question added successfully');
        }
        
        // Example usage:
        // addQuestionFromCode('GEN001', 'What is 2+2?', ['3', '4', '5', '6'], 'B');
    </script>
</body>
</html>